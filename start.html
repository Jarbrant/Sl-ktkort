<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Start ‚Äì Sl√§ktkort</title>
  <meta name="description" content="Start och guidning f√∂r Sl√§ktkort (demo). Tr√§d ‚Üí Personer ‚Üí Relationer ‚Üí Karta." />

  <style>
    :root { color-scheme: light; }
    body{
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      line-height: 1.5;
      margin: 0;
      padding: 24px;
      max-width: 1180px;
      margin-inline: auto;
      background: #fff;
      color: #111;
    }
    a{ color: inherit; text-decoration:none; }
    h1{ margin:0 0 6px; font-size:1.7rem; letter-spacing: -0.01em; }
    .muted{ color:#555; margin:0; }
    .small{ font-size:.95rem; color:#555; }
    .srOnly{
      position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden;
      clip: rect(0,0,0,0); border:0;
    }

    header{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      margin-bottom: 14px;
    }

    .btn, button{
      display:inline-block;
      padding:10px 12px;
      border:1px solid #333;
      border-radius:12px;
      background:#fff;
      font:inherit;
      cursor:pointer;
      text-decoration:none;
    }
    .btn.secondary{ border-color:#bbb; }
    .btn.primary{
      background:#111;
      color:#fff;
      border-color:#111;
      font-weight:900;
    }
    .btn.primary:hover{ opacity:.92; }
    .btn:focus-visible, button:focus-visible, a:focus-visible{
      outline: 3px solid rgba(0,0,0,.18);
      outline-offset: 2px;
      border-radius: 12px;
    }

    .topbar{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      margin-top: 10px;
    }

    /* ===== Dashboard blocks ===== */
    .card{
      border:1px solid #eaeaea;
      border-radius:16px;
      padding:16px;
      background:#fff;
      box-shadow: 0 8px 28px rgba(0,0,0,.05);
    }

    .stack{ display:flex; flex-direction:column; gap:12px; }

    /* ===== Status (v√§gledande) ===== */
    .statusRow{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border:1px solid #e6e6e6;
      border-radius:999px;
      background:#fafafa;
      font-size:.95rem;
      white-space:nowrap;
    }
    .pill strong{ font-weight:900; }
    .pill.ok{ border-color:#cfe8cf; background:#f5fff5; }
    .pill.warn{ border-color:#ffe1a6; background:#fff9ee; }
    .pill.err{ border-color:#ffb3b3; background:#fff2f2; }

    /* ===== Progress ===== */
    .progress{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
    }
    .step{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border:1px solid #eaeaea;
      border-radius:999px;
      background:#fff;
      font-size:.95rem;
    }
    .dot{
      width: 22px;
      height: 22px;
      border-radius: 999px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      font-weight: 950;
      border:1px solid #bbb;
      color:#555;
      background:#fff;
      flex: 0 0 auto;
    }
    .step.done .dot{
      border-color:#111;
      color:#111;
    }
    .step.active{
      border-color:#111;
      background:#111;
      color:#fff;
      font-weight: 900;
    }
    .step.active .dot{
      border-color:#fff;
      color:#111;
      background:#fff;
    }
    .arrow{ color:#777; font-weight: 900; }

    /* ===== Next step ===== */
    .nextBar{
      border:1px solid #eaeaea;
      border-radius:16px;
      padding:12px 14px;
      background:#fff;
      box-shadow: 0 8px 28px rgba(0,0,0,.04);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .nextText{
      font-weight: 900;
      letter-spacing: -0.01em;
    }

    /* ===== Tiles ===== */
    .grid{
      display:grid;
      gap:14px;
      grid-template-columns: 1fr;
      margin-top: 6px;
    }
    @media (min-width: 880px){
      .grid{ grid-template-columns: 1fr 1fr; }
    }

    .tile{
      border:1px solid #eaeaea;
      border-radius:16px;
      padding:16px;
      background:#fff;
      box-shadow: 0 8px 28px rgba(0,0,0,.05);
      display:flex;
      flex-direction:column;
      gap:10px;
      cursor:pointer;
      transition: transform .12s ease, box-shadow .12s ease, background .12s ease;
      position: relative;
    }
    .tile:hover{
      background:#fcfcfc;
      transform: translateY(-1px);
      box-shadow: 0 10px 34px rgba(0,0,0,.07);
    }
    .tileHead{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
    }
    .tileTitle{
      margin:0;
      font-size: 1.1rem;
      font-weight: 950;
      letter-spacing: -0.01em;
    }
    .tileDesc{ margin:0; color:#555; font-size:.95rem; }

    /* Make whole tile clickable but keep inner button */
    .tileLink{
      position:absolute;
      inset:0;
      border-radius:16px;
    }
    .tile .btn{ align-self:flex-start; z-index: 2; }

    /* Footer note */
    .footerNote{
      margin-top: 14px;
      color:#666;
      font-size: .92rem;
    }
  </style>
</head>

<body>
  <!-- ============================================
       DEMO AUTH-GUARD
       ============================================ -->
  <script>
    (function authGuard(){
      try{
        if(sessionStorage.getItem("demo_auth") !== "1"){
          // Om du vill att start ska vara publik: ta bort denna guard.
          window.location.href = "./index.html";
        }
      }catch{}
    })();
  </script>

  <header>
    <div style="min-width:0;">
      <h1>Start</h1>
      <p class="muted">F√∂lj stegen: Tr√§d ‚Üí Personer ‚Üí Relationer ‚Üí Karta.</p>

      <nav class="topbar" aria-label="Navigation">
        <a class="btn secondary" href="./start.html" aria-current="page">Start</a>
        <a class="btn secondary" href="./app/trees.html">Tr√§d</a>
        <a class="btn secondary" href="./app/slaktkort.html">Personer</a>
        <a class="btn secondary" href="./app/create-relation.html">Relationer</a>
        <a class="btn secondary" href="./app/map.html">Karta</a>
      </nav>
    </div>

    <div class="actions" style="display:flex; gap:10px; align-items:center;">
      <button id="logoutBtn" class="btn secondary" type="button">Logga ut</button>
    </div>
  </header>

  <main class="stack" aria-label="Startpanel">
    <!-- ============================================
         STATUS (v√§gledande)
         ============================================ -->
    <section class="card" aria-label="Status">
      <div class="statusRow" role="group" aria-label="V√§gledande status">
        <span id="pillTree" class="pill warn">Aktivt tr√§d: <strong>‚Äî</strong></span>
        <span id="pillPeople" class="pill warn">Personer: <strong>‚Äî</strong></span>
        <span id="pillRelations" class="pill warn">Relationer: <strong>‚Äî</strong></span>
        <span id="pillPlace" class="pill warn">Plats: <strong>‚Äî</strong></span>
      </div>

      <div style="margin-top:12px;">
        <div class="progress" aria-label="Progress">
          <span id="s1" class="step"><span class="dot">1</span>Tr√§d</span>
          <span class="arrow">‚Üí</span>
          <span id="s2" class="step"><span class="dot">2</span>Personer</span>
          <span class="arrow">‚Üí</span>
          <span id="s3" class="step"><span class="dot">3</span>Relationer</span>
          <span class="arrow">‚Üí</span>
          <span id="s4" class="step"><span class="dot">4</span>Karta</span>
        </div>
      </div>

      <div class="nextBar" style="margin-top:12px;" aria-label="N√§sta steg">
        <div class="nextText" id="nextText">‚û°Ô∏è N√§sta: ‚Äî</div>
        <a id="nextCta" class="btn primary" href="./app/slaktkort.html">Forts√§tt</a>
      </div>

      <p id="hint" class="small" style="margin:12px 0 0;" aria-live="polite">‚Äî</p>
    </section>

    <!-- ============================================
         TILES (hela rutor klickbara)
         ============================================ -->
    <section class="grid" aria-label="Steg">
      <!-- Tr√§d -->
      <article class="tile" aria-label="Tr√§d">
        <a class="tileLink" href="./app/trees.html" aria-label="√ñppna tr√§d"></a>
        <div class="tileHead">
          <h2 class="tileTitle">üå≥ Tr√§d</h2>
        </div>
        <p class="tileDesc">Skapa och v√§lj aktivt tr√§d.</p>
        <a class="btn secondary" href="./app/trees.html">√ñppna tr√§d</a>
      </article>

      <!-- Personer -->
      <article class="tile" aria-label="Personer">
        <a class="tileLink" href="./app/slaktkort.html" aria-label="Skapa person"></a>
        <div class="tileHead">
          <h2 class="tileTitle">üë§ Personer</h2>
        </div>
        <p class="tileDesc">L√§gg till personer i ditt tr√§d.</p>
        <a class="btn primary" href="./app/slaktkort.html">Skapa person</a>
      </article>

      <!-- Relationer -->
      <article class="tile" aria-label="Relationer">
        <a class="tileLink" href="./app/create-relation.html" aria-label="Skapa relation"></a>
        <div class="tileHead">
          <h2 class="tileTitle">üîó Relationer</h2>
        </div>
        <p class="tileDesc">Koppla f√∂r√§lder‚Äìbarn och partner.</p>
        <a class="btn secondary" href="./app/create-relation.html">Skapa relation</a>
      </article>

      <!-- Karta -->
      <article class="tile" aria-label="Karta">
        <a class="tileLink" href="./app/map.html" aria-label="√ñppna karta"></a>
        <div class="tileHead">
          <h2 class="tileTitle">üó∫Ô∏è Karta</h2>
        </div>
        <p class="tileDesc">Se mark√∂rer och kopplingar.</p>
        <a class="btn secondary" href="./app/map.html">√ñppna karta</a>
      </article>
    </section>

    <p class="footerNote">Demo-l√§ge: all data sparas lokalt i din webbl√§sare.</p>
  </main>

  <script>
    // =====================================================
    // STORAGE KEYS (ska matcha √∂vriga sidor)
    // =====================================================
    const KEY_TREES  = "slakttradet_trees";
    const KEY_ACTIVE = "slakttradet_active_tree_id";
    const cardsKey = (treeId) => "slakttradet_slaktkort_" + String(treeId);
    const relKey   = (treeId) => "slakttradet_relationer_" + String(treeId);

    // =====================================================
    // DOM
    // =====================================================
    const logoutBtn = document.getElementById("logoutBtn");

    const pillTree = document.getElementById("pillTree");
    const pillPeople = document.getElementById("pillPeople");
    const pillRelations = document.getElementById("pillRelations");
    const pillPlace = document.getElementById("pillPlace");

    const s1 = document.getElementById("s1");
    const s2 = document.getElementById("s2");
    const s3 = document.getElementById("s3");
    const s4 = document.getElementById("s4");

    const nextText = document.getElementById("nextText");
    const nextCta = document.getElementById("nextCta");
    const hint = document.getElementById("hint");

    // =====================================================
    // Helpers
    // =====================================================
    function safeParse(raw, fallback){ try{ return JSON.parse(raw); }catch{ return fallback; } }
    function loadJson(key, fallback){
      const raw = localStorage.getItem(key);
      return raw ? safeParse(raw, fallback) : fallback;
    }
    function setPill(el, kind, html){
      el.className = "pill " + (kind || "");
      el.innerHTML = html;
    }

    function activeTreeId(){ return localStorage.getItem(KEY_ACTIVE) || ""; }

    function getTrees(){
      const trees = loadJson(KEY_TREES, []);
      return Array.isArray(trees) ? trees : [];
    }

    function activeTreeLabel(){
      const id = activeTreeId();
      if(!id) return "‚Äî";
      const t = getTrees().find(x => String(x.id) === String(id));
      return t ? (t.name || t.id) : id;
    }

    function loadPeople(){
      const t = activeTreeId();
      if(!t) return [];
      const arr = loadJson(cardsKey(t), []);
      return Array.isArray(arr) ? arr : [];
    }

    function loadRelations(){
      const t = activeTreeId();
      if(!t) return [];
      const arr = loadJson(relKey(t), []);
      return Array.isArray(arr) ? arr : [];
    }

    function inLatLonRange(lat, lon){
      return Number.isFinite(lat) && Number.isFinite(lon) &&
        lat >= -90 && lat <= 90 &&
        lon >= -180 && lon <= 180;
    }

    function coordsFromPerson(p){
      if(p && typeof p.coords === "object" && p.coords){
        const lat = Number(p.coords.lat);
        const lon = Number(p.coords.lon);
        if(inLatLonRange(lat, lon)) return { lat, lon };
        return null;
      }
      if(typeof p.coords === "string"){
        const s = p.coords.trim();
        const parts = s.split(",").map(x => x.trim()).filter(Boolean);
        if(parts.length === 2){
          const lat = Number(parts[0]);
          const lon = Number(parts[1]);
          if(inLatLonRange(lat, lon)) return { lat, lon };
        }
      }
      return null;
    }

    function setStep(el, state){
      el.classList.remove("done","active");
      const dot = el.querySelector(".dot");
      if(!dot) return;

      if(state === "done"){
        el.classList.add("done");
        dot.textContent = "‚úì";
      }else if(state === "active"){
        el.classList.add("active");
        dot.textContent = "‚óè";
      }else{
        dot.textContent = dot.dataset.n || dot.textContent || "‚Ä¢";
      }
    }

    // Preload dot numbers once
    for(const [i, el] of [[1,s1],[2,s2],[3,s3],[4,s4]]){
      const dot = el.querySelector(".dot");
      if(dot) dot.dataset.n = String(i);
      if(dot) dot.textContent = String(i);
    }

    // =====================================================
    // Compute + Render
    // =====================================================
    function computeState(){
      const trees = getTrees();
      const hasTrees = trees.length > 0;

      const tId = activeTreeId();
      const hasActive = !!tId;

      const people = hasActive ? loadPeople() : [];
      const relations = hasActive ? loadRelations() : [];

      const peopleCount = people.length;
      const relCount = relations.length;

      const withCoords = people.filter(p => !!coordsFromPerson(p)).length;

      return {
        hasTrees, hasActive,
        treeLabel: activeTreeLabel(),
        peopleCount,
        relCount,
        withCoords
      };
    }

    function render(){
      const st = computeState();

      // ---- Status pills (v√§gledande) ----
      // Aktivt tr√§d
      if(!st.hasTrees){
        setPill(pillTree, "err", "Aktivt tr√§d: <strong>‚ö†Ô∏è skapa tr√§d</strong>");
      }else if(!st.hasActive){
        setPill(pillTree, "warn", "Aktivt tr√§d: <strong>‚ö†Ô∏è v√§lj aktivt</strong>");
      }else{
        setPill(pillTree, "ok", "Aktivt tr√§d: <strong>‚úì " + st.treeLabel + "</strong>");
      }

      // Personer
      if(!st.hasActive){
        setPill(pillPeople, "warn", "Personer: <strong>‚Äî</strong>");
      }else if(st.peopleCount >= 2){
        setPill(pillPeople, "ok", "Personer: <strong>‚úì klart</strong> <span class='srOnly'>(antal)</span>");
      }else{
        const want = 2;
        setPill(pillPeople, "warn", "Personer: <strong>‚ö†Ô∏è skapa " + want + " (nu: " + st.peopleCount + ")</strong>");
      }

      // Relationer
      if(!st.hasActive){
        setPill(pillRelations, "warn", "Relationer: <strong>‚Äî</strong>");
      }else if(st.relCount >= 1){
        setPill(pillRelations, "ok", "Relationer: <strong>‚úì klart</strong>");
      }else{
        setPill(pillRelations, "warn", "Relationer: <strong>‚ö†Ô∏è skapa 1</strong>");
      }

      // Plats (coords)
      if(!st.hasActive){
        setPill(pillPlace, "warn", "Plats: <strong>‚Äî</strong>");
      }else if(st.withCoords >= 1){
        setPill(pillPlace, "ok", "Plats: <strong>‚úì minst 1</strong>");
      }else{
        setPill(pillPlace, "warn", "Plats: <strong>‚ö†Ô∏è l√§gg till plats</strong>");
      }

      // ---- Progress step selection ----
      // Default: step 1 active
      let activeStep = 1;

      if(!st.hasTrees || !st.hasActive){
        activeStep = 1;
      }else if(st.peopleCount < 2){
        activeStep = 2;
      }else if(st.relCount < 1){
        activeStep = 3;
      }else{
        activeStep = 4;
      }

      const stepEls = [null, s1, s2, s3, s4];

      for(let i=1; i<=4; i++){
        const el = stepEls[i];
        const dot = el.querySelector(".dot");
        if(dot) dot.textContent = dot.dataset.n;

        if(i < activeStep){
          el.classList.remove("active");
          el.classList.add("done");
          const d = el.querySelector(".dot");
          if(d) d.textContent = "‚úì";
        }else if(i === activeStep){
          el.classList.remove("done");
          el.classList.add("active");
          const d = el.querySelector(".dot");
          if(d) d.textContent = "‚óè";
        }else{
          el.classList.remove("done","active");
          const d = el.querySelector(".dot");
          if(d) d.textContent = d.dataset.n;
        }
      }

      // ---- Next step text + CTA ----
      let next = "‚û°Ô∏è N√§sta: Skapa din f√∂rsta person";
      let ctaHref = "./app/slaktkort.html";
      let ctaText = "Forts√§tt";

      if(!st.hasTrees){
        next = "‚û°Ô∏è N√§sta: Skapa ett tr√§d";
        ctaHref = "./app/trees.html";
        ctaText = "√ñppna tr√§d";
      }else if(!st.hasActive){
        next = "‚û°Ô∏è N√§sta: V√§lj ett aktivt tr√§d";
        ctaHref = "./app/trees.html";
        ctaText = "V√§lj tr√§d";
      }else if(st.peopleCount === 0){
        next = "‚û°Ô∏è N√§sta: Skapa din f√∂rsta person";
        ctaHref = "./app/slaktkort.html";
        ctaText = "Skapa person";
      }else if(st.peopleCount === 1){
        next = "‚û°Ô∏è N√§sta: Skapa en person till (minst 2 beh√∂vs)";
        ctaHref = "./app/slaktkort.html";
        ctaText = "Skapa person";
      }else if(st.relCount < 1){
        next = "‚û°Ô∏è N√§sta: Skapa en relation";
        ctaHref = "./app/create-relation.html";
        ctaText = "Skapa relation";
      }else if(st.withCoords < 1){
        next = "‚û°Ô∏è N√§sta: L√§gg till plats p√• minst en person";
        ctaHref = "./app/slaktkort.html";
        ctaText = "L√§gg till plats";
      }else{
        next = "‚û°Ô∏è N√§sta: √ñppna kartan och klicka p√• en mark√∂r";
        ctaHref = "./app/map.html";
        ctaText = "√ñppna karta";
      }

      nextText.textContent = next;
      nextCta.setAttribute("href", ctaHref);
      nextCta.textContent = ctaText;

      // ---- Hint line (kort, sakligt) ----
      if(!st.hasTrees){
        hint.textContent = "Skapa ett tr√§d f√∂rst. Sedan kan du l√§gga till personer.";
      }else if(!st.hasActive){
        hint.textContent = "V√§lj vilket tr√§d som √§r aktivt. Allt sparas i det aktiva tr√§det.";
      }else if(st.peopleCount < 2){
        hint.textContent = "Skapa minst tv√• personer innan du bygger relationer.";
      }else if(st.relCount < 1){
        hint.textContent = "Skapa minst en relation f√∂r att se kopplingar i kartan.";
      }else if(st.withCoords < 1){
        hint.textContent = "L√§gg till plats (coords) p√• minst en person f√∂r att f√• mark√∂rer p√• kartan.";
      }else{
        hint.textContent = "Klart f√∂r anv√§ndning. √ñppna kartan och testa mark√∂rer + kopplingar.";
      }
    }

    // =====================================================
    // Events
    // =====================================================
    logoutBtn.addEventListener("click", () => {
      try{ sessionStorage.removeItem("demo_auth"); }catch{}
      window.location.href = "./index.html";
    });

    // Auto-refresh when coming back / storage changes
    window.addEventListener("focus", render);
    window.addEventListener("storage", render);

    // Start
    render();
  </script>
</body>
</html>
