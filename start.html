<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Start ‚Äì Sl√§ktkort</title>
  <meta name="description" content="Start och r√∂d tr√•d f√∂r Sl√§ktkort (localStorage-first)." />
  <style>
    :root { color-scheme: light; }
    body{
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      line-height: 1.5;
      margin: 0;
      padding: 24px;
      max-width: 980px;
      margin-inline: auto;
      background: #fff;
      color: #111;
    }
    a { color: inherit; }
    header{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 12px;
      margin-bottom: 18px;
    }
    h1{ margin: 0 0 6px; font-size: 1.6rem; }
    p{ margin: 0 0 12px; }
    .muted{ color:#555; }

    .topbar{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      margin: 10px 0 0;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 8px 10px;
      border: 1px solid #ddd;
      border-radius: 999px;
      background: #fafafa;
      font-size: .95rem;
    }
    .pill strong{ font-weight: 800; }
    .pill.ok{ border-color:#cfe8cf; background:#f5fff5; }
    .pill.warn{ border-color:#ffe1a6; background:#fff9ee; }

    .grid{
      display:grid;
      gap: 14px;
      grid-template-columns: 1fr;
    }
    @media (min-width: 860px){
      .grid{ grid-template-columns: 1fr 1fr; }
    }

    .card{
      border: 1px solid #ddd;
      border-radius: 12px;
      padding: 16px;
      background: #fff;
    }
    .card h2{
      margin: 0 0 6px;
      font-size: 1.15rem;
    }
    .card .desc{ margin: 0 0 12px; color:#555; }
    .stepTag{
      display:inline-block;
      font-weight: 800;
      font-size: .85rem;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid #ddd;
      background:#fafafa;
      margin-bottom: 10px;
    }
    .stepTag.primary{ border-color:#cfe8cf; background:#f5fff5; }
    .stepTag.optional{ border-color:#d9e6ff; background:#f5f9ff; }

    .actions{
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
      margin-top: 10px;
    }
    .btn, button{
      display:inline-block;
      padding: 10px 12px;
      border: 1px solid #333;
      border-radius: 10px;
      background: #fff;
      font: inherit;
      cursor: pointer;
      text-decoration:none;
    }
    .btn.secondary{
      border-color:#bbb;
      color:#111;
    }
    .btn.disabled{
      opacity: .45;
      cursor: not-allowed;
      pointer-events: none;
    }

    .note{
      margin-top: 12px;
      padding: 12px;
      border-radius: 12px;
      border: 1px solid #ffe1a6;
      background: #fff9ee;
    }
    .note strong{ font-weight: 900; }

    footer{
      margin-top: 18px;
      color:#666;
      font-size: .95rem;
    }
    hr{ border:none; border-top:1px solid #eee; margin: 18px 0; }
  </style>
</head>

<body>
<header>
  <div>
    <h1>Sl√§ktkort ‚Äì Start</h1>
    <p class="muted">R√∂d tr√•d: <strong>Tr√§d ‚Üí Personer ‚Üí Relationer ‚Üí Karta</strong> (localStorage-first).</p>

    <nav class="topbar" aria-label="Navigation">
      <a class="btn secondary" href="start.html">Start</a>
      <a class="btn secondary" href="app/trees.html">Tr√§d</a>
      <a class="btn secondary" href="app/slaktkort.html">Personer</a>
      <a class="btn secondary" href="app/create-relation.html">Relationer</a>
      <a class="btn secondary" href="app/map.html">Karta</a>
    </nav>
  </div>

  <div class="actions">
    <button id="logoutBtn" class="btn secondary" type="button" title="Estetisk utloggning">Logga ut</button>
  </div>
</header>

<section id="statusRow" class="actions" aria-label="Status">
  <span id="pillTree" class="pill warn">Aktivt tr√§d: <strong>‚Äî</strong></span>
  <span id="pillPeople" class="pill">Personer: <strong>0</strong></span>
  <span id="pillRels" class="pill">Relationer: <strong>0</strong></span>
</section>

<div id="noTreeNote" class="note" hidden>
  <strong>üö© Inga tr√§d sparade/valt:</strong> B√∂rja med <a href="app/trees.html">Tr√§d</a> och skapa eller v√§lj ett aktivt tr√§d.
</div>

<hr />

<section class="grid" aria-label="Fl√∂de">
  <!-- STEG 1 -->
  <article class="card">
    <div class="stepTag primary">STEG 1</div>
    <h2>üå≥ Tr√§d</h2>
    <p class="desc">Skapa eller v√§lj ett aktivt tr√§d. All data (personer, relationer, karta) kopplas till det aktiva tr√§det.</p>
    <div class="actions">
      <a class="btn" href="app/trees.html">√ñppna Tr√§d</a>
      <button class="btn secondary" type="button" id="refreshBtn1">Uppdatera status</button>
    </div>
  </article>

  <!-- STEG 2 -->
  <article class="card">
    <div class="stepTag">STEG 2</div>
    <h2>üë§ Personer (Sl√§ktkort)</h2>
    <p class="desc">L√§gg in personer i valt tr√§d (namn, √•rtal, plats, anteckning, koordinater).</p>
    <div class="actions">
      <a id="linkPeople" class="btn" href="app/slaktkort.html">√ñppna Personer</a>
      <a class="btn secondary" href="app/place-picker.html">V√§lj plats (karta)</a>
    </div>
    <p class="muted" id="hintPeople" style="margin:10px 0 0;"></p>
  </article>

  <!-- STEG 3 -->
  <article class="card">
    <div class="stepTag">STEG 3</div>
    <h2>üîó Relationer</h2>
    <p class="desc">Koppla personer (f√∂r√§lder ‚Üí barn). Rekommenderat efter att du lagt in minst tv√• personer.</p>
    <div class="actions">
      <a id="linkRels" class="btn" href="app/create-relation.html">√ñppna Relationer</a>
      <a class="btn secondary" href="app/map.html">Visa p√• karta</a>
    </div>
    <p class="muted" id="hintRels" style="margin:10px 0 0;"></p>
  </article>

  <!-- STEG 4 -->
  <article class="card">
    <div class="stepTag optional">STEG 4 (valfri vy)</div>
    <h2>üó∫Ô∏è Karta (hel vy)</h2>
    <p class="desc">Visa personer med koordinater p√• karta. Bra som ‚Äúresultatvy‚Äù n√§r grunden (tr√§d + personer + relationer) finns.</p>
    <div class="actions">
      <a id="linkMap" class="btn" href="app/map.html">√ñppna Karta</a>
      <a class="btn secondary" href="app/place-picker.html">Plats-picker</a>
    </div>
    <p class="muted" id="hintMap" style="margin:10px 0 0;"></p>
  </article>
</section>

<footer>
  Status: GitHub Pages (statisk) ‚Ä¢ Data i webbl√§saren (localStorage) ‚Ä¢ Inloggning √§r estetisk.
</footer>

<script>
  // Estetisk "auth" (f√∂r flow-k√§nsla, inte s√§kerhet)
  (function authGuard(){
    try{
      if(sessionStorage.getItem("demo_auth") !== "1"){
        // Skicka till login
        window.location.href = "index.html";
      }
    }catch{
      // Om sessionStorage √§r l√•st: l√•t sidan fungera √§nd√•
    }
  })();

  const KEY_ACTIVE = "slakttradet_active_tree_id";
  const cardsKey = (id) => "slakttradet_slaktkort_" + id;
  const relKey   = (id) => "slakttradet_relationer_" + id;
  const treesKey = "slakttradet_trees";

  const pillTree   = document.getElementById("pillTree");
  const pillPeople = document.getElementById("pillPeople");
  const pillRels   = document.getElementById("pillRels");
  const noTreeNote = document.getElementById("noTreeNote");

  const linkPeople = document.getElementById("linkPeople");
  const linkRels   = document.getElementById("linkRels");
  const linkMap    = document.getElementById("linkMap");

  const hintPeople = document.getElementById("hintPeople");
  const hintRels   = document.getElementById("hintRels");
  const hintMap    = document.getElementById("hintMap");

  function loadJson(k, fallback){
    try{
      const raw = localStorage.getItem(k);
      return raw ? JSON.parse(raw) : fallback;
    }catch{
      return fallback;
    }
  }

  function getActiveTreeId(){
    try{ return localStorage.getItem(KEY_ACTIVE) || ""; }
    catch{ return ""; }
  }

  function hasAnyTrees(){
    const trees = loadJson(treesKey, []);
    return Array.isArray(trees) && trees.length > 0;
  }

  function countPeople(treeId){
    const cards = loadJson(cardsKey(treeId), []);
    if(!Array.isArray(cards)) return 0;
    return cards.filter(p => p && p.id).length;
  }

  function countRelations(treeId){
    const rels = loadJson(relKey(treeId), []);
    if(!Array.isArray(rels)) return 0;
    return rels.length;
  }

  function countPeopleWithCoords(treeId){
    const cards = loadJson(cardsKey(treeId), []);
    if(!Array.isArray(cards)) return 0;
    return cards.filter(p => {
      if(!p || !p.id) return false;
      const lat = Number(p.lat ?? p.latitude ?? p.coords?.lat);
      const lon = Number(p.lon ?? p.lng ?? p.longitude ?? p.coords?.lon);
      return Number.isFinite(lat) && Number.isFinite(lon);
    }).length;
  }

  function setDisabled(anchorEl, disabled){
    if(disabled){
      anchorEl.classList.add("disabled");
      anchorEl.setAttribute("aria-disabled", "true");
      anchorEl.setAttribute("tabindex", "-1");
    }else{
      anchorEl.classList.remove("disabled");
      anchorEl.removeAttribute("aria-disabled");
      anchorEl.removeAttribute("tabindex");
    }
  }

  function refresh(){
    const treeId = getActiveTreeId();
    const anyTrees = hasAnyTrees();

    const people = treeId ? countPeople(treeId) : 0;
    const rels   = treeId ? countRelations(treeId) : 0;
    const coords = treeId ? countPeopleWithCoords(treeId) : 0;

    // Tree pill
    const treeLabel = treeId ? treeId : "‚Äî";
    pillTree.innerHTML = 'Aktivt tr√§d: <strong>' + treeLabel + '</strong>';
    pillTree.classList.remove("ok","warn");
    pillTree.classList.add(treeId ? "ok" : "warn");

    // People / rels
    pillPeople.innerHTML = 'Personer: <strong>' + people + '</strong>';
    pillRels.innerHTML   = 'Relationer: <strong>' + rels + '</strong>';

    // Note
    noTreeNote.hidden = !!treeId || anyTrees; // om det finns tr√§d men inget valt, visa inte "inga tr√§d sparade" som h√•rd sanning
    if(!treeId){
      // Om det finns tr√§d men inget valt: visa en mjukare hint
      if(anyTrees){
        noTreeNote.hidden = false;
        noTreeNote.innerHTML = '<strong>üö© Inget aktivt tr√§d valt:</strong> G√• till <a href="app/trees.html">Tr√§d</a> och v√§lj ett aktivt tr√§d.';
      }else{
        noTreeNote.hidden = false;
        noTreeNote.innerHTML = '<strong>üö© Inga tr√§d sparade:</strong> B√∂rja med <a href="app/trees.html">Tr√§d</a> och skapa ett tr√§d.';
      }
    }

    // Locking (UX)
    const lockPeople = !treeId;
    const lockRels = !treeId || people < 2;
    const lockMap  = !treeId || coords < 1;

    setDisabled(linkPeople, lockPeople);
    setDisabled(linkRels, lockRels);
    setDisabled(linkMap,  lockMap);

    hintPeople.textContent = lockPeople
      ? "F√∂rst: v√§lj/skapa ett aktivt tr√§d."
      : "Klart: l√§gg till personer i det aktiva tr√§det.";

    hintRels.textContent = lockRels
      ? (!treeId ? "F√∂rst: v√§lj/skapa ett aktivt tr√§d." : "L√§gg till minst 2 personer f√∂r att skapa relationer.")
      : "Klart: nu kan du koppla F√∂r√§lder ‚Üí Barn.";

    hintMap.textContent = lockMap
      ? (!treeId ? "F√∂rst: v√§lj/skapa ett aktivt tr√§d." : "L√§gg till minst 1 person med koordinater f√∂r att kartan ska bli meningsfull.")
      : "Klart: nu kan du se personer p√• karta.";
  }

  document.getElementById("refreshBtn1").addEventListener("click", refresh);

  document.getElementById("logoutBtn").addEventListener("click", () => {
    try{ sessionStorage.removeItem("demo_auth"); }catch{}
    window.location.href = "index.html";
  });

  refresh();
</script>
</body>
</html>
