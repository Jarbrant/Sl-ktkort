<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Start ‚Äì Sl√§ktkort</title>
  <meta name="description" content="√ñversikt √∂ver ditt sl√§ktarbete (localStorage-first)." />

  <style>
    :root { color-scheme: light; }
    body{
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      line-height: 1.5;
      margin: 0;
      padding: 24px;
      max-width: 980px;
      margin-inline: auto;
      background: #fff;
      color: #111;
    }
    a{ color: inherit; text-decoration: none; }
    header{ margin-bottom: 16px; }

    nav{
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      margin: 10px 0 18px;
    }
    nav a{
      padding: 8px 10px;
      border-radius: 12px;
      background: #f2f3f5;
      border: 1px solid #e6e8eb;
    }
    nav a[aria-current="page"]{
      background: #e9f7ef;
      border-color: #bfe7cf;
    }
    .spacer{ flex: 1 1 auto; }
    .btn{
      padding: 8px 10px;
      border-radius: 12px;
      background: #fff;
      border: 1px solid #e6e8eb;
      cursor: pointer;
      font: inherit;
    }

    .grid{
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 12px;
      margin: 14px 0 10px;
    }
    @media (max-width: 900px){
      .grid{ grid-template-columns: repeat(2, minmax(0, 1fr)); }
    }
    @media (max-width: 520px){
      .grid{ grid-template-columns: 1fr; }
    }

    .card{
      border: 1px solid #e6e8eb;
      border-radius: 16px;
      padding: 14px 14px 12px;
      background: #fff;
      box-shadow: 0 1px 0 rgba(0,0,0,.03);
      display: flex;
      flex-direction: column;
      gap: 8px;
      min-height: 132px;
    }
    .row{
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 10px;
    }
    .title{
      font-weight: 750;
      font-size: 16px;
      margin: 0;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .count{
      font-size: 26px;
      font-weight: 800;
      margin: 0;
      letter-spacing: -0.02em;
    }
    .desc{
      margin: 0;
      color: #4b5563;
      font-size: 13px;
    }
    .goto{
      margin-top: auto;
      display: inline-flex;
      gap: 6px;
      align-items: center;
      padding: 8px 10px;
      border-radius: 12px;
      border: 1px solid #e6e8eb;
      background: #fafafa;
      width: fit-content;
    }
    .kicker{
      margin: 0 0 6px;
      color: #4b5563;
      font-size: 13px;
    }
    h1{ margin: 0 0 4px; font-size: 28px; }
    .foot{ margin-top: 18px; font-size: 12px; color: #6b7280; }
    .sr-only{
      position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px;
      overflow: hidden; clip: rect(0,0,0,0); white-space: nowrap; border: 0;
    }
  </style>
</head>

<body>
  <header>
    <h1>Start</h1>
    <p class="kicker">√ñversikt. All data sparas lokalt i webbl√§saren.</p>

    <nav aria-label="Huvudmeny">
      <a href="./start.html" aria-current="page">Start</a>
      <a href="./app/trees.html">Tr√§d</a>
      <a href="./app/slaktkort.html">Personer</a>
      <a href="./app/create-relation.html">Relationer</a>
      <a href="./app/map.html">Karta</a>
      <span class="spacer"></span>
      <button class="btn" id="logoutBtn" type="button">Logga ut</button>
    </nav>
  </header>

  <div class="grid" role="list" aria-label="Status">
    <a class="card" role="listitem" href="./app/trees.html" aria-label="G√• till Tr√§d">
      <div class="row">
        <p class="title">üå≥ Tr√§d</p>
        <p class="count" id="countTrees">0</p>
      </div>
      <p class="desc">Skapa och v√§lj vilket tr√§d du arbetar med.</p>
      <span class="goto">√ñppna ‚Üí</span>
    </a>

    <a class="card" role="listitem" href="./app/slaktkort.html" aria-label="G√• till Personer">
      <div class="row">
        <p class="title">üë§ Personer</p>
        <p class="count" id="countPeople">0</p>
      </div>
      <p class="desc">L√§gg till personer och deras grunduppgifter.</p>
      <span class="goto">√ñppna ‚Üí</span>
    </a>

    <a class="card" role="listitem" href="./app/create-relation.html" aria-label="G√• till Relationer">
      <div class="row">
        <p class="title">üîó Relationer</p>
        <p class="count" id="countRelations">0</p>
      </div>
      <p class="desc">Koppla samman personer i sl√§kten.</p>
      <span class="goto">√ñppna ‚Üí</span>
    </a>

    <a class="card" role="listitem" href="./app/map.html" aria-label="G√• till Karta">
      <div class="row">
        <p class="title">üó∫Ô∏è Karta</p>
        <p class="count" id="countPlaces">0</p>
      </div>
      <p class="desc">Se var i landet sl√§kten h√∂r hemma.</p>
      <span class="goto">√ñppna ‚Üí</span>
    </a>
  </div>

  <p class="foot">Tips: om siffrorna √§r 0 fast du vet att data finns, √§r det n√§stan alltid olika localStorage-nycklar mellan sidorna. Den h√§r start-sidan r√§knar √§nd√• r√§tt.</p>

  <script>
    "use strict";

    // --------- utils ----------
    function safeParseJSON(v){
      if (typeof v !== "string") return null;
      try { return JSON.parse(v); } catch { return null; }
    }
    function isObject(x){ return x && typeof x === "object" && !Array.isArray(x); }
    function asArray(x){ return Array.isArray(x) ? x : []; }

    // --------- key candidates (try first) ----------
    const KEY_CANDIDATES = {
      trees: [
        "slaktkort_trees","slakttradet_trees","trees","slakt_trees","trad","slaktkort_trad"
      ],
      people: [
        "slaktkort_people","slaktkort_personer","slakttradet_people","slakttradet_personer",
        "people","persons","personer","slaktkort_persons"
      ],
      relations: [
        "slaktkort_relations","slaktkort_relationer","slakttradet_relations","slakttradet_relationer",
        "relations","relationer"
      ],
      activeTreeId: [
        "slaktkort_active_tree_id","slakttradet_active_tree_id","activeTreeId","currentTreeId"
      ]
    };

    function firstExistingJSON(keys){
      for (const k of keys){
        const parsed = safeParseJSON(localStorage.getItem(k));
        if (parsed !== null) return { key: k, value: parsed };
      }
      return null;
    }

    // --------- fallback: scan all localStorage and infer ----------
    function scanStorage(){
      const blobs = [];
      for (let i=0; i<localStorage.length; i++){
        const key = localStorage.key(i);
        const parsed = safeParseJSON(localStorage.getItem(key));
        if (parsed !== null) blobs.push({ key, value: parsed });
      }

      let trees = [];
      let people = [];
      let relations = [];

      for (const b of blobs){
        const v = b.value;

        // nested object form: {trees:[...], people:[...], relations:[...]}
        if (isObject(v)){
          const maybeTrees = Array.isArray(v.trees) ? v.trees : (Array.isArray(v.trad) ? v.trad : null);
          const maybePeople = Array.isArray(v.people) ? v.people : (Array.isArray(v.personer) ? v.personer : null);
          const maybeRelations = Array.isArray(v.relations) ? v.relations : (Array.isArray(v.relationer) ? v.relationer : null);

          if (maybeTrees && trees.length === 0) trees = maybeTrees;
          if (maybePeople && people.length === 0) people = maybePeople;
          if (maybeRelations && relations.length === 0) relations = maybeRelations;
        }

        // direct arrays
        if (Array.isArray(v)){
          if (trees.length === 0 && v.some(x => isObject(x) && (x.name || x.namn) && (x.id || x.treeId))) {
            trees = v;
          } else if (people.length === 0 && v.some(x => isObject(x) && (x.fornamn || x.firstName || x.givenName) && (x.efternamn || x.lastName || x.familyName))) {
            people = v;
          } else if (relations.length === 0 && v.some(x => isObject(x) && (x.type || x.relationType || x.relation) && (x.a || x.from || x.source || x.personA))) {
            relations = v;
          }
        }
      }

      return { trees: asArray(trees), people: asArray(people), relations: asArray(relations) };
    }

    function countPlacesFromPeople(people){
      let n = 0;
      for (const x of people){
        if (!isObject(x)) continue;

        const lat = (x.lat ?? (x.coords && x.coords.lat));
        const lon = (x.lon ?? x.lng ?? (x.coords && (x.coords.lon ?? x.coords.lng)));
        const hasCoords = Number.isFinite(+lat) && Number.isFinite(+lon);

        const placeText = (x.plats ?? x.place ?? x.location ?? "").toString().trim();
        const hasPlaceText = placeText.length > 0;

        if (hasCoords || hasPlaceText) n++;
      }
      return n;
    }

    function computeCounts(){
      const t = firstExistingJSON(KEY_CANDIDATES.trees);
      const p = firstExistingJSON(KEY_CANDIDATES.people);
      const r = firstExistingJSON(KEY_CANDIDATES.relations);

      let trees = t ? (Array.isArray(t.value) ? t.value : (t.value.trees || t.value.trad || [])) : null;
      let people = p ? (Array.isArray(p.value) ? p.value : (p.value.people || p.value.personer || [])) : null;
      let relations = r ? (Array.isArray(r.value) ? r.value : (r.value.relations || r.value.relationer || [])) : null;

      if (!trees || !people || !relations){
        const scanned = scanStorage();
        trees = trees || scanned.trees;
        people = people || scanned.people;
        relations = relations || scanned.relations;
      }

      trees = asArray(trees);
      people = asArray(people);
      relations = asArray(relations);

      return {
        trees: trees.length,
        people: people.length,
        relations: relations.length,
        places: countPlacesFromPeople(people)
      };
    }

    function renderCounts(){
      const c = computeCounts();
      const elT = document.getElementById("countTrees");
      const elP = document.getElementById("countPeople");
      const elR = document.getElementById("countRelations");
      const elL = document.getElementById("countPlaces");
      if (elT) elT.textContent = String(c.trees);
      if (elP) elP.textContent = String(c.people);
      if (elR) elR.textContent = String(c.relations);
      if (elL) elL.textContent = String(c.places);
    }

    // "Logga ut" i demo-l√§ge: ta bort tokens och ladda om.
    document.getElementById("logoutBtn")?.addEventListener("click", () => {
      localStorage.removeItem("auth_token");
      localStorage.removeItem("accessToken");
      localStorage.removeItem("refreshToken");
      location.href = "./start.html";
    });

    renderCounts();
    window.addEventListener("storage", renderCounts);
  </script>
</body>
</html>
