<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Start ‚Äì Sl√§ktkort</title>
  <meta name="description" content="Startfl√∂de: Tr√§d (f√∂rsta g√•ngen) ‚Üí Personer ‚Üí Relationer ‚Üí Karta." />

  <style>
    :root { color-scheme: light; }
    body{
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      line-height: 1.5;
      margin: 0;
      padding: 24px;
      max-width: 980px;
      margin-inline: auto;
      background: #fff;
      color: #111;
    }
    a{ color: inherit; text-decoration:none; }
    header{ margin-bottom: 14px; }
    h1{ margin:0 0 6px; font-size:1.6rem; }
    .muted{ color:#555; margin:0 0 12px; }

    .topbar{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      margin: 10px 0 16px;
    }
    .btn, button{
      display:inline-block;
      padding:10px 12px;
      border:1px solid #333;
      border-radius:10px;
      background:#fff;
      font:inherit;
      cursor:pointer;
      text-decoration:none;
    }
    .btn.secondary{ border-color:#bbb; }
    .btn.disabled{
      opacity:.45;
      cursor:not-allowed;
      pointer-events:none;
    }

    .pillRow{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      margin: 10px 0 18px;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border:1px solid #ddd;
      border-radius:999px;
      background:#fafafa;
      font-size:.95rem;
    }
    .pill strong{ font-weight:900; }
    .pill.ok{ border-color:#cfe8cf; background:#f5fff5; }
    .pill.warn{ border-color:#ffe1a6; background:#fff9ee; }
    .pill.err{ border-color:#ffb3b3; background:#fff2f2; }

    .grid{
      display:grid;
      gap:14px;
      grid-template-columns: 1fr;
    }
    @media (min-width: 860px){
      .grid{ grid-template-columns: 1fr 1fr; }
    }
    .card{
      border:1px solid #ddd;
      border-radius:12px;
      padding:16px;
      background:#fff;
    }
    .card h2{ margin:0 0 6px; font-size:1.15rem; }
    .small{ font-size:.95rem; color:#555; margin:0 0 10px; }

    .actions{ display:flex; gap:10px; flex-wrap:wrap; margin-top:12px; align-items:center; }
    .note{
      margin: 0 0 18px;
      padding: 12px;
      border-radius: 12px;
      border: 1px solid #ffe1a6;
      background: #fff9ee;
    }
    code{ background:#f4f4f4; padding:2px 6px; border-radius:6px; }
  </style>
</head>

<body>
<header>
  <h1>Start</h1>
  <p class="muted">R√∂d tr√•d: <strong>Tr√§d</strong> (f√∂rsta g√•ngen) ‚Üí <strong>Personer</strong> ‚Üí <strong>Relationer</strong> ‚Üí <strong>Karta</strong>.</p>

  <!-- Viktigt: alla l√§nkar g√•r till /app/... -->
  <nav class="topbar" aria-label="Navigation">
    <a class="btn secondary" href="./start.html">Start</a>
    <a class="btn secondary" href="./app/trees.html">Tr√§d</a>
    <a class="btn secondary" href="./app/slaktkort.html">Personer</a>
    <a class="btn secondary" href="./app/create-relation.html">Relationer</a>
    <a class="btn secondary" href="./app/map.html">Karta</a>
    <a class="btn secondary" href="./app/place-picker.html">Plats-picker</a>
    <button id="logoutBtn" class="btn secondary" type="button">Logga ut</button>
  </nav>
</header>

<section class="pillRow" aria-label="√ñversikt">
  <span id="pillTree" class="pill warn">Aktivt tr√§d: <strong>‚Äî</strong></span>
  <span id="pillPeople" class="pill">Personer: <strong>0</strong></span>
  <span id="pillRels" class="pill">Relationer: <strong>0</strong></span>
  <span id="pillMode" class="pill warn">L√§ge: <strong>F√∂rsta g√•ngen</strong></span>
</section>

<div id="noteBox" class="note" hidden></div>

<section class="grid" aria-label="Startfl√∂de">
  <article class="card">
    <h2 id="treeTitle">üå≥ Steg 1 ‚Äì Tr√§d</h2>
    <p class="small" id="treeText">F√∂rsta g√•ngen: skapa/v√§lj ett tr√§d s√• resten av sidorna vet var de ska spara.</p>
    <div class="actions">
      <a class="btn" href="./app/trees.html">√ñppna Tr√§d</a>
      <button class="btn secondary" id="refreshBtn" type="button">Uppdatera status</button>
    </div>
    <p class="small" id="treeLine">‚Äî</p>
  </article>

  <article class="card">
    <h2 id="peopleTitle">üë§ Steg 2 ‚Äì Personer</h2>
    <p class="small">Skapa minst tv√• personer. Draft i Personer-sidan g√∂r att f√§lt inte tappas n√§r du g√•r till karta.</p>
    <div class="actions">
      <a class="btn disabled" id="goPeople" href="./app/slaktkort.html" aria-disabled="true" tabindex="-1">√ñppna Personer</a>
    </div>
    <p class="small" id="peopleLine">‚Äî</p>
  </article>

  <article class="card">
    <!-- Patch: konsekvent default-rubrik (JS kommer √§nd√• √§ndra beroende p√• l√§ge) -->
    <h2 id="relsTitle">üîó Steg 3 ‚Äì Relationer</h2>
    <p class="small">Koppla f√∂r√§lder ‚Üí barn (max 2 f√∂r√§ldrar per barn).</p>
    <div class="actions">
      <a class="btn disabled" id="goRels" href="./app/create-relation.html" aria-disabled="true" tabindex="-1">√ñppna Relationer</a>
    </div>
    <p class="small" id="relsLine">‚Äî</p>
  </article>

  <article class="card">
    <h2 id="mapTitle">üó∫Ô∏è Steg 4 ‚Äì Karta</h2>
    <p class="small">Visa personer med koordinater i aktivt tr√§d.</p>
    <div class="actions">
      <a class="btn disabled" id="goMap" href="./app/map.html" aria-disabled="true" tabindex="-1">√ñppna Karta</a>
    </div>
    <p class="small" id="mapLine">‚Äî</p>
  </article>
</section>

<script>
  // Estetisk auth-guard (om du anv√§nder index.html som login)
  (function authGuard(){
    try{
      if(sessionStorage.getItem("demo_auth") !== "1"){
        window.location.href = "./index.html";
      }
    }catch{}
  })();

  const KEY_TREES  = "slakttradet_trees";
  const KEY_ACTIVE = "slakttradet_active_tree_id";
  const cardsKey = (treeId) => "slakttradet_slaktkort_" + String(treeId);
  const relKey   = (treeId) => "slakttradet_relationer_" + String(treeId);

  const pillTree = document.getElementById("pillTree");
  const pillPeople = document.getElementById("pillPeople");
  const pillRels = document.getElementById("pillRels");
  const pillMode = document.getElementById("pillMode");
  const noteBox = document.getElementById("noteBox");

  const treeTitle = document.getElementById("treeTitle");
  const treeText = document.getElementById("treeText");
  const treeLine = document.getElementById("treeLine");

  const peopleTitle = document.getElementById("peopleTitle");
  const peopleLine = document.getElementById("peopleLine");
  const relsTitle = document.getElementById("relsTitle");
  const relsLine = document.getElementById("relsLine");
  const mapTitle = document.getElementById("mapTitle");
  const mapLine = document.getElementById("mapLine");

  const goPeople = document.getElementById("goPeople");
  const goRels = document.getElementById("goRels");
  const goMap = document.getElementById("goMap");

  function safeParse(raw, fallback){ try{ return JSON.parse(raw); }catch{ return fallback; } }

  function hasLocalStorage(){
    try{
      const k = "__ls_test__";
      localStorage.setItem(k, "1");
      localStorage.removeItem(k);
      return true;
    }catch{
      return false;
    }
  }

  function loadJson(key, fallback){
    try{
      const raw = localStorage.getItem(key);
      return raw ? safeParse(raw, fallback) : fallback;
    }catch{
      return fallback;
    }
  }

  function setDisabled(el, disabled){
    if(disabled){
      el.classList.add("disabled");
      el.setAttribute("aria-disabled","true");
      el.setAttribute("tabindex","-1");
    }else{
      el.classList.remove("disabled");
      el.removeAttribute("aria-disabled");
      el.removeAttribute("tabindex");
    }
  }

  function activeTreeId(){
    try{ return localStorage.getItem(KEY_ACTIVE) || ""; }catch{ return ""; }
  }

  function activeTreeLabel(){
    const id = activeTreeId();
    if(!id) return "‚Äî";
    const trees = loadJson(KEY_TREES, []);
    const t = Array.isArray(trees) ? trees.find(x => String(x.id) === String(id)) : null;
    return t ? (t.name || t.id) : id;
  }

  function countPersons(treeId){
    const arr = loadJson(cardsKey(treeId), []);
    return Array.isArray(arr) ? arr.length : 0;
  }

  function countRelations(treeId){
    const arr = loadJson(relKey(treeId), []);
    return Array.isArray(arr) ? arr.length : 0;
  }

  function setNote(html){
    noteBox.hidden = false;
    noteBox.innerHTML = html;
  }

  function clearNote(){
    noteBox.hidden = true;
    noteBox.textContent = "";
  }

  function render(){
    if(!hasLocalStorage()){
      setNote("<strong>‚ö†Ô∏è localStorage √§r avst√§ngt:</strong> Sidan kan inte spara eller l√§sa data i denna webbl√§sarmilj√∂ (t.ex. privat l√§ge).");
      // L√•s allt som kr√§ver sparad data
      setDisabled(goPeople, true);
      setDisabled(goRels, true);
      setDisabled(goMap, true);
      return;
    }

    const trees = loadJson(KEY_TREES, []);
    const hasTrees = Array.isArray(trees) && trees.length > 0;

    const id = activeTreeId();
    const hasActive = !!id;

    const firstTime = (!hasTrees || !hasActive);

    const peopleCount = hasActive ? countPersons(id) : 0;
    const relsCount = hasActive ? countRelations(id) : 0;

    pillTree.className = "pill " + (hasActive ? "ok" : (hasTrees ? "warn" : "err"));
    pillTree.innerHTML = "Aktivt tr√§d: <strong>" + (hasActive ? activeTreeLabel() : "‚Äî") + "</strong>";

    pillPeople.innerHTML = "Personer: <strong>" + peopleCount + "</strong>";
    pillRels.innerHTML = "Relationer: <strong>" + relsCount + "</strong>";

    pillMode.className = "pill " + (firstTime ? "warn" : "ok");
    pillMode.innerHTML = "L√§ge: <strong>" + (firstTime ? "F√∂rsta g√•ngen" : "√Öterv√§ndare") + "</strong>";

    if(!hasTrees){
      setNote("<strong>üö© Inga tr√§d sparade:</strong> B√∂rja i <a href='./app/trees.html'><code>Tr√§d</code></a> och skapa ett tr√§d.");
    }else if(!hasActive){
      setNote("<strong>üö© Inget aktivt tr√§d:</strong> V√§lj ett tr√§d i <a href='./app/trees.html'><code>Tr√§d</code></a>.");
    }else if(peopleCount < 2){
      setNote("<strong>Tips:</strong> Skapa minst <strong>2 personer</strong> i <a href='./app/slaktkort.html'><code>Personer</code></a> innan relationer.");
    }else{
      clearNote();
    }

    treeTitle.textContent  = firstTime ? "üå≥ Steg 1 ‚Äì Tr√§d" : "üå≥ Tr√§d (kontext)";
    treeText.textContent   = firstTime
      ? "F√∂rsta g√•ngen: skapa/v√§lj ett tr√§d s√• resten av sidorna vet var de ska spara."
      : "Du har redan ett aktivt tr√§d. Byt tr√§d bara om du beh√∂ver.";

    peopleTitle.textContent = firstTime ? "üë§ Steg 2 ‚Äì Personer" : "üë§ Steg 1 ‚Äì Personer";
    relsTitle.textContent   = firstTime ? "üîó Steg 3 ‚Äì Relationer" : "üîó Steg 2 ‚Äì Relationer";
    mapTitle.textContent    = firstTime ? "üó∫Ô∏è Steg 4 ‚Äì Karta" : "üó∫Ô∏è Steg 3 ‚Äì Karta";

    // Enable/disable knappar
    setDisabled(goPeople, !hasActive);
    setDisabled(goRels, !(hasActive && peopleCount >= 2));

    // Karta: kr√§ver minst 1 person idag. (Senare kan du kr√§va koordinater.)
    setDisabled(goMap,  !(hasActive && peopleCount >= 1));

    treeLine.textContent = hasActive ? ("Aktivt: " + activeTreeLabel()) : "V√§lj ett aktivt tr√§d f√∂rst.";
    peopleLine.textContent = !hasActive ? "V√§lj tr√§d f√∂rst."
      : (peopleCount === 0 ? "Skapa f√∂rsta personen." : (peopleCount < 2 ? "Skapa minst en person till." : "Klart, du kan skapa relationer."));

    relsLine.textContent = !(hasActive && peopleCount >= 2) ? "Skapa minst 2 personer f√∂rst."
      : (relsCount === 0 ? "Skapa f√∂rsta relationen." : ("Du har " + relsCount + " relation(er)."));

    mapLine.textContent = !hasActive ? "V√§lj tr√§d f√∂rst." : "Kartan blir b√§ttre om personer har koordinater.";
  }

  document.getElementById("refreshBtn").addEventListener("click", render);
  document.getElementById("logoutBtn").addEventListener("click", () => {
    try{ sessionStorage.removeItem("demo_auth"); }catch{}
    window.location.href = "./index.html";
  });

  render();
</script>
</body>
</html>
