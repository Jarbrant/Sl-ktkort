<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Start ‚Äì Sl√§ktkort</title>
  <meta name="description" content="Startfl√∂de f√∂r Sl√§ktkort: v√§lj tr√§d (f√∂rsta g√•ngen) och forts√§tt med personer ‚Üí relationer ‚Üí karta." />

  <style>
    :root { color-scheme: light; }
    body{
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      line-height: 1.5;
      margin: 0;
      padding: 24px;
      max-width: 980px;
      margin-inline: auto;
      background: #fff;
      color: #111;
    }
    a{ color: inherit; text-decoration: none; }
    header{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 12px;
      margin-bottom: 18px;
    }
    h1{ margin: 0 0 6px; font-size: 1.6rem; }
    p{ margin: 0 0 12px; }
    .muted{ color:#555; }

    .topbar{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      margin: 10px 0 0;
    }
    .btn, button{
      display:inline-block;
      padding: 10px 12px;
      border: 1px solid #333;
      border-radius: 10px;
      background: #fff;
      font: inherit;
      cursor: pointer;
      text-decoration:none;
    }
    .btn.secondary{ border-color:#bbb; }
    .btn.danger{ border-color:#b00020; color:#b00020; }
    .btn.disabled{
      opacity:.45;
      cursor:not-allowed;
      pointer-events:none;
    }

    .pillRow{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      margin: 10px 0 18px;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 8px 10px;
      border: 1px solid #ddd;
      border-radius: 999px;
      background: #fafafa;
      font-size: .95rem;
    }
    .pill strong{ font-weight: 900; }
    .pill.ok{ border-color:#cfe8cf; background:#f5fff5; }
    .pill.warn{ border-color:#ffe1a6; background:#fff9ee; }
    .pill.err{ border-color:#ffb3b3; background:#fff2f2; }

    .grid{
      display:grid;
      gap: 14px;
      grid-template-columns: 1fr;
    }
    @media (min-width: 860px){
      .grid{ grid-template-columns: 1fr 1fr; }
    }
    .card{
      border: 1px solid #ddd;
      border-radius: 12px;
      padding: 16px;
      background: #fff;
    }
    .card h2{ margin: 0 0 6px; font-size: 1.15rem; }
    .small{ font-size:.95rem; color:#555; margin: 0 0 10px; }

    .note{
      margin: 0 0 18px;
      padding: 12px;
      border-radius: 12px;
      border: 1px solid #ffe1a6;
      background: #fff9ee;
    }
    .note strong{ font-weight: 900; }

    .stepTitle{
      display:flex;
      align-items:baseline;
      justify-content:space-between;
      gap: 10px;
      margin: 0 0 8px;
    }
    .stepTitle .kicker{
      font-weight: 900;
    }
    .statusLine{
      color:#555;
      font-size:.95rem;
      margin: 8px 0 0;
    }

    footer{ margin-top: 18px; color:#666; font-size:.95rem; }
    code{ background:#f4f4f4; padding:2px 6px; border-radius:6px; }
  </style>
</head>

<body>
<header>
  <div>
    <h1>Start</h1>
    <p class="muted">R√∂d tr√•d: <strong>Tr√§d</strong> (bara f√∂rsta g√•ngen) ‚Üí <strong>Personer</strong> ‚Üí <strong>Relationer</strong> ‚Üí <strong>Karta</strong>.</p>

    <nav class="topbar" aria-label="Navigation">
      <a class="btn secondary" href="start.html">Start</a>
      <a class="btn secondary" href="trees.html">Tr√§d</a>
      <a class="btn secondary" href="slaktkort.html">Personer</a>
      <a class="btn secondary" href="create-relation.html">Relationer</a>
      <a class="btn secondary" href="map.html">Karta</a>
    </nav>
  </div>

  <div class="pillRow" style="margin:0; justify-content:flex-end;">
    <button id="logoutBtn" class="btn secondary" type="button">Logga ut</button>
  </div>
</header>

<section class="pillRow" aria-label="√ñversikt">
  <span id="pillTree" class="pill warn">Aktivt tr√§d: <strong>‚Äî</strong></span>
  <span id="pillPeople" class="pill">Personer: <strong>0</strong></span>
  <span id="pillRels" class="pill">Relationer: <strong>0</strong></span>
  <span id="pillMode" class="pill warn">L√§ge: <strong>F√∂rsta g√•ngen</strong></span>
</section>

<div id="noteBox" class="note" hidden></div>

<section class="grid" aria-label="Startfl√∂de">
  <!-- BOX: Tr√§d (bara som steg f√∂rsta g√•ngen) -->
  <article class="card" id="treeStep">
    <div class="stepTitle">
      <div class="kicker" id="treeStepTitle">üå≥ Steg 1 ‚Äì Tr√§d</div>
      <span class="pill warn" id="treeStepPill">Kr√§vs</span>
    </div>
    <p class="small" id="treeStepText">
      F√∂rsta g√•ngen: skapa eller v√§lj ett sl√§kttr√§d s√• resten av sidorna vet var de ska spara.
    </p>
    <div style="display:flex; gap:10px; flex-wrap:wrap;">
      <a class="btn" href="trees.html">√ñppna Tr√§d</a>
      <button class="btn secondary" id="refreshBtn" type="button">Uppdatera status</button>
    </div>
    <p class="statusLine" id="treeLine">‚Äî</p>
  </article>

  <!-- BOX: Personer -->
  <article class="card" id="peopleStep">
    <div class="stepTitle">
      <div class="kicker" id="peopleStepTitle">üë§ Steg 2 ‚Äì Personer</div>
      <span class="pill warn" id="peopleStepPill">V√§ntar</span>
    </div>
    <p class="small" id="peopleStepText">
      Skapa minst tv√• personer. N√§r du har det kan du koppla relationer.
    </p>
    <div style="display:flex; gap:10px; flex-wrap:wrap;">
      <a class="btn disabled" id="goPeople" href="slaktkort.html" aria-disabled="true" tabindex="-1">√ñppna Personer</a>
    </div>
    <p class="statusLine" id="peopleLine">‚Äî</p>
  </article>

  <!-- BOX: Relationer -->
  <article class="card" id="relsStep">
    <div class="stepTitle">
      <div class="kicker" id="relsStepTitle">üîó Steg 3 ‚Äì Relationer</div>
      <span class="pill warn" id="relsStepPill">V√§ntar</span>
    </div>
    <p class="small" id="relsStepText">
      Koppla f√∂r√§lder ‚Üí barn (max 2 f√∂r√§ldrar per barn). Sen kan du se allt p√• kartan.
    </p>
    <div style="display:flex; gap:10px; flex-wrap:wrap;">
      <a class="btn disabled" id="goRels" href="create-relation.html" aria-disabled="true" tabindex="-1">√ñppna Relationer</a>
    </div>
    <p class="statusLine" id="relsLine">‚Äî</p>
  </article>

  <!-- BOX: Karta -->
  <article class="card" id="mapStep" style="grid-column: 1 / -1;">
    <div class="stepTitle">
      <div class="kicker" id="mapStepTitle">üó∫Ô∏è Steg 4 ‚Äì Karta</div>
      <span class="pill warn" id="mapStepPill">V√§ntar</span>
    </div>
    <p class="small" id="mapStepText">
      Visa sl√§kten geografiskt (om personer har plats/koordinater).
    </p>
    <div style="display:flex; gap:10px; flex-wrap:wrap;">
      <a class="btn disabled" id="goMap" href="map.html" aria-disabled="true" tabindex="-1">√ñppna Karta</a>
    </div>
    <p class="statusLine" id="mapLine">‚Äî</p>
  </article>
</section>

<footer>
  Allt sparas lokalt i <code>localStorage</code>. Inloggningen √§r estetisk (GitHub Pages).
</footer>

<script>
  // ===== Estetisk auth-guard =====
  (function authGuard(){
    try{
      if(sessionStorage.getItem("demo_auth") !== "1"){
        window.location.href = "index.html";
      }
    }catch{}
  })();

  const KEY_TREES  = "slakttradet_trees";
  const KEY_ACTIVE = "slakttradet_active_tree_id";
  function cardsKey(treeId){ return "slakttradet_slaktkort_" + String(treeId); }
  function relKey(treeId){ return "slakttradet_relationer_" + String(treeId); }

  const logoutBtn = document.getElementById("logoutBtn");
  const refreshBtn = document.getElementById("refreshBtn");

  const pillTree = document.getElementById("pillTree");
  const pillPeople = document.getElementById("pillPeople");
  const pillRels = document.getElementById("pillRels");
  const pillMode = document.getElementById("pillMode");
  const noteBox = document.getElementById("noteBox");

  const treeStep = document.getElementById("treeStep");
  const treeStepTitle = document.getElementById("treeStepTitle");
  const treeStepPill = document.getElementById("treeStepPill");
  const treeLine = document.getElementById("treeLine");

  const peopleStepTitle = document.getElementById("peopleStepTitle");
  const peopleStepPill = document.getElementById("peopleStepPill");
  const peopleLine = document.getElementById("peopleLine");
  const goPeople = document.getElementById("goPeople");

  const relsStepTitle = document.getElementById("relsStepTitle");
  const relsStepPill = document.getElementById("relsStepPill");
  const relsLine = document.getElementById("relsLine");
  const goRels = document.getElementById("goRels");

  const mapStepPill = document.getElementById("mapStepPill");
  const mapLine = document.getElementById("mapLine");
  const goMap = document.getElementById("goMap");

  function safeParse(raw, fallback){
    try{ return JSON.parse(raw); }catch{ return fallback; }
  }
  function loadJson(key, fallback){
    const raw = localStorage.getItem(key);
    return raw ? safeParse(raw, fallback) : fallback;
  }
  function setDisabled(el, disabled){
    if(disabled){
      el.classList.add("disabled");
      el.setAttribute("aria-disabled","true");
      el.setAttribute("tabindex","-1");
    }else{
      el.classList.remove("disabled");
      el.removeAttribute("aria-disabled");
      el.removeAttribute("tabindex");
    }
  }
  function setPill(el, kind, text){
    el.className = "pill " + (kind || "");
    el.innerHTML = text;
  }
  function activeTreeId(){
    return localStorage.getItem(KEY_ACTIVE) || "";
  }
  function activeTreeLabel(){
    const id = activeTreeId();
    if(!id) return "‚Äî";
    const trees = loadJson(KEY_TREES, []);
    const t = Array.isArray(trees) ? trees.find(x => String(x.id) === String(id)) : null;
    return t ? (t.name || t.id) : id;
  }
  function countPersons(treeId){
    if(!treeId) return 0;
    const arr = loadJson(cardsKey(treeId), []);
    return Array.isArray(arr) ? arr.length : 0;
  }
  function countRelations(treeId){
    if(!treeId) return 0;
    const arr = loadJson(relKey(treeId), []);
    return Array.isArray(arr) ? arr.length : 0;
  }

  function render(){
    const trees = loadJson(KEY_TREES, []);
    const hasTrees = Array.isArray(trees) && trees.length > 0;

    const id = activeTreeId();
    const hasActive = !!id;
    const treeName = activeTreeLabel();

    const peopleCount = hasActive ? countPersons(id) : 0;
    const relsCount = hasActive ? countRelations(id) : 0;

    // Global pills
    setPill(pillTree, hasActive ? "ok" : (hasTrees ? "warn" : "err"), 'Aktivt tr√§d: <strong>' + (hasActive ? treeName : "‚Äî") + '</strong>');
    pillPeople.innerHTML = 'Personer: <strong>' + peopleCount + '</strong>';
    pillRels.innerHTML = 'Relationer: <strong>' + relsCount + '</strong>';

    // Mode:
    // - "F√∂rsta g√•ngen" om inga tr√§d eller inget aktivt tr√§d
    // - "√Öterv√§ndare" om aktivt tr√§d finns
    const firstTime = (!hasTrees || !hasActive);
    setPill(pillMode, firstTime ? "warn" : "ok", 'L√§ge: <strong>' + (firstTime ? "F√∂rsta g√•ngen" : "√Öterv√§ndare") + '</strong>');

    // Note
    if(!hasTrees){
      noteBox.hidden = false;
      noteBox.innerHTML = "<strong>üö© Inga tr√§d sparade:</strong> B√∂rja med att skapa ett tr√§d i <a href='trees.html'>Tr√§d</a>.";
    }else if(!hasActive){
      noteBox.hidden = false;
      noteBox.innerHTML = "<strong>üö© Inget aktivt tr√§d valt:</strong> V√§lj ett tr√§d i <a href='trees.html'>Tr√§d</a>.";
    }else if(peopleCount < 2){
      noteBox.hidden = false;
      noteBox.innerHTML = "<strong>Tip:</strong> L√§gg till minst <strong>2 personer</strong> i <a href='slaktkort.html'>Personer</a> innan du skapar relationer.";
    }else{
      noteBox.hidden = true;
    }

    // Tree step behaviour:
    // First time: show as Step 1
    // Returning: show as "Kontext/byt tr√§d" (not a step)
    if(firstTime){
      treeStepTitle.textContent = "üå≥ Steg 1 ‚Äì Tr√§d";
      setPill(treeStepPill, "warn", "Kr√§vs");
      treeLine.textContent = hasTrees
        ? "Du har tr√§d sparade men inget aktivt valt √§nnu."
        : "Du har inga tr√§d sparade √§nnu.";
      treeStep.style.opacity = "1";
    }else{
      treeStepTitle.textContent = "üå≥ Tr√§d (kontext)";
      setPill(treeStepPill, "ok", "Klart");
      treeLine.textContent = "Aktivt: " + treeName + " ‚Ä¢ Byt tr√§d vid behov.";
      treeStep.style.opacity = "1";
    }

    // Steps renumbering (presentation)
    // If returning: People should be Step 1
    peopleStepTitle.textContent = firstTime ? "üë§ Steg 2 ‚Äì Personer" : "üë§ Steg 1 ‚Äì Personer";
    relsStepTitle.textContent   = firstTime ? "üîó Steg 3 ‚Äì Relationer" : "üîó Steg 2 ‚Äì Relationer";

    // Enable People
    setDisabled(goPeople, !hasActive);

    if(!hasActive){
      setPill(peopleStepPill, "warn", "V√§ntar");
      peopleLine.textContent = "V√§lj aktivt tr√§d f√∂rst.";
    }else if(peopleCount === 0){
      setPill(peopleStepPill, "warn", "Starta");
      peopleLine.textContent = "Skapa f√∂rsta personen.";
    }else if(peopleCount < 2){
      setPill(peopleStepPill, "warn", "P√•g√•r");
      peopleLine.textContent = "Du har " + peopleCount + " person(er). Skapa minst en till.";
    }else{
      setPill(peopleStepPill, "ok", "Klart");
      peopleLine.textContent = "Du har minst 2 personer. Du kan skapa relationer.";
    }

    // Enable Relations if >=2 persons
    const canRels = hasActive && peopleCount >= 2;
    setDisabled(goRels, !canRels);

    if(!hasActive){
      setPill(relsStepPill, "warn", "V√§ntar");
      relsLine.textContent = "V√§lj aktivt tr√§d f√∂rst.";
    }else if(!canRels){
      setPill(relsStepPill, "warn", "V√§ntar");
      relsLine.textContent = "Skapa minst 2 personer f√∂rst.";
    }else if(relsCount === 0){
      setPill(relsStepPill, "warn", "Starta");
      relsLine.textContent = "Skapa din f√∂rsta relation.";
    }else{
      setPill(relsStepPill, "ok", "Klart");
      relsLine.textContent = "Du har " + relsCount + " relation(er).";
    }

    // Map: enable if at least 1 person (or you can require relations; I require at least 1 person)
    const canMap = hasActive && peopleCount >= 1;
    setDisabled(goMap, !canMap);

    if(!hasActive){
      setPill(mapStepPill, "warn", "V√§ntar");
      mapLine.textContent = "V√§lj aktivt tr√§d f√∂rst.";
    }else if(!canMap){
      setPill(mapStepPill, "warn", "V√§ntar");
      mapLine.textContent = "Skapa minst 1 person f√∂rst.";
    }else{
      setPill(mapStepPill, relsCount > 0 ? "ok" : "warn", relsCount > 0 ? "Redo" : "Redo");
      mapLine.textContent = "Kartan blir b√§ttre om personer har plats/koordinater.";
    }
  }

  refreshBtn.addEventListener("click", render);
  logoutBtn.addEventListener("click", () => {
    try{ sessionStorage.removeItem("demo_auth"); }catch{}
    window.location.href = "index.html";
  });

  render();
</script>
</body>
</html>
