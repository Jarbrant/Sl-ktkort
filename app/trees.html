<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tr√§d ‚Äì Skapa & v√§lj</title>
  <meta name="description" content="Skapa och v√§lj aktivt sl√§kttr√§d (localStorage)." />

  <style>
    :root{
      color-scheme: light;

      /* Samma typ av lugna toner som din start.html (varm/gr√• + mild gr√∂n) */
      --bg: #ffffff;
      --text: #111111;
      --muted: #555555;

      --border: #eaeaea;
      --card: #ffffff;
      --shadow: 0 8px 28px rgba(0,0,0,.05);

      --pill-bg: #fafafa;
      --pill-border: #e6e6e6;

      --warn-bg: #fff9ee;
      --warn-border: #ffe1a6;

      --ok-bg: #f5fff5;
      --ok-border: #cfe8cf;

      /* Ljusgr√∂n markering (d√§mpad) */
      --active-text: #1f7a3f;
      --active-bg: #f3fbf5;
      --active-border: #cfe8cf;

      --focus: rgba(0,0,0,.18);
    }

    body{
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      line-height: 1.5;
      margin: 0;
      padding: 24px;
      max-width: 980px;
      margin-inline: auto;
      background: var(--bg);
      color: var(--text);
    }

    a{ color: inherit; text-decoration: none; }

    header{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 12px;
      margin-bottom: 18px;
    }

    h1{ margin: 0 0 6px; font-size: 1.6rem; letter-spacing:-0.01em; }
    p{ margin: 0 0 12px; }
    .muted{ color: var(--muted); }

    .topbar{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      margin: 10px 0 0;
    }

    .btn, button{
      display:inline-block;
      padding: 10px 12px;
      border: 1px solid #bbb;
      border-radius: 12px;
      background: #fff;
      font: inherit;
      cursor: pointer;
      text-decoration:none;
    }
    .btn.secondary{
      border-color:#bbb;
      color: var(--text);
    }
    .btn:focus-visible, button:focus-visible, a:focus-visible{
      outline: 3px solid var(--focus);
      outline-offset: 2px;
      border-radius: 12px;
    }

    .pillRow{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      margin: 10px 0 18px;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 8px 10px;
      border: 1px solid var(--pill-border);
      border-radius: 999px;
      background: var(--pill-bg);
      font-size: .95rem;
      white-space: nowrap;
    }
    .pill strong{ font-weight: 900; }
    .pill.ok{ border-color: var(--ok-border); background: var(--ok-bg); }
    .pill.warn{ border-color: var(--warn-border); background: var(--warn-bg); }

    .note{
      margin: 0 0 18px;
      padding: 12px 14px;
      border-radius: 14px;
      border: 1px solid var(--warn-border);
      background: var(--warn-bg);
    }
    .note strong{ font-weight: 900; }

    .grid{
      display:grid;
      gap: 14px;
      grid-template-columns: 1fr;
    }
    @media (min-width: 860px){
      .grid{ grid-template-columns: 1fr 1fr; }
    }

    .card{
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 16px;
      background: var(--card);
      box-shadow: var(--shadow);
    }
    .card h2{
      margin: 0 0 6px;
      font-size: 1.15rem;
      letter-spacing:-0.01em;
    }
    .small{ font-size: .95rem; color: var(--muted); margin: 0 0 10px; }

    label{ display:block; margin: 10px 0 6px; font-weight: 800; }
    input{
      width: 100%;
      box-sizing: border-box;
      padding: 10px;
      border-radius: 12px;
      border: 1px solid #bbb;
      font: inherit;
      background: #fff;
    }

    .row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      margin-top: 10px;
    }
    .row > *{ flex: 1; min-width: 160px; }

    .msg{ margin: 10px 0 0; color: var(--muted); }
    .msg strong{ color: var(--text); }

    /* ---------- Tr√§dlista (kryssruta + ljusgr√∂n aktiv markering) ---------- */
    .treeList{
      margin: 10px 0 0;
      padding: 0;
      list-style: none;
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    .treeRow{
      display:flex;
      gap:12px;
      align-items:center;
      padding: 12px 12px;
      border: 1px solid var(--border);
      border-radius: 16px;
      background: #fff;
      cursor:pointer;
      transition: background .12s ease, transform .12s ease;
    }
    .treeRow:hover{
      background:#fcfcfc;
      transform: translateY(-1px);
    }
    .treeRow.active{
      border-color: var(--active-border);
      background: var(--active-bg);
    }

    /* Visuell "kryssruta" (men radio-beteende) */
    .check{
      width: 20px;
      height: 20px;
      border-radius: 6px;
      border: 1px solid #bbb;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      flex: 0 0 auto;
      background:#fff;
      color: transparent;
      font-weight: 900;
      line-height: 1;
    }
    .treeRow.active .check{
      border-color: var(--active-border);
      background: #fff;
      color: var(--active-text);
    }

    .treeMain{ min-width:0; flex:1; }
    .treeName{
      margin:0;
      font-weight: 950;
      letter-spacing:-0.01em;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .treeRow.active .treeName{ color: var(--active-text); }

    .treeMeta{
      margin: 2px 0 0;
      color: var(--muted);
      font-size: .95rem;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }

    .emptyBox{
      border: 1px dashed var(--border);
      border-radius: 16px;
      padding: 12px;
      color: var(--muted);
      background: #fff;
    }

    .continueWrap{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      margin-top: 12px;
    }
    .btn.disabled{
      opacity: .45;
      cursor: not-allowed;
      pointer-events: none;
    }

    code{ background:#f4f4f4; padding: 2px 6px; border-radius: 8px; }

    footer{
      margin-top: 18px;
      color:#666;
      font-size: .95rem;
    }
  </style>
</head>

<body>
<header>
  <div>
    <h1>üå≥ Tr√§d</h1>
    <p class="muted">
      GitHub Pages-l√§ge: allt sparas lokalt i <code>localStorage</code>. V√§lj ett tr√§d som resten av sidorna anv√§nder.
    </p>

    <nav class="topbar" aria-label="Navigation">
      <a class="btn secondary" href="../start.html">Start</a>
      <a class="btn secondary" href="./trees.html" aria-current="page">Tr√§d</a>
      <a class="btn secondary" href="./slaktkort.html">Personer</a>
      <a class="btn secondary" href="./create-relation.html">Relationer</a>
      <a class="btn secondary" href="./map.html">Karta</a>
    </nav>
  </div>

  <div class="row" style="justify-content:flex-end; max-width: 320px;">
    <button id="logoutBtn" class="btn secondary" type="button">Logga ut</button>
  </div>
</header>

<section class="pillRow" aria-label="Status">
  <span id="pillTree" class="pill warn">Valt tr√§d: <strong>‚Äî</strong></span>
  <span id="pillTrees" class="pill">Tr√§d sparade: <strong>0</strong></span>
</section>

<div id="noteBox" class="note" hidden></div>

<section class="grid" aria-label="Tr√§dfunktioner">
  <article class="card">
    <h2>Skapa nytt tr√§d</h2>
    <p class="small">Skapar ett nytt tr√§d och markerar det direkt som valt.</p>

    <label for="treeName">Namn p√• tr√§d</label>
    <input id="treeName" placeholder="t.ex. Anderssons sl√§kt" />

    <div class="row">
      <button id="createBtn" type="button" class="btn">Skapa tr√§d</button>
    </div>

    <p class="msg" id="createMsg" aria-live="polite"></p>
  </article>

  <article class="card">
    <h2>V√§lj tr√§d</h2>
    <p class="small">Kryssa i ett tr√§d f√∂r att arbeta i det.</p>

    <div id="listWrap">
      <div class="emptyBox" id="emptyBox" hidden>
        Inga tr√§d sparade √§nnu. Skapa ett tr√§d f√∂rst.
      </div>
      <ul id="treeList" class="treeList" aria-label="Tr√§dlista"></ul>
    </div>

    <div class="continueWrap">
      <a id="continueBtn" class="btn disabled" href="./slaktkort.html" aria-disabled="true" tabindex="-1">Forts√§tt ‚Üí Personer</a>
    </div>

    <p class="msg" id="selectMsg" aria-live="polite"></p>
  </article>
</section>

<footer class="muted">
  Tips: N√§r ett tr√§d √§r markerat (ljusgr√∂nt) √§r du klar och kan g√• vidare till Personer.
</footer>

<script>
  // ============================
  // DEMO AUTH-GUARD
  // ============================
  (function authGuard(){
    try{
      if(sessionStorage.getItem("demo_auth") !== "1"){
        window.location.href = "../index.html";
      }
    }catch{}
  })();

  // ============================
  // LocalStorage keys
  // ============================
  const KEY_TREES  = "slakttradet_trees";
  const KEY_ACTIVE = "slakttradet_active_tree_id";

  // DOM
  const pillTree  = document.getElementById("pillTree");
  const pillTrees = document.getElementById("pillTrees");
  const noteBox   = document.getElementById("noteBox");

  const treeName  = document.getElementById("treeName");
  const createBtn = document.getElementById("createBtn");
  const createMsg = document.getElementById("createMsg");

  const treeList  = document.getElementById("treeList");
  const emptyBox  = document.getElementById("emptyBox");

  const continueBtn = document.getElementById("continueBtn");
  const selectMsg   = document.getElementById("selectMsg");

  const logoutBtn = document.getElementById("logoutBtn");

  function safeParse(raw, fallback){
    try { return JSON.parse(raw); } catch { return fallback; }
  }

  function loadTrees(){
    const raw = localStorage.getItem(KEY_TREES);
    const trees = safeParse(raw, []);
    return Array.isArray(trees) ? trees : [];
  }

  function saveTrees(trees){
    localStorage.setItem(KEY_TREES, JSON.stringify(trees));
  }

  function getActiveTreeId(){
    return localStorage.getItem(KEY_ACTIVE) || "";
  }

  function setActiveTreeId(id){
    localStorage.setItem(KEY_ACTIVE, String(id || ""));
  }

  function makeId(){
    return "t" + Date.now().toString(36) + Math.random().toString(36).slice(2, 6);
  }

  function setDisabled(el, disabled){
    if(disabled){
      el.classList.add("disabled");
      el.setAttribute("aria-disabled","true");
      el.setAttribute("tabindex","-1");
    }else{
      el.classList.remove("disabled");
      el.removeAttribute("aria-disabled");
      el.removeAttribute("tabindex");
    }
  }

  function esc(s){
    return String(s || "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function updateStatus(){
    const trees = loadTrees();
    const activeId = getActiveTreeId();
    const active = trees.find(t => String(t.id) === String(activeId));

    pillTrees.innerHTML = 'Tr√§d sparade: <strong>' + trees.length + '</strong>';

    if(!trees.length){
      pillTree.className = "pill warn";
      pillTree.innerHTML = 'Valt tr√§d: <strong>‚Äî</strong>';
      noteBox.hidden = false;
      noteBox.innerHTML = '<strong>üö© Inga tr√§d sparade:</strong> Skapa ett tr√§d f√∂r att b√∂rja.';
      setDisabled(continueBtn, true);
      return;
    }

    if(!active){
      pillTree.className = "pill warn";
      pillTree.innerHTML = 'Valt tr√§d: <strong>‚Äî</strong>';
      noteBox.hidden = false;
      noteBox.innerHTML = '<strong>üö© V√§lj ett tr√§d:</strong> Kryssa i ett tr√§d i listan.';
      setDisabled(continueBtn, true);
      return;
    }

    pillTree.className = "pill ok";
    pillTree.innerHTML = 'Valt tr√§d: <strong>' + esc(active.name || active.id) + '</strong>';
    noteBox.hidden = true;
    setDisabled(continueBtn, false);
  }

  function renderList(){
    const trees = loadTrees();
    const activeId = getActiveTreeId();

    treeList.innerHTML = "";

    if(!trees.length){
      emptyBox.hidden = false;
      return;
    }
    emptyBox.hidden = true;

    for(const t of trees){
      const id = String(t.id);
      const isActive = id === String(activeId);

      const li = document.createElement("li");

      const row = document.createElement("button");
      row.type = "button";
      row.className = "treeRow" + (isActive ? " active" : "");
      row.setAttribute("aria-pressed", isActive ? "true" : "false");
      row.setAttribute("data-id", id);

      row.innerHTML =
        "<span class='check' aria-hidden='true'>" + (isActive ? "‚úì" : "") + "</span>" +
        "<span class='treeMain'>" +
          "<p class='treeName'>" + esc(t.name || ("Tr√§d " + t.id)) + "</p>" +
          "<p class='treeMeta'>Kryssa i f√∂r att v√§lja</p>" +
        "</span>";

      row.addEventListener("click", () => {
        createMsg.textContent = "";
        selectMsg.textContent = "";

        setActiveTreeId(id);
        selectMsg.innerHTML = "<strong>Valt:</strong> Tr√§det √§r nu markerat.";

        renderList();
        updateStatus();
      });

      li.appendChild(row);
      treeList.appendChild(li);
    }
  }

  // ============================
  // Actions
  // ============================
  createBtn.addEventListener("click", () => {
    createMsg.textContent = "";
    selectMsg.textContent = "";

    const name = String(treeName.value || "").trim();
    if(!name){
      createMsg.textContent = "Skriv ett namn f√∂rst.";
      return;
    }

    const trees = loadTrees();
    const id = makeId();

    trees.push({ id, name, createdAt: new Date().toISOString() });
    saveTrees(trees);
    setActiveTreeId(id);

    treeName.value = "";
    createMsg.innerHTML = "<strong>Klart:</strong> Tr√§d skapat och markerat.";

    renderList();
    updateStatus();
  });

  logoutBtn.addEventListener("click", () => {
    try{ sessionStorage.removeItem("demo_auth"); }catch{}
    window.location.href = "../index.html";
  });

  // ============================
  // Start
  // ============================
  renderList();
  updateStatus();
</script>
</body>
</html>
