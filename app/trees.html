<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Träd – Släktkort</title>
  <meta name="description" content="Skapa och välj aktivt träd." />

  <style>
    :root { color-scheme: light; }
    body{
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      line-height: 1.5;
      margin: 0;
      padding: 24px;
      max-width: 1180px;
      margin-inline: auto;
      background: #fff;
      color: #111;
    }
    a{ color: inherit; text-decoration:none; }

    header{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      margin-bottom:18px;
    }
    h1{ margin:0 0 6px; font-size:1.6rem; }
    .muted{ color:#555; margin:0 0 12px; }

    .topbar{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      margin: 10px 0 0;
    }

    .btn, button{
      display:inline-block;
      padding:10px 12px;
      border:1px solid #333;
      border-radius:10px;
      background:#fff;
      font:inherit;
      cursor:pointer;
      text-decoration:none;
      user-select:none;
    }
    .btn.secondary{ border-color:#bbb; }
    .btn:disabled{ opacity:.55; cursor:not-allowed; }

    /* Aktiv nav (ljusgrön) */
    .btn.navActive{
      border-color:#cfe8cf;
      background:#f5fff5;
      color:#111;
    }

    .pillRow{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      margin: 10px 0 18px;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border:1px solid #ddd;
      border-radius:999px;
      background:#fafafa;
      font-size:.95rem;
    }
    .pill strong{ font-weight:900; }
    .pill.ok{ border-color:#cfe8cf; background:#f5fff5; }
    .pill.warn{ border-color:#ffe1a6; background:#fff9ee; }
    .pill.err{ border-color:#ffb3b3; background:#fff2f2; }

    .grid{
      display:grid;
      gap:14px;
      grid-template-columns: 1fr;
    }
    @media (min-width: 1080px){
      .grid{ grid-template-columns: 420px 1fr; }
    }

    .card{
      border:1px solid #ddd;
      border-radius:12px;
      padding:16px;
      background:#fff;
    }
    .card h2{ margin:0 0 6px; font-size:1.15rem; }
    .small{ font-size:.95rem; color:#555; margin:0 0 10px; }

    label{ display:block; margin:10px 0 6px; font-weight:800; }
    input{
      width:100%;
      box-sizing:border-box;
      padding:10px;
      border-radius:10px;
      border:1px solid #bbb;
      font:inherit;
      background:#fff;
    }

    .actions{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      margin-top: 12px;
    }

    .list{
      margin: 10px 0 0;
      padding: 0;
      list-style:none;
      display:flex;
      flex-direction:column;
      gap:10px;
      max-height: 560px;
      overflow:auto;
      border-top: 1px solid #eee;
      padding-top: 10px;
    }
    .item{
      border:1px solid #eee;
      border-radius:12px;
      padding:10px;
      background:#fff;
      cursor:pointer;
    }
    .item:hover{ background:#fafafa; }

    .item.active{
      border-color:#7fcf9b;
      box-shadow: 0 0 0 4px rgba(183,228,199,.35);
    }

    .itemTitle{
      font-weight:900;
      margin:0 0 2px;
      display:flex;
      align-items:center;
      gap:8px;
      flex-wrap:wrap;
    }
    .badge{
      font-size:.85rem;
      border:1px solid #ddd;
      padding:2px 8px;
      border-radius:999px;
      background:#fafafa;
    }
    .badge.ok{
      border-color:#cfe8cf;
      background:#f5fff5;
    }
    .itemSub{ margin:4px 0 0; color:#333; font-size:.95rem; }

    .hintBox{
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid #ffe1a6;
      background: #fff9ee;
    }

    details.tech{
      margin-top: 14px;
      border-radius: 12px;
      border: 1px solid #eee;
      background: #fafafa;
      padding: 10px 12px;
    }
    details.tech > summary{
      cursor:pointer;
      font-weight:900;
      list-style:none;
    }
    details.tech > summary::-webkit-details-marker{ display:none; }

    code{ background:#f4f4f4; padding:2px 6px; border-radius:6px; }
  </style>
</head>

<body>
<header>
  <div>
    <h1>Träd</h1>
    <p class="muted">Här skapar och väljer du vilket släktträd du arbetar i.</p>

    <nav class="topbar" aria-label="Navigation">
      <a class="btn secondary" href="../start.html">Start</a>
      <a class="btn navActive" href="./trees.html" aria-current="page">Träd</a>
      <a class="btn secondary" href="./slaktkort.html">Personer</a>
      <a class="btn secondary" href="./create-relation.html">Relationer</a>
      <a class="btn secondary" href="./map.html">Karta</a>
    </nav>
  </div>

  <div class="actions" style="justify-content:flex-end;">
    <button id="logoutBtn" class="btn secondary" type="button">Logga ut</button>
  </div>
</header>

<section class="pillRow" aria-label="Status">
  <span id="pillActive" class="pill warn">Aktivt träd: <strong>—</strong></span>
  <span id="pillTrees" class="pill">Träd: <strong>0</strong></span>
</section>

<div class="grid">
  <section class="card" aria-label="Trädlista">
    <h2>Mina träd</h2>
    <p class="small">Klicka på ett träd för att välja det som aktivt.</p>

    <div id="leftHint" class="hintBox" hidden></div>
    <ul id="list" class="list" aria-label="Träd"></ul>

    <div class="actions" style="margin-top:14px;">
      <button id="reloadBtn" type="button" class="btn secondary">Uppdatera lista</button>
    </div>
  </section>

  <section class="card" aria-label="Skapa träd">
    <h2>Skapa träd</h2>
    <p class="small">Skriv ett namn och skapa ett nytt släktträd.</p>

    <label for="name">Namn</label>
    <input id="name" placeholder="t.ex. Släkten Nilsson" autocomplete="off" />

    <div class="actions">
      <button id="createBtn" type="button" class="btn">Skapa träd</button>
      <button id="clearBtn" type="button" class="btn secondary">Rensa</button>
    </div>

    <div id="statusBox" class="pill ok" hidden></div>

    <details class="tech">
      <summary>Visa tekniskt</summary>
      <div class="small" style="margin-top:8px;">
        Träd: <code>slakttradet_trees</code><br/>
        Aktivt träd: <code>slakttradet_active_tree_id</code>
      </div>
    </details>
  </section>
</div>

<script>
"use strict";

(function authGuard(){
  try{
    if(sessionStorage.getItem("demo_auth") !== "1"){
      window.location.href = "../index.html";
    }
  }catch{}
})();

const KEY_TREES  = "slakttradet_trees";
const KEY_ACTIVE = "slakttradet_active_tree_id";

const listEl = document.getElementById("list");
const pillActive = document.getElementById("pillActive");
const pillTrees = document.getElementById("pillTrees");
const leftHint = document.getElementById("leftHint");
const nameEl = document.getElementById("name");
const statusBox = document.getElementById("statusBox");

function load(key,f){ try{ return JSON.parse(localStorage.getItem(key)) ?? f; }catch{ return f; } }
function save(key,v){ localStorage.setItem(key,JSON.stringify(v)); }
function id(){ return "t_"+Date.now().toString(36); }

function active(){ return localStorage.getItem(KEY_ACTIVE)||""; }
function setActive(id){ id?localStorage.setItem(KEY_ACTIVE,id):localStorage.removeItem(KEY_ACTIVE); }

let trees=[];

function refresh(){
  trees = load(KEY_TREES,[]);
  const act = active();

  if(act && !trees.some(t=>t.id===act)){
    setActive(trees[0]?.id||"");
  }

  pillTrees.innerHTML = "Träd: <strong>"+trees.length+"</strong>";
  pillActive.className="pill "+(active()?"ok":"warn");
  pillActive.innerHTML="Aktivt träd: <strong>"+(trees.find(t=>t.id===active())?.name||"—")+"</strong>";

  listEl.innerHTML="";
  if(!trees.length){
    leftHint.hidden=false;
    leftHint.innerHTML="<strong>Inga träd ännu.</strong> Skapa ett till höger.";
    return;
  }
  leftHint.hidden=true;

  for(const t of trees){
    const li=document.createElement("li");
    li.className="item"+(t.id===active()?" active":"");
    li.innerHTML="<p class='itemTitle'>"+t.name+(t.id===active()?" <span class='badge ok'>Aktivt</span>":"")+"</p><p class='itemSub'>Klicka för att välja</p>";
    li.onclick=()=>{ setActive(t.id); refresh(); };
    listEl.appendChild(li);
  }
}

document.getElementById("createBtn").onclick=()=>{
  const n=nameEl.value.trim(); if(!n) return;
  const t={id:id(),name:n};
  trees.unshift(t); save(KEY_TREES,trees); setActive(t.id);
  nameEl.value="";
  statusBox.hidden=false; statusBox.textContent="Trädet är skapat och valt.";
  setTimeout(()=>statusBox.hidden=true,1500);
  refresh();
};

document.getElementById("reloadBtn").onclick=refresh;
document.getElementById("clearBtn").onclick=()=>nameEl.value="";
document.getElementById("logoutBtn").onclick=()=>{
  sessionStorage.removeItem("demo_auth");
  window.location.href="../index.html";
};

refresh();
</script>
</body>
</html>
