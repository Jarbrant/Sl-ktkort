<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sl√§kttr√§d ‚Äì Skapa & v√§lj</title>

  <style>
    body {
      font-family: system-ui, Arial, sans-serif;
      margin: 0;
      padding: 32px 20px;
      background: #fafafa;
      color: #111;
    }
    .container { max-width: 900px; margin: 0 auto; }
    a { color: inherit; text-decoration: none; }
    .topnav { display:flex; gap:12px; flex-wrap: wrap; align-items:center; margin-bottom: 16px; }
    .topnav a {
      display:inline-block;
      border:1px solid #333;
      border-radius: 10px;
      padding: 10px 14px;
      background:#fff;
      font-weight: 600;
    }
    .topnav a:hover { background:#f0f0f0; }

    h1 { margin: 0 0 6px; font-size: 1.5rem; }
    .muted { color:#555; margin: 0 0 18px; }

    .grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap:16px; }
    .card {
      background:#fff;
      border:1px solid #ddd;
      border-radius:14px;
      padding:18px;
    }
    .card h2 { margin: 0 0 10px; font-size: 1.1rem; }
    label { display:block; font-weight:700; margin-top: 10px; }
    input, select, button {
      width:100%;
      padding: 10px;
      margin-top: 6px;
      font-size: 1rem;
      box-sizing: border-box;
    }
    button {
      border:1px solid #333;
      background:#fff;
      cursor:pointer;
      border-radius: 10px;
      font-weight: 700;
    }
    button:hover { background:#f0f0f0; }
    button.danger { border-color:#b00020; color:#b00020; }
    button.danger:hover { background:#fff0f0; }

    .status {
      border-radius: 14px;
      padding: 14px 16px;
      border:1px solid #ddd;
      background:#fff;
      margin: 14px 0 18px;
    }
    .status.ok { border-color: #1b5e20; }
    .status.err { border-color: #b00020; }
    .statusTitle { font-weight: 900; margin: 0 0 6px; }
    .statusText { margin: 0; color:#333; }

    .row { display:flex; gap:10px; flex-wrap: wrap; align-items:center; }
    .row > * { flex: 1; min-width: 160px; }
    .small { font-size: 0.95rem; color:#555; }
    code { background:#eee; padding:2px 6px; border-radius:6px; }
    pre { background:#f4f4f4; padding:12px; border-radius:12px; overflow:auto; }
  </style>
</head>

<body>
  <div class="container">
    <div class="topnav">
      <!-- docs-root: index ligger i samma mapp -->
      <a href="./index.html">‚Üê Tillbaka</a>
      <a href="./slaktkort.html">√ñppna sl√§ktkort</a>
    </div>

    <h1>üå≥ Sl√§kttr√§d ‚Äì Skapa & v√§lj</h1>
    <p class="muted">
      GitHub Pages-l√§ge: allt sparas lokalt i <code>localStorage</code>.
      Du v√§ljer ett ‚Äúaktivt tr√§d‚Äù som resten av sidorna ska anv√§nda.
    </p>

    <!-- Statusruta (du bad om en ‚Äúruta‚Äù som visar att tr√§d saknas) -->
    <div id="statusBox" class="status">
      <p class="statusTitle" id="statusTitle">Status</p>
      <p class="statusText" id="statusText">Laddar‚Ä¶</p>
    </div>

    <div class="grid">
      <div class="card">
        <h2>1) Skapa nytt tr√§d</h2>
        <p class="small">Skapar ett nytt tr√§d och g√∂r det aktivt direkt.</p>

        <label for="treeName">Namn p√• tr√§d</label>
        <input id="treeName" placeholder="t.ex. Anderssons sl√§kt" />

        <button id="createBtn" type="button">Skapa tr√§d</button>

        <p class="small" id="createMsg" aria-live="polite"></p>
      </div>

      <div class="card">
        <h2>2) V√§lj aktivt tr√§d</h2>
        <p class="small">Det aktiva tr√§det anv√§nds av andra vyer.</p>

        <label for="treeSelect">Dina tr√§d</label>
        <select id="treeSelect"></select>

        <div class="row" style="margin-top:10px;">
          <button id="setActiveBtn" type="button">S√§tt som aktivt</button>
          <button id="deleteBtn" class="danger" type="button">Ta bort valt</button>
        </div>

        <p class="small" id="selectMsg" aria-live="polite"></p>
      </div>

      <div class="card">
        <h2>3) Debug (valfritt)</h2>
        <p class="small">Visar exakt vad som ligger i localStorage.</p>
        <button id="refreshDebugBtn" type="button">Uppdatera debug</button>
        <pre id="debugOut">[]</pre>
      </div>
    </div>
  </div>

  <script>
    // ============================
    // LocalStorage-nycklar (enhetliga)
    // ============================
    const KEY_TREES = "slakttradet_trees";
    const KEY_ACTIVE = "slakttradet_active_tree_id";

    // DOM
    const statusBox = document.getElementById("statusBox");
    const statusTitle = document.getElementById("statusTitle");
    const statusText = document.getElementById("statusText");

    const treeName = document.getElementById("treeName");
    const createBtn = document.getElementById("createBtn");
    const createMsg = document.getElementById("createMsg");

    const treeSelect = document.getElementById("treeSelect");
    const setActiveBtn = document.getElementById("setActiveBtn");
    const deleteBtn = document.getElementById("deleteBtn");
    const selectMsg = document.getElementById("selectMsg");

    const refreshDebugBtn = document.getElementById("refreshDebugBtn");
    const debugOut = document.getElementById("debugOut");

    function safeParse(raw, fallback) {
      try { return JSON.parse(raw); } catch { return fallback; }
    }

    function loadTrees() {
      const raw = localStorage.getItem(KEY_TREES);
      const trees = safeParse(raw, []);
      return Array.isArray(trees) ? trees : [];
    }

    function saveTrees(trees) {
      localStorage.setItem(KEY_TREES, JSON.stringify(trees));
    }

    function getActiveTreeId() {
      return localStorage.getItem(KEY_ACTIVE) || "";
    }

    function setActiveTreeId(id) {
      localStorage.setItem(KEY_ACTIVE, String(id || ""));
    }

    function makeId() {
      return "t" + Date.now().toString(36) + Math.random().toString(36).slice(2, 6);
    }

    function setStatus(type, title, text) {
      statusBox.className = "status " + (type === "ok" ? "ok" : type === "err" ? "err" : "");
      statusTitle.textContent = title;
      statusText.textContent = text;
    }

    function fillSelect() {
      const trees = loadTrees();
      const activeId = getActiveTreeId();

      treeSelect.innerHTML = "";
      if (trees.length === 0) {
        const opt = document.createElement("option");
        opt.value = "";
        opt.textContent = "Inga tr√§d sparade";
        treeSelect.appendChild(opt);
        treeSelect.disabled = true;
        setActiveBtn.disabled = true;
        deleteBtn.disabled = true;
        return;
      }

      treeSelect.disabled = false;
      setActiveBtn.disabled = false;
      deleteBtn.disabled = false;

      for (const t of trees) {
        const opt = document.createElement("option");
        opt.value = t.id;
        opt.textContent = (t.name || ("Tr√§d " + t.id)) + (t.id === activeId ? " (aktivt)" : "");
        treeSelect.appendChild(opt);
      }

      // F√∂rs√∂k v√§lja det aktiva
      if (activeId) treeSelect.value = activeId;
      if (!treeSelect.value) treeSelect.selectedIndex = 0;
    }

    function updateStatus() {
      const trees = loadTrees();
      const activeId = getActiveTreeId();
      const active = trees.find(t => t.id === activeId);

      if (trees.length === 0) {
        setStatus(
          "err",
          "Inga tr√§d sparade",
          "G√• till 'Skapa & v√§lj tr√§d' och skapa ett tr√§d."
        );
        return;
      }

      if (!active) {
        setStatus(
          "err",
          "Inget aktivt tr√§d valt",
          "V√§lj ett tr√§d och klicka 'S√§tt som aktivt'."
        );
        return;
      }

      setStatus("ok", "Aktivt tr√§d", `Aktivt sl√§kttr√§d: ${active.name || active.id}`);
    }

    function refreshDebug() {
      const trees = loadTrees();
      const activeId = getActiveTreeId();
      debugOut.textContent = JSON.stringify({ activeTreeId: activeId, trees }, null, 2);
    }

    // ============================
    // Actions
    // ============================
    createBtn.addEventListener("click", () => {
      createMsg.textContent = "";
      const name = String(treeName.value || "").trim();

      if (!name) {
        createMsg.textContent = "Skriv ett namn f√∂rst.";
        return;
      }

      const trees = loadTrees();
      const id = makeId();

      trees.push({ id, name, createdAt: new Date().toISOString() });
      saveTrees(trees);
      setActiveTreeId(id);

      treeName.value = "";
      createMsg.textContent = "Tr√§d skapat och satt som aktivt.";

      fillSelect();
      updateStatus();
      refreshDebug();
    });

    setActiveBtn.addEventListener("click", () => {
      const id = treeSelect.value;
      if (!id) return;
      setActiveTreeId(id);
      selectMsg.textContent = "Aktivt tr√§d uppdaterat.";
      fillSelect();
      updateStatus();
      refreshDebug();
    });

    deleteBtn.addEventListener("click", () => {
      const id = treeSelect.value;
      if (!id) return;

      const trees = loadTrees().filter(t => t.id !== id);
      saveTrees(trees);

      const activeId = getActiveTreeId();
      if (activeId === id) setActiveTreeId("");

      selectMsg.textContent = "Tr√§d borttaget.";
      fillSelect();
      updateStatus();
      refreshDebug();
    });

    refreshDebugBtn.addEventListener("click", refreshDebug);

    // ============================
    // Start
    // ============================
    fillSelect();
    updateStatus();
    refreshDebug();
  </script>
</body>
</html>
