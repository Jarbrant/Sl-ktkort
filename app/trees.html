<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Träd – Släktkort</title>
  <meta name="description" content="Skapa och välj aktivt träd (localStorage-first)." />

  <style>
    :root { color-scheme: light; }
    body{
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      line-height: 1.5;
      margin: 0;
      padding: 24px;
      max-width: 1180px;
      margin-inline: auto;
      background: #fff;
      color: #111;
    }
    a{ color: inherit; text-decoration:none; }

    header{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      margin-bottom:18px;
    }
    h1{ margin:0 0 6px; font-size:1.6rem; }
    .muted{ color:#555; margin:0 0 12px; }

    .topbar{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      margin: 10px 0 0;
    }
    .btn, button{
      display:inline-block;
      padding:10px 12px;
      border:1px solid #333;
      border-radius:10px;
      background:#fff;
      font:inherit;
      cursor:pointer;
      text-decoration:none;
      user-select:none;
    }
    .btn.secondary{ border-color:#bbb; }
    .btn.danger{ border-color:#b00020; color:#b00020; }
    .btn:disabled{ opacity:.5; cursor:not-allowed; }

    .pillRow{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      margin: 10px 0 18px;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border:1px solid #ddd;
      border-radius:999px;
      background:#fafafa;
      font-size:.95rem;
    }
    .pill strong{ font-weight:900; }
    .pill.ok{ border-color:#cfe8cf; background:#f5fff5; }
    .pill.warn{ border-color:#ffe1a6; background:#fff9ee; }
    .pill.err{ border-color:#ffb3b3; background:#fff2f2; }

    .grid{
      display:grid;
      gap:14px;
      grid-template-columns: 1fr;
    }
    @media (min-width: 1080px){
      .grid{ grid-template-columns: 420px 1fr; }
    }

    .card{
      border:1px solid #ddd;
      border-radius:12px;
      padding:16px;
      background:#fff;
      position: relative;
    }
    .card h2{ margin:0 0 6px; font-size:1.15rem; }
    .small{ font-size:.95rem; color:#555; margin:0 0 10px; }

    label{ display:block; margin:10px 0 6px; font-weight:800; }
    input{
      width:100%;
      box-sizing:border-box;
      padding:10px;
      border-radius:10px;
      border:1px solid #bbb;
      font:inherit;
      background:#fff;
    }

    .actions{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      margin-top: 12px;
    }

    .list{
      margin: 10px 0 0;
      padding: 0;
      list-style:none;
      display:flex;
      flex-direction:column;
      gap:10px;
      max-height: 560px;
      overflow:auto;
      border-top: 1px solid #eee;
      padding-top: 10px;
    }
    .item{
      border:1px solid #eee;
      border-radius:12px;
      padding:10px;
      background:#fff;
      cursor:pointer;
    }
    .item:hover{ background:#fafafa; }
    .item.active{
      border-color:#7fcf9b;
      box-shadow: 0 0 0 4px rgba(183,228,199,.35);
    }
    .itemTitle{ font-weight:900; margin:0 0 2px; display:flex; align-items:center; gap:8px; }
    .badge{
      font-size:.85rem;
      border:1px solid #ddd;
      padding:2px 8px;
      border-radius:999px;
      background:#fafafa;
    }
    .itemMeta{ margin:0; color:#555; font-size:.95rem; }
    .itemSub{ margin:4px 0 0; color:#333; font-size:.95rem; }

    .hintBox{
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid #ffe1a6;
      background: #fff9ee;
    }
    .okBox{
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid #cfe8cf;
      background: #f5fff5;
    }
    code{ background:#f4f4f4; padding:2px 6px; border-radius:6px; }
  </style>
</head>

<body>
<header>
  <div>
    <h1>Träd</h1>
    <p class="muted">Skapa träd och välj vilket du arbetar i. Aktivt träd styr Personer, Relationer och Karta.</p>

    <nav class="topbar" aria-label="Navigation">
      <a class="btn secondary" href="../start.html">Start</a>
      <a class="btn" href="./trees.html">Träd</a>
      <a class="btn secondary" href="./slaktkort.html">Personer</a>
      <a class="btn secondary" href="./create-relation.html">Relationer</a>
      <a class="btn secondary" href="./map.html">Karta</a>
    </nav>
  </div>

  <div class="actions" style="justify-content:flex-end;">
    <button id="logoutBtn" class="btn secondary" type="button">Logga ut</button>
  </div>
</header>

<section class="pillRow" aria-label="Status">
  <span id="pillActive" class="pill warn">Aktivt träd: <strong>—</strong></span>
  <span id="pillTrees" class="pill">Träd: <strong>0</strong></span>
</section>

<div class="grid">
  <!-- VÄNSTER: LISTA -->
  <section class="card" aria-label="Trädlista">
    <h2>Trädlista</h2>
    <p class="small">Klicka ett träd för att markera. Använd knapparna till höger för att byta namn eller ta bort.</p>

    <div class="actions">
      <button id="reloadBtn" type="button" class="btn secondary">Ladda om</button>
      <button id="newBtn" type="button" class="btn">Skapa nytt träd</button>
    </div>

    <div id="leftHint" class="hintBox" hidden></div>

    <ul id="list" class="list" aria-label="Träd"></ul>
  </section>

  <!-- HÖGER: EDIT -->
  <section class="card" aria-label="Redigera träd">
    <h2 id="panelTitle">Skapa nytt träd</h2>
    <p class="small" id="panelSub">Ge trädet ett namn och spara.</p>

    <label for="name">Trädnamn</label>
    <input id="name" placeholder="t.ex. Släkten Nilsson" autocomplete="off" />

    <div class="actions">
      <button id="saveBtn" type="button" class="btn">Spara</button>
      <button id="setActiveBtn" type="button" class="btn secondary" disabled>Gör aktivt</button>
      <button id="deleteBtn" type="button" class="btn danger" disabled>Ta bort</button>
      <button id="resetBtn" type="button" class="btn secondary">Återställ</button>
    </div>

    <div id="statusBox" class="okBox" hidden></div>

    <div class="hintBox" style="margin-top:14px;">
      <strong>Nycklar (tekniskt)</strong>
      <div class="small" style="margin-top:6px;">
        Träd sparas i <code>slakttradet_trees</code><br/>
        Aktivt träd: <code>slakttradet_active_tree_id</code><br/>
        Personer per träd: <code>slakttradet_slaktkort_&lt;treeId&gt;</code><br/>
        Relationer per träd: <code>slakttradet_relationer_&lt;treeId&gt;</code>
      </div>
    </div>

    <p class="small" id="tech" style="margin-top:10px;">—</p>
  </section>
</div>

<script>
  "use strict";

  // =====================================================
  // DEMO AUTH GUARD (matchar dina andra sidor)
  // =====================================================
  (function authGuard(){
    try{
      if(sessionStorage.getItem("demo_auth") !== "1"){
        window.location.href = "../index.html";
      }
    }catch{}
  })();

  // =====================================================
  // STORAGE KEYS (LÅSTA)
  // =====================================================
  const KEY_TREES  = "slakttradet_trees";
  const KEY_ACTIVE = "slakttradet_active_tree_id";
  const cardsKey = (treeId) => "slakttradet_slaktkort_" + String(treeId);
  const relKey   = (treeId) => "slakttradet_relationer_" + String(treeId);

  // =====================================================
  // DOM
  // =====================================================
  const logoutBtn = document.getElementById("logoutBtn");

  const pillActive = document.getElementById("pillActive");
  const pillTrees = document.getElementById("pillTrees");

  const reloadBtn = document.getElementById("reloadBtn");
  const newBtn = document.getElementById("newBtn");

  const leftHint = document.getElementById("leftHint");
  const listEl = document.getElementById("list");

  const panelTitle = document.getElementById("panelTitle");
  const panelSub = document.getElementById("panelSub");
  const nameEl = document.getElementById("name");

  const saveBtn = document.getElementById("saveBtn");
  const setActiveBtn = document.getElementById("setActiveBtn");
  const deleteBtn = document.getElementById("deleteBtn");
  const resetBtn = document.getElementById("resetBtn");

  const statusBox = document.getElementById("statusBox");
  const techEl = document.getElementById("tech");

  // =====================================================
  // HELPERS
  // =====================================================
  function safeParse(raw, fallback){
    try{ return JSON.parse(raw); }catch{ return fallback; }
  }
  function loadJson(key, fallback){
    const raw = localStorage.getItem(key);
    return raw ? safeParse(raw, fallback) : fallback;
  }
  function saveJson(key, value){
    localStorage.setItem(key, JSON.stringify(value));
  }
  function escapeHtml(s){
    return String(s || "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }
  function tid(){
    return "t_" + Date.now().toString(36) + "_" + Math.random().toString(36).slice(2,8);
  }
  function activeTreeId(){
    return localStorage.getItem(KEY_ACTIVE) || "";
  }
  function setActiveTreeId(id){
    if(id) localStorage.setItem(KEY_ACTIVE, String(id));
    else localStorage.removeItem(KEY_ACTIVE);
  }
  function getTrees(){
    const arr = loadJson(KEY_TREES, []);
    return Array.isArray(arr) ? arr : [];
  }
  function saveTrees(arr){
    saveJson(KEY_TREES, Array.isArray(arr) ? arr : []);
  }
  function treeLabel(t){
    return String(t && (t.name || t.namn || t.id) ? (t.name || t.namn || t.id) : "—");
  }
  function countPeople(treeId){
    const arr = loadJson(cardsKey(treeId), []);
    return Array.isArray(arr) ? arr.length : 0;
  }
  function countRelations(treeId){
    const arr = loadJson(relKey(treeId), []);
    return Array.isArray(arr) ? arr.length : 0;
  }
  function showStatus(html){
    statusBox.hidden = false;
    statusBox.innerHTML = html;
    setTimeout(() => { try{ statusBox.hidden = true; }catch{} }, 1800);
  }

  // =====================================================
  // STATE
  // =====================================================
  let trees = [];
  let selectedId = ""; // "" = create mode

  // =====================================================
  // UI
  // =====================================================
  function renderPills(){
    const act = activeTreeId();
    const hasActive = !!act;
    const exists = hasActive && trees.some(t => String(t.id) === String(act));
    const label = exists ? treeLabel(trees.find(t => String(t.id) === String(act))) : "—";

    pillActive.className = "pill " + (exists ? "ok" : (trees.length ? "warn" : "err"));
    pillActive.innerHTML = "Aktivt träd: <strong>" + escapeHtml(exists ? label : "—") + "</strong>";

    pillTrees.innerHTML = "Träd: <strong>" + trees.length + "</strong>";
  }

  function renderList(){
    listEl.innerHTML = "";

    if(trees.length === 0){
      leftHint.hidden = false;
      leftHint.innerHTML = "<strong>Inga träd ännu.</strong> Klicka <code>Skapa nytt träd</code>.";
      const li = document.createElement("li");
      li.className = "item";
      li.style.cursor = "default";
      li.innerHTML = "<p class='itemTitle'>—</p><p class='itemMeta'>Skapa ett träd för att börja.</p>";
      listEl.appendChild(li);
      return;
    }

    leftHint.hidden = true;
    leftHint.innerHTML = "";

    const act = activeTreeId();

    for(const t of trees){
      const li = document.createElement("li");
      const isSel = String(t.id) === String(selectedId);
      const isAct = act && String(t.id) === String(act);

      li.className = "item" + (isSel ? " active" : "");
      li.dataset.id = String(t.id);

      const ppl = countPeople(t.id);
      const rel = countRelations(t.id);

      li.innerHTML =
        "<p class='itemTitle'>" +
          escapeHtml(treeLabel(t)) +
          (isAct ? " <span class='badge'>Aktivt</span>" : "") +
        "</p>" +
        "<p class='itemMeta'>ID: " + escapeHtml(String(t.id)) + "</p>" +
        "<p class='itemSub'>Personer: " + ppl + " · Relationer: " + rel + "</p>";

      li.addEventListener("click", () => selectTree(String(t.id)));

      listEl.appendChild(li);
    }
  }

  function setPanelMode(){
    if(selectedId){
      const t = trees.find(x => String(x.id) === String(selectedId));
      panelTitle.textContent = "Redigera träd";
      panelSub.textContent = "Byt namn, gör aktivt eller ta bort.";
      nameEl.value = t ? (t.name || "") : "";
      setActiveBtn.disabled = false;
      deleteBtn.disabled = false;
    }else{
      panelTitle.textContent = "Skapa nytt träd";
      panelSub.textContent = "Ge trädet ett namn och spara.";
      nameEl.value = "";
      setActiveBtn.disabled = true;
      deleteBtn.disabled = true;
    }
    renderTech();
  }

  function renderTech(){
    const act = activeTreeId();
    techEl.textContent =
      "Valt: " + (selectedId ? selectedId : "— (ny)") +
      " · Aktivt: " + (act || "—") +
      " · Träd-nyckel: " + KEY_TREES;
  }

  // =====================================================
  // ACTIONS
  // =====================================================
  function selectTree(id){
    const t = trees.find(x => String(x.id) === String(id));
    if(!t) return;
    selectedId = String(t.id);
    setPanelMode();
    renderList();
  }

  function resetPanel(){
    selectedId = "";
    setPanelMode();
    renderList();
  }

  function createTree(){
    const name = String(nameEl.value || "").trim();
    if(!name){
      showStatus("<strong>Skriv ett trädnamn.</strong>");
      return;
    }

    const t = {
      id: tid(),
      name,
      createdAt: Date.now(),
      updatedAt: Date.now()
    };

    trees.unshift(t);
    saveTrees(trees);

    // om inget aktivt finns: gör det nya aktivt
    if(!activeTreeId()){
      setActiveTreeId(t.id);
    }

    selectedId = String(t.id);
    showStatus("<strong>Skapat.</strong>");
    refresh();
  }

  function renameTree(){
    const t = trees.find(x => String(x.id) === String(selectedId));
    if(!t){
      showStatus("<strong>Välj ett träd.</strong>");
      return;
    }

    const name = String(nameEl.value || "").trim();
    if(!name){
      showStatus("<strong>Skriv ett trädnamn.</strong>");
      return;
    }

    t.name = name;
    t.updatedAt = Date.now();
    saveTrees(trees);

    showStatus("<strong>Sparat.</strong>");
    refresh();
  }

  function setActive(){
    if(!selectedId){
      showStatus("<strong>Välj ett träd.</strong>");
      return;
    }
    const exists = trees.some(t => String(t.id) === String(selectedId));
    if(!exists){
      showStatus("<strong>Trädet finns inte.</strong>");
      return;
    }
    setActiveTreeId(selectedId);
    showStatus("<strong>Aktivt träd uppdaterat.</strong>");
    refresh();
  }

  function deleteTree(){
    const t = trees.find(x => String(x.id) === String(selectedId));
    if(!t) return;

    const ppl = countPeople(t.id);
    const rel = countRelations(t.id);

    const ok = confirm(
      "Ta bort trädet:\n\n" +
      (t.name || t.id) + "\n\n" +
      "Detta tar även bort åtkomst till data som ligger under nycklarna:\n" +
      cardsKey(t.id) + " (" + ppl + " personer)\n" +
      relKey(t.id) + " (" + rel + " relationer)\n\n" +
      "OBS: Data tas bort endast om du väljer 'OK'."
    );
    if(!ok) return;

    // ta bort data för trädet
    try{ localStorage.removeItem(cardsKey(t.id)); }catch{}
    try{ localStorage.removeItem(relKey(t.id)); }catch{}

    // ta bort trädet
    trees = trees.filter(x => String(x.id) !== String(t.id));
    saveTrees(trees);

    // om aktivt träd var detta -> välj nytt aktivt eller rensa
    const act = activeTreeId();
    if(act && String(act) === String(t.id)){
      if(trees.length){
        setActiveTreeId(trees[0].id);
      }else{
        setActiveTreeId("");
      }
    }

    showStatus("<strong>Borttaget.</strong>");
    selectedId = "";
    refresh();
  }

  // =====================================================
  // REFRESH
  // =====================================================
  function refresh(){
    trees = getTrees();
    // om aktivt pekar på icke-existerande: fixa
    const act = activeTreeId();
    if(act && !trees.some(t => String(t.id) === String(act))){
      if(trees.length) setActiveTreeId(trees[0].id);
      else setActiveTreeId("");
    }

    renderPills();
    renderList();

    // om selectedId inte finns längre
    if(selectedId && !trees.some(t => String(t.id) === String(selectedId))){
      selectedId = "";
    }
    setPanelMode();
  }

  // =====================================================
  // EVENTS
  // =====================================================
  reloadBtn.addEventListener("click", () => {
    refresh();
    showStatus("<strong>Omladdat.</strong>");
  });

  newBtn.addEventListener("click", () => {
    selectedId = "";
    setPanelMode();
    try{ nameEl.focus(); }catch{}
    showStatus("<strong>Nytt träd.</strong>");
  });

  saveBtn.addEventListener("click", () => {
    if(selectedId) renameTree();
    else createTree();
  });

  setActiveBtn.addEventListener("click", setActive);
  deleteBtn.addEventListener("click", deleteTree);

  resetBtn.addEventListener("click", () => {
    if(selectedId){
      // återställ namn från storage
      const t = trees.find(x => String(x.id) === String(selectedId));
      nameEl.value = t ? (t.name || "") : "";
      showStatus("<strong>Återställt.</strong>");
    }else{
      nameEl.value = "";
      showStatus("<strong>Återställt.</strong>");
    }
  });

  // Enter = spara
  nameEl.addEventListener("keydown", (e) => {
    if(e.key === "Enter"){
      e.preventDefault();
      saveBtn.click();
    }
  });

  logoutBtn.addEventListener("click", () => {
    try{ sessionStorage.removeItem("demo_auth"); }catch{}
    window.location.href = "../index.html";
  });

  // =====================================================
  // START
  // =====================================================
  refresh();
</script>
</body>
</html>
