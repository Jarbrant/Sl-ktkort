<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tr√§d ‚Äì Skapa & v√§lj</title>
  <meta name="description" content="Skapa och v√§lj aktivt sl√§kttr√§d (localStorage)." />

  <style>
    :root { color-scheme: light; }
    body{
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      line-height: 1.5;
      margin: 0;
      padding: 24px;
      max-width: 980px;
      margin-inline: auto;
      background: #fff;
      color: #111;
    }
    a{ color: inherit; text-decoration: none; }
    header{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 12px;
      margin-bottom: 18px;
    }
    h1{ margin: 0 0 6px; font-size: 1.6rem; }
    p{ margin: 0 0 12px; }
    .muted{ color:#555; }

    .topbar{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      margin: 10px 0 0;
    }
    .btn, button{
      display:inline-block;
      padding: 10px 12px;
      border: 1px solid #333;
      border-radius: 10px;
      background: #fff;
      font: inherit;
      cursor: pointer;
      text-decoration:none;
    }
    .btn.secondary{
      border-color:#bbb;
      color:#111;
    }
    .btn.danger{
      border-color:#b00020;
      color:#b00020;
    }
    .btn.disabled{
      opacity: .45;
      cursor: not-allowed;
      pointer-events: none;
    }

    .pillRow{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      margin: 10px 0 18px;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 8px 10px;
      border: 1px solid #ddd;
      border-radius: 999px;
      background: #fafafa;
      font-size: .95rem;
    }
    .pill strong{ font-weight: 900; }
    .pill.ok{ border-color:#cfe8cf; background:#f5fff5; }
    .pill.warn{ border-color:#ffe1a6; background:#fff9ee; }

    .note{
      margin: 0 0 18px;
      padding: 12px;
      border-radius: 12px;
      border: 1px solid #ffe1a6;
      background: #fff9ee;
    }
    .note strong{ font-weight: 900; }

    .grid{
      display:grid;
      gap: 14px;
      grid-template-columns: 1fr;
    }
    @media (min-width: 860px){
      .grid{ grid-template-columns: 1fr 1fr; }
    }

    .card{
      border: 1px solid #ddd;
      border-radius: 12px;
      padding: 16px;
      background: #fff;
    }
    .card h2{
      margin: 0 0 6px;
      font-size: 1.15rem;
    }
    .small{ font-size: .95rem; color:#555; margin: 0 0 10px; }

    label{ display:block; margin: 10px 0 6px; font-weight: 700; }
    input, select{
      width: 100%;
      box-sizing: border-box;
      padding: 10px;
      border-radius: 10px;
      border: 1px solid #bbb;
      font: inherit;
      background: #fff;
    }

    .row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      margin-top: 10px;
    }
    .row > *{ flex: 1; min-width: 160px; }

    pre{
      background:#f4f4f4;
      padding: 12px;
      border-radius: 12px;
      overflow:auto;
      white-space: pre-wrap;
      margin: 10px 0 0;
    }
    code{ background:#f4f4f4; padding: 2px 6px; border-radius: 6px; }

    .msg{ margin: 10px 0 0; color:#555; }
    .msg strong{ color:#111; }

    footer{
      margin-top: 18px;
      color:#666;
      font-size: .95rem;
    }
  </style>
</head>

<body>
<header>
  <div>
    <h1>üå≥ Tr√§d ‚Äì Skapa & v√§lj</h1>
    <p class="muted">
      GitHub Pages-l√§ge: allt sparas lokalt i <code>localStorage</code>. V√§lj ett ‚Äúaktivt tr√§d‚Äù som resten av sidorna anv√§nder.
    </p>

    <!-- NAV (matchar din nya start.html) -->
    <nav class="topbar" aria-label="Navigation">
      <a class="btn secondary" href="start.html">Start</a>

      <!-- Om dina filer ligger i root: byt dessa till r√§tt filer -->
      <a class="btn secondary" href="trees.html">Tr√§d</a>
      <a class="btn secondary" href="slaktkort.html">Personer</a>
      <a class="btn secondary" href="create-relation.html">Relationer</a>
      <a class="btn secondary" href="map.html">Karta</a>
    </nav>
  </div>

  <div class="row" style="justify-content:flex-end; max-width: 320px;">
    <button id="logoutBtn" class="btn secondary" type="button" title="Estetisk utloggning">Logga ut</button>
  </div>
</header>

<section class="pillRow" aria-label="Status">
  <span id="pillTree" class="pill warn">Aktivt tr√§d: <strong>‚Äî</strong></span>
  <span id="pillTrees" class="pill">Tr√§d sparade: <strong>0</strong></span>
  <span id="pillNext" class="pill warn">N√§sta steg: <strong>Skapa/v√§lj tr√§d</strong></span>
</section>

<div id="noteBox" class="note" hidden></div>

<section class="grid" aria-label="Tr√§dfunktioner">
  <article class="card">
    <h2>1) Skapa nytt tr√§d</h2>
    <p class="small">Skapar ett nytt tr√§d och g√∂r det aktivt direkt.</p>

    <label for="treeName">Namn p√• tr√§d</label>
    <input id="treeName" placeholder="t.ex. Anderssons sl√§kt" />

    <div class="row">
      <button id="createBtn" type="button" class="btn">Skapa tr√§d</button>
      <button id="refreshBtn" type="button" class="btn secondary">Uppdatera status</button>
    </div>

    <p class="msg" id="createMsg" aria-live="polite"></p>
  </article>

  <article class="card">
    <h2>2) V√§lj aktivt tr√§d</h2>
    <p class="small">Det aktiva tr√§det anv√§nds av andra vyer.</p>

    <label for="treeSelect">Dina tr√§d</label>
    <select id="treeSelect"></select>

    <div class="row">
      <button id="setActiveBtn" type="button" class="btn">S√§tt som aktivt</button>
      <button id="deleteBtn" type="button" class="btn danger">Ta bort valt</button>
    </div>

    <div class="row">
      <a id="continueBtn" class="btn disabled" href="slaktkort.html" aria-disabled="true" tabindex="-1">Forts√§tt ‚Üí Personer</a>
      <a class="btn secondary" href="start.html">Tillbaka till Start</a>
    </div>

    <p class="msg" id="selectMsg" aria-live="polite"></p>
  </article>

  <article class="card" style="grid-column: 1 / -1;">
    <h2>3) Debug (valfritt)</h2>
    <p class="small">Visar exakt vad som ligger i localStorage.</p>
    <div class="row">
      <button id="refreshDebugBtn" type="button" class="btn secondary">Uppdatera debug</button>
      <button id="clearAllBtn" type="button" class="btn danger" title="Tar bort alla tr√§d och nollst√§ller aktivt tr√§d">Nollst√§ll tr√§d</button>
    </div>
    <pre id="debugOut">[]</pre>
  </article>
</section>

<footer>
  Tips: N√§r du ser ‚ÄúAktivt tr√§d‚Äù som gr√∂n pill √§r du klar med steg 1 och kan g√• vidare till Personer.
</footer>

<script>
  // ============================
  // Estetisk "auth" (flow, inte s√§kerhet)
  // ============================
  (function authGuard(){
    try{
      if(sessionStorage.getItem("demo_auth") !== "1"){
        window.location.href = "index.html";
      }
    }catch{
      // Om sessionStorage √§r l√•st: till√•t √§nd√• (demo)
    }
  })();

  // ============================
  // LocalStorage-nycklar (enhetliga)
  // ============================
  const KEY_TREES  = "slakttradet_trees";
  const KEY_ACTIVE = "slakttradet_active_tree_id";

  // DOM
  const pillTree  = document.getElementById("pillTree");
  const pillTrees = document.getElementById("pillTrees");
  const pillNext  = document.getElementById("pillNext");
  const noteBox   = document.getElementById("noteBox");

  const treeName  = document.getElementById("treeName");
  const createBtn = document.getElementById("createBtn");
  const refreshBtn= document.getElementById("refreshBtn");
  const createMsg = document.getElementById("createMsg");

  const treeSelect  = document.getElementById("treeSelect");
  const setActiveBtn= document.getElementById("setActiveBtn");
  const deleteBtn   = document.getElementById("deleteBtn");
  const continueBtn = document.getElementById("continueBtn");
  const selectMsg   = document.getElementById("selectMsg");

  const refreshDebugBtn = document.getElementById("refreshDebugBtn");
  const clearAllBtn     = document.getElementById("clearAllBtn");
  const debugOut        = document.getElementById("debugOut");

  const logoutBtn = document.getElementById("logoutBtn");

  function safeParse(raw, fallback){
    try { return JSON.parse(raw); } catch { return fallback; }
  }

  function loadTrees(){
    const raw = localStorage.getItem(KEY_TREES);
    const trees = safeParse(raw, []);
    return Array.isArray(trees) ? trees : [];
  }

  function saveTrees(trees){
    localStorage.setItem(KEY_TREES, JSON.stringify(trees));
  }

  function getActiveTreeId(){
    return localStorage.getItem(KEY_ACTIVE) || "";
  }

  function setActiveTreeId(id){
    localStorage.setItem(KEY_ACTIVE, String(id || ""));
  }

  function makeId(){
    return "t" + Date.now().toString(36) + Math.random().toString(36).slice(2, 6);
  }

  function setDisabled(el, disabled){
    if(disabled){
      el.classList.add("disabled");
      el.setAttribute("aria-disabled","true");
      el.setAttribute("tabindex","-1");
    }else{
      el.classList.remove("disabled");
      el.removeAttribute("aria-disabled");
      el.removeAttribute("tabindex");
    }
  }

  function fillSelect(){
    const trees = loadTrees();
    const activeId = getActiveTreeId();

    treeSelect.innerHTML = "";

    if(trees.length === 0){
      const opt = document.createElement("option");
      opt.value = "";
      opt.textContent = "Inga tr√§d sparade";
      treeSelect.appendChild(opt);

      treeSelect.disabled = true;
      setActiveBtn.disabled = true;
      deleteBtn.disabled = true;
      return;
    }

    treeSelect.disabled = false;
    setActiveBtn.disabled = false;
    deleteBtn.disabled = false;

    for(const t of trees){
      const opt = document.createElement("option");
      opt.value = t.id;
      opt.textContent = (t.name || ("Tr√§d " + t.id)) + (t.id === activeId ? " (aktivt)" : "");
      treeSelect.appendChild(opt);
    }

    if(activeId) treeSelect.value = activeId;
    if(!treeSelect.value) treeSelect.selectedIndex = 0;
  }

  function updateStatus(){
    const trees = loadTrees();
    const activeId = getActiveTreeId();
    const active = trees.find(t => t.id === activeId);

    pillTrees.innerHTML = 'Tr√§d sparade: <strong>' + trees.length + '</strong>';

    if(trees.length === 0){
      pillTree.className = "pill warn";
      pillTree.innerHTML = 'Aktivt tr√§d: <strong>‚Äî</strong>';
      pillNext.className = "pill warn";
      pillNext.innerHTML = 'N√§sta steg: <strong>Skapa tr√§d</strong>';

      noteBox.hidden = false;
      noteBox.innerHTML = '<strong>üö© Inga tr√§d sparade:</strong> Skapa ett tr√§d i steg 1.';

      setDisabled(continueBtn, true);
      return;
    }

    if(!active){
      pillTree.className = "pill warn";
      pillTree.innerHTML = 'Aktivt tr√§d: <strong>‚Äî</strong>';
      pillNext.className = "pill warn";
      pillNext.innerHTML = 'N√§sta steg: <strong>V√§lj aktivt tr√§d</strong>';

      noteBox.hidden = false;
      noteBox.innerHTML = '<strong>üö© Inget aktivt tr√§d valt:</strong> V√§lj ett tr√§d och klicka ‚ÄúS√§tt som aktivt‚Äù.';

      setDisabled(continueBtn, true);
      return;
    }

    pillTree.className = "pill ok";
    pillTree.innerHTML = 'Aktivt tr√§d: <strong>' + (active.name || active.id) + '</strong>';
    pillNext.className = "pill ok";
    pillNext.innerHTML = 'N√§sta steg: <strong>G√• till Personer</strong>';

    noteBox.hidden = true;
    setDisabled(continueBtn, false);
  }

  function refreshDebug(){
    const trees = loadTrees();
    const activeId = getActiveTreeId();
    debugOut.textContent = JSON.stringify({ activeTreeId: activeId, trees }, null, 2);
  }

  // ============================
  // Actions
  // ============================
  createBtn.addEventListener("click", () => {
    createMsg.textContent = "";
    selectMsg.textContent = "";

    const name = String(treeName.value || "").trim();
    if(!name){
      createMsg.textContent = "Skriv ett namn f√∂rst.";
      return;
    }

    const trees = loadTrees();
    const id = makeId();

    trees.push({ id, name, createdAt: new Date().toISOString() });
    saveTrees(trees);
    setActiveTreeId(id);

    treeName.value = "";
    createMsg.innerHTML = "<strong>Klart:</strong> Tr√§d skapat och satt som aktivt.";

    fillSelect();
    updateStatus();
    refreshDebug();
  });

  setActiveBtn.addEventListener("click", () => {
    createMsg.textContent = "";
    selectMsg.textContent = "";

    const id = treeSelect.value;
    if(!id) return;

    setActiveTreeId(id);
    selectMsg.innerHTML = "<strong>Klart:</strong> Aktivt tr√§d uppdaterat.";

    fillSelect();
    updateStatus();
    refreshDebug();
  });

  deleteBtn.addEventListener("click", () => {
    createMsg.textContent = "";
    selectMsg.textContent = "";

    const id = treeSelect.value;
    if(!id) return;

    const trees = loadTrees().filter(t => t.id !== id);
    saveTrees(trees);

    const activeId = getActiveTreeId();
    if(activeId === id) setActiveTreeId("");

    selectMsg.innerHTML = "<strong>Klart:</strong> Tr√§d borttaget.";

    fillSelect();
    updateStatus();
    refreshDebug();
  });

  clearAllBtn.addEventListener("click", () => {
    // Nollst√§ll endast tr√§dlistan + aktivt tr√§d (r√∂r inte persondata-nycklar)
    saveTrees([]);
    setActiveTreeId("");
    createMsg.textContent = "";
    selectMsg.innerHTML = "<strong>Klart:</strong> Tr√§d √§r nollst√§llda.";
    fillSelect();
    updateStatus();
    refreshDebug();
  });

  refreshBtn.addEventListener("click", () => {
    fillSelect();
    updateStatus();
    refreshDebug();
  });

  refreshDebugBtn.addEventListener("click", refreshDebug);

  logoutBtn.addEventListener("click", () => {
    try{ sessionStorage.removeItem("demo_auth"); }catch{}
    window.location.href = "index.html";
  });

  // ============================
  // Start
  // ============================
  fillSelect();
  updateStatus();
  refreshDebug();
</script>
</body>
</html>
