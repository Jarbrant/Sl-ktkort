<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Karta ‚Äì Sl√§ktkort</title>
  <meta name="description" content="Visa personer med koordinater och kopplingar (relationer) i aktivt tr√§d." />

  <!-- Leaflet (CDN) -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <style>
    :root { color-scheme: light; }
    body{
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      line-height: 1.5;
      margin: 0;
      padding: 24px;
      max-width: 1100px;
      margin-inline: auto;
      background: #fff;
      color: #111;
    }
    a{ color: inherit; text-decoration:none; }

    header{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      margin-bottom:18px;
    }
    h1{ margin:0 0 6px; font-size:1.6rem; }
    .muted{ color:#555; margin:0 0 12px; }

    .topbar{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      margin: 10px 0 0;
    }
    .btn, button{
      display:inline-block;
      padding:10px 12px;
      border:1px solid #333;
      border-radius:10px;
      background:#fff;
      font:inherit;
      cursor:pointer;
      text-decoration:none;
    }
    .btn.secondary{ border-color:#bbb; }
    .btn.disabled{
      opacity:.45;
      cursor:not-allowed;
      pointer-events:none;
    }

    .pillRow{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      margin: 10px 0 18px;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border:1px solid #ddd;
      border-radius:999px;
      background:#fafafa;
      font-size:.95rem;
    }
    .pill strong{ font-weight:900; }
    .pill.ok{ border-color:#cfe8cf; background:#f5fff5; }
    .pill.warn{ border-color:#ffe1a6; background:#fff9ee; }
    .pill.err{ border-color:#ffb3b3; background:#fff2f2; }

    .grid{
      display:grid;
      gap:14px;
      grid-template-columns: 1fr;
    }
    @media (min-width: 980px){
      .grid{ grid-template-columns: 380px 1fr; }
    }

    .card{
      border:1px solid #ddd;
      border-radius:12px;
      padding:16px;
      background:#fff;
    }
    .card h2{ margin:0 0 6px; font-size:1.15rem; }
    .small{ font-size:.95rem; color:#555; margin:0 0 10px; }

    label{ display:block; margin:10px 0 6px; font-weight:800; }
    input{
      width:100%;
      box-sizing:border-box;
      padding:10px;
      border-radius:10px;
      border:1px solid #bbb;
      font:inherit;
      background:#fff;
    }

    .actions{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      margin-top: 12px;
    }

    .toggleRow{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      margin-top: 10px;
    }
    .toggleRow label{
      display:flex;
      align-items:center;
      gap:10px;
      font-weight:700;
      margin:0;
    }
    .toggleRow input[type="checkbox"]{
      width:auto;
      padding:0;
      margin:0;
      accent-color: auto;
    }

    #map{
      width:100%;
      height: 560px;
      border-radius:12px;
      border: 1px solid #ddd;
      overflow:hidden;
      background:#f4f4f4;
    }
    @media (max-width: 520px){
      #map{ height: 440px; }
    }

    .error{ color:#b00020; font-weight:900; }
    .ok{ font-weight:900; }

    .list{
      margin: 10px 0 0;
      padding: 0;
      list-style:none;
      display:flex;
      flex-direction:column;
      gap:10px;
      max-height: 360px;
      overflow:auto;
      border-top: 1px solid #eee;
      padding-top: 10px;
    }
    .item{
      border:1px solid #eee;
      border-radius:12px;
      padding:10px;
      background:#fff;
      cursor:pointer;
    }
    .item:hover{ background:#fafafa; }
    .itemTitle{ font-weight:900; margin:0 0 2px; }
    .itemMeta{ margin:0; color:#555; font-size:.95rem; }

    .hintBox{
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid #ffe1a6;
      background: #fff9ee;
    }
    code{ background:#f4f4f4; padding:2px 6px; border-radius:6px; }
  </style>
</head>

<body>
<header>
  <div>
    <h1>Karta</h1>
    <p class="muted">Visar <strong>personer</strong> och <strong>kopplingar</strong> (F√∂r√§lder‚ÜíBarn) i aktivt tr√§d.</p>

    <nav class="topbar" aria-label="Navigation">
      <a class="btn secondary" href="../start.html">Start</a>
      <a class="btn secondary" href="./trees.html">Tr√§d</a>
      <a class="btn secondary" href="./slaktkort.html">Personer</a>
      <a class="btn secondary" href="./create-relation.html">Relationer</a>
      <a class="btn" href="./map.html">Karta</a>
      <a class="btn secondary" href="./place-picker.html">Plats-picker</a>
    </nav>
  </div>

  <div class="actions" style="justify-content:flex-end;">
    <button id="logoutBtn" class="btn secondary" type="button">Logga ut</button>
  </div>
</header>

<section class="pillRow" aria-label="Status">
  <span id="pillTree" class="pill warn">Aktivt tr√§d: <strong>‚Äî</strong></span>
  <span id="pillPeople" class="pill">Personer: <strong>0</strong></span>
  <span id="pillWithCoords" class="pill">Med koordinater: <strong>0</strong></span>
  <span id="pillLinks" class="pill">Kopplingar ritade: <strong>0</strong></span>
</section>

<div class="grid">
  <section class="card" aria-label="Kontroller">
    <h2>Filter & vy</h2>
    <p class="small">Klicka en person f√∂r att zooma och √∂ppna popup.</p>

    <label for="search">S√∂k</label>
    <input id="search" placeholder="S√∂k namn eller plats‚Ä¶" autocomplete="off" />

    <div class="toggleRow" role="group" aria-label="Visningsval">
      <label>
        <input id="toggleLinks" type="checkbox" checked />
        Visa kopplingar (F√∂r√§lder‚ÜíBarn)
      </label>
    </div>

    <div class="actions">
      <button id="refreshBtn" type="button" class="btn secondary">Uppdatera</button>
      <button id="fitBtn" type="button" class="btn">Zooma till alla</button>
      <a class="btn secondary" href="./slaktkort.html">L√§gg till koordinater</a>
    </div>

    <div id="hint" class="hintBox" hidden></div>

    <ul id="list" class="list" aria-label="Personer med koordinater"></ul>

    <div class="actions" style="margin-top:14px;">
      <a class="btn secondary" href="./create-relation.html">‚Üê Tillbaka (Relationer)</a>
      <a class="btn secondary" href="./slaktkort.html">‚Üê Tillbaka (Personer)</a>
    </div>
  </section>

  <section class="card" aria-label="Karta">
    <h2>Karta</h2>
    <p class="small">OpenStreetMap via Leaflet. Kopplingar ritas n√§r b√•da har coords.</p>
    <div id="map" role="application" aria-label="Karta med mark√∂rer och kopplingar"></div>
    <p id="msg" class="muted" aria-live="polite" style="margin-top:10px;"></p>
  </section>
</div>

<script>
  // ============================
  // Estetisk auth-guard
  // ============================
  (function authGuard(){
    try{
      if(sessionStorage.getItem("demo_auth") !== "1"){
        window.location.href = "../index.html";
      }
    }catch{}
  })();

  // ============================
  // Keys (m√•ste matcha dina andra sidor)
  // ============================
  const KEY_TREES  = "slakttradet_trees";
  const KEY_ACTIVE = "slakttradet_active_tree_id";

  const cardsKey = (treeId) => "slakttradet_slaktkort_" + String(treeId);
  const relKey   = (treeId) => "slakttradet_relationer_" + String(treeId);

  // ============================
  // DOM
  // ============================
  const logoutBtn = document.getElementById("logoutBtn");
  const msg = document.getElementById("msg");
  const hint = document.getElementById("hint");

  const pillTree = document.getElementById("pillTree");
  const pillPeople = document.getElementById("pillPeople");
  const pillWithCoords = document.getElementById("pillWithCoords");
  const pillLinks = document.getElementById("pillLinks");

  const searchEl = document.getElementById("search");
  const toggleLinksEl = document.getElementById("toggleLinks");
  const refreshBtn = document.getElementById("refreshBtn");
  const fitBtn = document.getElementById("fitBtn");
  const listEl = document.getElementById("list");

  // ============================
  // Helpers
  // ============================
  function safeParse(raw, fallback){ try{ return JSON.parse(raw); }catch{ return fallback; } }
  function loadJson(key, fallback){
    const raw = localStorage.getItem(key);
    return raw ? safeParse(raw, fallback) : fallback;
  }
  function activeTreeId(){ return localStorage.getItem(KEY_ACTIVE) || ""; }
  function getTrees(){
    const trees = loadJson(KEY_TREES, []);
    return Array.isArray(trees) ? trees : [];
  }
  function activeTreeLabel(){
    const id = activeTreeId();
    if(!id) return "‚Äî";
    const t = getTrees().find(x => String(x.id) === String(id));
    return t ? (t.name || t.id) : id;
  }
  function personName(p){
    const n = `${p.fornamn || ""} ${p.efternamn || ""}`.trim();
    return n || "(namnl√∂s)";
  }
  function escapeHtml(s){
    return String(s || "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function coordsFromPerson(p){
    // accepterar p.coords={lat,lon} eller p.coords="lat, lon"
    if(p && typeof p.coords === "object" && p.coords){
      const lat = Number(p.coords.lat);
      const lon = Number(p.coords.lon);
      if(Number.isFinite(lat) && Number.isFinite(lon)) return { lat, lon };
    }
    if(typeof p.coords === "string"){
      const s = p.coords.trim();
      const parts = s.split(",").map(x => x.trim()).filter(Boolean);
      if(parts.length === 2){
        const lat = Number(parts[0]);
        const lon = Number(parts[1]);
        if(Number.isFinite(lat) && Number.isFinite(lon)) return { lat, lon };
      }
    }
    return null;
  }

  function setPill(el, kind, html){
    el.className = "pill " + (kind || "");
    el.innerHTML = html;
  }

  // ============================
  // Leaflet setup
  // ============================
  const map = L.map("map", { zoomControl: true });
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: 19,
    attribution: '&copy; OpenStreetMap'
  }).addTo(map);

  // Default: Stockholm-ish
  map.setView([59.3293, 18.0686], 5);

  const markerLayer = L.layerGroup().addTo(map);
  const linkLayer = L.layerGroup().addTo(map);

  const markersById = new Map(); // personId -> marker
  const coordsById = new Map();  // personId -> {lat,lon}

  function clearMarkers(){
    markerLayer.clearLayers();
    markersById.clear();
    coordsById.clear();
  }
  function clearLinks(){
    linkLayer.clearLayers();
  }

  function openMarker(personId){
    const m = markersById.get(personId);
    if(!m) return;
    m.openPopup();
    map.setView(m.getLatLng(), Math.max(map.getZoom(), 10), { animate: true });
  }

  function fitToAll(){
    const ll = [];
    markersById.forEach(m => ll.push(m.getLatLng()));
    if(ll.length === 0) return;
    map.fitBounds(L.latLngBounds(ll).pad(0.2));
  }

  // ============================
  // Data loaders
  // ============================
  function loadPeople(){
    const t = activeTreeId();
    if(!t) return [];
    const arr = loadJson(cardsKey(t), []);
    return Array.isArray(arr) ? arr : [];
  }
  function loadRelations(){
    const t = activeTreeId();
    if(!t) return [];
    const arr = loadJson(relKey(t), []);
    return Array.isArray(arr) ? arr : [];
  }

  // ============================
  // Render
  // ============================
  function renderHint(hasTrees, hasActive, peopleWithCoords){
    if(!hasTrees){
      hint.hidden = false;
      hint.innerHTML = "<strong>üö© Inga tr√§d:</strong> G√• till <a href='./trees.html'><code>Tr√§d</code></a> och skapa ett tr√§d.";
      return;
    }
    if(!hasActive){
      hint.hidden = false;
      hint.innerHTML = "<strong>üö© Inget aktivt tr√§d:</strong> V√§lj aktivt tr√§d i <a href='./trees.html'><code>Tr√§d</code></a>.";
      return;
    }
    if(peopleWithCoords.length === 0){
      hint.hidden = false;
      hint.innerHTML =
        "<strong>Tip:</strong> Inga personer har koordinater √§nnu. " +
        "G√• till <a href='./slaktkort.html'><code>Personer</code></a> och s√§tt coords (eller via <a href='./place-picker.html'><code>Plats-picker</code></a>).";
      return;
    }
    hint.hidden = true;
    hint.innerHTML = "";
  }

  function renderList(people){
    listEl.innerHTML = "";
    if(people.length === 0){
      const li = document.createElement("li");
      li.className = "item";
      li.style.cursor = "default";
      li.innerHTML = "<p class='itemTitle'>Inga personer att visa</p><p class='itemMeta'>L√§gg koordinater i Personer.</p>";
      listEl.appendChild(li);
      return;
    }

    for(const p of people){
      const c = coordsFromPerson(p);
      const place = (p.plats || "").trim();
      const year = [
        (p.fodelsear != null ? String(p.fodelsear) : ""),
        (p.dodsar != null ? String(p.dodsar) : "")
      ].filter(Boolean).join("‚Äì");

      const li = document.createElement("li");
      li.className = "item";
      li.dataset.id = String(p.id);

      li.innerHTML =
        "<p class='itemTitle'>" + escapeHtml(personName(p)) + "</p>" +
        "<p class='itemMeta'>" +
        (year ? escapeHtml(year) + " ¬∑ " : "") +
        (place ? escapeHtml(place) + " ¬∑ " : "") +
        (c ? (Number(c.lat).toFixed(4) + ", " + Number(c.lon).toFixed(4)) : "‚Äî") +
        "</p>";

      li.addEventListener("click", () => openMarker(String(p.id)));
      listEl.appendChild(li);
    }
  }

  function renderMarkers(people){
    clearMarkers();

    for(const p of people){
      const c = coordsFromPerson(p);
      if(!c) continue;

      coordsById.set(String(p.id), c);

      const title = personName(p);
      const place = (p.plats || "").trim();
      const note = (p.anteckning || "").trim();

      const popupHtml =
        "<strong>" + escapeHtml(title) + "</strong><br/>" +
        (place ? ("Plats: " + escapeHtml(place) + "<br/>") : "") +
        "Koordinater: " + Number(c.lat).toFixed(5) + ", " + Number(c.lon).toFixed(5) +
        (note ? ("<br/><span style='color:#555'>Anteckning: " + escapeHtml(note.slice(0, 140)) + (note.length > 140 ? "‚Ä¶" : "") + "</span>") : "");

      const m = L.marker([c.lat, c.lon]).addTo(markerLayer).bindPopup(popupHtml);
      markersById.set(String(p.id), m);
    }
  }

  function renderLinks(relations){
    clearLinks();

    if(!toggleLinksEl.checked) {
      pillLinks.innerHTML = "Kopplingar ritade: <strong>0</strong>";
      return 0;
    }

    let drawn = 0;

    // Vi ritar bara FORALDER_BARN, och bara om b√•da har coords
    for(const r of relations){
      if(!r || r.typ !== "FORALDER_BARN") continue;

      const fromId = String(r.franPersonId || "");
      const toId   = String(r.tillPersonId || "");
      if(!fromId || !toId) continue;

      const a = coordsById.get(fromId);
      const b = coordsById.get(toId);
      if(!a || !b) continue;

      // Standard Leaflet polyline (ingen f√§rgspec h√§r ‚Äî enkel)
      const line = L.polyline([[a.lat, a.lon], [b.lat, b.lon]], {
        weight: 3,
        opacity: 0.75
      });

      line.addTo(linkLayer);
      drawn++;
    }

    pillLinks.innerHTML = "Kopplingar ritade: <strong>" + drawn + "</strong>";
    return drawn;
  }

  function currentFiltered(peopleWithCoords){
    const q = String(searchEl.value || "").trim().toLowerCase();
    if(!q) return peopleWithCoords;

    return peopleWithCoords.filter(p => {
      const n = personName(p).toLowerCase();
      const place = String(p.plats || "").toLowerCase();
      return n.includes(q) || place.includes(q);
    });
  }

  function refresh(){
    const trees = getTrees();
    const hasTrees = trees.length > 0;

    const t = activeTreeId();
    const hasActive = !!t;

    const allPeople = hasActive ? loadPeople() : [];
    const allRelations = hasActive ? loadRelations() : [];

    const peopleWithCoords = allPeople.filter(p => !!coordsFromPerson(p));
    const filtered = currentFiltered(peopleWithCoords);

    // Status pills
    setPill(
      pillTree,
      hasActive ? "ok" : (hasTrees ? "warn" : "err"),
      "Aktivt tr√§d: <strong>" + (hasActive ? activeTreeLabel() : "‚Äî") + "</strong>"
    );
    pillPeople.innerHTML = "Personer: <strong>" + allPeople.length + "</strong>";
    pillWithCoords.innerHTML = "Med koordinater: <strong>" + peopleWithCoords.length + "</strong>";

    renderHint(hasTrees, hasActive, peopleWithCoords);

    renderList(filtered);
    renderMarkers(filtered);

    const drawn = renderLinks(allRelations);

    if(markersById.size > 0){
      fitToAll();
      msg.innerHTML =
        "<span class='ok'>Klar.</span> Visar " + markersById.size +
        " mark√∂r(er) och " + drawn + " koppling(ar).";
    }else{
      msg.innerHTML =
        "<span class='error'>Inga mark√∂rer.</span> Inga personer i aktivt tr√§d har koordinater (eller matchar filtret).";
    }
  }

  // ============================
  // Events
  // ============================
  refreshBtn.addEventListener("click", refresh);
  fitBtn.addEventListener("click", () => {
    if(markersById.size > 0) fitToAll();
  });

  let searchTimer = null;
  searchEl.addEventListener("input", () => {
    if(searchTimer) clearTimeout(searchTimer);
    searchTimer = setTimeout(refresh, 120);
  });

  toggleLinksEl.addEventListener("change", refresh);

  logoutBtn.addEventListener("click", () => {
    try{ sessionStorage.removeItem("demo_auth"); }catch{}
    window.location.href = "../index.html";
  });

  // ============================
  // Start
  // ============================
  refresh();
</script>
</body>
</html>
