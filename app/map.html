<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Karta ‚Äì Sl√§ktkort</title>
  <meta name="description" content="Visa personer med koordinater och kopplingar (relationer) i aktivt tr√§d." />

  <!-- =====================================================
       LEAFLET (CDN)
       ===================================================== -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <style>
    :root { color-scheme: light; }
    body{
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      line-height: 1.5;
      margin: 0;
      padding: 24px;
      max-width: 1180px;
      margin-inline: auto;
      background: #fff;
      color: #111;
    }
    a{ color: inherit; text-decoration:none; }

    header{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      margin-bottom:18px;
    }
    h1{ margin:0 0 6px; font-size:1.6rem; }
    .muted{ color:#555; margin:0 0 12px; }

    .topbar{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      margin: 10px 0 0;
    }
    .btn, button{
      display:inline-block;
      padding:10px 12px;
      border:1px solid #333;
      border-radius:10px;
      background:#fff;
      font:inherit;
      cursor:pointer;
      text-decoration:none;
    }
    .btn.secondary{ border-color:#bbb; }
    .btn.disabled{ opacity:.45; cursor:not-allowed; pointer-events:none; }

    .pillRow{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      margin: 10px 0 18px;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border:1px solid #ddd;
      border-radius:999px;
      background:#fafafa;
      font-size:.95rem;
    }
    .pill strong{ font-weight:900; }
    .pill.ok{ border-color:#cfe8cf; background:#f5fff5; }
    .pill.warn{ border-color:#ffe1a6; background:#fff9ee; }
    .pill.err{ border-color:#ffb3b3; background:#fff2f2; }

    .grid{
      display:grid;
      gap:14px;
      grid-template-columns: 1fr;
    }
    @media (min-width: 1080px){
      .grid{ grid-template-columns: 380px 1fr; }
    }

    .card{
      border:1px solid #ddd;
      border-radius:12px;
      padding:16px;
      background:#fff;
      position: relative;
    }
    .card h2{ margin:0 0 6px; font-size:1.15rem; }
    .small{ font-size:.95rem; color:#555; margin:0 0 10px; }

    label{ display:block; margin:10px 0 6px; font-weight:800; }
    input{
      width:100%;
      box-sizing:border-box;
      padding:10px;
      border-radius:10px;
      border:1px solid #bbb;
      font:inherit;
      background:#fff;
    }

    .actions{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      margin-top: 12px;
    }

    .toggleRow{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      margin-top: 10px;
    }
    .toggleRow label{
      display:flex;
      align-items:center;
      gap:10px;
      font-weight:700;
      margin:0;
    }
    .toggleRow input[type="checkbox"]{
      width:auto;
      padding:0;
      margin:0;
    }

    #map{
      width:100%;
      height: 560px;
      border-radius:12px;
      border: 1px solid #ddd;
      overflow:hidden;
      background:#f4f4f4;
    }
    @media (max-width: 520px){
      #map{ height: 440px; }
    }

    .error{ color:#b00020; font-weight:900; }
    .ok{ font-weight:900; }

    .list{
      margin: 10px 0 0;
      padding: 0;
      list-style:none;
      display:flex;
      flex-direction:column;
      gap:10px;
      max-height: 360px;
      overflow:auto;
      border-top: 1px solid #eee;
      padding-top: 10px;
    }
    .item{
      border:1px solid #eee;
      border-radius:12px;
      padding:10px;
      background:#fff;
      cursor:pointer;
    }
    .item:hover{ background:#fafafa; }
    .itemTitle{ font-weight:900; margin:0 0 2px; }
    .itemMeta{ margin:0; color:#555; font-size:.95rem; }
    .itemSub{ margin:4px 0 0; color:#333; font-size:.95rem; }

    .hintBox{
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid #ffe1a6;
      background: #fff9ee;
    }
    code{ background:#f4f4f4; padding:2px 6px; border-radius:6px; }

    /* Popup */
    .popupWrap{ min-width: 220px; max-width: 280px; }
    .popupTitle{ font-weight: 950; margin: 0 0 4px; font-size: 1.05rem; }
    .popupMuted{ margin: 0; color:#555; }
    .popupLine{ margin: 0; color:#333; }
    .popupDivider{ height: 1px; background:#eee; margin: 10px 0; }
    .popupCta{
      display:block;
      width:100%;
      box-sizing:border-box;
      text-align:center;
      padding:10px 12px;
      border:1px solid #333;
      border-radius:10px;
      font-weight:900;
      background:#fff;
    }
    .popupCta:hover{ background:#f5f5f5; }

    /* =====================================================
       PANEL: √ñPPNAR FR√ÖN V√ÑNSTER, MEN BARA √ñVER KARTAN
       (inte √∂ver v√§nsterspalten)
       ===================================================== */
    .mapCard { position: relative; }

    .panel{
      position: absolute;
      inset: 0;
      pointer-events: none;
      z-index: 9999; /* √∂ver Leaflet */
    }
    .panelOverlay{
      position:absolute;
      inset:0;
      background: rgba(0,0,0,.15);
      opacity:0;
      transition: opacity .18s ease;
    }
    .panelSheet{
      position:absolute;
      left: 12px;
      top: 12px;
      bottom: 12px;
      width: min(420px, calc(100% - 24px));
      background:#fff;
      border:1px solid #ddd;
      border-radius:16px;
      box-shadow: 0 10px 40px rgba(0,0,0,.15);
      transform: translateX(-16px);
      opacity:0;
      transition: transform .18s ease, opacity .18s ease;
      overflow:hidden;
      display:flex;
      flex-direction:column;
    }

    /* Mobile: drawer l√§ngst ned (fortfarande bara √∂ver kart-kortet) */
    @media (max-width: 820px){
      .panelSheet{
        left: 12px;
        right: 12px;
        top: auto;
        height: min(78vh, 640px);
        width: auto;
        transform: translateY(16px);
      }
    }

    .panel.open{ pointer-events: auto; }
    .panel.open .panelOverlay{ opacity:1; }
    .panel.open .panelSheet{ opacity:1; transform: translateX(0); }
    @media (max-width: 820px){
      .panel.open .panelSheet{ transform: translateY(0); }
    }

    .panelHeader{
      padding: 14px 14px 10px;
      border-bottom: 1px solid #eee;
      display:flex;
      gap:10px;
      align-items:flex-start;
      justify-content:space-between;
    }
    .panelTitle{
      margin:0;
      font-size: 1.2rem;
      font-weight: 950;
      line-height: 1.2;
    }
    .panelMeta{
      margin: 6px 0 0;
      color:#555;
      font-size:.95rem;
    }
    .panelClose{
      flex:0 0 auto;
      border-color:#bbb;
      padding:8px 10px;
      border-radius:12px;
    }

    .panelBody{
      padding: 12px 14px 14px;
      overflow:auto;
    }
    .panelSection{
      margin-top: 12px;
    }
    .panelSection h3{
      margin: 0 0 6px;
      font-size: 1.02rem;
      font-weight: 950;
    }
    .panelActions{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      margin-top: 12px;
    }

    /* Mini-tree (chips) */
    .miniTree{
      border:1px solid #eee;
      border-radius:14px;
      padding: 12px;
      background:#fff;
    }
    .miniGrid{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      grid-template-rows: auto auto auto;
      gap: 10px 10px;
      align-items:center;
    }
    .slotParents{ grid-column: 1 / 4; grid-row: 1; display:flex; gap:10px; flex-wrap:wrap; justify-content:center; }
    .slotPartner{ grid-column: 1; grid-row: 2; display:flex; gap:10px; flex-wrap:wrap; justify-content:center; }
    .slotFocus{ grid-column: 2; grid-row: 2; display:flex; justify-content:center; }
    .slotChildren{ grid-column: 1 / 4; grid-row: 3; display:flex; gap:10px; flex-wrap:wrap; justify-content:center; }

    .chip{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border:1px solid #ddd;
      border-radius:999px;
      background:#fafafa;
      font: inherit;
      cursor:pointer;
      max-width: 100%;
    }
    .chip:hover{ background:#f5f5f5; }
    .chip.primary{
      border-color:#333;
      background:#fff;
      font-weight:950;
    }
    .chip.muted{
      border-color:#eee;
      background:#fff;
      cursor: default;
    }
    .chip .chipLabel{
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      max-width: 240px;
    }
    .chip small{
      color:#555;
      font-weight:700;
    }

    .expandBox{
      margin-top: 10px;
      padding: 10px 12px;
      border: 1px solid #eee;
      border-radius: 12px;
      background: #fff;
    }
    .expandList{
      margin: 8px 0 0;
      padding: 0;
      list-style:none;
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .expandItemBtn{
      width: 100%;
      text-align:left;
      padding:10px 12px;
      border:1px solid #ddd;
      border-radius:12px;
      background:#fff;
      cursor:pointer;
      font:inherit;
    }
    .expandItemBtn:hover{ background:#fafafa; }
  </style>
</head>

<body>
<header>
  <div>
    <h1>Karta</h1>
    <p class="muted">Klicka en mark√∂r (eller en person i listan) f√∂r att se sl√§kt√∂versikt i sidopanel.</p>

    <nav class="topbar" aria-label="Navigation">
      <a class="btn secondary" href="../start.html">Start</a>
      <a class="btn secondary" href="./trees.html">Tr√§d</a>
      <a class="btn secondary" href="./slaktkort.html">Personer</a>
      <a class="btn secondary" href="./create-relation.html">Relationer</a>
      <a class="btn" href="./map.html">Karta</a>
      <a class="btn secondary" href="./place-picker.html">Plats-picker</a>
    </nav>
  </div>

  <div class="actions" style="justify-content:flex-end;">
    <button id="logoutBtn" class="btn secondary" type="button">Logga ut</button>
  </div>
</header>

<section class="pillRow" aria-label="Status">
  <span id="pillTree" class="pill warn">Aktivt tr√§d: <strong>‚Äî</strong></span>
  <span id="pillPeople" class="pill">Personer: <strong>0</strong></span>
  <span id="pillWithCoords" class="pill">Med koordinater: <strong>0</strong></span>
  <span id="pillLinks" class="pill">Kopplingar ritade: <strong>0</strong></span>
</section>

<div class="grid">
  <section class="card" aria-label="Kontroller">
    <h2>Filter & vy</h2>
    <p class="small">S√∂k p√• namn eller plats. Klicka i listan f√∂r att zooma och √∂ppna panel.</p>

    <label for="search">S√∂k</label>
    <input id="search" placeholder="S√∂k namn eller plats‚Ä¶" autocomplete="off" />

    <div class="actions" style="margin-top:10px;">
      <button id="clearSearchBtn" type="button" class="btn secondary">Rensa s√∂k</button>
      <span id="matchInfo" class="small" aria-live="polite">‚Äî</span>
    </div>

    <div class="toggleRow" role="group" aria-label="Visningsval">
      <label>
        <input id="toggleParentChild" type="checkbox" checked />
        Visa kopplingar (F√∂r√§lder‚ÜíBarn)
      </label>
      <label>
        <input id="togglePartner" type="checkbox" />
        Visa kopplingar (Partner)
      </label>
      <label>
        <input id="toggleFocusOnly" type="checkbox" />
        Visa bara kopplingar f√∂r fokus
      </label>
    </div>

    <div class="hintBox" style="margin-top:10px;">
      <strong>Legend:</strong>
      <div class="small" style="margin-top:6px;">
        Hel linje = F√∂r√§lder‚ÜíBarn<br />
        Streckad linje = Partner
      </div>
    </div>

    <div class="actions">
      <button id="refreshBtn" type="button" class="btn secondary">Uppdatera</button>
      <button id="fitBtn" type="button" class="btn">Zooma till alla</button>
      <a class="btn secondary" href="./slaktkort.html">L√§gg till plats</a>
    </div>

    <div id="hint" class="hintBox" hidden></div>

    <ul id="list" class="list" aria-label="Personer med koordinater"></ul>

    <div class="actions" style="margin-top:14px;">
      <a class="btn secondary" href="./create-relation.html">‚Üê Tillbaka (Relationer)</a>
      <a class="btn secondary" href="./slaktkort.html">‚Üê Tillbaka (Personer)</a>
    </div>
  </section>

  <section class="card mapCard" aria-label="Karta">
    <h2>Karta</h2>
    <p class="small">OpenStreetMap via Leaflet.</p>
    <div id="map" role="application" aria-label="Karta med mark√∂rer och kopplingar"></div>
    <p id="msg" class="muted" aria-live="polite" style="margin-top:10px;"></p>

    <!-- =====================================================
         SIDE PANEL (√ñVER KARTAN)
         ===================================================== -->
    <div id="panel" class="panel" aria-hidden="true">
      <div id="panelOverlay" class="panelOverlay" tabindex="-1" aria-label="St√§ng panel"></div>

      <aside class="panelSheet" role="dialog" aria-modal="true" aria-label="Sl√§kt√∂versikt">
        <div class="panelHeader">
          <div style="min-width:0;">
            <h2 id="panelName" class="panelTitle">‚Äî</h2>
            <p id="panelMeta" class="panelMeta">‚Äî</p>
          </div>
          <button id="panelClose" class="btn panelClose" type="button" aria-label="St√§ng">St√§ng</button>
        </div>

        <div class="panelBody">
          <div class="panelSection">
            <h3>Sl√§kt (√∂versikt)</h3>

            <div class="miniTree" aria-label="Mini-tr√§d">
              <div class="miniGrid">
                <div id="slotParents" class="slotParents"></div>
                <div id="slotPartner" class="slotPartner"></div>
                <div id="slotFocus" class="slotFocus"></div>
                <div id="slotChildren" class="slotChildren"></div>
              </div>

              <div id="expandBox" class="expandBox" hidden>
                <div style="display:flex; align-items:center; justify-content:space-between; gap:10px;">
                  <strong id="expandTitle">Barn</strong>
                  <button id="expandClose" class="btn secondary" type="button" style="padding:8px 10px;">St√§ng lista</button>
                </div>
                <ul id="expandList" class="expandList" aria-label="Lista"></ul>
              </div>
            </div>

            <p id="panelHint" class="small" style="margin-top:10px;">Tips: klicka p√• en chip f√∂r att byta fokus.</p>

            <div class="panelActions">
              <a class="btn secondary" href="./slaktkort.html">G√• till Personer</a>
              <a class="btn secondary" href="./create-relation.html">G√• till Relationer</a>
            </div>
          </div>

          <div class="panelSection">
            <h3>Teknisk info</h3>
            <p class="small" id="panelTech">Dold som standard. (Visa h√§r bara om du vill fels√∂ka.)</p>
          </div>
        </div>
      </aside>
    </div>
  </section>
</div>

<script>
  // =====================================================
  // AUTH-GUARD (DEMO)
  // =====================================================
  (function authGuard(){
    try{
      if(sessionStorage.getItem("demo_auth") !== "1"){
        window.location.href = "../index.html";
      }
    }catch{}
  })();

  // =====================================================
  // STORAGE KEYS (M√ÖSTE MATCHA ANDRA SIDOR)
  // =====================================================
  const KEY_TREES  = "slakttradet_trees";
  const KEY_ACTIVE = "slakttradet_active_tree_id";

  const cardsKey = (treeId) => "slakttradet_slaktkort_" + String(treeId);
  const relKey   = (treeId) => "slakttradet_relationer_" + String(treeId);

  // =====================================================
  // DOM
  // =====================================================
  const logoutBtn = document.getElementById("logoutBtn");

  const msg = document.getElementById("msg");
  const hint = document.getElementById("hint");

  const pillTree = document.getElementById("pillTree");
  const pillPeople = document.getElementById("pillPeople");
  const pillWithCoords = document.getElementById("pillWithCoords");
  const pillLinks = document.getElementById("pillLinks");

  const searchEl = document.getElementById("search");
  const clearSearchBtn = document.getElementById("clearSearchBtn");
  const matchInfo = document.getElementById("matchInfo");

  const toggleParentChildEl = document.getElementById("toggleParentChild");
  const togglePartnerEl = document.getElementById("togglePartner");
  const toggleFocusOnlyEl = document.getElementById("toggleFocusOnly");

  const refreshBtn = document.getElementById("refreshBtn");
  const fitBtn = document.getElementById("fitBtn");
  const listEl = document.getElementById("list");

  // =====================================================
  // SIDE PANEL DOM
  // =====================================================
  const panel = document.getElementById("panel");
  const panelOverlay = document.getElementById("panelOverlay");
  const panelClose = document.getElementById("panelClose");

  const panelName = document.getElementById("panelName");
  const panelMeta = document.getElementById("panelMeta");
  const panelTech = document.getElementById("panelTech");

  const slotParents = document.getElementById("slotParents");
  const slotPartner = document.getElementById("slotPartner");
  const slotFocus = document.getElementById("slotFocus");
  const slotChildren = document.getElementById("slotChildren");

  const expandBox = document.getElementById("expandBox");
  const expandTitle = document.getElementById("expandTitle");
  const expandClose = document.getElementById("expandClose");
  const expandList = document.getElementById("expandList");

  // =====================================================
  // JSON HELPERS
  // =====================================================
  function safeParse(raw, fallback){
    try{ return JSON.parse(raw); }
    catch{ return fallback; }
  }

  function loadJson(key, fallback){
    const raw = localStorage.getItem(key);
    return raw ? safeParse(raw, fallback) : fallback;
  }

  // =====================================================
  // ACTIVE TREE
  // =====================================================
  function activeTreeId(){
    return localStorage.getItem(KEY_ACTIVE) || "";
  }

  function getTrees(){
    const trees = loadJson(KEY_TREES, []);
    return Array.isArray(trees) ? trees : [];
  }

  function activeTreeLabel(){
    const id = activeTreeId();
    if(!id) return "‚Äî";
    const t = getTrees().find(x => String(x.id) === String(id));
    return t ? (t.name || t.id) : id;
  }

  // =====================================================
  // FORMAT HELPERS
  // =====================================================
  function personName(p){
    const n = `${p.fornamn || ""} ${p.efternamn || ""}`.trim();
    return n || "(namnl√∂s)";
  }

  function yearsLine(p){
    const a = (p && p.fodelsear != null && String(p.fodelsear).trim() !== "") ? String(p.fodelsear).trim() : "";
    const b = (p && p.dodsar != null && String(p.dodsar).trim() !== "") ? String(p.dodsar).trim() : "";
    if(!a && !b) return "";
    if(a && b) return `${a}‚Äì${b}`;
    return a ? `${a}‚Äì` : `‚Äì${b}`;
  }

  function escapeHtml(s){
    return String(s || "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  // =====================================================
  // COORDS PARSE + RANGE CHECK
  // =====================================================
  function inLatLonRange(lat, lon){
    return Number.isFinite(lat) && Number.isFinite(lon) &&
      lat >= -90 && lat <= 90 &&
      lon >= -180 && lon <= 180;
  }

  function coordsFromPerson(p){
    if(p && typeof p.coords === "object" && p.coords){
      const lat = Number(p.coords.lat);
      const lon = Number(p.coords.lon);
      if(inLatLonRange(lat, lon)) return { lat, lon };
      return null;
    }

    if(typeof p.coords === "string"){
      const s = p.coords.trim();
      const parts = s.split(",").map(x => x.trim()).filter(Boolean);
      if(parts.length === 2){
        const lat = Number(parts[0]);
        const lon = Number(parts[1]);
        if(inLatLonRange(lat, lon)) return { lat, lon };
      }
    }

    return null;
  }

  // =====================================================
  // UI HELPER
  // =====================================================
  function setPill(el, kind, html){
    el.className = "pill " + (kind || "");
    el.innerHTML = html;
  }

  // =====================================================
  // OFFLINE PLATS (FALUN / DALARNA)
  // =====================================================
  const FALUN = { lat: 60.6070, lon: 15.6355 };
  const FALUN_RADIUS_KM = 15;

  const DALARNA_BOX = { minLat: 59.8, maxLat: 61.4, minLon: 12.2, maxLon: 16.9 };

  function haversineKm(a, b){
    const R = 6371;
    const toRad = (d) => d * Math.PI / 180;
    const dLat = toRad(b.lat - a.lat);
    const dLon = toRad(b.lon - a.lon);
    const lat1 = toRad(a.lat);
    const lat2 = toRad(b.lat);
    const s =
      Math.sin(dLat/2)**2 +
      Math.cos(lat1) * Math.cos(lat2) * (Math.sin(dLon/2)**2);
    return 2 * R * Math.asin(Math.min(1, Math.sqrt(s)));
  }

  function inBox(c, box){
    return c.lat >= box.minLat && c.lat <= box.maxLat && c.lon >= box.minLon && c.lon <= box.maxLon;
  }

  function placeFromCoords(coords){
    if(!coords) return { primary:"", secondary:"" };

    const kmToFalun = haversineKm(coords, FALUN);
    if(kmToFalun <= FALUN_RADIUS_KM){
      return { primary: "Falun", secondary: "Dalarna" };
    }

    if(inBox(coords, DALARNA_BOX)){
      return { primary: "Dalarna", secondary: "" };
    }

    return { primary: "Sverige", secondary: "" };
  }

  // =====================================================
  // LOADERS
  // =====================================================
  function loadPeople(){
    const t = activeTreeId();
    if(!t) return [];
    const arr = loadJson(cardsKey(t), []);
    return Array.isArray(arr) ? arr : [];
  }

  function loadRelations(){
    const t = activeTreeId();
    if(!t) return [];
    const arr = loadJson(relKey(t), []);
    return Array.isArray(arr) ? arr : [];
  }

  function getPersonById(people, id){
    return people.find(p => String(p.id) === String(id)) || null;
  }

  // =====================================================
  // LEAFLET SETUP
  // =====================================================
  const map = L.map("map", { zoomControl: true });

  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: 19,
    attribution: '&copy; OpenStreetMap'
  }).addTo(map);

  map.setView([59.3293, 18.0686], 5);

  const markerLayer = L.layerGroup().addTo(map);
  const linkLayer = L.layerGroup().addTo(map);

  const markersById = new Map(); // personId -> marker (bara filtrerade / synliga)
  const coordsById = new Map();  // personId -> {lat,lon} (alla med coords)

  function clearMarkersOnly(){
    markerLayer.clearLayers();
    markersById.clear();
  }

  function clearLinks(){
    linkLayer.clearLayers();
  }

  function rebuildCoordsIndex(peopleWithCoordsAll){
    coordsById.clear();
    for(const p of peopleWithCoordsAll){
      const c = coordsFromPerson(p);
      if(!c) continue;
      coordsById.set(String(p.id), c);
    }
  }

  function fitToAllCoords(){
    const ll = [];
    coordsById.forEach(c => ll.push(L.latLng(c.lat, c.lon)));
    if(ll.length === 0) return;
    map.fitBounds(L.latLngBounds(ll).pad(0.2));
  }

  function openMarker(personId, opts){
    const m = markersById.get(String(personId));
    if(m){
      m.openPopup();
      map.setView(m.getLatLng(), Math.max(map.getZoom(), 10), { animate: true });
    }
    if(opts && opts.openPanel){
      openPanel(String(personId), { focusMap: false });
    }
  }

  // =====================================================
  // POPUP HTML
  // =====================================================
  function buildPopupHtml(person, coords){
    const name = personName(person);
    const years = yearsLine(person);

    const place = placeFromCoords(coords);
    const placeLine = place.primary
      ? ("<p class='popupLine'>Plats: <strong>" + escapeHtml(place.primary) + "</strong>" +
         (place.secondary ? (" <span class='popupMuted'>(" + escapeHtml(place.secondary) + ")</span>") : "") +
         "</p>")
      : "";

    const pid = escapeHtml(String(person.id || ""));

    return (
      "<div class='popupWrap'>" +
        "<p class='popupTitle'>" + escapeHtml(name) + "</p>" +
        (years ? ("<p class='popupMuted'>" + escapeHtml(years) + "</p>") : "") +
        placeLine +
        "<div class='popupDivider'></div>" +
        "<button class='popupCta js-open-panel' type='button' data-personid='" + pid + "'>Visa sl√§kt</button>" +
      "</div>"
    );
  }

  map.on("popupopen", (e) => {
    try{
      const el = e.popup.getElement();
      if(!el) return;

      const btn = el.querySelector(".js-open-panel");
      if(!btn) return;

      if(btn.dataset.bound === "1") return;
      btn.dataset.bound = "1";

      btn.addEventListener("click", () => {
        const pid = btn.getAttribute("data-personid");
        if(pid) openPanel(String(pid), { focusMap: true });
      });
    }catch{}
  });

  // =====================================================
  // FILTERING
  // =====================================================
  function currentFiltered(peopleWithCoords){
    const q = String(searchEl.value || "").trim().toLowerCase();
    if(!q) return peopleWithCoords;

    return peopleWithCoords.filter(p => {
      const n = personName(p).toLowerCase();
      const coords = coordsFromPerson(p);
      const place = coords ? placeFromCoords(coords) : { primary:"", secondary:"" };
      const placeTxt = (place.primary + " " + place.secondary).toLowerCase();
      const savedPlace = String(p.plats || "").toLowerCase();
      return n.includes(q) || savedPlace.includes(q) || placeTxt.includes(q);
    });
  }

  // =====================================================
  // LIST RENDER
  // =====================================================
  function renderList(people){
    listEl.innerHTML = "";

    if(people.length === 0){
      const li = document.createElement("li");
      li.className = "item";
      li.style.cursor = "default";
      li.innerHTML = "<p class='itemTitle'>Inga personer att visa</p><p class='itemMeta'>L√§gg koordinater i Personer.</p>";
      listEl.appendChild(li);
      return;
    }

    for(const p of people){
      const c = coordsFromPerson(p);
      const years = yearsLine(p);

      const place = c ? placeFromCoords(c) : { primary:"", secondary:"" };
      const placeLine = place.primary
        ? ("Plats: " + place.primary + (place.secondary ? " (" + place.secondary + ")" : ""))
        : (String(p.plats || "").trim() ? ("Plats: " + String(p.plats || "").trim()) : "Plats: ‚Äî");

      const li = document.createElement("li");
      li.className = "item";
      li.dataset.id = String(p.id);

      li.innerHTML =
        "<p class='itemTitle'>" + escapeHtml(personName(p)) + "</p>" +
        "<p class='itemMeta'>" + escapeHtml(years || "‚Äî") + "</p>" +
        "<p class='itemSub'>" + escapeHtml(placeLine) + "</p>";

      li.addEventListener("click", () => {
        const id = String(p.id);
        openMarker(id, { openPanel: true });
      });

      listEl.appendChild(li);
    }
  }

  // =====================================================
  // MARKER RENDER (endast filtrerade/synliga)
  // =====================================================
  function renderMarkers(peopleVisible){
    clearMarkersOnly();

    for(const p of peopleVisible){
      const c = coordsFromPerson(p);
      if(!c) continue;

      const popupHtml = buildPopupHtml(p, c);
      const m = L.marker([c.lat, c.lon]).addTo(markerLayer).bindPopup(popupHtml);

      markersById.set(String(p.id), m);
    }
  }

  // =====================================================
  // LINK RENDER
  // =====================================================
  function renderLinks(relations, focusId){
    clearLinks();

    const showParentChild = !!toggleParentChildEl.checked;
    const showPartner = !!togglePartnerEl.checked;
    const focusOnly = !!toggleFocusOnlyEl.checked;

    if(!showParentChild && !showPartner){
      pillLinks.innerHTML = "Kopplingar ritade: <strong>0</strong>";
      return { parentChild: 0, partner: 0, total: 0 };
    }

    let drawnPC = 0;
    let drawnPartner = 0;

    const seen = new Set();

    const focus = String(focusId || "");
    const useFocusFilter = focusOnly && !!focus;

    for(const r of relations){
      if(!r || !r.typ) continue;

      if(showParentChild && r.typ === "FORALDER_BARN"){
        const fromId = String(r.franPersonId || "");
        const toId   = String(r.tillPersonId || "");
        if(!fromId || !toId) continue;

        if(useFocusFilter && fromId !== focus && toId !== focus) continue;

        const key = "PC:" + fromId + "->" + toId;
        if(seen.has(key)) continue;
        seen.add(key);

        const a = coordsById.get(fromId);
        const b = coordsById.get(toId);
        if(!a || !b) continue;

        L.polyline([[a.lat, a.lon], [b.lat, b.lon]], {
          weight: 3,
          opacity: 0.75
        }).addTo(linkLayer);

        drawnPC++;
        continue;
      }

      if(showPartner && r.typ === "PARTNER"){
        const aId = String(r.personAId || "");
        const bId = String(r.personBId || "");
        if(!aId || !bId) continue;

        if(useFocusFilter && aId !== focus && bId !== focus) continue;

        const low = aId < bId ? aId : bId;
        const high = aId < bId ? bId : aId;

        const key = "P:" + low + "--" + high;
        if(seen.has(key)) continue;
        seen.add(key);

        const a = coordsById.get(aId);
        const b = coordsById.get(bId);
        if(!a || !b) continue;

        L.polyline([[a.lat, a.lon], [b.lat, b.lon]], {
          weight: 3,
          opacity: 0.65,
          dashArray: "7 9"
        }).addTo(linkLayer);

        drawnPartner++;
      }
    }

    const total = drawnPC + drawnPartner;

    pillLinks.innerHTML =
      "Kopplingar ritade: <strong>" + total + "</strong>" +
      " <span class='popupMuted'>(F√∂r√§lder‚ÜíBarn: " + drawnPC + ", Partner: " + drawnPartner + ")</span>";

    return { parentChild: drawnPC, partner: drawnPartner, total };
  }

  // =====================================================
  // HINT RENDER
  // =====================================================
  function renderHint(hasTrees, hasActive, peopleWithCoords){
    if(!hasTrees){
      hint.hidden = false;
      hint.innerHTML = "<strong>üö© Inga tr√§d:</strong> G√• till <a href='./trees.html'><code>Tr√§d</code></a> och skapa ett tr√§d.";
      return;
    }
    if(!hasActive){
      hint.hidden = false;
      hint.innerHTML = "<strong>üö© Inget aktivt tr√§d:</strong> V√§lj aktivt tr√§d i <a href='./trees.html'><code>Tr√§d</code></a>.";
      return;
    }
    if(peopleWithCoords.length === 0){
      hint.hidden = false;
      hint.innerHTML =
        "<strong>Tips:</strong> Inga personer har plats √§nnu. " +
        "G√• till <a href='./slaktkort.html'><code>Personer</code></a> och s√§tt coords (eller via <a href='./place-picker.html'><code>Plats-picker</code></a>).";
      return;
    }
    hint.hidden = true;
    hint.innerHTML = "";
  }

  // =====================================================
  // SIDE PANEL STATE
  // =====================================================
  let panelPersonId = "";
  let expandedMode = "NONE"; // "NONE" | "BARN" | "PARTNER"

  function closePanel(){
    panel.classList.remove("open");
    panel.setAttribute("aria-hidden","true");
    panelPersonId = "";
    expandedMode = "NONE";
  }

  function openPanel(personId, opts){
    panelPersonId = String(personId || "");
    if(!panelPersonId) return;

    panel.classList.add("open");
    panel.setAttribute("aria-hidden","false");
    expandedMode = "NONE";

    renderPanel(panelPersonId);

    // uppdatera l√§nkar om focusOnly √§r aktiv
    try{ refreshLinksOnly(); }catch{}

    if(opts && opts.focusMap){
      const m = markersById.get(panelPersonId);
      if(m){
        m.openPopup();
        map.setView(m.getLatLng(), Math.max(map.getZoom(), 10), { animate: true });
      }
    }
  }

  function makeChip(label, sub, personId, kind){
    const btn = document.createElement("button");
    btn.type = "button";
    btn.className = "chip " + (kind || "");

    if(!personId){
      btn.classList.add("muted");
      btn.style.cursor = "default";
      btn.setAttribute("aria-disabled","true");
    }

    const span = document.createElement("span");
    span.className = "chipLabel";
    span.textContent = label || "‚Äî";
    btn.appendChild(span);

    if(sub){
      const sm = document.createElement("small");
      sm.textContent = sub;
      btn.appendChild(sm);
    }

    if(personId){
      btn.addEventListener("click", () => {
        openPanel(String(personId), { focusMap: true });
      });
    }

    return btn;
  }

  function setExpandList(title, people){
    expandTitle.textContent = title;
    expandList.innerHTML = "";

    for(const p of people){
      const li = document.createElement("li");

      const b = document.createElement("button");
      b.type = "button";
      b.className = "expandItemBtn";
      b.textContent = personName(p) + (yearsLine(p) ? (" ¬∑ " + yearsLine(p)) : "");

      b.addEventListener("click", () => openPanel(String(p.id), { focusMap: true }));

      li.appendChild(b);
      expandList.appendChild(li);
    }
  }

  function getFamily(focusId, people, rels){
    const id = String(focusId);

    const parents = rels
      .filter(r => r && r.typ === "FORALDER_BARN" && String(r.tillPersonId) === id)
      .map(r => String(r.franPersonId));

    const children = rels
      .filter(r => r && r.typ === "FORALDER_BARN" && String(r.franPersonId) === id)
      .map(r => String(r.tillPersonId));

    const partners = rels
      .filter(r => r && r.typ === "PARTNER" && (String(r.personAId) === id || String(r.personBId) === id))
      .map(r => (String(r.personAId) === id ? String(r.personBId) : String(r.personAId)));

    const uniq = (arr) => [...new Set(arr)].filter(Boolean);
    const toPeople = (ids) => uniq(ids).map(pid => getPersonById(people, pid)).filter(Boolean);

    return {
      parents: toPeople(parents),
      children: toPeople(children),
      partners: toPeople(partners)
    };
  }

  function renderPanel(focusId){
    const people = loadPeople();
    const rels = loadRelations();

    const p = getPersonById(people, focusId);

    if(!p){
      panelName.textContent = "Ok√§nd person";
      panelMeta.textContent = "‚Äî";

      slotParents.innerHTML = "";
      slotPartner.innerHTML = "";
      slotFocus.innerHTML = "";
      slotChildren.innerHTML = "";

      expandBox.hidden = true;
      expandList.innerHTML = "";

      panelTech.textContent = "‚Äî";
      return;
    }

    const name = personName(p);
    const years = yearsLine(p);

    const coords = coordsFromPerson(p);
    const place = coords ? placeFromCoords(coords) : { primary:"", secondary:"" };

    panelName.textContent = name;

    let meta = "";
    if(years) meta += years;

    if(place.primary){
      meta += (meta ? " ¬∑ " : "") + "Plats: " + place.primary + (place.secondary ? " (" + place.secondary + ")" : "");
    }

    panelMeta.textContent = meta || "‚Äî";

    if(coords){
      panelTech.textContent = "Koordinater: " + coords.lat.toFixed(4) + ", " + coords.lon.toFixed(4);
    }else{
      panelTech.textContent = "Koordinater: ‚Äî";
    }

    const fam = getFamily(focusId, people, rels);

    slotParents.innerHTML = "";
    slotPartner.innerHTML = "";
    slotFocus.innerHTML = "";
    slotChildren.innerHTML = "";

    if(fam.parents.length > 0){
      for(const par of fam.parents.slice(0, 2)){
        slotParents.appendChild(makeChip(personName(par), "F√∂r√§lder", par.id, ""));
      }
      if(fam.parents.length > 2){
        slotParents.appendChild(makeChip("+" + (fam.parents.length - 2), "fler", null, ""));
      }
    }else{
      slotParents.appendChild(makeChip("‚Äî", "F√∂r√§ldrar", null, "muted"));
    }

    if(fam.partners.length > 0){
      const first = fam.partners[0];
      slotPartner.appendChild(makeChip(personName(first), "Partner", first.id, ""));

      if(fam.partners.length > 1){
        const more = document.createElement("button");
        more.type = "button";
        more.className = "chip";
        more.innerHTML = "<span class='chipLabel'>+" + (fam.partners.length - 1) + "</span><small>fler</small>";

        more.addEventListener("click", () => {
          expandedMode = "PARTNER";
          expandBox.hidden = false;
          setExpandList("Partner", fam.partners);
        });

        slotPartner.appendChild(more);
      }
    }else{
      slotPartner.appendChild(makeChip("‚Äî", "Partner", null, "muted"));
    }

    slotFocus.appendChild(makeChip(name, "Fokus", focusId, "primary"));

    if(fam.children.length > 0){
      const visible = fam.children.slice(0, 4);

      for(const ch of visible){
        slotChildren.appendChild(makeChip(personName(ch), "Barn", ch.id, ""));
      }

      if(fam.children.length > 4){
        const moreN = fam.children.length - 4;

        const more = document.createElement("button");
        more.type = "button";
        more.className = "chip";
        more.innerHTML = "<span class='chipLabel'>+" + moreN + "</span><small>Visa fler</small>";

        more.addEventListener("click", () => {
          expandedMode = "BARN";
          expandBox.hidden = false;
          setExpandList("Barn", fam.children);
        });

        slotChildren.appendChild(more);
      }
    }else{
      slotChildren.appendChild(makeChip("‚Äî", "Barn", null, "muted"));
    }

    if(expandedMode === "NONE"){
      expandBox.hidden = true;
      expandList.innerHTML = "";
    }
  }

  // =====================================================
  // PANEL EVENTS
  // =====================================================
  panelClose.addEventListener("click", () => { closePanel(); try{ refreshLinksOnly(); }catch{} });
  panelOverlay.addEventListener("click", () => { closePanel(); try{ refreshLinksOnly(); }catch{} });

  expandClose.addEventListener("click", () => {
    expandedMode = "NONE";
    expandBox.hidden = true;
    expandList.innerHTML = "";
  });

  document.addEventListener("keydown", (e) => {
    if(e.key === "Escape" && panel.classList.contains("open")){
      closePanel();
      try{ refreshLinksOnly(); }catch{}
    }
  });

  // =====================================================
  // REFRESH CORE
  // =====================================================
  let lastAllRelations = [];
  let lastAllPeople = [];
  let lastPeopleWithCoordsAll = [];

  function refreshLinksOnly(){
    const focusId = panel.classList.contains("open") ? panelPersonId : "";
    renderLinks(lastAllRelations, focusId);
  }

  function refresh(){
    const trees = getTrees();
    const hasTrees = trees.length > 0;

    const t = activeTreeId();
    const hasActive = !!t;

    const allPeople = hasActive ? loadPeople() : [];
    const allRelations = hasActive ? loadRelations() : [];

    lastAllPeople = allPeople;
    lastAllRelations = allRelations;

    const peopleWithCoordsAll = allPeople.filter(p => !!coordsFromPerson(p));
    lastPeopleWithCoordsAll = peopleWithCoordsAll;

    rebuildCoordsIndex(peopleWithCoordsAll);

    const filtered = currentFiltered(peopleWithCoordsAll);

    setPill(
      pillTree,
      hasActive ? "ok" : (hasTrees ? "warn" : "err"),
      "Aktivt tr√§d: <strong>" + (hasActive ? escapeHtml(activeTreeLabel()) : "‚Äî") + "</strong>"
    );

    pillPeople.innerHTML = "Personer: <strong>" + allPeople.length + "</strong>";
    pillWithCoords.innerHTML = "Med koordinater: <strong>" + peopleWithCoordsAll.length + "</strong>";

    matchInfo.textContent =
      filtered.length + " matchar filtret" +
      (peopleWithCoordsAll.length ? (" (av " + peopleWithCoordsAll.length + ")") : "");

    renderHint(hasTrees, hasActive, peopleWithCoordsAll);

    renderList(filtered);
    renderMarkers(filtered);

    const focusId = panel.classList.contains("open") ? panelPersonId : "";
    const drawn = renderLinks(allRelations, focusId);

    if(coordsById.size > 0){
      fitToAllCoords();

      msg.innerHTML =
        "<span class='ok'>Klar.</span> Visar " +
        markersById.size + " mark√∂r(er), " +
        coordsById.size + " med koordinater och " +
        (drawn && drawn.total != null ? drawn.total : 0) + " koppling(ar).";
    }else{
      msg.innerHTML =
        "<span class='error'>Inga mark√∂rer.</span> Inga personer i aktivt tr√§d har koordinater (eller matchar filtret).";
    }

    if(panel.classList.contains("open") && panelPersonId){
      const exists = allPeople.some(p => String(p.id) === String(panelPersonId));
      if(!exists){
        closePanel();
        refreshLinksOnly();
      }else{
        renderPanel(panelPersonId);
      }
    }
  }

  // =====================================================
  // EVENTS (UI)
  // =====================================================
  refreshBtn.addEventListener("click", refresh);

  fitBtn.addEventListener("click", () => {
    if(coordsById.size > 0) fitToAllCoords();
  });

  let searchTimer = null;
  searchEl.addEventListener("input", () => {
    if(searchTimer) clearTimeout(searchTimer);
    searchTimer = setTimeout(refresh, 120);
  });

  searchEl.addEventListener("keydown", (e) => {
    if(e.key === "Enter"){
      e.preventDefault();
      refresh();
    }
  });

  clearSearchBtn.addEventListener("click", () => {
    searchEl.value = "";
    refresh();
    try{ searchEl.focus(); }catch{}
  });

  toggleParentChildEl.addEventListener("change", refreshLinksOnly);
  togglePartnerEl.addEventListener("change", refreshLinksOnly);
  toggleFocusOnlyEl.addEventListener("change", refreshLinksOnly);

  logoutBtn.addEventListener("click", () => {
    try{ sessionStorage.removeItem("demo_auth"); }catch{}
    window.location.href = "../index.html";
  });

  // =====================================================
  // START
  // =====================================================
  refresh();
</script>
</body>
</html>
