<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Karta – Släktkort</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    :root { color-scheme: light; }

    body{
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      margin:0;
      padding:24px;
      max-width:1180px;
      margin-inline:auto;
      background:#fff;
      color:#111;
      line-height:1.5;
    }

    a{ color:inherit; text-decoration:none; }

    header{
      display:flex;
      justify-content:space-between;
      gap:12px;
      margin-bottom:16px;
    }

    h1{ margin:0; font-size:1.6rem; }
    .muted{ color:#555; margin:6px 0 0; }

    .topbar{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top:10px;
    }

    .btn{
      padding:10px 12px;
      border-radius:12px;
      border:1px solid #bbb;
      background:#fff;
      font:inherit;
      cursor:pointer;
    }

    .grid{
      display:grid;
      gap:14px;
      grid-template-columns:1fr;
    }
    @media(min-width:1080px){
      .grid{ grid-template-columns:380px 1fr; }
    }

    .card{
      border:1px solid #ddd;
      border-radius:16px;
      padding:16px;
      background:#fff;
    }

    #map{
      width:100%;
      height:560px;
      border-radius:16px;
      border:1px solid #ddd;
      background:#f4f4f4;
    }

    /* ---------- Marker tone ---------- */
    .leaflet-marker-icon{
      filter: saturate(.7) brightness(.95);
      transform: scale(.85);
      transition: transform .15s ease, filter .15s ease;
    }
    .marker-dimmed{
      opacity:.35;
    }

    /* ---------- Popup ---------- */
    .popupTitle{ font-weight:900; margin:0 0 4px; }
    .popupMuted{ color:#555; margin:0 0 8px; }
    .popupBtn{
      width:100%;
      padding:8px 10px;
      border-radius:10px;
      border:1px solid #bbb;
      background:#fff;
      font-weight:700;
      cursor:pointer;
    }

    /* ---------- Panel ---------- */
    #dockPanel[hidden]{ display:none; }

    .panelHeader{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      margin:-16px -16px 12px;
      padding:14px;
      border-bottom:1px solid #eee;
    }

    .panelTitle{ margin:0; font-size:1.2rem; font-weight:900; }
    .panelMeta{ margin-top:6px; color:#555; }

    .chip{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid #ddd;
      background:#fafafa;
      font-size:.95rem;
      cursor:pointer;
    }
    .chip.primary{
      border-color:#333;
      font-weight:900;
      background:#fff;
    }

  </style>
</head>

<body>

<header>
  <div>
    <h1>Karta</h1>
    <p class="muted">En släktöversikt över platser i Sverige.</p>

    <nav class="topbar">
      <a class="btn" href="../start.html">Start</a>
      <a class="btn" href="./trees.html">Träd</a>
      <a class="btn" href="./slaktkort.html">Personer</a>
      <a class="btn" href="./create-relation.html">Relationer</a>
      <a class="btn" href="./map.html">Karta</a>
    </nav>
  </div>

  <button id="logoutBtn" class="btn">Logga ut</button>
</header>

<div class="grid">

  <!-- LEFT -->
  <section class="card">
    <h2>Släktöversikt</h2>
    <p class="muted">Klicka en markör för detaljer.</p>

    <section id="dockPanel" hidden>
      <div class="panelHeader">
        <div>
          <h3 id="panelName" class="panelTitle">—</h3>
          <p id="panelMeta" class="panelMeta">—</p>
        </div>
        <button id="panelClose" class="btn">Stäng</button>
      </div>

      <div>
        <div id="panelChips"></div>
      </div>
    </section>
  </section>

  <!-- RIGHT -->
  <section class="card">
    <div id="map"></div>
  </section>

</div>

<script>
/* ---------------- AUTH ---------------- */
if(sessionStorage.getItem("demo_auth")!=="1"){
  location.href="../index.html";
}

/* ---------------- MAP ---------------- */
const map = L.map("map",{ zoomControl:true });

L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{
  maxZoom:18
}).addTo(map);

/* Sverige bounds */
const SWEDEN = L.latLngBounds(
  [55.0, 10.5],
  [69.5, 24.5]
);
map.fitBounds(SWEDEN);

/* Layers */
const markerLayer = L.layerGroup().addTo(map);
let allMarkers = [];

/* Dummy load (same keys as before) */
const KEY_ACTIVE="slakttradet_active_tree_id";
const cardsKey=(t)=>"slakttradet_slaktkort_"+t;

const treeId=localStorage.getItem(KEY_ACTIVE);
const people=treeId ? JSON.parse(localStorage.getItem(cardsKey(treeId))||"[]") : [];

/* Helpers */
function name(p){
  return `${p.fornamn||""} ${p.efternamn||""}`.trim()||"Namnlös";
}

/* Panel */
const dockPanel=document.getElementById("dockPanel");
const panelName=document.getElementById("panelName");
const panelMeta=document.getElementById("panelMeta");
const panelChips=document.getElementById("panelChips");
document.getElementById("panelClose").onclick=()=>{
  dockPanel.hidden=true;
  allMarkers.forEach(m=>m.getElement()?.classList.remove("marker-dimmed"));
};

/* Render markers */
people.forEach(p=>{
  if(!p.coords) return;
  const lat=Number(p.coords.lat);
  const lon=Number(p.coords.lon);
  if(!Number.isFinite(lat)||!Number.isFinite(lon)) return;

  const marker=L.marker([lat,lon]).addTo(markerLayer);
  allMarkers.push(marker);

  marker.bindPopup(`
    <div>
      <p class="popupTitle">${name(p)}</p>
      <p class="popupMuted">${p.fodelsear||""}${p.dodsar?"–"+p.dodsar:""}</p>
      <button class="popupBtn" data-id="${p.id}">Visa släkt</button>
    </div>
  `);

  marker.on("popupopen",e=>{
    const btn=e.popup.getElement().querySelector("button");
    btn.onclick=()=>{
      allMarkers.forEach(m=>m.getElement()?.classList.add("marker-dimmed"));
      marker.getElement()?.classList.remove("marker-dimmed");

      panelName.textContent=name(p);
      panelMeta.textContent=(p.fodelsear||"")+(p.dodsar?"–"+p.dodsar:"");
      panelChips.innerHTML=`<span class="chip primary">Fokus</span>`;
      dockPanel.hidden=false;
    };
  });
});

/* Logout */
document.getElementById("logoutBtn").onclick=()=>{
  sessionStorage.removeItem("demo_auth");
  location.href="../index.html";
};
</script>
</body>
</html>
