<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Karta ‚Äì Sl√§ktkort</title>
  <meta name="description" content="Klicka p√• kartan f√∂r att v√§lja plats. Mark√∂rer och kopplingar f√∂r aktivt tr√§d." />

  <!-- LEAFLET (CDN) -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <style>
    :root{
      color-scheme: light;
      --accentGreen: #b7e4c7;
      --accentGreenDeep: #7fcf9b;
      --border: #ddd;
      --muted: #555;
    }
    body{
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      line-height: 1.5;
      margin: 0;
      padding: 24px;
      max-width: 1180px;
      margin-inline: auto;
      background: #fff;
      color: #111;
    }
    a{ color: inherit; text-decoration:none; }

    header{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      margin-bottom:18px;
    }
    h1{ margin:0 0 6px; font-size:1.6rem; }
    .muted{ color: var(--muted); margin:0 0 12px; }

    .topbar{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      margin: 10px 0 0;
    }
    .btn, button{
      display:inline-block;
      padding:10px 12px;
      border:1px solid #333;
      border-radius:10px;
      background:#fff;
      font:inherit;
      cursor:pointer;
      text-decoration:none;
      user-select:none;
    }
    .btn.secondary{ border-color:#bbb; }
    .btn:disabled{ opacity:.5; cursor:not-allowed; }

    .pillRow{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      margin: 10px 0 18px;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border:1px solid var(--border);
      border-radius:999px;
      background:#fafafa;
      font-size:.95rem;
    }
    .pill strong{ font-weight:900; }
    .pill.ok{ border-color:#cfe8cf; background:#f5fff5; }
    .pill.warn{ border-color:#ffe1a6; background:#fff9ee; }
    .pill.err{ border-color:#ffb3b3; background:#fff2f2; }

    .grid{
      display:grid;
      gap:14px;
      grid-template-columns: 1fr;
    }
    @media (min-width: 1080px){
      .grid{ grid-template-columns: 380px 1fr; }
    }

    .card{
      border:1px solid var(--border);
      border-radius:12px;
      padding:16px;
      background:#fff;
      position: relative;
    }
    .card h2{ margin:0 0 6px; font-size:1.15rem; }
    .small{ font-size:.95rem; color: var(--muted); margin:0 0 10px; }

    label{ display:block; margin:10px 0 6px; font-weight:800; }
    input{
      width:100%;
      box-sizing:border-box;
      padding:10px;
      border-radius:10px;
      border:1px solid #bbb;
      font:inherit;
      background:#fff;
    }

    .actions{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      margin-top: 12px;
    }

    .hintBox{
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid #ffe1a6;
      background: #fff9ee;
    }
    .okBox{
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid #cfe8cf;
      background: #f5fff5;
    }
    .errBox{
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid #ffb3b3;
      background: #fff2f2;
    }
    code{ background:#f4f4f4; padding:2px 6px; border-radius:6px; }

    /* LIST */
    .list{
      margin: 10px 0 0;
      padding: 0;
      list-style:none;
      display:flex;
      flex-direction:column;
      gap:10px;
      max-height: 280px;
      overflow:auto;
      border-top: 1px solid #eee;
      padding-top: 10px;
    }
    .item{
      border:1px solid #eee;
      border-radius:12px;
      padding:10px;
      background:#fff;
      cursor:pointer;
    }
    .item:hover{ background:#fafafa; }
    .itemTitle{ font-weight:900; margin:0 0 2px; }
    .itemMeta{ margin:0; color:#555; font-size:.95rem; }

    /* MAP: lika stor som rutan */
    #map{
      width:100%;
      height: 100%;
      min-height: 560px;
      border-radius:12px;
      border: 1px solid var(--border);
      overflow:hidden;
      background:#f4f4f4;
    }
    @media (max-width: 520px){
      #map{ min-height: 440px; }
    }

    /* Dockad panel: alltid h√∂gst upp i v√§nsterspalten */
    #dockPanel[hidden]{ display:none; }
    .panelHeader{
      padding: 14px 14px 10px;
      border-bottom: 1px solid #eee;
      display:flex;
      gap:10px;
      align-items:flex-start;
      justify-content:space-between;
      margin: -16px -16px 12px;
      border-top-left-radius: 12px;
      border-top-right-radius: 12px;
      background:#fff;
    }
    .panelTitle{
      margin:0;
      font-size: 1.15rem;
      font-weight: 950;
      line-height: 1.2;
    }
    .panelMeta{
      margin: 6px 0 0;
      color: var(--muted);
      font-size:.95rem;
    }
    .panelClose{
      flex:0 0 auto;
      border-color:#bbb;
      padding:8px 10px;
      border-radius:12px;
    }
    .panelSection{ margin-top: 12px; }
    .panelSection h3{
      margin: 0 0 6px;
      font-size: 1.02rem;
      font-weight: 950;
    }

    /* Mini-tree chips (centrerad label under) */
    .miniTree{
      border:1px solid #eee;
      border-radius:14px;
      padding: 12px;
      background:#fff;
    }
    .miniGrid{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      grid-template-rows: auto auto auto;
      gap: 10px 10px;
      align-items:start;
    }
    .slotParents{ grid-column: 1 / 4; grid-row: 1; display:flex; gap:10px; flex-wrap:wrap; justify-content:center; }
    .slotPartner{ grid-column: 1; grid-row: 2; display:flex; gap:10px; flex-wrap:wrap; justify-content:center; }
    .slotFocus{ grid-column: 2; grid-row: 2; display:flex; justify-content:center; }
    .slotChildren{ grid-column: 1 / 4; grid-row: 3; display:flex; gap:10px; flex-wrap:wrap; justify-content:center; }

    .chip{
      display:inline-flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:4px;
      padding:10px 12px;
      border:1px solid #ddd;
      border-radius:14px;
      background:#fafafa;
      font: inherit;
      cursor:pointer;
      max-width: 100%;
      text-align:center;
      min-width: 120px;
    }
    .chip:hover{ background:#f5f5f5; }
    .chip.primary{
      border-color:#333;
      background:#fff;
      font-weight:950;
    }
    .chip.muted{
      border-color:#eee;
      background:#fff;
      cursor: default;
    }
    .chip .chipLabel{
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      max-width: 240px;
      font-weight: 900;
    }
    .chip .chipSub{
      font-size: .9rem;
      color: var(--muted);
      font-weight: 800;
      line-height: 1.1;
    }

    /* MARK√ñRER */
    .mkWrap{
      width: 22px;
      height: 22px;
      border-radius: 999px;
      display:flex;
      align-items:center;
      justify-content:center;
      background: rgba(255,255,255,.92);
      border: 1px solid rgba(17,17,17,.18);
      box-shadow: 0 6px 18px rgba(0,0,0,.08);
      transition: transform .12s ease, box-shadow .12s ease, opacity .12s ease, border-color .12s ease;
      user-select:none;
    }
    .mkFlag{ font-size: 14px; line-height: 1; transform: translateY(0.5px); }

    .mkWrap.isActive{
      border-color: rgba(127,207,155,.85);
      box-shadow:
        0 10px 26px rgba(0,0,0,.12),
        0 0 0 5px rgba(183,228,199,.55),
        0 0 0 10px rgba(183,228,199,.22);
      transform: scale(1.06);
    }
    .mkWrap.isDim{
      opacity: .38;
      box-shadow: 0 4px 14px rgba(0,0,0,.06);
      transform: scale(0.98);
    }

    .leaflet-marker-icon.mkIcon{ background: transparent; border: 0; }
  </style>
</head>

<body>
<header>
  <div>
    <h1>Karta</h1>
    <p class="muted">Klicka p√• kartan f√∂r att v√§lja plats. Klick p√• en flagga √∂ppnar panelen till v√§nster.</p>

    <nav class="topbar" aria-label="Navigation">
      <a class="btn secondary" href="../start.html">Start</a>
      <a class="btn secondary" href="./trees.html">Tr√§d</a>
      <a class="btn secondary" href="./slaktkort.html">Personer</a>
      <a class="btn secondary" href="./create-relation.html">Relationer</a>
      <a class="btn" href="./map.html">Karta</a>
    </nav>
  </div>

  <div class="actions" style="justify-content:flex-end;">
    <button id="logoutBtn" class="btn secondary" type="button">Logga ut</button>
  </div>
</header>

<section class="pillRow" aria-label="Status">
  <span id="pillTree" class="pill warn">Aktivt tr√§d: <strong>‚Äî</strong></span>
  <span id="pillPeople" class="pill">Personer: <strong>0</strong></span>
  <span id="pillPick" class="pill">Platsval: <strong>‚Äî</strong></span>
</section>

<div class="grid">
  <!-- V√ÑNSTERSPALT -->
  <section class="card" aria-label="V√§nsterspalt">
    <h2>V√§nsterpanel</h2>
    <p class="small">S√∂k person. Klicka flagga/person f√∂r panel. Klicka kartan f√∂r att flytta ‚Äúval-flaggan‚Äù.</p>

    <label for="search">S√∂k</label>
    <input id="search" placeholder="S√∂k namn‚Ä¶" autocomplete="off" />

    <div class="actions">
      <button id="fitBtn" class="btn secondary" type="button">Zooma till alla</button>
      <button id="backBtn" class="btn" type="button">Tillbaka</button>
    </div>

    <div id="ok" class="okBox" hidden></div>
    <div id="err" class="errBox" hidden></div>
    <div id="hint" class="hintBox" hidden></div>

    <!-- DOCKAD PANEL: ligger alltid h√∂gst upp -->
    <section id="dockPanel" class="card" style="margin-top:14px;" aria-label="Sl√§kt√∂versikt" hidden>
      <div class="panelHeader">
        <div style="min-width:0;">
          <h2 id="panelName" class="panelTitle">‚Äî</h2>
          <p id="panelMeta" class="panelMeta">‚Äî</p>
        </div>
        <button id="panelClose" class="btn panelClose" type="button" aria-label="St√§ng">St√§ng</button>
      </div>

      <div class="panelSection">
        <h3>Sl√§kt (√∂versikt)</h3>
        <div class="miniTree" aria-label="Mini-tr√§d">
          <div class="miniGrid">
            <div id="slotParents" class="slotParents"></div>
            <div id="slotPartner" class="slotPartner"></div>
            <div id="slotFocus" class="slotFocus"></div>
            <div id="slotChildren" class="slotChildren"></div>
          </div>
        </div>
      </div>

      <div class="panelSection">
        <h3>Plats f√∂r vald person</h3>
        <p class="small" id="panelTech">Koordinater: ‚Äî</p>
        <div class="actions">
          <button id="pickHereBtn" class="btn" type="button">Spara denna plats till Personer</button>
          <a class="btn secondary" href="./slaktkort.html">G√• till Personer</a>
        </div>
      </div>
    </section>

    <h2 style="margin-top:14px;">Personer med koordinater</h2>
    <p class="small">Klicka f√∂r att fokusera p√• kartan.</p>
    <ul id="list" class="list" aria-label="Personer med koordinater"></ul>
  </section>

  <!-- KARTA -->
  <section class="card" aria-label="Karta">
    <h2>Karta</h2>
    <p class="small">OpenStreetMap via Leaflet.</p>
    <div id="map" role="application" aria-label="Karta"></div>
    <p class="small" id="mapMsg" style="margin-top:10px;">‚Äî</p>
  </section>
</div>

<script>
  "use strict";

  // =====================================================
  // AUTH-GUARD (DEMO)
  // =====================================================
  (function authGuard(){
    try{
      if(sessionStorage.getItem("demo_auth") !== "1"){
        window.location.href = "../index.html";
      }
    }catch{}
  })();

  // =====================================================
  // STORAGE KEYS (L√ÖSTA)
  // =====================================================
  const KEY_TREES  = "slakttradet_trees";
  const KEY_ACTIVE = "slakttradet_active_tree_id";
  const cardsKey = (treeId) => "slakttradet_slaktkort_" + String(treeId);
  const relKey   = (treeId) => "slakttradet_relationer_" + String(treeId);

  // Handshake med Personer (slaktkort.html)
  const KEY_PICK_CONTEXT = "slakttradet_place_pick_context";
  const KEY_PICK_RESULT  = "slakttradet_place_pick_result";

  // =====================================================
  // DOM
  // =====================================================
  const logoutBtn = document.getElementById("logoutBtn");
  const fitBtn = document.getElementById("fitBtn");
  const backBtn = document.getElementById("backBtn");
  const searchEl = document.getElementById("search");

  const pillTree = document.getElementById("pillTree");
  const pillPeople = document.getElementById("pillPeople");
  const pillPick = document.getElementById("pillPick");

  const okEl = document.getElementById("ok");
  const errEl = document.getElementById("err");
  const hintEl = document.getElementById("hint");

  const listEl = document.getElementById("list");
  const mapMsg = document.getElementById("mapMsg");

  const dockPanel = document.getElementById("dockPanel");
  const panelClose = document.getElementById("panelClose");
  const panelName = document.getElementById("panelName");
  const panelMeta = document.getElementById("panelMeta");
  const panelTech = document.getElementById("panelTech");

  const slotParents = document.getElementById("slotParents");
  const slotPartner = document.getElementById("slotPartner");
  const slotFocus = document.getElementById("slotFocus");
  const slotChildren = document.getElementById("slotChildren");
  const pickHereBtn = document.getElementById("pickHereBtn");

  // =====================================================
  // HELPERS
  // =====================================================
  function safeParse(raw, fallback){
    try{ return JSON.parse(raw); }catch{ return fallback; }
  }
  function loadJson(key, fallback){
    const raw = localStorage.getItem(key);
    return raw ? safeParse(raw, fallback) : fallback;
  }
  function saveJson(key, value){
    localStorage.setItem(key, JSON.stringify(value));
  }
  function escapeHtml(s){
    return String(s || "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }
  function clearBoxes(){
    okEl.hidden = true; okEl.innerHTML = "";
    errEl.hidden = true; errEl.innerHTML = "";
    hintEl.hidden = true; hintEl.innerHTML = "";
  }
  function setBox(el, html){
    el.hidden = false;
    el.innerHTML = html;
  }

  function getTrees(){
    const arr = loadJson(KEY_TREES, []);
    return Array.isArray(arr) ? arr : [];
  }
  function activeTreeId(){
    return localStorage.getItem(KEY_ACTIVE) || "";
  }
  function activeTreeLabel(){
    const id = activeTreeId();
    if(!id) return "‚Äî";
    const t = getTrees().find(x => String(x.id) === String(id));
    return t ? (t.name || t.id) : id;
  }

  function loadPeople(){
    const t = activeTreeId();
    if(!t) return [];
    const arr = loadJson(cardsKey(t), []);
    return Array.isArray(arr) ? arr : [];
  }
  function loadRelations(){
    const t = activeTreeId();
    if(!t) return [];
    const arr = loadJson(relKey(t), []);
    return Array.isArray(arr) ? arr : [];
  }

  function personName(p){
    const n = `${p.fornamn || ""} ${p.efternamn || ""}`.trim();
    return n || "(namnl√∂s)";
  }
  function yearsLine(p){
    const a = (p && p.fodelsear != null && String(p.fodelsear).trim() !== "") ? String(p.fodelsear).trim() : "";
    const b = (p && p.dodsar != null && String(p.dodsar).trim() !== "") ? String(p.dodsar).trim() : "";
    if(!a && !b) return "";
    if(a && b) return `${a}‚Äì${b}`;
    return a ? `${a}‚Äì` : `‚Äì${b}`;
  }

  function normalizeCoords(lat, lon){
    const a = Number(lat), b = Number(lon);
    if(!Number.isFinite(a) || !Number.isFinite(b)) return null;
    if(a < -90 || a > 90 || b < -180 || b > 180) return null;
    return { lat: a, lon: b };
  }
  function coordsFromPerson(p){
    if(p && p.coords && typeof p.coords === "object"){
      const c = normalizeCoords(p.coords.lat, p.coords.lon);
      return c;
    }
    if(typeof p.coords === "string"){
      const parts = p.coords.split(",").map(x => x.trim()).filter(Boolean);
      if(parts.length === 2){
        return normalizeCoords(parts[0], parts[1]);
      }
    }
    return null;
  }

  // Partner adapter (accept both formats)
  function getPartnerPair(r){
    const a1 = r && (r.personAId ?? r.personA ?? r.aId ?? r.a);
    const b1 = r && (r.personBId ?? r.personB ?? r.bId ?? r.b);
    if(a1 != null && b1 != null) return { aId: String(a1), bId: String(b1) };

    const a2 = r && (r.person1Id ?? r.personId1 ?? r.person1);
    const b2 = r && (r.person2Id ?? r.personId2 ?? r.person2);
    if(a2 != null && b2 != null) return { aId: String(a2), bId: String(b2) };

    const a3 = r && (r.franPersonId ?? r.fromPersonId ?? r.fromId);
    const b3 = r && (r.tillPersonId ?? r.toPersonId ?? r.toId);
    if(a3 != null && b3 != null && String(r.typ) === "PARTNER") return { aId: String(a3), bId: String(b3) };

    return null;
  }

  // =====================================================
  // PICK CONTEXT (fr√•n slaktkort.html)
  // =====================================================
  function loadPickContext(){
    const ctx = loadJson(KEY_PICK_CONTEXT, null);
    if(!ctx || !ctx.treeId || !ctx.personId) return null;
    // om context tree inte matchar aktivt tr√§d ‚Äì fortfarande ok, men vi visar varning
    return ctx;
  }
  const pickCtx = loadPickContext();

  // =====================================================
  // UI PILL
  // =====================================================
  function renderPills(peopleCount){
    const trees = getTrees();
    const act = activeTreeId();
    const hasTrees = trees.length > 0;
    const hasActive = !!act && trees.some(t => String(t.id) === String(act));

    pillTree.className = "pill " + (hasActive ? "ok" : (hasTrees ? "warn" : "err"));
    pillTree.innerHTML = "Aktivt tr√§d: <strong>" + escapeHtml(hasActive ? activeTreeLabel() : "‚Äî") + "</strong>";

    pillPeople.innerHTML = "Personer: <strong>" + (hasActive ? peopleCount : 0) + "</strong>";

    if(pickCtx && pickCtx.personId){
      pillPick.className = "pill ok";
      pillPick.innerHTML = "Platsval: <strong>P√•</strong>";
    }else{
      pillPick.className = "pill warn";
      pillPick.innerHTML = "Platsval: <strong>Av</strong>";
    }
  }

  // =====================================================
  // LEAFLET SETUP
  // =====================================================
  const map = L.map("map", { zoomControl: true });

  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: 19,
    attribution: '&copy; OpenStreetMap'
  }).addTo(map);

  map.setView([62.0, 16.0], 4);

  const markerLayer = L.layerGroup().addTo(map);
  const linkLayer = L.layerGroup().addTo(map);

  const markersById = new Map(); // personId -> marker
  const coordsById = new Map();  // personId -> coords

  let focusedMarkerId = "";
  let panelPersonId = "";
  let selectedPickLatLng = null; // d√§r anv√§ndaren klickat p√• kartan
  let pickMarker = null;         // ‚Äúval-flaggan‚Äù som flyttas

  // marker icon
  function markerIconHtml(){
    return "<div class='mkWrap'><span class='mkFlag'>üá∏üá™</span></div>";
  }
  const MK_ICON = L.divIcon({
    className: "mkIcon",
    html: markerIconHtml(),
    iconSize: [22, 22],
    iconAnchor: [11, 11]
  });

  function applyMarkerFocusStyles(){
    const hasFocus = !!focusedMarkerId;

    for(const [pid, marker] of markersById.entries()){
      const el = marker.getElement();
      if(!el) continue;
      const wrap = el.querySelector(".mkWrap");
      if(!wrap) continue;

      wrap.classList.remove("isActive", "isDim");

      if(!hasFocus) continue;

      if(String(pid) === String(focusedMarkerId)){
        wrap.classList.add("isActive");
      }else{
        wrap.classList.add("isDim");
      }
    }
  }

  function setFocusMarker(personId){
    focusedMarkerId = String(personId || "");
    applyMarkerFocusStyles();
  }
  function clearFocusMarker(){
    focusedMarkerId = "";
    applyMarkerFocusStyles();
  }

  // =====================================================
  // LIST + MARKERS
  // =====================================================
  function rebuildCoordsIndex(people){
    coordsById.clear();
    for(const p of people){
      const c = coordsFromPerson(p);
      if(!c) continue;
      coordsById.set(String(p.id), c);
    }
  }

  function fitToAllCoords(){
    const ll = [];
    coordsById.forEach(c => ll.push(L.latLng(c.lat, c.lon)));
    if(ll.length === 0) return;
    map.fitBounds(L.latLngBounds(ll).pad(0.2));
  }

  function renderList(peopleWithCoords){
    listEl.innerHTML = "";
    if(peopleWithCoords.length === 0){
      const li = document.createElement("li");
      li.className = "item";
      li.style.cursor = "default";
      li.innerHTML = "<p class='itemTitle'>Inga personer med koordinater</p><p class='itemMeta'>S√§tt plats i Personer.</p>";
      listEl.appendChild(li);
      return;
    }

    for(const p of peopleWithCoords){
      const li = document.createElement("li");
      li.className = "item";
      li.dataset.id = String(p.id);

      const years = yearsLine(p);
      li.innerHTML =
        "<p class='itemTitle'>" + escapeHtml(personName(p)) + "</p>" +
        "<p class='itemMeta'>" + escapeHtml(years || "‚Äî") + "</p>";

      li.addEventListener("click", () => {
        const id = String(p.id);

        // fokus + panel + zoom
        setFocusMarker(id);
        openPanel(id, { focusMap: true });

        const m = markersById.get(id);
        if(m){
          map.setView(m.getLatLng(), Math.max(map.getZoom(), 10), { animate: true });
        }
      });

      listEl.appendChild(li);
    }
  }

  function clearMarkers(){
    markerLayer.clearLayers();
    linkLayer.clearLayers();
    markersById.clear();
  }

  function renderMarkers(peopleWithCoords){
    clearMarkers();

    for(const p of peopleWithCoords){
      const c = coordsFromPerson(p);
      if(!c) continue;

      const m = L.marker([c.lat, c.lon], { icon: MK_ICON }).addTo(markerLayer);

      m.on("click", () => {
        const id = String(p.id);

        // toggle: om samma person och panel √∂ppen -> st√§ng
        if(String(panelPersonId) === id && !dockPanel.hidden){
          closePanel();
          clearFocusMarker();
          return;
        }

        setFocusMarker(id);
        openPanel(id, { focusMap: false });
      });

      markersById.set(String(p.id), m);
    }

    applyMarkerFocusStyles();
  }

  // =====================================================
  // LINKS (ritas om automatiskt, utan legend)
  // =====================================================
  function renderLinks(relations){
    linkLayer.clearLayers();

    // vi ritar alltid b√•da ‚Äì men utan legendtext
    // (du kan sl√• av helt genom att kommentera bort om du vill)
    const seen = new Set();

    for(const r of relations){
      if(!r || !r.typ) continue;

      if(r.typ === "FORALDER_BARN"){
        const fromId = String(r.franPersonId || "");
        const toId   = String(r.tillPersonId || "");
        if(!fromId || !toId) continue;

        const key = "PC:" + fromId + "->" + toId;
        if(seen.has(key)) continue;
        seen.add(key);

        const a = coordsById.get(fromId);
        const b = coordsById.get(toId);
        if(!a || !b) continue;

        L.polyline([[a.lat, a.lon], [b.lat, b.lon]], {
          weight: 3,
          opacity: 0.75
        }).addTo(linkLayer);

        continue;
      }

      if(r.typ === "PARTNER"){
        const pair = getPartnerPair(r);
        if(!pair) continue;

        const aId = pair.aId;
        const bId = pair.bId;
        if(!aId || !bId) continue;

        const low = aId < bId ? aId : bId;
        const high = aId < bId ? bId : aId;

        const key = "P:" + low + "--" + high;
        if(seen.has(key)) continue;
        seen.add(key);

        const a = coordsById.get(aId);
        const b = coordsById.get(bId);
        if(!a || !b) continue;

        L.polyline([[a.lat, a.lon], [b.lat, b.lon]], {
          weight: 3,
          opacity: 0.65,
          dashArray: "7 9"
        }).addTo(linkLayer);
      }
    }
  }

  // =====================================================
  // PANEL: chips med centrerad ‚ÄúPartner/Fokus/Barn/F√∂r√§lder‚Äù
  // =====================================================
  function getPersonById(people, id){
    return people.find(p => String(p.id) === String(id)) || null;
  }

  function makeChip(label, sub, personId, kind){
    const btn = document.createElement("button");
    btn.type = "button";
    btn.className = "chip " + (kind || "");

    if(!personId){
      btn.classList.add("muted");
      btn.style.cursor = "default";
      btn.setAttribute("aria-disabled","true");
    }

    const span = document.createElement("div");
    span.className = "chipLabel";
    span.textContent = label || "‚Äî";
    btn.appendChild(span);

    const subEl = document.createElement("div");
    subEl.className = "chipSub";
    subEl.textContent = sub || "";
    btn.appendChild(subEl);

    if(personId){
      btn.addEventListener("click", () => {
        const id = String(personId);
        setFocusMarker(id);
        openPanel(id, { focusMap: true });
        const m = markersById.get(id);
        if(m){
          map.setView(m.getLatLng(), Math.max(map.getZoom(), 10), { animate: true });
        }
      });
    }

    return btn;
  }

  function getFamily(focusId, people, rels){
    const id = String(focusId);

    const parents = rels
      .filter(r => r && r.typ === "FORALDER_BARN" && String(r.tillPersonId) === id)
      .map(r => String(r.franPersonId));

    const children = rels
      .filter(r => r && r.typ === "FORALDER_BARN" && String(r.franPersonId) === id)
      .map(r => String(r.tillPersonId));

    const partners = rels
      .filter(r => r && r.typ === "PARTNER")
      .map(r => {
        const pair = getPartnerPair(r);
        if(!pair) return null;
        if(pair.aId === id) return pair.bId;
        if(pair.bId === id) return pair.aId;
        return null;
      })
      .filter(Boolean);

    const uniq = (arr) => [...new Set(arr)].filter(Boolean);
    const toPeople = (ids) => uniq(ids).map(pid => getPersonById(people, pid)).filter(Boolean);

    return {
      parents: toPeople(parents),
      children: toPeople(children),
      partners: toPeople(partners)
    };
  }

  function closePanel(){
    dockPanel.hidden = true;
    panelPersonId = "";
    panelName.textContent = "‚Äî";
    panelMeta.textContent = "‚Äî";
    panelTech.textContent = "Koordinater: ‚Äî";
    slotParents.innerHTML = "";
    slotPartner.innerHTML = "";
    slotFocus.innerHTML = "";
    slotChildren.innerHTML = "";
  }

  function openPanel(personId, opts){
    panelPersonId = String(personId || "");
    if(!panelPersonId) return;

    const people = loadPeople();
    const rels = loadRelations();
    const p = getPersonById(people, panelPersonId);

    dockPanel.hidden = false;

    // Viktigt: panel ska hamna h√∂gst upp i v√§nsterspalten
    // (ingen scroll ner i listan)
    try{
      dockPanel.scrollIntoView({ behavior: "smooth", block: "start" });
    }catch{}

    if(!p){
      panelName.textContent = "Ok√§nd person";
      panelMeta.textContent = "‚Äî";
      panelTech.textContent = "Koordinater: ‚Äî";
      return;
    }

    panelName.textContent = personName(p);

    const years = yearsLine(p);
    panelMeta.textContent = years ? years : "‚Äî";

    const c = coordsFromPerson(p);
    if(c){
      panelTech.textContent = "Koordinater: " + c.lat.toFixed(4) + ", " + c.lon.toFixed(4);
      // n√§r man √∂ppnar panelen: s√§tt √§ven ‚Äúval-flagga‚Äù p√• personens plats
      setPickMarker(c.lat, c.lon);
    }else{
      panelTech.textContent = "Koordinater: ‚Äî";
    }

    const fam = getFamily(panelPersonId, people, rels);

    slotParents.innerHTML = "";
    slotPartner.innerHTML = "";
    slotFocus.innerHTML = "";
    slotChildren.innerHTML = "";

    if(fam.parents.length){
      for(const par of fam.parents.slice(0,2)){
        slotParents.appendChild(makeChip(personName(par), "F√∂r√§lder", par.id, ""));
      }
      if(fam.parents.length > 2){
        slotParents.appendChild(makeChip("+" + (fam.parents.length - 2), "fler", null, ""));
      }
    }else{
      slotParents.appendChild(makeChip("‚Äî", "F√∂r√§ldrar", null, "muted"));
    }

    if(fam.partners.length){
      const first = fam.partners[0];
      slotPartner.appendChild(makeChip(personName(first), "Partner", first.id, ""));
      if(fam.partners.length > 1){
        slotPartner.appendChild(makeChip("+" + (fam.partners.length - 1), "fler", null, ""));
      }
    }else{
      slotPartner.appendChild(makeChip("‚Äî", "Partner", null, "muted"));
    }

    slotFocus.appendChild(makeChip(personName(p), "Fokus", panelPersonId, "primary"));

    if(fam.children.length){
      for(const ch of fam.children.slice(0,4)){
        slotChildren.appendChild(makeChip(personName(ch), "Barn", ch.id, ""));
      }
      if(fam.children.length > 4){
        slotChildren.appendChild(makeChip("+" + (fam.children.length - 4), "fler", null, ""));
      }
    }else{
      slotChildren.appendChild(makeChip("‚Äî", "Barn", null, "muted"));
    }

    if(opts && opts.focusMap){
      const m = markersById.get(panelPersonId);
      if(m){
        map.setView(m.getLatLng(), Math.max(map.getZoom(), 10), { animate: true });
      }
    }
  }

  panelClose.addEventListener("click", () => {
    closePanel();
    clearFocusMarker();
  });

  // =====================================================
  // PICK MARKER (klick p√• karta flyttar flaggan)
  // =====================================================
  function setPickMarker(lat, lon){
    const c = normalizeCoords(lat, lon);
    if(!c) return;

    selectedPickLatLng = { lat: c.lat, lon: c.lon };

    if(!pickMarker){
      pickMarker = L.marker([c.lat, c.lon], { icon: MK_ICON }).addTo(markerLayer);
    }else{
      pickMarker.setLatLng([c.lat, c.lon]);
    }

    // pickMarkern ska inte ‚Äúdimmas‚Äù
    try{
      const el = pickMarker.getElement();
      const wrap = el && el.querySelector(".mkWrap");
      if(wrap){
        wrap.classList.add("isActive");
        wrap.classList.remove("isDim");
      }
    }catch{}
  }

  map.on("click", (e) => {
    clearBoxes();
    setPickMarker(e.latlng.lat, e.latlng.lng);
    mapMsg.textContent = "Plats vald: " + e.latlng.lat.toFixed(4) + ", " + e.latlng.lng.toFixed(4) + " (klicka Spara i panelen om du vill skicka till Personer)";
  });

  // =====================================================
  // SAVE PICK RESULT -> tillbaka till Personer
  // =====================================================
  function savePickResultAndReturn(){
    clearBoxes();

    const ctx = loadPickContext();
    if(!ctx || !ctx.treeId || !ctx.personId){
      setBox(errEl, "<strong>Kan inte spara plats:</strong> ingen plats-koppling fr√•n Personer (saknar context). G√• via <code>V√§lj plats</code> i Personer.");
      return;
    }
    if(!selectedPickLatLng){
      setBox(errEl, "<strong>Kan inte spara plats:</strong> klicka p√• kartan f√∂rst s√• flaggan flyttas.");
      return;
    }

    const payload = {
      treeId: String(ctx.treeId),
      personId: String(ctx.personId),
      lat: Number(selectedPickLatLng.lat),
      lon: Number(selectedPickLatLng.lon),
      placeText: "", // valfritt, l√§mnar tomt
      ts: Date.now()
    };

    try{
      saveJson(KEY_PICK_RESULT, payload);
      setBox(okEl, "<strong>Sparat.</strong> Skickar tillbaka till Personer‚Ä¶");
    }catch{
      setBox(errEl, "<strong>Fel:</strong> kunde inte spara i localStorage.");
      return;
    }

    // tillbaka till personer
    window.location.href = "./slaktkort.html";
  }

  pickHereBtn.addEventListener("click", savePickResultAndReturn);

  // backBtn g√•r tillbaka beroende p√• context
  backBtn.addEventListener("click", () => {
    const ctx = loadPickContext();
    if(ctx && ctx.returnTo === "slaktkort"){
      window.location.href = "./slaktkort.html";
      return;
    }
    window.location.href = "../start.html";
  });

  // =====================================================
  // SEARCH
  // =====================================================
  function currentFiltered(peopleWithCoords){
    const q = String(searchEl.value || "").trim().toLowerCase();
    if(!q) return peopleWithCoords;
    return peopleWithCoords.filter(p => personName(p).toLowerCase().includes(q));
  }

  let searchTimer = null;
  searchEl.addEventListener("input", () => {
    if(searchTimer) clearTimeout(searchTimer);
    searchTimer = setTimeout(refresh, 120);
  });

  // =====================================================
  // REFRESH
  // =====================================================
  function refresh(){
    clearBoxes();

    const trees = getTrees();
    const hasTrees = trees.length > 0;

    const act = activeTreeId();
    const hasActive = !!act && trees.some(t => String(t.id) === String(act));

    if(!hasTrees){
      setBox(hintEl, "<strong>üö© Inga tr√§d:</strong> G√• till <a href='./trees.html'><code>Tr√§d</code></a> och skapa ett tr√§d.");
    }else if(!hasActive){
      setBox(hintEl, "<strong>üö© Inget aktivt tr√§d:</strong> V√§lj aktivt tr√§d i <a href='./trees.html'><code>Tr√§d</code></a>.");
    }

    const people = hasActive ? loadPeople() : [];
    const rels = hasActive ? loadRelations() : [];

    renderPills(people.length);

    const peopleWithCoordsAll = people.filter(p => !!coordsFromPerson(p));
    rebuildCoordsIndex(peopleWithCoordsAll);

    const filtered = currentFiltered(peopleWithCoordsAll);

    renderList(filtered);
    renderMarkers(filtered);
    renderLinks(rels);

    if(coordsById.size > 0){
      mapMsg.textContent = "Visar " + filtered.length + " mark√∂rer (av " + coordsById.size + " med koordinater). Klicka p√• kartan f√∂r att v√§lja ny plats.";
    }else{
      mapMsg.textContent = "Inga mark√∂rer √§n. L√§gg plats i Personer och kom tillbaka.";
    }

    // Om vi har pick-context: hj√§lp anv√§ndaren genom att visa status
    if(pickCtx && pickCtx.personId){
      // f√∂rs√∂k s√§tta pickMarker till personens nuvarande coords om finns
      const p = people.find(x => String(x.id) === String(pickCtx.personId));
      const c = p ? coordsFromPerson(p) : null;
      if(c){
        setPickMarker(c.lat, c.lon);
        map.setView([c.lat, c.lon], Math.max(map.getZoom(), 9));
        setBox(okEl, "<strong>Platsl√§ge:</strong> Klicka p√• kartan f√∂r att flytta flaggan. Tryck sedan <code>Spara denna plats</code> i panelen.");
      }else{
        setBox(okEl, "<strong>Platsl√§ge:</strong> Klicka p√• kartan f√∂r att placera flaggan. √ñppna personen (flagga/lista) och tryck <code>Spara denna plats</code>.");
      }
    }
  }

  // =====================================================
  // BUTTONS
  // =====================================================
  fitBtn.addEventListener("click", () => {
    if(coordsById.size > 0) fitToAllCoords();
  });

  logoutBtn.addEventListener("click", () => {
    try{ sessionStorage.removeItem("demo_auth"); }catch{}
    window.location.href = "../index.html";
  });

  // =====================================================
  // START
  // =====================================================
  refresh();
</script>
</body>
</html>
