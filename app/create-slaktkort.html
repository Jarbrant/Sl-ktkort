<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Relationer ‚Äì Sl√§ktkort</title>
  <meta name="description" content="Skapa relationer i aktivt tr√§d (localStorage-first). Fokusperson ‚Üí relationstyp ‚Üí variant ‚Üí kommentar ‚Üí annan person." />

  <style>
    :root { color-scheme: light; }
    body{
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      line-height: 1.5;
      margin: 0;
      padding: 24px;
      max-width: 980px;
      margin-inline: auto;
      background: #fff;
      color: #111;
    }
    a{ color: inherit; text-decoration:none; }
    header{ margin-bottom: 14px; }
    h1{ margin:0 0 6px; font-size:1.6rem; }
    .muted{ color:#555; margin:0 0 12px; }

    .topbar{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      margin: 10px 0 16px;
    }
    .btn, button{
      display:inline-block;
      padding:10px 12px;
      border:1px solid #333;
      border-radius:10px;
      background:#fff;
      font:inherit;
      cursor:pointer;
      text-decoration:none;
    }
    .btn.secondary{ border-color:#bbb; }
    .btn.danger{ border-color:#b00020; color:#b00020; }

    .pillRow{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      margin: 10px 0 18px;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border:1px solid #ddd;
      border-radius:999px;
      background:#fafafa;
      font-size:.95rem;
    }
    .pill strong{ font-weight:950; }

    .card{
      border:1px solid #ddd;
      border-radius:12px;
      padding:16px;
      margin: 14px 0;
      background:#fff;
    }
    .card h2{ margin:0 0 6px; font-size:1.15rem; }
    .small{ font-size:.95rem; color:#555; margin:0 0 10px; }

    label{ display:block; margin:10px 0 6px; font-weight:900; }
    select, textarea{
      width:100%;
      box-sizing:border-box;
      padding:10px;
      border-radius:10px;
      border:1px solid #bbb;
      font:inherit;
      background:#fff;
    }
    textarea{
      min-height: 90px;
      resize: vertical;
    }

    .row{ display:grid; gap:12px; grid-template-columns: 1fr; }
    @media (min-width: 740px){
      .row.two{ grid-template-columns: 1fr 1fr; }
      .row.three{ grid-template-columns: 1fr 1fr 1fr; }
      .row.four{ grid-template-columns: 1fr 1fr 1fr 1fr; }
    }

    .actions{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      margin-top: 12px;
    }

    .error{ color:#b00020; font-weight:950; }
    .ok{ font-weight:950; }

    .list{
      margin: 10px 0 0;
      padding: 0;
      list-style:none;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .item{
      border:1px solid #eee;
      border-radius:12px;
      padding:10px;
      background:#fff;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
    }
    .itemTitle{ font-weight:950; margin:0 0 2px; }
    .itemMeta{ margin:0; color:#555; font-size:.95rem; }
    .itemNote{
      margin: 6px 0 0;
      color:#333;
      font-size:.95rem;
      white-space: pre-wrap;
    }
    .itemActions{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }

    code{ background:#f4f4f4; padding:2px 6px; border-radius:6px; }
  </style>
</head>

<body>
<header>
  <h1>üîó Relationer</h1>
  <p class="muted">Fokusperson ‚Üí Relationstyp ‚Üí Variant (ibland) ‚Üí Kommentar ‚Üí V√§lj person.</p>

  <nav class="topbar" aria-label="Navigation">
    <a class="btn secondary" href="../start.html">Start</a>
    <a class="btn secondary" href="./trees.html">Tr√§d</a>
    <a class="btn secondary" href="./slaktkort.html">Personer</a>
    <a class="btn" href="./create-relation.html">Relationer</a>
    <a class="btn secondary" href="./map.html">Karta</a>
    <a class="btn secondary" href="./place-picker.html">Plats-picker</a>
    <button id="logoutBtn" class="btn secondary" type="button">Logga ut</button>
  </nav>

  <div class="pillRow" aria-label="Status">
    <span class="pill">Aktivt tr√§d: <strong id="pillTree">‚Äî</strong></span>
    <span class="pill">Personer: <strong id="pillPeople">0</strong></span>
    <span class="pill">Relationer: <strong id="pillRels">0</strong></span>
    <span class="pill">N√§sta steg: <strong>üó∫Ô∏è Karta</strong></span>
  </div>
</header>

<section class="card">
  <h2>1) V√§lj fokusperson</h2>
  <p class="small">Fokuspersonen √§r ‚Äújag‚Äù i relationen.</p>

  <div class="row.two row">
    <div>
      <label for="focusSelect">Fokusperson *</label>
      <select id="focusSelect" required>
        <option value="">V√§lj‚Ä¶</option>
      </select>
      <div class="actions">
        <a class="btn secondary" href="./slaktkort.html">Skapa person</a>
        <button id="reloadBtn" class="btn secondary" type="button">Ladda om</button>
      </div>
    </div>

    <div>
      <label>Vald fokusperson</label>
      <p class="small" id="focusSummary">‚Äî</p>
    </div>
  </div>

  <p id="msgTop" class="muted" aria-live="polite"></p>
</section>

<section class="card">
  <h2>2) Skapa relation</h2>
  <p class="small">Variant-rutan visas bara n√§r den g√∂r nytta (t.ex. farmor/farfar/mormor/morfar). Kommentar √§r valfri.</p>

  <form id="form">
    <div class="row four">
      <div>
        <label for="relationKey">Relationstyp *</label>
        <select id="relationKey" required>
          <option value="PARENT_OF" selected>F√∂r√§lder till</option>
          <option value="CHILD_OF">Barn till</option>

          <option value="SIBLING_OF">Syskon med</option>

          <option value="GRANDPARENT_OF">Far-/morf√∂r√§lder till</option>
          <option value="GRANDCHILD_OF">Barnbarn till</option>

          <option value="PARTNER_OF">Partner med</option>

          <option value="AUNTUNCLE_MATERNAL">Moster/Morbror till</option>
          <option value="AUNTUNCLE_PATERNAL">Faster/Farbror till</option>

          <option value="COUSIN_OF">Kusin med</option>

          <option value="STEP_PARENT_OF">Styvf√∂r√§lder till</option>
          <option value="STEP_CHILD_OF">Styvbarn till</option>
        </select>
      </div>

      <div id="variantWrap" hidden>
        <label for="variantSelect" id="variantLabel">Variant (valfri)</label>
        <select id="variantSelect">
          <option value="">Ingen</option>
        </select>
        <p class="small" id="variantHelp">‚Äî</p>
      </div>

      <div>
        <label for="otherSelect" id="otherLabel">Person *</label>
        <select id="otherSelect" required>
          <option value="">V√§lj‚Ä¶</option>
        </select>
        <p class="small" id="otherHelp">‚Äî</p>
      </div>

      <div>
        <label>F√∂rhandsvisning</label>
        <p class="small" id="previewLine">V√§lj fokusperson f√∂rst.</p>
      </div>
    </div>

    <div class="row" style="margin-top:10px;">
      <div>
        <label for="note">Kommentar (valfri)</label>
        <textarea id="note" placeholder="Skriv en kort notis om relationen‚Ä¶ (t.ex. 'os√§ker k√§lla', 'adopterad', 'troligen' osv)"></textarea>
        <p class="small">Tips: h√•ll det kort. Du kan anv√§nda detta senare f√∂r kvalitet/k√§llor.</p>
      </div>
    </div>

    <div class="actions">
      <button type="submit" class="btn">Spara relation</button>
      <button type="button" id="resetBtn" class="btn secondary">Rensa val</button>
      <a class="btn secondary" href="./map.html">Forts√§tt ‚Üí Karta</a>
    </div>

    <p id="msgSave" class="muted" aria-live="polite"></p>
  </form>
</section>

<section class="card">
  <h2>3) Relationer f√∂r vald fokusperson</h2>
  <p class="small">Visar allt d√§r fokuspersonen ing√•r. Du kan ta bort.</p>

  <ul id="relsList" class="list" aria-label="Relationer"></ul>

  <div class="actions" style="margin-top:14px;">
    <a class="btn secondary" href="./slaktkort.html">‚Üê Tillbaka (Personer)</a>
    <a class="btn secondary" href="./map.html">G√• till (Karta)</a>
  </div>
</section>

<script>
  (function authGuard(){
    try{
      if(sessionStorage.getItem("demo_auth") !== "1"){
        window.location.href = "../index.html";
      }
    }catch{}
  })();

  const KEY_TREES  = "slakttradet_trees";
  const KEY_ACTIVE = "slakttradet_active_tree_id";
  const cardsKey = (treeId) => "slakttradet_slaktkort_" + String(treeId);
  const relKey   = (treeId) => "slakttradet_relationer_" + String(treeId);

  const logoutBtn = document.getElementById("logoutBtn");

  const pillTree = document.getElementById("pillTree");
  const pillPeople = document.getElementById("pillPeople");
  const pillRels = document.getElementById("pillRels");

  const focusSelect = document.getElementById("focusSelect");
  const focusSummary = document.getElementById("focusSummary");
  const msgTop = document.getElementById("msgTop");

  const relationKeyEl = document.getElementById("relationKey");

  const variantWrap = document.getElementById("variantWrap");
  const variantSelect = document.getElementById("variantSelect");
  const variantLabel = document.getElementById("variantLabel");
  const variantHelp = document.getElementById("variantHelp");

  const otherSelect = document.getElementById("otherSelect");
  const otherLabel = document.getElementById("otherLabel");
  const otherHelp = document.getElementById("otherHelp");

  const noteEl = document.getElementById("note");

  const previewLine = document.getElementById("previewLine");
  const msgSave = document.getElementById("msgSave");
  const relsList = document.getElementById("relsList");

  const reloadBtn = document.getElementById("reloadBtn");
  const resetBtn = document.getElementById("resetBtn");
  const form = document.getElementById("form");

  function safeParse(raw, fallback){ try{ return JSON.parse(raw); }catch{ return fallback; } }
  function loadJson(key, fallback){
    const raw = localStorage.getItem(key);
    return raw ? safeParse(raw, fallback) : fallback;
  }
  function saveJson(key, value){ localStorage.setItem(key, JSON.stringify(value)); }

  function escapeHtml(s){
    return String(s || "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }
  function setMsg(el, type, text){
    el.innerHTML = type === "error"
      ? "<span class='error'>" + escapeHtml(text) + "</span>"
      : type === "ok"
        ? "<span class='ok'>" + escapeHtml(text) + "</span>"
        : escapeHtml(text || "");
  }

  function getTrees(){
    const trees = loadJson(KEY_TREES, []);
    return Array.isArray(trees) ? trees : [];
  }
  function activeTreeId(){ return localStorage.getItem(KEY_ACTIVE) || ""; }
  function activeTreeLabel(){
    const id = activeTreeId();
    if(!id) return "‚Äî";
    const t = getTrees().find(x => String(x.id) === String(id));
    return t ? (t.name || t.id) : id;
  }

  function loadPeople(){
    const t = activeTreeId();
    if(!t) return [];
    const arr = loadJson(cardsKey(t), []);
    return Array.isArray(arr) ? arr : [];
  }
  function loadRels(){
    const t = activeTreeId();
    if(!t) return [];
    const arr = loadJson(relKey(t), []);
    return Array.isArray(arr) ? arr : [];
  }
  function saveRels(rels){
    const t = activeTreeId();
    if(!t) return;
    saveJson(relKey(t), rels);
  }

  function personName(p){
    const n = `${p.fornamn || ""} ${p.efternamn || ""}`.trim();
    return n || "(namnl√∂s)";
  }
  function getPersonById(people, id){
    return people.find(x => String(x.id) === String(id)) || null;
  }

  const REL_META = {
    PARENT_OF:          { label:"F√∂r√§lder till",         otherLabel:"Barn *",            help:"Fokuspersonen √§r f√∂r√§lder. Den andra √§r barn.", symmetric:false, type:"PARENTCHILD" },
    CHILD_OF:           { label:"Barn till",             otherLabel:"F√∂r√§lder *",        help:"Fokuspersonen √§r barn. Den andra √§r f√∂r√§lder.", symmetric:false, type:"PARENTCHILD" },

    SIBLING_OF:         { label:"Syskon med",            otherLabel:"Syskon *",          help:"Syskonrelation (symmetrisk).", symmetric:true,  type:"GENERIC" },

    GRANDPARENT_OF:     { label:"Far-/morf√∂r√§lder till", otherLabel:"Barnbarn *",        help:"Fokuspersonen √§r far-/morf√∂r√§lder. Den andra √§r barnbarn.", symmetric:false, type:"GENERIC" },
    GRANDCHILD_OF:      { label:"Barnbarn till",         otherLabel:"Far-/morf√∂r√§lder *",help:"Fokuspersonen √§r barnbarn. Den andra √§r far-/morf√∂r√§lder.", symmetric:false, type:"GENERIC" },

    PARTNER_OF:         { label:"Partner med",           otherLabel:"Partner *",         help:"Partnerrelation (symmetrisk).", symmetric:true,  type:"PARTNER" },

    AUNTUNCLE_MATERNAL: { label:"Moster/Morbror till",   otherLabel:"Syskonbarn *",      help:"Fokuspersonen √§r moster/morbror. Den andra √§r syskonbarn.", symmetric:false, type:"GENERIC" },
    AUNTUNCLE_PATERNAL: { label:"Faster/Farbror till",   otherLabel:"Syskonbarn *",      help:"Fokuspersonen √§r faster/farbror. Den andra √§r syskonbarn.", symmetric:false, type:"GENERIC" },

    COUSIN_OF:          { label:"Kusin med",             otherLabel:"Kusin *",           help:"Kusinrelation (symmetrisk).", symmetric:true,  type:"GENERIC" },

    STEP_PARENT_OF:     { label:"Styvf√∂r√§lder till",     otherLabel:"Styvbarn *",        help:"Relation via omgifte/ny partner.", symmetric:false, type:"GENERIC" },
    STEP_CHILD_OF:      { label:"Styvbarn till",         otherLabel:"Styvf√∂r√§lder *",    help:"Relation via omgifte/ny partner.", symmetric:false, type:"GENERIC" }
  };

  const VARIANTS = {
    PARENT_OF:     { label:"F√∂r√§ldervariant", help:"Valfritt: mamma eller pappa.", options:[
      {v:"Mamma", t:"Mamma"}, {v:"Pappa", t:"Pappa"}
    ]},
    CHILD_OF:      { label:"Barnvariant", help:"Valfritt: son eller dotter.", options:[
      {v:"Son", t:"Son"}, {v:"Dotter", t:"Dotter"}
    ]},
    GRANDPARENT_OF:{ label:"Variant", help:"Valfritt: farmor/farfar/mormor/morfar.", options:[
      {v:"Farmor", t:"Farmor"}, {v:"Farfar", t:"Farfar"}, {v:"Mormor", t:"Mormor"}, {v:"Morfar", t:"Morfar"}
    ]},
    AUNTUNCLE_MATERNAL:{ label:"Variant", help:"Valfritt: moster eller morbror.", options:[
      {v:"Moster", t:"Moster"}, {v:"Morbror", t:"Morbror"}
    ]},
    AUNTUNCLE_PATERNAL:{ label:"Variant", help:"Valfritt: faster eller farbror.", options:[
      {v:"Faster", t:"Faster"}, {v:"Farbror", t:"Farbror"}
    ]},
    PARTNER_OF: { label:"Partnerstatus", help:"Valfritt: typ av partnerrelation.", options:[
      {v:"Make/Maka", t:"Make/Maka"}, {v:"Sambo", t:"Sambo"}, {v:"S√§rbo", t:"S√§rbo"}, {v:"Skilda", t:"Skilda"}
    ]},
    STEP_PARENT_OF:{ label:"Variant", help:"Valfritt: styvf√∂r√§lder.", options:[
      {v:"Styvf√∂r√§lder", t:"Styvf√∂r√§lder"}
    ]},
    STEP_CHILD_OF:{ label:"Variant", help:"Valfritt: styvbarn.", options:[
      {v:"Styvbarn", t:"Styvbarn"}
    ]}
  };

  function relLabel(key){
    return (REL_META[key] && REL_META[key].label) ? REL_META[key].label : key;
  }

  function hasSameParentChild(rels, parentId, childId){
    return rels.some(r =>
      r && r.typ === "FORALDER_BARN" &&
      String(r.franPersonId) === String(parentId) &&
      String(r.tillPersonId) === String(childId)
    );
  }
  function parentsOfChild(rels, childId){
    return rels
      .filter(r => r && r.typ === "FORALDER_BARN" && String(r.tillPersonId) === String(childId))
      .map(r => String(r.franPersonId));
  }
  function hasSamePartner(rels, aId, bId){
    const A = String(aId), B = String(bId);
    return rels.some(r => {
      if(!r || r.typ !== "PARTNER") return false;
      const x = String(r.personAId), y = String(r.personBId);
      return (x === A && y === B) || (x === B && y === A);
    });
  }
  function hasSameGeneric(rels, relationKey, aId, bId, symmetric, variant){
    const A = String(aId), B = String(bId);
    const V = String(variant || "");
    return rels.some(r => {
      if(!r || r.typ !== "GENERIC") return false;
      if(String(r.relationKey) !== String(relationKey)) return false;
      if(String(r.variant || "") !== V) return false;

      const x = String(r.personAId), y = String(r.personBId);
      if(symmetric) return (x === A && y === B) || (x === B && y === A);
      return (x === A && y === B);
    });
  }

  function fillSelect(select, people, includeEmpty=true){
    select.innerHTML = includeEmpty ? "<option value=''>V√§lj‚Ä¶</option>" : "";
    for(const p of people){
      if(!p || !p.id) continue;
      const opt = document.createElement("option");
      opt.value = String(p.id);
      opt.textContent = personName(p);
      select.appendChild(opt);
    }
  }

  function renderStatus(){
    const t = activeTreeId();
    const people = loadPeople();
    const rels = loadRels();

    pillTree.textContent = activeTreeLabel();
    pillPeople.textContent = String(people.length);
    pillRels.textContent = String(rels.length);

    if(!t){
      setMsg(msgTop, "error", "V√§lj ett aktivt tr√§d f√∂rst (Tr√§d).");
      return false;
    }
    if(people.length === 0){
      setMsg(msgTop, "error", "Inga personer √§n. Skapa personer f√∂rst.");
      return false;
    }
    setMsg(msgTop, "", "");
    return true;
  }

  function applyVariantUI(){
    const key = String(relationKeyEl.value || "");
    const v = VARIANTS[key];

    if(!v){
      variantWrap.hidden = true;
      variantSelect.innerHTML = "<option value=''>Ingen</option>";
      variantHelp.textContent = "‚Äî";
      return;
    }

    variantWrap.hidden = false;
    variantLabel.textContent = (v.label || "Variant") + " (valfri)";
    variantHelp.textContent = v.help || "‚Äî";

    const prev = String(variantSelect.value || "");
    variantSelect.innerHTML = "<option value=''>Ingen</option>";
    for(const o of v.options || []){
      const opt = document.createElement("option");
      opt.value = o.v;
      opt.textContent = o.t;
      variantSelect.appendChild(opt);
    }
    if(prev) variantSelect.value = prev;
  }

  function applyRelationUI(){
    const k = String(relationKeyEl.value || "");
    const meta = REL_META[k] || { otherLabel:"Person *", help:"‚Äî" };

    otherLabel.textContent = meta.otherLabel || "Person *";
    otherHelp.textContent = meta.help || "‚Äî";

    const focusId = String(focusSelect.value || "");
    if(otherSelect.value && otherSelect.value === focusId){
      otherSelect.value = "";
    }

    applyVariantUI();
    renderPreview();
  }

  function renderFocusSummary(){
    const people = loadPeople();
    const focusId = String(focusSelect.value || "");
    const p = focusId ? getPersonById(people, focusId) : null;
    focusSummary.textContent = p ? personName(p) : "‚Äî";

    if(otherSelect.value && otherSelect.value === focusId) otherSelect.value = "";
    renderPreview();
  }

  function renderPreview(){
    const people = loadPeople();
    const focusId = String(focusSelect.value || "");
    const otherId = String(otherSelect.value || "");
    const relK = String(relationKeyEl.value || "");
    const variant = String(variantSelect.value || "");
    const note = String(noteEl.value || "").trim();

    const a = focusId ? getPersonById(people, focusId) : null;
    const b = otherId ? getPersonById(people, otherId) : null;

    if(!a){
      previewLine.textContent = "V√§lj fokusperson f√∂rst.";
      return;
    }

    let mid = relLabel(relK);
    if(variant) mid += " (" + variant + ")";
    let line = personName(a) + " ‚Äî " + mid + " ‚Äî " + (b ? personName(b) : "‚Ä¶");
    if(note) line += " ¬∑ ‚Äú" + note + "‚Äù";
    previewLine.textContent = line;
  }

  function makeRow(title, meta, note, onRemove){
    const li = document.createElement("li");
    li.className = "item";

    const left = document.createElement("div");
    left.style.minWidth = "0";
    left.innerHTML =
      "<p class='itemTitle'>" + escapeHtml(title) + "</p>" +
      (meta ? "<p class='itemMeta'>" + escapeHtml(meta) + "</p>" : "<p class='itemMeta'>‚Äî</p>") +
      (note ? "<p class='itemNote'>" + escapeHtml(note) + "</p>" : "");

    const right = document.createElement("div");
    right.className = "itemActions";

    const del = document.createElement("button");
    del.type = "button";
    del.className = "btn danger";
    del.textContent = "Ta bort";
    del.addEventListener("click", onRemove);

    right.appendChild(del);
    li.appendChild(left);
    li.appendChild(right);
    return li;
  }

  function renderList(){
    relsList.innerHTML = "";

    const ok = renderStatus();
    if(!ok) return;

    const people = loadPeople();
    const rels = loadRels();
    const focusId = String(focusSelect.value || "");

    if(!focusId){
      relsList.innerHTML =
        "<li class='item' style='cursor:default;'><div><p class='itemTitle'>V√§lj fokusperson</p><p class='itemMeta'>F√∂r att se relationer.</p></div></li>";
      return;
    }

    const focus = getPersonById(people, focusId);
    const focusName = focus ? personName(focus) : "Fokus";

    const mine = rels.filter(r => {
      if(!r) return false;
      if(r.typ === "FORALDER_BARN") return String(r.franPersonId) === focusId || String(r.tillPersonId) === focusId;
      if(r.typ === "PARTNER") return String(r.personAId) === focusId || String(r.personBId) === focusId;
      if(r.typ === "GENERIC") return String(r.personAId) === focusId || String(r.personBId) === focusId;
      return false;
    });

    if(mine.length === 0){
      relsList.innerHTML =
        "<li class='item' style='cursor:default;'><div><p class='itemTitle'>‚Äî</p><p class='itemMeta'>Inga relationer √§nnu.</p></div></li>";
      return;
    }

    for(const r of mine){
      let title = "Relation";
      let meta = "";
      const note = String(r.note || "").trim();
      const variant = String(r.variant || "").trim();
      const variantTxt = variant ? (" ¬∑ " + variant) : "";

      if(r.typ === "FORALDER_BARN"){
        const parentId = String(r.franPersonId);
        const childId  = String(r.tillPersonId);

        if(focusId === parentId){
          const other = getPersonById(people, childId);
          title = "F√∂r√§lder till";
          meta = focusName + " ‚Üí " + (other ? personName(other) : childId) + variantTxt;
        }else{
          const other = getPersonById(people, parentId);
          title = "Barn till";
          meta = focusName + " ‚Üê " + (other ? personName(other) : parentId) + variantTxt;
        }
      }

      if(r.typ === "PARTNER"){
        const A = String(r.personAId), B = String(r.personBId);
        const otherId = (A === focusId) ? B : A;
        const other = getPersonById(people, otherId);
        title = "Partner med";
        meta = focusName + " ‚Üî " + (other ? personName(other) : otherId) + variantTxt;
      }

      if(r.typ === "GENERIC"){
        const A = String(r.personAId), B = String(r.personBId);
        const otherId = (A === focusId) ? B : A;
        const other = getPersonById(people, otherId);
        title = relLabel(String(r.relationKey || "GENERIC"));
        meta = focusName + " ‚Äî " + title + " ‚Äî " + (other ? personName(other) : otherId) + variantTxt;
      }

      const li = makeRow(title, meta, note, () => {
        const yes = confirm("Ta bort relationen?");
        if(!yes) return;
        const all = loadRels();
        const next = all.filter(x => String(x.id) !== String(r.id));
        saveRels(next);
        pillRels.textContent = String(next.length);
        setMsg(msgSave, "ok", "Relation borttagen.");
        renderList();
      });

      relsList.appendChild(li);
    }
  }

  function refreshAll(keepFocus=true){
    setMsg(msgSave, "", "");

    const people = loadPeople();

    const prevFocus = keepFocus ? String(focusSelect.value || "") : "";
    const prevOther = keepFocus ? String(otherSelect.value || "") : "";

    fillSelect(focusSelect, people, true);
    fillSelect(otherSelect, people, true);

    if(prevFocus) focusSelect.value = prevFocus;
    if(prevOther) otherSelect.value = prevOther;

    renderStatus();
    renderFocusSummary();
    applyRelationUI();
    renderList();
  }

  form.addEventListener("submit", (e) => {
    e.preventDefault();

    const t = activeTreeId();
    if(!t) return setMsg(msgSave, "error", "V√§lj ett aktivt tr√§d f√∂rst.");

    const focusId = String(focusSelect.value || "").trim();
    const otherId = String(otherSelect.value || "").trim();
    const key = String(relationKeyEl.value || "").trim();
    const variant = String(variantSelect.value || "").trim();
    const note = String(noteEl.value || "").trim();

    if(!focusId) return setMsg(msgSave, "error", "V√§lj fokusperson f√∂rst.");
    if(!key) return setMsg(msgSave, "error", "V√§lj relationstyp.");
    if(!otherId) return setMsg(msgSave, "error", "V√§lj den andra personen.");
    if(otherId === focusId) return setMsg(msgSave, "error", "Du kan inte v√§lja samma person.");

    const rels = loadRels();
    const meta = REL_META[key] || { symmetric:false, type:"GENERIC" };

    if(meta.type === "PARENTCHILD"){
      const parentId = (key === "PARENT_OF") ? focusId : otherId;
      const childId  = (key === "PARENT_OF") ? otherId : focusId;

      if(hasSameParentChild(rels, parentId, childId)) return setMsg(msgSave, "error", "Redan kopplad.");
      const parents = new Set(parentsOfChild(rels, childId));
      if(parents.size >= 2) return setMsg(msgSave, "error", "Barnet har redan 2 f√∂r√§ldrar.");

      rels.push({
        id: "r" + Date.now(),
        typ: "FORALDER_BARN",
        franPersonId: parentId,
        tillPersonId: childId,
        variant: variant || "",
        note: note || "",
        createdAt: new Date().toISOString()
      });

      saveRels(rels);
      pillRels.textContent = String(rels.length);
      otherSelect.value = "";
      noteEl.value = "";
      setMsg(msgSave, "ok", "Sparat: F√∂r√§lder ‚Üî Barn.");
      renderList();
      renderPreview();
      return;
    }

    if(meta.type === "PARTNER"){
      if(hasSamePartner(rels, focusId, otherId)) return setMsg(msgSave, "error", "Partnerrelation finns redan.");

      rels.push({
        id: "r" + Date.now(),
        typ: "PARTNER",
        personAId: focusId,
        personBId: otherId,
        variant: variant || "",
        note: note || "",
        createdAt: new Date().toISOString()
      });

      saveRels(rels);
      pillRels.textContent = String(rels.length);
      otherSelect.value = "";
      noteEl.value = "";
      setMsg(msgSave, "ok", "Sparat: Partner.");
      renderList();
      renderPreview();
      return;
    }

    if(hasSameGeneric(rels, key, focusId, otherId, !!meta.symmetric, variant)) {
      return setMsg(msgSave, "error", "Relationen finns redan.");
    }

    rels.push({
      id: "r" + Date.now(),
      typ: "GENERIC",
      relationKey: key,
      personAId: focusId,
      personBId: otherId,
      symmetric: !!meta.symmetric,
      variant: variant || "",
      note: note || "",
      createdAt: new Date().toISOString()
    });

    saveRels(rels);
    pillRels.textContent = String(rels.length);
    otherSelect.value = "";
    noteEl.value = "";
    setMsg(msgSave, "ok", "Sparat: " + relLabel(key) + ".");
    renderList();
    renderPreview();
  });

  reloadBtn.addEventListener("click", () => refreshAll(true));

  focusSelect.addEventListener("change", () => {
    renderFocusSummary();
    applyRelationUI();
    renderList();
  });

  relationKeyEl.addEventListener("change", () => {
    applyRelationUI();
    renderList();
  });

  variantSelect.addEventListener("change", renderPreview);
  otherSelect.addEventListener("change", renderPreview);
  noteEl.addEventListener("input", () => {
    // l√§tt debounce-k√§nsla utan timer: bara uppdatera preview
    renderPreview();
  });

  resetBtn.addEventListener("click", () => {
    otherSelect.value = "";
    variantSelect.value = "";
    noteEl.value = "";
    setMsg(msgSave, "", "");
    renderPreview();
  });

  logoutBtn.addEventListener("click", () => {
    try{ sessionStorage.removeItem("demo_auth"); }catch{}
    window.location.href = "../index.html";
  });

  refreshAll(false);
</script>
</body>
</html>
