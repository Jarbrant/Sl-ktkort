<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mina släktträd</title>
  <style>
    body { font-family: system-ui, Arial, sans-serif; padding: 24px; max-width: 900px; }
    a { display:inline-block; margin-bottom: 16px; }
    h1 { margin-bottom: 6px; }
    .muted { color:#555; }
    .card { border:1px solid #ddd; border-radius:10px; padding:16px; margin-top: 16px; }
    label { display:block; margin-top: 12px; font-weight: 700; }
    input, button { width:100%; padding:10px; margin-top:6px; font-size:1rem; }
    button { border:1px solid #333; background:#fff; cursor:pointer; margin-top: 16px; }
    .error { color:#b00020; font-weight: 800; }
    .ok { font-weight: 800; }
    pre { background:#f4f4f4; padding:12px; border-radius:10px; overflow:auto; white-space:pre-wrap; }
    code { background:#f4f4f4; padding:2px 6px; border-radius:6px; }
  </style>
</head>
<body>
  <a href="./index.html">← Tillbaka</a>

  <h1>Mina släktträd</h1>
  <p class="muted">
    Kräver inloggning. Hämtar via <code>GET /trees</code> och skapar via <code>POST /trees</code>.
  </p>

  <div class="card">
    <h2>1) Skapa nytt träd</h2>
    <label for="name">Namn på träd</label>
    <input id="name" placeholder="t.ex. Jarbrant-släkten" />
    <button id="createBtn">Skapa träd</button>
    <p id="createMsg" class="muted" aria-live="polite"></p>
  </div>

  <div class="card">
    <h2>2) Lista mina träd</h2>
    <button id="loadBtn">Hämta träd</button>
    <p id="loadMsg" class="muted" aria-live="polite"></p>
    <pre id="out">[]</pre>
  </div>

<script>
  // Byt senare till Codespaces-URL om ni kör backend där.
  const API = "http://localhost:3001";

  const nameEl = document.getElementById("name");
  const createBtn = document.getElementById("createBtn");
  const createMsg = document.getElementById("createMsg");

  const loadBtn = document.getElementById("loadBtn");
  const loadMsg = document.getElementById("loadMsg");
  const out = document.getElementById("out");

  function setMsg(el, type, text) {
    el.innerHTML = type === "error"
      ? "<span class='error'>" + text + "</span>"
      : type === "ok"
        ? "<span class='ok'>" + text + "</span>"
        : text;
  }

  async function createTree() {
    setMsg(createMsg, "", "");
    const name = nameEl.value.trim();
    if (name.length < 2) {
      setMsg(createMsg, "error", "Skriv ett namn (minst 2 tecken).");
      return;
    }

    try {
      const res = await fetch(API + "/trees", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        credentials: "include",
        body: JSON.stringify({ name })
      });

      const data = await res.json().catch(() => ({}));
      if (!res.ok) {
        setMsg(createMsg, "error", "Fel: " + (data.error || "UNKNOWN"));
        return;
      }

      setMsg(createMsg, "ok", "Träd skapat (id: " + (data.tree?.id || "?") + "). Rollen blir OWNER automatiskt.");
    } catch {
      setMsg(createMsg, "error", "Kunde inte nå backend.");
    }
  }

  async function loadTrees() {
    setMsg(loadMsg, "", "Laddar…");
    out.textContent = "[]";

    try {
      const res = await fetch(API + "/trees", { credentials: "include" });
      const data = await res.json().catch(() => ({}));
      out.textContent = JSON.stringify(data, null, 2);

      if (!res.ok) {
        setMsg(loadMsg, "error", "Fel: " + (data.error || "UNKNOWN"));
      } else {
        setMsg(loadMsg, "ok", "OK.");
      }
    } catch {
      setMsg(loadMsg, "error", "Kunde inte nå backend.");
    }
  }

  createBtn.addEventListener("click", createTree);
  loadBtn.addEventListener("click", loadTrees);

  // Auto-load
  loadTrees();
</script>
</body>
</html>
