<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Person puzzle – Släktkort</title>
  <meta name="description" content="Ringa in rätt kandidat genom pusselbitar, poäng och (valfritt) nya frågor mot provider." />

  <style>
    :root{ color-scheme: light; }
    body{
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      line-height: 1.5;
      margin: 0;
      padding: 24px;
      max-width: 1180px;
      margin-inline: auto;
      background: #fff;
      color: #111;
    }
    a{ color: inherit; text-decoration: none; }
    .topbar{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      margin: 10px 0 18px;
    }
    .btn, button{
      display:inline-block;
      padding:10px 12px;
      border:1px solid #333;
      border-radius:10px;
      background:#fff;
      font:inherit;
      cursor:pointer;
      text-decoration:none;
      user-select:none;
    }
    .btn.secondary{ border-color:#bbb; background:#fafafa; }
    .btn.primary{ background:#111; color:#fff; border-color:#111; }
    .btn:disabled{ opacity:.55; cursor:not-allowed; }
    .spacer{ flex:1 1 auto; }

    h1{ margin:0 0 6px; font-size: 28px; }
    .muted{ color:#555; margin:0 0 10px; }

    .grid{
      display:grid;
      gap: 14px;
      grid-template-columns: 1fr;
    }
    @media (min-width: 980px){
      .grid{ grid-template-columns: 460px 1fr; }
    }

    .card{
      border:1px solid #e6e8eb;
      border-radius: 16px;
      padding: 14px;
      background:#fff;
      box-shadow: 0 1px 0 rgba(0,0,0,.03);
    }
    .card h2{ margin:0 0 6px; font-size: 18px; }
    .small{ margin:0 0 10px; color:#555; font-size: 13px; }

    label{ display:block; font-weight:800; margin: 10px 0 6px; }
    input{
      width:100%;
      box-sizing:border-box;
      padding: 10px;
      border-radius: 12px;
      border: 1px solid #bbb;
      font: inherit;
      background:#fff;
    }

    .actions{
      display:flex;
      flex-wrap:wrap;
      gap: 10px;
      align-items:center;
      margin-top: 12px;
    }

    .liftBox{
      border: 1px solid #e6e8eb;
      background: #fafafa;
      border-radius: 12px;
      padding: 10px 12px;
      font-size: 13px;
      color:#333;
    }
    .liftBox.ok{ border-color:#cfe8cf; background:#f5fff5; }
    .liftBox.warn{ border-color:#ffe1a6; background:#fff9ee; }
    .liftBox.err{ border-color:#ffb3b3; background:#fff2f2; }

    .list{
      margin: 10px 0 0;
      padding: 0;
      list-style:none;
      display:flex;
      flex-direction:column;
      gap:10px;
      max-height: 620px;
      overflow:auto;
      border-top: 1px solid #eee;
      padding-top: 10px;
    }
    .item{
      border:1px solid #eee;
      border-radius: 14px;
      padding: 10px;
      background:#fff;
      cursor:pointer;
    }
    .item:hover{ background:#fafafa; }
    .itemTitle{ font-weight:900; margin:0 0 2px; }
    .itemMeta{ margin:0; color:#555; font-size: 13px; }
    .score{
      display:inline-block;
      padding:2px 8px;
      border-radius: 999px;
      border:1px solid #ddd;
      background:#fafafa;
      font-size: 12px;
      margin-left:8px;
    }

    code{ background:#f4f4f4; padding:2px 6px; border-radius:6px; }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; }
  </style>

  <script src="./assets/js/ra-providers.js"></script>
</head>

<body>
  <h1>Person puzzle</h1>
  <p class="muted">Här ställer du fler frågor och ringar in rätt kandidat. Resultatet kan vara många → men bara en blir “rätt” till slut.</p>

  <nav class="topbar" aria-label="Pusselmeny">
    <a class="btn secondary" href="./person-search.html">← Till sök</a>
    <a class="btn secondary" href="./slaktkort.html">Personer</a>
    <span class="spacer"></span>
    <button class="btn secondary" id="clearSessionBtn" type="button">Rensa puzzle-session</button>
  </nav>

  <div id="topMsg" class="liftBox warn" hidden></div>

  <div class="grid">
    <section class="card" aria-label="Pusselbitar">
      <h2>Pusselbitar</h2>
      <p class="small">
        Lägg till pusselbitar (plats, år, partnernamn, notis-term). Vi ger poäng och kan (valfritt) fråga provider igen.
      </p>

      <div class="liftBox" id="ctxBox"></div>

      <label for="place">Plats (valfritt)</label>
      <input id="place" placeholder="t.ex. Falun, Uppsala, Stockholm" autocomplete="off" />

      <label for="yearMin">År (från)</label>
      <input id="yearMin" placeholder="t.ex. 1820" inputmode="numeric" />

      <label for="yearMax">År (till)</label>
      <input id="yearMax" placeholder="t.ex. 1890" inputmode="numeric" />

      <label for="spouse">Partnernamn (valfritt)</label>
      <input id="spouse" placeholder="t.ex. Anna Persdotter" autocomplete="off" />

      <label for="clue">Fri pusselbit / notis-term (valfritt)</label>
      <input id="clue" placeholder="t.ex. 'järnväg', 'härad', 'dräng'" autocomplete="off" />

      <div class="actions">
        <button class="btn primary" id="applyBtn" type="button">Poängsätt & filtrera lokalt</button>
        <button class="btn secondary" id="refineBtn" type="button">Ställ ny fråga till provider</button>
      </div>

      <div class="liftBox" style="margin-top:10px;">
        <strong>Not</strong><br/>
        <span class="mono">refine</span> kör bara om providern stödjer det (annars är knappen av).<br/>
        All kandidatdata är session-only och rensas när du lämnar/fail-closed.
      </div>

      <hr style="border:none;border-top:1px solid #eee; margin:12px 0;"/>

      <h2>Vald kandidat</h2>
      <div id="selectedBox" class="liftBox">Välj en kandidat i listan.</div>

      <div class="actions">
        <button class="btn primary" id="importBtn" type="button" disabled>Importera till Personer</button>
      </div>

      <div class="liftBox" style="margin-top:10px;">
        <strong>Import</strong><br/>
        Import skapar person i aktivt träd (localStorage) och öppnar den via <code>slaktkort.html#open=&lt;id&gt;</code>.<br/>
        (Ingen automatisk extern data lagras.)
      </div>
    </section>

    <section class="card" aria-label="Kandidater">
      <h2>Kandidater</h2>
      <p class="small">Sorteras på poäng. Målet är att gå från många → få → 1 rätt.</p>

      <ul id="candList" class="list" aria-label="Kandidatlista"></ul>
    </section>
  </div>

  <script>
    "use strict";

    // Session keys (ska matcha person-search.html)
    const SS_CANDIDATES = "ra_session_candidates_v1";
    const SS_CONTEXT    = "ra_session_context_v1";

    // Core keys (oförändrade)
    const KEY_ACTIVE = "slakttradet_active_tree_id";
    const cardsKey = (treeId) => "slakttradet_slaktkort_" + String(treeId);

    const topMsg = document.getElementById("topMsg");
    const ctxBox = document.getElementById("ctxBox");

    const placeEl = document.getElementById("place");
    const yearMinEl = document.getElementById("yearMin");
    const yearMaxEl = document.getElementById("yearMax");
    const spouseEl = document.getElementById("spouse");
    const clueEl = document.getElementById("clue");

    const applyBtn = document.getElementById("applyBtn");
    const refineBtn = document.getElementById("refineBtn");
    const clearSessionBtn = document.getElementById("clearSessionBtn");

    const candList = document.getElementById("candList");
    const selectedBox = document.getElementById("selectedBox");
    const importBtn = document.getElementById("importBtn");

    function safeParse(raw, fallback){
      try{ return JSON.parse(raw); }catch{ return fallback; }
    }
    function loadSession(key, fallback){
      try{
        const raw = sessionStorage.getItem(key);
        return raw ? safeParse(raw, fallback) : fallback;
      }catch{
        return fallback;
      }
    }
    function saveLocal(key, value){
      localStorage.setItem(key, JSON.stringify(value));
    }
    function loadLocal(key, fallback){
      const raw = localStorage.getItem(key);
      if(!raw) return fallback;
      try{ return JSON.parse(raw); }catch{ return fallback; }
    }

    function escapeHtml(s){
      return String(s || "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function showTopMsg(kind, text){
      topMsg.hidden = false;
      topMsg.className = "liftBox " + (kind || "warn");
      topMsg.innerHTML = escapeHtml(text);
    }
    function clearTopMsg(){
      topMsg.hidden = true;
      topMsg.innerHTML = "";
      topMsg.className = "liftBox";
    }

    function normalize(s){ return String(s || "").trim().toLowerCase(); }

    function safeInt(v){
      const n = Number(String(v || "").trim());
      if(!Number.isFinite(n)) return null;
      const i = Math.trunc(n);
      if(i < 0 || i > 3000) return null;
      return i;
    }

    function yearsText(c){
      const b = (c && c.birthYear != null) ? String(c.birthYear) : "—";
      const d = (c && c.deathYear != null) ? String(c.deathYear) : "—";
      if(b === "—" && d === "—") return "";
      return " (" + b + "–" + d + ")";
    }

    function activeTreeId(){
      return localStorage.getItem(KEY_ACTIVE) || "";
    }

    function newId(){
      return "p_" + Date.now().toString(36) + "_" + Math.random().toString(36).slice(2,7);
    }

    // ----------------------------------------------------------
    // Session init (fail-closed)
    // ----------------------------------------------------------
    const ctx = loadSession(SS_CONTEXT, null);
    let candidates = loadSession(SS_CANDIDATES, []);

    if(!ctx || !Array.isArray(candidates) || candidates.length === 0){
      showTopMsg("err", "⛔ Ingen puzzle-session hittades. Gå tillbaka till sök och välj en kandidat.");
      ctxBox.innerHTML = "Ingen session.";
      refineBtn.disabled = true;
    }else{
      ctxBox.innerHTML =
        "<strong>Session</strong><br/>" +
        "Sökterm: <span class='mono'>" + escapeHtml(ctx.q || "—") + "</span><br/>" +
        "Provider: <span class='mono'>" + escapeHtml(ctx.providerLabel || ctx.providerId || "—") + "</span><br/>" +
        "Kandidater: <span class='mono'>" + String(candidates.length) + "</span>";

      const p = window.RAProviders ? window.RAProviders.getProvider(ctx.providerId) : null;
      refineBtn.disabled = !(p && typeof p.refine === "function");
    }

    // ----------------------------------------------------------
    // Poängsystem (lokalt)
    // ----------------------------------------------------------
    function scoreCandidate(c, params){
      let score = 0;
      const why = [];

      if(params.place){
        const hit = normalize(c.place || "").includes(params.place);
        if(hit){ score += 3; why.push("Platsmatch"); }
        else{ score -= 1; }
      }

      if(params.yearMin != null){
        if(c.birthYear != null && c.birthYear >= params.yearMin){ score += 2; why.push("Födelseår >= " + params.yearMin); }
        else if(c.birthYear != null){ score -= 1; }
      }
      if(params.yearMax != null){
        if(c.deathYear != null && c.deathYear <= params.yearMax){ score += 2; why.push("Dödsår <= " + params.yearMax); }
        else if(c.deathYear != null){ score -= 1; }
      }

      if(params.spouse){
        const blob = normalize((c.name || "") + " " + (Array.isArray(c.why) ? c.why.join(" ") : ""));
        if(blob.includes(params.spouse)){ score += 2; why.push("Partner-clue match"); }
      }
      if(params.clue){
        const blob = normalize((c.name || "") + " " + (Array.isArray(c.why) ? c.why.join(" ") : ""));
        if(blob.includes(params.clue)){ score += 1; why.push("Clue match"); }
      }

      return { score, why };
    }

    function applyLocalScoring(){
      clearTopMsg();
      if(!Array.isArray(candidates) || candidates.length === 0){
        showTopMsg("err", "⛔ Inga kandidater att poängsätta.");
        return;
      }

      const params = {
        place: normalize(placeEl.value),
        yearMin: safeInt(yearMinEl.value),
        yearMax: safeInt(yearMaxEl.value),
        spouse: normalize(spouseEl.value),
        clue: normalize(clueEl.value)
      };

      const scored = candidates.map(c => {
        const r = scoreCandidate(c, params);
        return {
          ...c,
          _score: r.score,
          _whyLocal: r.why
        };
      });

      scored.sort((a,b) => (b._score - a._score) || String(a.name||"").localeCompare(String(b.name||"")));

      candidates = scored;
      renderCandidates();

      showTopMsg("ok", "✅ Poängsatt lokalt. Lägg fler pusselbitar eller kör refine (om aktivt).");
    }

    // ----------------------------------------------------------
    // Refine: ny fråga till provider (om stöds)
    // ----------------------------------------------------------
    async function refineWithProvider(){
      clearTopMsg();

      if(!ctx){
        showTopMsg("err", "⛔ Saknar session-context.");
        return;
      }

      const p = window.RAProviders ? window.RAProviders.getProvider(ctx.providerId) : null;
      if(!p || typeof p.refine !== "function"){
        showTopMsg("warn", "⚠️ Providern stödjer inte refine. Kör lokalt poängsystem istället.");
        return;
      }

      const name = String(ctx.q || "").trim();
      const place = String(placeEl.value || "").trim();
      const yearMin = safeInt(yearMinEl.value);
      const yearMax = safeInt(yearMaxEl.value);

      if(!name || name.length < 2){
        showTopMsg("err", "⛔ Saknar giltig sökterm för refine.");
        return;
      }

      refineBtn.disabled = true;

      try{
        const newCandidates = await p.refine({ name, place, yearMin, yearMax });

        if(Array.isArray(newCandidates) && newCandidates.length){
          candidates = newCandidates.map(c => ({ ...c, _score: 0, _whyLocal: [] }));
          renderCandidates();
          showTopMsg("ok", "✅ Refine klar. Ny kandidatlista från provider.");
        }else{
          showTopMsg("warn", "⚠️ Refine gav 0 träffar. Behåller befintliga kandidater.");
        }
      }catch{
        showTopMsg("warn", "⚠️ Refine misslyckades (CORS/timeout). Behåller befintliga kandidater. (fail-closed)");
      }finally{
        refineBtn.disabled = false;
      }
    }

    // ----------------------------------------------------------
    // UI: Kandidatlista + val
    // ----------------------------------------------------------
    let selected = null;

    function renderCandidates(){
      candList.innerHTML = "";

      if(!Array.isArray(candidates) || candidates.length === 0){
        const li = document.createElement("li");
        li.className = "item";
        li.style.cursor = "default";
        li.innerHTML =
          "<p class='itemTitle'>Inga kandidater</p>" +
          "<p class='itemMeta'>Gå tillbaka till sök och hämta kandidater.</p>";
        candList.appendChild(li);
        setSelected(null);
        return;
      }

      for(const c of candidates){
        const li = document.createElement("li");
        li.className = "item";

        const score = (c._score != null) ? Number(c._score) : 0;
        const localWhy = Array.isArray(c._whyLocal) ? c._whyLocal : [];

        const metaBits = [];
        metaBits.push(c.place ? ("Plats: " + c.place) : "Plats: —");
        if(c.source) metaBits.push("Källa: " + c.source);
        if(localWhy.length) metaBits.push("Lokalt: " + localWhy.join(", "));

        li.innerHTML =
          "<p class='itemTitle'>" +
            escapeHtml((c.name || "(namn saknas)") + yearsText(c)) +
            " <span class='score'>" + escapeHtml("Score: " + String(score)) + "</span>" +
          "</p>" +
          "<p class='itemMeta'>" + escapeHtml(metaBits.join(" · ")) + "</p>";

        li.addEventListener("click", () => setSelected(c));
        candList.appendChild(li);
      }

      if(ctx && ctx.selectedId){
        const hit = candidates.find(x => String(x.id) === String(ctx.selectedId));
        if(hit) setSelected(hit);
      }
    }

    function setSelected(c){
      selected = c || null;

      if(!selected){
        selectedBox.className = "liftBox";
        selectedBox.innerHTML = "Välj en kandidat i listan.";
        importBtn.disabled = true;
        return;
      }

      selectedBox.className = "liftBox ok";
      selectedBox.innerHTML =
        "<div><strong>" + escapeHtml((selected.name || "—") + yearsText(selected)) + "</strong></div>" +
        "<div class='small' style='margin-top:6px;'>" +
          "Plats: <span class='mono'>" + escapeHtml(selected.place || "—") + "</span><br/>" +
          "Källa: <span class='mono'>" + escapeHtml(selected.source || "—") + "</span><br/>" +
          (selected.url ? ("URL: <span class='mono'>" + escapeHtml(selected.url) + "</span><br/>") : "") +
          (Array.isArray(selected.why) && selected.why.length ? ("Varför: <span class='mono'>" + escapeHtml(selected.why.join(" · ")) + "</span>") : "") +
        "</div>";

      importBtn.disabled = false;
    }

    // ----------------------------------------------------------
    // Import: skapa person i aktivt träd (localStorage)
    // ----------------------------------------------------------
    function importSelected(){
      clearTopMsg();
      const treeId = activeTreeId();
      if(!treeId){
        showTopMsg("err", "⛔ Inget aktivt träd. Välj träd först.");
        return;
      }
      if(!selected){
        showTopMsg("warn", "⚠️ Välj kandidat först.");
        return;
      }

      const full = String(selected.name || "").trim();
      const parts = full.split(/\s+/).filter(Boolean);
      const fornamn = parts.slice(0, Math.max(1, parts.length-1)).join(" ");
      const efternamn = (parts.length >= 2) ? parts[parts.length-1] : "";

      if(!fornamn){
        showTopMsg("err", "⛔ Kan inte importera: saknar namn.");
        return;
      }

      const people = loadLocal(cardsKey(treeId), []);
      const arr = Array.isArray(people) ? people : [];

      const id = newId();

      const created = {
        id,
        fornamn: fornamn,
        efternamn: efternamn,
        kon: "",
        yrke: "",
        fodelsear: (selected.birthYear != null ? String(selected.birthYear) : ""),
        dodsar: (selected.deathYear != null ? String(selected.deathYear) : ""),
        plats: String(selected.place || "").trim(),
        coords: null,
        anteckning: ("Importerad från extern sök (via puzzle). Källa: " + (selected.source || "—") + (selected.url ? (" · " + selected.url) : "")).trim()
      };

      arr.push(created);
      saveLocal(cardsKey(treeId), arr);

      // Fail-closed: rensa session direkt efter import
      try{
        sessionStorage.removeItem(SS_CANDIDATES);
        sessionStorage.removeItem(SS_CONTEXT);
      }catch{}

      window.location.href = "./slaktkort.html#open=" + encodeURIComponent(id);
    }

    function clearPuzzleSession(){
      try{
        sessionStorage.removeItem(SS_CANDIDATES);
        sessionStorage.removeItem(SS_CONTEXT);
      }catch{}
      showTopMsg("ok", "✅ Puzzle-session rensad.");
    }

    // Events
    applyBtn.addEventListener("click", applyLocalScoring);
    refineBtn.addEventListener("click", refineWithProvider);
    importBtn.addEventListener("click", importSelected);
    clearSessionBtn.addEventListener("click", clearPuzzleSession);

    // Init
    renderCandidates();
  </script>
</body>
</html>
