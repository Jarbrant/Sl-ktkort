<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Person puzzle – Släktkort</title>
  <meta name="description" content="Ring in rätt person bland kandidater. Poängsätt, eliminera, fråga källan igen, och importera vald person." />

  <style>
    :root{ color-scheme: light; }
    body{
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      line-height: 1.5;
      margin: 0;
      padding: 24px;
      max-width: 1180px;
      margin-inline: auto;
      background: #fff;
      color: #111;
    }
    a{ color: inherit; text-decoration: none; }
    header{ display:block; margin-bottom:18px; }
    .topbar{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      margin: 10px 0 0;
    }
    .btn, button{
      display:inline-block;
      padding:10px 12px;
      border:1px solid #333;
      border-radius:10px;
      background:#fff;
      font:inherit;
      cursor:pointer;
      text-decoration:none;
      user-select:none;
    }
    .btn.secondary{ border-color:#bbb; background:#fafafa; }
    .btn.primary{ background:#111; color:#fff; border-color:#111; }
    .btn:disabled, button:disabled{ opacity:.55; cursor:not-allowed; }
    .spacer{ flex:1 1 auto; }

    h1{ margin:0 0 6px; font-size: 28px; }
    .muted{ color:#555; margin:0; }

    .pillRow{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      margin: 10px 0 18px;
    }
    .pill{
      display:inline-flex;
      gap:8px;
      align-items:center;
      padding:8px 10px;
      border:1px solid #ddd;
      border-radius:999px;
      background:#fafafa;
      font-size: .95rem;
    }
    .pill strong{ font-weight:900; }
    .pill.ok{ border-color:#cfe8cf; background:#f5fff5; }
    .pill.warn{ border-color:#ffe1a6; background:#fff9ee; }
    .pill.err{ border-color:#ffb3b3; background:#fff2f2; }

    .grid{ display:grid; gap:14px; grid-template-columns: 1fr; }
    @media (min-width: 980px){
      .grid{ grid-template-columns: 460px 1fr; }
    }

    .card{
      border:1px solid #e6e8eb;
      border-radius: 16px;
      padding: 14px;
      background:#fff;
      box-shadow: 0 1px 0 rgba(0,0,0,.03);
    }
    .card h2{ margin:0 0 6px; font-size: 18px; }
    .small{ margin:0 0 10px; color:#555; font-size: 13px; }

    label{ display:block; font-weight:800; margin: 10px 0 6px; }
    input, textarea{
      width:100%;
      box-sizing:border-box;
      padding: 10px;
      border-radius: 12px;
      border: 1px solid #bbb;
      font: inherit;
      background:#fff;
    }
    textarea{ min-height: 84px; resize: vertical; }

    .row2{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; }

    .actions{
      display:flex;
      flex-wrap:wrap;
      gap: 10px;
      align-items:center;
      margin-top: 12px;
    }

    .liftBox{
      border: 1px solid #e6e8eb;
      background: #fafafa;
      border-radius: 12px;
      padding: 10px 12px;
      font-size: 13px;
      color:#333;
    }
    .liftBox.ok{ border-color:#cfe8cf; background:#f5fff5; }
    .liftBox.warn{ border-color:#ffe1a6; background:#fff9ee; }
    .liftBox.err{ border-color:#ffb3b3; background:#fff2f2; }

    .list{
      margin: 10px 0 0;
      padding: 0;
      list-style:none;
      display:flex;
      flex-direction:column;
      gap:10px;
      max-height: 560px;
      overflow:auto;
      border-top: 1px solid #eee;
      padding-top: 10px;
    }
    .item{
      border:1px solid #eee;
      border-radius: 14px;
      padding: 10px;
      background:#fff;
      cursor:pointer;
    }
    .item:hover{ background:#fafafa; }
    .item.sel{ outline:2px solid #111; }
    .itemTitle{
      font-weight:900;
      margin:0 0 2px;
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }
    .badge{
      display:inline-flex;
      align-items:center;
      padding: 3px 8px;
      border-radius:999px;
      border:1px solid #ddd;
      background:#fafafa;
      font-size:12px;
      font-weight:900;
      white-space:nowrap;
    }
    .badge.good{ border-color:#cfe8cf; background:#f5fff5; }
    .badge.bad{ border-color:#ffb3b3; background:#fff2f2; }
    .itemMeta{ margin:0; color:#555; font-size: 13px; }

    code{ background:#f4f4f4; padding:2px 6px; border-radius:6px; }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; }
  </style>

  <!-- Providerlager -->
  <script src="./assets/js/ra-providers.js?v=20251225c"></script>
</head>

<body>
  <header>
    <h1>Person puzzle</h1>
    <p class="muted">Ring in rätt person med pusselbitar och poäng. Import sker bara när du klickar Importera.</p>

    <nav class="topbar" aria-label="Huvudmeny">
      <a class="btn secondary" href="../start.html">Start</a>
      <a class="btn secondary" href="./trees.html">Träd</a>
      <a class="btn secondary" href="./slaktkort.html">Personer</a>
      <a class="btn secondary" href="./create-relation.html">Relationer</a>
      <a class="btn secondary" href="./map.html">Karta</a>
      <span class="spacer"></span>
      <button class="btn secondary" id="logoutBtn" type="button">Logga ut</button>
    </nav>
  </header>

  <section class="pillRow" aria-label="Status">
    <span id="pillTree" class="pill warn">Aktivt träd: <strong>—</strong></span>
    <span id="pillCand" class="pill">Kandidater: <strong>0</strong></span>
    <span id="pillSource" class="pill warn">Källa: <strong>—</strong></span>
    <span id="pillVisible" class="pill">Visas: <strong>0</strong></span>
  </section>

  <div class="grid">
    <section class="card" aria-label="Frågor och poäng">
      <h2>Frågor</h2>
      <p class="small">
        Målet är att <strong>minska</strong> listan. Du kan dölja kandidater under en tröskel och fråga källan igen (ny sökning).
      </p>

      <div id="topMsg" class="liftBox warn" hidden></div>

      <label for="place">Plats (pusselbit)</label>
      <input id="place" placeholder="t.ex. Leksand, Falun, socken, län…" autocomplete="off"/>

      <div class="row2">
        <div>
          <label for="birthMin">Födelseår (min)</label>
          <input id="birthMin" inputmode="numeric" placeholder="t.ex. 1820" />
        </div>
        <div>
          <label for="birthMax">Födelseår (max)</label>
          <input id="birthMax" inputmode="numeric" placeholder="t.ex. 1825" />
        </div>
      </div>

      <div class="row2">
        <div>
          <label for="deathMin">Dödsår (min)</label>
          <input id="deathMin" inputmode="numeric" placeholder="t.ex. 1880" />
        </div>
        <div>
          <label for="deathMax">Dödsår (max)</label>
          <input id="deathMax" inputmode="numeric" placeholder="t.ex. 1895" />
        </div>
      </div>

      <label for="clues">Pusselbitar (nyckelord – fri text)</label>
      <textarea id="clues" placeholder="t.ex. 'smed', 'soldat', 'tidningsnotis', gårdsnamn…"></textarea>

      <label for="minScore">Min score för att visas (döljer resten)</label>
      <input id="minScore" inputmode="numeric" placeholder="t.ex. 5" />

      <div class="actions">
        <button class="btn primary" id="applyBtn" type="button">Poängsätt & sortera</button>
        <button class="btn secondary" id="resetBtn" type="button">Nollställ frågor</button>
        <button class="btn secondary" id="askBtn" type="button">Fråga källan igen</button>
        <button class="btn secondary" id="backBtn" type="button">Tillbaka</button>
      </div>

      <div class="liftBox" style="margin-top:10px;">
        <strong>Fail-closed</strong><br/>
        Saknas session eller aktivt träd → vi stoppar och skickar dig tillbaka.<br/>
        Extern kandidatdata lagras endast i <code>sessionStorage</code>.
      </div>
    </section>

    <section class="card" aria-label="Kandidater och import">
      <h2>Kandidater</h2>
      <p class="small">Välj kandidat. Högre score = bättre match med dina pusselbitar.</p>

      <div id="previewBox" class="liftBox" aria-live="polite">Välj en kandidat för att se detaljer här.</div>

      <div class="actions" style="margin-top:10px;">
        <button class="btn primary" id="importBtn" type="button" disabled>Importera till Personer</button>
        <button class="btn secondary" id="copyBtn" type="button" disabled>Kopiera som text</button>
        <button class="btn secondary" id="dropBtn" type="button" disabled>Ta bort kandidat</button>
      </div>

      <ul id="candList" class="list" aria-label="Kandidater"></ul>

      <div class="liftBox" style="margin-top:10px;">
        <strong>Teknik</strong><br/>
        Bas-sökterm: <code id="ctxQ">—</code><br/>
        API-query: <code id="ctxApiQ">—</code><br/>
        Start-hints: <code id="ctxHints">—</code>
      </div>
    </section>
  </div>

  <script>
    "use strict";

    /* ============================================================
       AUTH GUARD
       ============================================================ */
    (function authGuard(){
      try{
        if(sessionStorage.getItem("demo_auth") !== "1"){
          window.location.href = "../index.html";
        }
      }catch{}
    })();

    /* ============================================================
       CORE STORAGE KEYS (LÅST)
       ============================================================ */
    const KEY_TREES  = "slakttradet_trees";
    const KEY_ACTIVE = "slakttradet_active_tree_id";
    const cardsKey = (treeId) => "slakttradet_slaktkort_" + String(treeId);

    /* ============================================================
       SESSION KEYS (måste matcha person-search.html)
       ============================================================ */
    const SS_CANDIDATES = "ra_session_candidates_v1";
    const SS_CONTEXT    = "ra_session_context_v1";

    /* ============================================================
       UI refs
       ============================================================ */
    const logoutBtn = document.getElementById("logoutBtn");
    const backBtn = document.getElementById("backBtn");

    const pillTree = document.getElementById("pillTree");
    const pillCand = document.getElementById("pillCand");
    const pillSource = document.getElementById("pillSource");
    const pillVisible = document.getElementById("pillVisible");

    const topMsg = document.getElementById("topMsg");

    const placeEl = document.getElementById("place");
    const birthMinEl = document.getElementById("birthMin");
    const birthMaxEl = document.getElementById("birthMax");
    const deathMinEl = document.getElementById("deathMin");
    const deathMaxEl = document.getElementById("deathMax");
    const cluesEl = document.getElementById("clues");
    const minScoreEl = document.getElementById("minScore");

    const applyBtn = document.getElementById("applyBtn");
    const resetBtn = document.getElementById("resetBtn");
    const askBtn = document.getElementById("askBtn");

    const candList = document.getElementById("candList");
    const previewBox = document.getElementById("previewBox");

    const importBtn = document.getElementById("importBtn");
    const copyBtn = document.getElementById("copyBtn");
    const dropBtn = document.getElementById("dropBtn");

    const ctxQ = document.getElementById("ctxQ");
    const ctxApiQ = document.getElementById("ctxApiQ");
    const ctxHints = document.getElementById("ctxHints");

    /* ============================================================
       Helpers
       ============================================================ */
    function safeParse(raw, fallback){
      try{ return JSON.parse(raw); }catch{ return fallback; }
    }
    function loadJsonLS(key, fallback){
      const raw = localStorage.getItem(key);
      return raw ? safeParse(raw, fallback) : fallback;
    }
    function saveJsonLS(key, value){
      localStorage.setItem(key, JSON.stringify(value));
    }
    function loadJsonSS(key, fallback){
      const raw = sessionStorage.getItem(key);
      return raw ? safeParse(raw, fallback) : fallback;
    }
    function saveJsonSS(key, value){
      sessionStorage.setItem(key, JSON.stringify(value));
    }

    function escapeHtml(s){
      return String(s || "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function showTopMsg(kind, text){
      topMsg.hidden = false;
      topMsg.className = "liftBox " + (kind || "warn");
      topMsg.innerHTML = escapeHtml(text);
    }
    function clearTopMsg(){
      topMsg.hidden = true;
      topMsg.innerHTML = "";
      topMsg.className = "liftBox";
    }

    function normalize(s){
      return String(s || "").trim().toLowerCase();
    }

    function parseYear(v){
      const s = String(v || "").trim();
      if(!s) return null;
      const n = Number(s);
      if(!Number.isFinite(n)) return null;
      const i = Math.trunc(n);
      if(i < 0 || i > 3000) return null;
      return i;
    }

    function activeTreeId(){
      return localStorage.getItem(KEY_ACTIVE) || "";
    }
    function getTrees(){
      const arr = loadJsonLS(KEY_TREES, []);
      return Array.isArray(arr) ? arr : [];
    }
    function activeTreeLabel(){
      const id = activeTreeId();
      if(!id) return "—";
      const t = getTrees().find(x => String(x.id) === String(id));
      return t ? (t.name || t.id) : id;
    }

    function refreshPills(visibleCount){
      const t = activeTreeId();
      const trees = getTrees();
      const hasTrees = trees.length > 0;
      const hasActive = !!t;

      pillTree.className = "pill " + (hasActive ? "ok" : (hasTrees ? "warn" : "err"));
      pillTree.innerHTML = "Aktivt träd: <strong>" + escapeHtml(hasActive ? activeTreeLabel() : "—") + "</strong>";

      pillCand.innerHTML = "Kandidater: <strong>" + String(current.length) + "</strong>";

      const src = (context && context.providerLabel) ? String(context.providerLabel) : "—";
      pillSource.className = "pill " + (src === "—" ? "warn" : "ok");
      pillSource.innerHTML = "Källa: <strong>" + escapeHtml(src) + "</strong>";

      pillVisible.innerHTML = "Visas: <strong>" + String(visibleCount || 0) + "</strong>";
    }

    function yearsText(c){
      const b = (c && c.birthYear != null) ? String(c.birthYear) : "—";
      const d = (c && c.deathYear != null) ? String(c.deathYear) : "—";
      if(b === "—" && d === "—") return "";
      return " (" + b + "–" + d + ")";
    }
    function candTitle(c){
      return (c && c.name ? String(c.name) : "(namn saknas)") + yearsText(c);
    }

    function newId(){
      return "p_" + Date.now().toString(36) + "_" + Math.random().toString(36).slice(2,7);
    }

    /* ============================================================
       Load session (fail-closed)
       ============================================================ */
    let context = loadJsonSS(SS_CONTEXT, null);
    let base = loadJsonSS(SS_CANDIDATES, null);

    if(!Array.isArray(base) || base.length === 0){
      showTopMsg("err", "⛔ Inga kandidater i session. Gå tillbaka till sök och hämta ny lista. (Fail-closed)");
      setTimeout(() => { window.location.href = "./person-search.html"; }, 700);
    }

    // Intern arbetslista (session-only)
    let current = Array.isArray(base) ? base.slice() : [];
    let selectedIndex = -1;

    // Visningscache
    let lastRendered = [];

    // Pre-fill inputs från context (hints)
    (function hydrateFromContext(){
      const hints = (context && Array.isArray(context.hints)) ? context.hints.slice() : [];
      const place = (context && context.place) ? String(context.place) : "";
      const yMin = (context && typeof context.yearMin === "number") ? context.yearMin : null;
      const yMax = (context && typeof context.yearMax === "number") ? context.yearMax : null;

      if(place) placeEl.value = place;
      if(yMin != null) birthMinEl.value = String(yMin);
      if(yMax != null) birthMaxEl.value = String(yMax);

      ctxQ.textContent = context && context.q ? String(context.q) : "—";
      ctxApiQ.textContent = context && context.apiQuery ? String(context.apiQuery) : "—";
      ctxHints.textContent = hints.length ? hints.join(" | ") : "—";

      // Lägg in hints i clues också (så poängsystemet använder dem direkt)
      if(hints.length){
        const existing = String(cluesEl.value || "").trim();
        const merged = (existing ? (existing + " ") : "") + hints.join(" ");
        cluesEl.value = merged.trim();
      }

      // Förvalt minScore: visa typ de bättre
      if(!String(minScoreEl.value || "").trim()){
        minScoreEl.value = "0";
      }
    })();

    /* ============================================================
       Scoring (lokalt)
       ============================================================ */
    function scoreCandidate(c, f){
      let score = 0;

      const name = normalize(c.name);
      const place = normalize(c.place);
      const source = normalize(c.source);
      const why = Array.isArray(c.why) ? c.why.map(normalize).join(" ") : "";

      // Plats (stark)
      if(f.place){
        if(place.includes(f.place)) score += 25;
        else score -= 6;
      }

      // Årintervall (mjuk)
      const by = (typeof c.birthYear === "number") ? c.birthYear : null;
      const dy = (typeof c.deathYear === "number") ? c.deathYear : null;

      if(f.birthMin != null){
        if(by == null) score -= 3;
        else if(by >= f.birthMin) score += 8;
        else score -= 9;
      }
      if(f.birthMax != null){
        if(by == null) score -= 3;
        else if(by <= f.birthMax) score += 8;
        else score -= 9;
      }

      if(f.deathMin != null){
        if(dy == null) score -= 2;
        else if(dy >= f.deathMin) score += 6;
        else score -= 7;
      }
      if(f.deathMax != null){
        if(dy == null) score -= 2;
        else if(dy <= f.deathMax) score += 6;
        else score -= 7;
      }

      // Nyckelord (fri text) – lite aggressiv men enkel
      for(const k of f.keywords){
        const hit = name.includes(k) || place.includes(k) || source.includes(k) || why.includes(k);
        score += hit ? 5 : -1;
      }

      return score;
    }

    function getFilters(){
      const place = normalize(placeEl.value);

      const birthMin = parseYear(birthMinEl.value);
      const birthMax = parseYear(birthMaxEl.value);
      const deathMin = parseYear(deathMinEl.value);
      const deathMax = parseYear(deathMaxEl.value);

      const clues = normalize(cluesEl.value);
      const keywords = clues
        ? clues.split(/[\s,.;:()]+/).map(x => x.trim()).filter(x => x.length >= 3).slice(0, 30)
        : [];

      const minScore = parseYear(minScoreEl.value);
      return { place, birthMin, birthMax, deathMin, deathMax, keywords, minScore: (minScore == null ? 0 : minScore) };
    }

    function applyScoring(showMessage){
      clearTopMsg();
      const f = getFilters();

      // Score + sort
      const scored = current.map(c => ({ c, score: scoreCandidate(c, f) }));
      scored.sort((a,b) => (b.score - a.score));

      // Filter for view (minScore)
      const visible = scored.filter(x => x.score >= f.minScore);

      // Spara renderad lista (för click-index)
      lastRendered = visible;

      renderList(visible);
      refreshPills(visible.length);

      // UX: om bara 1 kandidat återstår i visningen, markera det tydligt
      if(visible.length === 1){
        showTopMsg("ok", "✅ Endast 1 kandidat kvar över tröskeln. Kontrollera och importera om det är rätt.");
      }else if(showMessage){
        showTopMsg("ok", "✅ Poängsatt och sorterat. Visar " + visible.length + " kandidat(er) (minScore=" + f.minScore + ").");
      }
    }

    /* ============================================================
       Render
       ============================================================ */
    function setSelected(renderedIndex){
      selectedIndex = renderedIndex;

      const c = (renderedIndex >= 0 && renderedIndex < lastRendered.length) ? lastRendered[renderedIndex].c : null;

      const items = candList.querySelectorAll(".item");
      items.forEach((el, idx) => el.classList.toggle("sel", idx === renderedIndex));

      if(!c){
        previewBox.className = "liftBox";
        previewBox.innerHTML = "Välj en kandidat för att se detaljer här.";
        importBtn.disabled = true;
        copyBtn.disabled = true;
        dropBtn.disabled = true;
        return;
      }

      previewBox.className = "liftBox ok";
      previewBox.innerHTML =
        "<div><strong>" + escapeHtml(candTitle(c)) + "</strong></div>" +
        "<div class='small' style='margin-top:6px;'>" +
          "Plats: <span class='mono'>" + escapeHtml(c.place || "—") + "</span><br/>" +
          "Källa: <span class='mono'>" + escapeHtml(c.source || "—") + "</span><br/>" +
          (c.url ? ("URL: <span class='mono'>" + escapeHtml(c.url) + "</span><br/>") : "") +
          (Array.isArray(c.why) && c.why.length ? ("Varför: <span class='mono'>" + escapeHtml(c.why.join(" · ")) + "</span>") : "") +
        "</div>";

      importBtn.disabled = false;
      copyBtn.disabled = false;
      dropBtn.disabled = false;
    }

    function renderList(visible){
      candList.innerHTML = "";

      if(!visible.length){
        const li = document.createElement("li");
        li.className = "item";
        li.style.cursor = "default";
        li.innerHTML =
          "<p class='itemTitle'>0 kandidater visas</p>" +
          "<p class='itemMeta'>Sänk minScore eller nollställ frågor. Du kan också fråga källan igen.</p>";
        candList.appendChild(li);
        setSelected(-1);
        return;
      }

      for(let i=0;i<visible.length;i++){
        const c = visible[i].c;
        const score = visible[i].score;

        const li = document.createElement("li");
        li.className = "item";

        const badgeClass = score >= 0 ? "badge good" : "badge bad";

        li.innerHTML =
          "<p class='itemTitle'>" +
            "<span class='" + badgeClass + "'>Score: " + String(score) + "</span>" +
            escapeHtml(candTitle(c)) +
          "</p>" +
          "<p class='itemMeta'>" +
            (c.place ? ("Plats: " + escapeHtml(c.place)) : "Plats: —") +
            (c.source ? (" · Källa: " + escapeHtml(c.source)) : "") +
          "</p>";

        li.addEventListener("click", () => setSelected(i));
        candList.appendChild(li);
      }

      setSelected(-1);
    }

    /* ============================================================
       Ask source again (ny sökning på API-query från context)
       - Fail-closed: om context saknas -> tillbaka till sök
       ============================================================ */
    async function askSourceAgain(){
      clearTopMsg();

      if(!(window.RAProviders && typeof window.RAProviders.pickProvider === "function")){
        showTopMsg("err", "⛔ Providerlager saknas. Kontrollera ra-providers.js.");
        return;
      }

      const apiQuery = (context && context.apiQuery) ? String(context.apiQuery).trim() : "";
      if(!apiQuery){
        showTopMsg("err", "⛔ Saknar apiQuery. Gå tillbaka och gör ett nytt sök. (Fail-closed)");
        return;
      }

      askBtn.disabled = true;

      try{
        const provider = window.RAProviders.pickProvider("searchapi");
        const raw = await provider.search(apiQuery);

        // 0 träffar = 0 (ingen fallback här)
        if(Array.isArray(raw) && raw.length === 0){
          current = [];
          base = [];
          saveJsonSS(SS_CANDIDATES, []);
          showTopMsg("warn", "⚠️ 0 träffar vid ny fråga: “" + apiQuery + "”. Gå tillbaka och ändra söket.");
          applyScoring(false);
          refreshPills(0);
          return;
        }

        current = Array.isArray(raw) ? raw.slice(0, 80) : [];
        base = current.slice();

        // Uppdatera context label
        context = Object.assign({}, (context || {}), {
          providerId: "searchapi",
          providerLabel: provider.label || "Riksarkivet"
        });

        saveJsonSS(SS_CANDIDATES, current);
        saveJsonSS(SS_CONTEXT, context);

        // Poängsätt direkt (med dina nuvarande frågor)
        applyScoring(false);
        showTopMsg("ok", "✅ Nytt svar från källan. Listan är uppdaterad i session (inte sparad).");

      }catch(e){
        const msg = (e && e.message) ? String(e.message) : String(e || "");
        showTopMsg("warn", "⚠️ Kunde inte fråga källan igen: " + msg + " (fail-closed → behåller nuvarande lista).");
      }finally{
        askBtn.disabled = false;
      }
    }

    /* ============================================================
       Import (explicit action only)
       - 110-årsspärr på birthYear (fail-closed)
       - Respekterar core storage-keys/datamodell
       ============================================================ */
    function importSelected(){
      clearTopMsg();

      const t = activeTreeId();
      if(!t){
        showTopMsg("err", "⛔ Inget aktivt träd. Gå till Träd och välj aktivt träd innan import.");
        return;
      }

      if(!(selectedIndex >= 0 && selectedIndex < lastRendered.length)){
        showTopMsg("warn", "⚠️ Välj en kandidat först.");
        return;
      }

      const c = lastRendered[selectedIndex].c;

      // 110-årsspärr (på födelseår om det finns)
      const nowYear = new Date().getFullYear();
      const cut = nowYear - 110;
      if(typeof c.birthYear === "number" && Number.isFinite(c.birthYear) && c.birthYear > cut){
        showTopMsg("err", "⛔ Spärr: födelseår " + String(c.birthYear) + " är för nytt (>" + String(cut) + "). Import stoppad.");
        return;
      }

      // Split namn (enkel, fail-closed om tomt)
      const full = String(c.name || "").trim();
      if(!full){
        showTopMsg("err", "⛔ Kan inte importera: namn saknas.");
        return;
      }
      const parts = full.split(/\s+/).filter(Boolean);
      const fornamn = parts.slice(0, Math.max(1, parts.length - 1)).join(" ");
      const efternamn = (parts.length >= 2) ? parts.slice(-1).join(" ") : "";

      const people = loadJsonLS(cardsKey(t), []);
      const arr = Array.isArray(people) ? people : [];

      const id = newId();

      const created = {
        id,
        fornamn,
        efternamn,
        kon: "",
        yrke: "",
        fodelsear: (c.birthYear != null ? String(c.birthYear) : ""),
        dodsar: (c.deathYear != null ? String(c.deathYear) : ""),
        plats: String(c.place || "").trim(),
        coords: null,
        anteckning: [
          "Importerad från extern källa (via person-puzzle).",
          (context && context.providerLabel) ? ("Källa: " + context.providerLabel) : "",
          c.source ? ("Source: " + c.source) : "",
          c.url ? ("URL: " + c.url) : "",
          (Array.isArray(c.why) && c.why.length) ? ("Varför: " + c.why.join(" · ")) : "",
          (context && context.apiQuery) ? ("Sök: " + context.apiQuery) : ""
        ].filter(Boolean).join("\n")
      };

      arr.push(created);
      saveJsonLS(cardsKey(t), arr);

      // Dataminimering: rensa session efter import
      try{
        sessionStorage.removeItem(SS_CANDIDATES);
        sessionStorage.removeItem(SS_CONTEXT);
      }catch{}

      // Öppna i Personer
      window.location.href = "./slaktkort.html#open=" + encodeURIComponent(id);
    }

    async function copySelected(){
      if(!(selectedIndex >= 0 && selectedIndex < lastRendered.length)) return;

      const c = lastRendered[selectedIndex].c;
      const b = (c.birthYear != null) ? String(c.birthYear) : "—";
      const d = (c.deathYear != null) ? String(c.deathYear) : "—";

      const text =
        candTitle(c) + "\n" +
        "Plats: " + (c.place || "—") + "\n" +
        "Källa: " + (c.source || "—") + "\n" +
        "Födelseår: " + b + " · Dödsår: " + d + "\n" +
        (c.url ? ("URL: " + c.url + "\n") : "") +
        (Array.isArray(c.why) && c.why.length ? ("Varför: " + c.why.join(" · ") + "\n") : "");

      try{
        await navigator.clipboard.writeText(text);
        showTopMsg("ok", "✅ Kopierat till urklipp.");
      }catch{
        showTopMsg("warn", "⚠️ Kunde inte kopiera (webbläsaren blockerade).");
      }
    }

    function dropSelected(){
      clearTopMsg();
      if(!(selectedIndex >= 0 && selectedIndex < lastRendered.length)){
        showTopMsg("warn", "⚠️ Välj en kandidat först.");
        return;
      }

      const c = lastRendered[selectedIndex].c;

      // Ta bort från current (matcha på id/url/name)
      current = current.filter(x => {
        if(x === c) return false;
        const sameId = x && c && x.id && c.id && String(x.id) === String(c.id);
        const sameUrl = x && c && x.url && c.url && String(x.url) === String(c.url);
        const sameName = x && c && x.name && c.name && String(x.name) === String(c.name);
        return !(sameId || sameUrl || sameName);
      });

      saveJsonSS(SS_CANDIDATES, current);

      applyScoring(false);
      showTopMsg("ok", "✅ Kandidat borttagen (session-only).");
    }

    function resetQuestions(){
      placeEl.value = "";
      birthMinEl.value = "";
      birthMaxEl.value = "";
      deathMinEl.value = "";
      deathMaxEl.value = "";
      cluesEl.value = "";
      minScoreEl.value = "0";
      showTopMsg("ok", "✅ Frågor nollställda.");
      applyScoring(false);
    }

    function goBack(){
      window.location.href = "./person-search.html";
    }

    /* ============================================================
       Events
       ============================================================ */
    logoutBtn.addEventListener("click", () => {
      try{ sessionStorage.removeItem("demo_auth"); }catch{}
      window.location.href = "../index.html";
    });

    backBtn.addEventListener("click", goBack);

    applyBtn.addEventListener("click", () => applyScoring(true));
    resetBtn.addEventListener("click", resetQuestions);
    askBtn.addEventListener("click", askSourceAgain);

    importBtn.addEventListener("click", importSelected);
    copyBtn.addEventListener("click", copySelected);
    dropBtn.addEventListener("click", dropSelected);

    // Enter = poängsätt (smidigt)
    [placeEl, birthMinEl, birthMaxEl, deathMinEl, deathMaxEl, minScoreEl, cluesEl].forEach(el => {
      el.addEventListener("keydown", (e) => {
        if(e.key === "Enter" && el !== cluesEl){
          e.preventDefault();
          applyScoring(true);
        }
      });
    });

    /* ============================================================
       Init
       ============================================================ */
    (function init(){
      // Active tree check (fail-closed)
      if(!activeTreeId()){
        showTopMsg("err", "⛔ Inget aktivt träd valt. Gå till Träd och välj aktivt träd. (Fail-closed)");
      }

      // Start
      applyScoring(false);

      const q = (context && context.q) ? String(context.q) : "";
      const apiQ = (context && context.apiQuery) ? String(context.apiQuery) : "";
      const hints = (context && Array.isArray(context.hints)) ? context.hints : [];
      if(q){
        showTopMsg("warn", "ℹ️ Start: " + current.length + " kandidater från sök. Bas: “" + q + "”. API: “" + (apiQ || "—") + "”. " + (hints.length ? ("Hints: " + hints.join(" | ") + ".") : "Lägg till pusselbitar för bättre score."));
      }else{
        showTopMsg("warn", "ℹ️ Start: " + current.length + " kandidater. Poängsätt för att ringa in rätt person.");
      }

      try{ placeEl.focus(); }catch{}
    })();
  </script>
</body>
</html>
