<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Person Puzzle – Släktkort</title>
  <meta name="description" content="Stegvis förfining av kandidatpool (DB1→DB4) för att hitta bästa match." />

  <style>
    :root{ color-scheme: light; }
    body{
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      line-height: 1.5;
      margin: 0;
      padding: 24px;
      max-width: 1180px;
      margin-inline: auto;
      background: #fff;
      color: #111;
    }
    a{ color: inherit; text-decoration:none; }
    header{ margin-bottom:18px; }
    h1{ margin:0 0 6px; font-size: 28px; }
    .muted{ color:#555; margin:0; }

    .pillRow{
      display:flex; flex-wrap:wrap; gap:10px; margin:12px 0 18px;
    }
    .pill{
      padding:8px 12px; border-radius:999px; border:1px solid #ddd;
      background:#fafafa; font-size:14px;
    }
    .ok{ background:#f5fff5; border-color:#cfe8cf; }
    .warn{ background:#fff9ee; border-color:#ffe1a6; }
    .err{ background:#fff2f2; border-color:#ffb3b3; }

    .grid{ display:grid; gap:14px; grid-template-columns: 1fr; }
    @media (min-width: 980px){
      .grid{ grid-template-columns: 420px 1fr; }
    }

    .card{
      border:1px solid #e6e8eb; border-radius:16px; padding:14px; background:#fff;
      box-shadow: 0 1px 0 rgba(0,0,0,.03);
    }
    .card h2{ margin:0 0 6px; font-size:18px; }
    .small{ color:#555; font-size:13px; }

    .actions{ display:flex; flex-wrap:wrap; gap:10px; margin-top:10px; }
    button{
      padding:10px 14px; border-radius:12px; border:1px solid #333;
      background:#111; color:#fff; font:inherit; cursor:pointer;
    }
    button.secondary{ background:#fff; color:#111; border-color:#bbb; }
    button:disabled{ opacity:.55; cursor:not-allowed; }

    .list{ list-style:none; padding:0; margin-top:10px; display:flex; flex-direction:column; gap:10px; }
    .item{ border:1px solid #eee; border-radius:14px; padding:10px; background:#fff; }
    .itemTitle{ font-weight:800; margin:0 0 2px; }
    .itemMeta{ font-size:13px; color:#555; margin:0; }

    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; }
  </style>
</head>

<body>
<header>
  <h1>Person Puzzle</h1>
  <p class="muted">Stegvis pipeline: bygg kandidatpool → förfina → hitta bästa match.</p>
</header>

<section class="pillRow">
  <span id="pillStage" class="pill warn">Steg: <strong>Init</strong></span>
  <span id="pillCount" class="pill">Kandidater: <strong>0</strong></span>
  <span id="pillInfo" class="pill">Status: <strong>Väntar</strong></span>
</section>

<div class="grid">
  <section class="card">
    <h2>Pipeline</h2>
    <p class="small">
      DB1 bygger pool. DB2–DB4 förfinar samma kandidater.
      Listan kapas efter varje steg.
    </p>

    <div class="actions">
      <button id="stage1Btn">Steg 1 – Grovsortera (Top 20)</button>
      <button id="stage2Btn" class="secondary">Steg 2 – Enrich A (Top 10–20)</button>
      <button id="stage3Btn" class="secondary">Steg 3 – Enrich B (Top 5–10)</button>
      <button id="stage4Btn" class="secondary">Steg 4 – Slutrankning (Top 1–10)</button>
    </div>

    <div class="actions">
      <button id="resetBtn" class="secondary">Nollställ Puzzle</button>
    </div>
  </section>

  <section class="card">
    <h2>Kandidater</h2>
    <ul id="list" class="list"></ul>
  </section>
</div>

<script src="./assets/js/ra-providers.js"></script>
<script>
"use strict";

/* ============================================================
   STATE (in-memory only)
   ============================================================ */
let pool = [];     // [{ candidate, score, why, enrichBits }]
let stage = 0;

/* ============================================================
   DOM
   ============================================================ */
const pillStage = document.getElementById("pillStage");
const pillCount = document.getElementById("pillCount");
const pillInfo  = document.getElementById("pillInfo");
const listEl    = document.getElementById("list");

const stage1Btn = document.getElementById("stage1Btn");
const stage2Btn = document.getElementById("stage2Btn");
const stage3Btn = document.getElementById("stage3Btn");
const stage4Btn = document.getElementById("stage4Btn");
const resetBtn  = document.getElementById("resetBtn");

/* ============================================================
   Helpers
   ============================================================ */
function normalize(s){ return String(s||"").toLowerCase().trim(); }
function clamp(n,min,max){ return Math.min(Math.max(n,min),max); }

function updatePills(){
  pillStage.innerHTML = "Steg: <strong>" + stage + "</strong>";
  pillCount.innerHTML = "Kandidater: <strong>" + pool.length + "</strong>";
}

function render(){
  listEl.innerHTML = "";
  for(const p of pool){
    const li = document.createElement("li");
    li.className = "item";
    li.innerHTML =
      "<p class='itemTitle'>" + p.candidate.name + "</p>" +
      "<p class='itemMeta'>Score: <span class='mono'>" + p.score + "</span></p>";
    listEl.appendChild(li);
  }
  updatePills();
}

/* ============================================================
   SCORING (enkel, deterministisk)
   ============================================================ */
function scoreCandidate(c){
  let s = 0;
  if(c.name) s += 20;
  if(c.place) s += 10;
  if(c.birthYear) s += 15;
  if(c.deathYear) s += 10;
  if(c.url) s += 5;
  return s;
}

/* ============================================================
   PIPELINE STEPS
   ============================================================ */
function step1(){
  stage = 1;
  pillInfo.textContent = "Grovsorterar…";
  pool.forEach(p => p.score = scoreCandidate(p.candidate));
  pool.sort((a,b)=>b.score-a.score);
  pool = pool.slice(0,20);
  render();
  pillInfo.textContent = "Steg 1 klart";
}

async function enrichWithProviders(limitMin, limitMax){
  const providers = (window.RAProviders && window.RAProviders.enrichProviders) || [];
  for(const p of pool){
    p.enrichBits = [];
    for(const prov of providers){
      try{
        if(prov.supports && prov.supports(p.candidate)){
          const bits = await prov.enrich(p.candidate,{});
          if(Array.isArray(bits)) p.enrichBits.push(...bits);
        }
      }catch{}
    }
    if(p.enrichBits.length) p.score += 10;
  }
  pool.sort((a,b)=>b.score-a.score);
  pool = pool.slice(0, clamp(pool.length, limitMin, limitMax));
}

async function step2(){
  stage = 2;
  pillInfo.textContent = "Enrich A…";
  await enrichWithProviders(10,20);
  render();
  pillInfo.textContent = "Steg 2 klart";
}

async function step3(){
  stage = 3;
  pillInfo.textContent = "Enrich B…";
  await enrichWithProviders(5,10);
  render();
  pillInfo.textContent = "Steg 3 klart";
}

async function step4(){
  stage = 4;
  pillInfo.textContent = "Slutrankning…";
  pool.sort((a,b)=>b.score-a.score);
  pool = pool.slice(0,10);
  render();
  pillInfo.textContent = "Steg 4 klart";
}

/* ============================================================
   EVENTS
   ============================================================ */
stage1Btn.onclick = step1;
stage2Btn.onclick = step2;
stage3Btn.onclick = step3;
stage4Btn.onclick = step4;

resetBtn.onclick = () => {
  pool = [];
  stage = 0;
  render();
  pillInfo.textContent = "Nollställd";
};

/* ============================================================
   INTAKE
   - Via postMessage (pool-läge)
   - Via ?candidate= (fallback)
   ============================================================ */
window.addEventListener("message", (e)=>{
  if(e.data && e.data.type === "PUZZLE_POOL" && Array.isArray(e.data.items)){
    pool = e.data.items.map(c => ({ candidate:c, score:0, enrichBits:[] }));
    stage = 0;
    render();
    pillInfo.textContent = "Pool mottagen";
  }
});

// fallback: single candidate via URL
(function(){
  const u = new URL(location.href);
  const raw = u.searchParams.get("candidate");
  if(!raw) return;
  try{
    const json = decodeURIComponent(atob(raw.replace(/-/g,"+").replace(/_/g,"/")));
    const c = JSON.parse(json);
    pool = [{ candidate:c, score:0, enrichBits:[] }];
    render();
    pillInfo.textContent = "En kandidat laddad";
  }catch{}
})();
</script>
</body>
</html>
