<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>V√§lj plats ‚Äì Sl√§ktkort</title>
  <meta name="description" content="V√§lj koordinater p√• karta och spara tillbaka till personkort." />

  <!-- Leaflet -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <style>
    :root { color-scheme: light; }
    body{
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      line-height: 1.5;
      margin: 0;
      padding: 24px;
      max-width: 1100px;
      margin-inline: auto;
      background: #fff;
      color: #111;
    }
    a{ color: inherit; text-decoration:none; }
    header{ margin-bottom: 14px; }
    h1{ margin:0 0 6px; font-size: 28px; }
    .muted{ color:#555; margin:0; }
    .card{
      border:1px solid #e6e8eb;
      border-radius: 16px;
      padding: 14px;
      background:#fff;
      box-shadow: 0 1px 0 rgba(0,0,0,.03);
    }
    .grid{
      display:grid;
      gap: 14px;
      grid-template-columns: 1fr;
    }
    @media (min-width: 980px){
      .grid{ grid-template-columns: 420px 1fr; }
    }
    .btn{
      padding: 10px 12px;
      border-radius: 12px;
      background: #fff;
      border: 1px solid #e6e8eb;
      cursor: pointer;
      font: inherit;
    }
    .btn.primary{
      background:#111;
      color:#fff;
      border-color:#111;
    }
    .btn.secondary{ background:#fafafa; }
    .btn.disabled{ opacity:.5; cursor:not-allowed; pointer-events:none; }
    .actions{
      display:flex;
      flex-wrap:wrap;
      gap: 10px;
      align-items:center;
      margin-top: 12px;
    }
    .pillRow{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      margin: 10px 0 14px;
    }
    .pill{
      display:inline-flex;
      gap:8px;
      align-items:center;
      padding:8px 10px;
      border:1px solid #ddd;
      border-radius:999px;
      background:#fafafa;
      font-size: .95rem;
    }
    .pill strong{ font-weight:900; }
    .pill.ok{ border-color:#cfe8cf; background:#f5fff5; }
    .pill.warn{ border-color:#ffe1a6; background:#fff9ee; }
    .pill.err{ border-color:#ffb3b3; background:#fff2f2; }
    #map{
      width:100%;
      height: 620px;
      border-radius: 16px;
      border: 1px solid #e6e8eb;
      overflow:hidden;
      background:#f4f4f4;
    }
    @media (max-width: 520px){
      #map{ height: 480px; }
    }
    code{ background:#f4f4f4; padding:2px 6px; border-radius:6px; }
    .hint{
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid #ffe1a6;
      background: #fff9ee;
      font-size: 13px;
      color:#333;
    }
    .error{ color:#b00020; font-weight:900; }
    .ok{ font-weight:900; }
    label{ display:block; font-weight:800; margin: 10px 0 6px; }
    input{
      width:100%;
      box-sizing:border-box;
      padding: 10px;
      border-radius: 12px;
      border: 1px solid #bbb;
      font: inherit;
      background:#fff;
    }

    /* Minimal ‚Äúflag‚Äù-icon (matchar map.html-stilen) */
    .mkWrap{
      width: 22px; height: 22px;
      border-radius: 999px;
      display:flex; align-items:center; justify-content:center;
      background: rgba(255,255,255,.92);
      border: 1px solid rgba(17,17,17,.18);
      box-shadow: 0 6px 18px rgba(0,0,0,.08);
      user-select:none;
    }
    .mkFlag{ font-size: 14px; line-height: 1; transform: translateY(0.5px); }
    .leaflet-marker-icon.mkIcon{ background: transparent; border: 0; }
  </style>
</head>

<body>
  <header>
    <h1>V√§lj plats</h1>
    <p class="muted">Klicka i kartan f√∂r att placera en flagga och spara tillbaka till personkortet.</p>
  </header>

  <section class="pillRow" aria-label="Status">
    <span id="pillCtx" class="pill warn">Koppling: <strong>‚Äî</strong></span>
    <span id="pillPick" class="pill">Vald plats: <strong>‚Äî</strong></span>
  </section>

  <div class="grid">
    <section class="card" aria-label="Kontroller">
      <h2 style="margin:0 0 6px; font-size:18px;">Kontroller</h2>
      <p class="muted" style="margin:0 0 10px;">Spara skickar koordinater till <code>slakttradet_place_pick_result</code> och g√•r tillbaka.</p>

      <label for="label">Platsnamn (valfritt)</label>
      <input id="label" placeholder="t.ex. Falun" autocomplete="off" />

      <label for="coords">Koordinater</label>
      <input id="coords" placeholder="Klicka i kartan‚Ä¶" readonly />

      <div class="actions">
        <button class="btn primary disabled" id="saveBtn" type="button">Spara plats</button>
        <button class="btn secondary" id="clearBtn" type="button">Rensa</button>
        <button class="btn secondary" id="backBtn" type="button">Tillbaka utan att spara</button>
      </div>

      <div id="msg" class="hint" hidden></div>

      <div class="hint">
        <strong>Tips</strong><br/>
        Klicka i kartan d√§r flaggan ska st√•. Du kan ocks√• zooma in f√∂r precision.
      </div>
    </section>

    <section class="card" aria-label="Karta">
      <h2 style="margin:0 0 6px; font-size:18px;">Karta</h2>
      <p class="muted" style="margin:0 0 10px;">OpenStreetMap via Leaflet.</p>
      <div id="map" role="application" aria-label="Karta f√∂r platsval"></div>
    </section>
  </div>

  <script>
    "use strict";

    // -----------------------------------------------------
    // DEMO AUTH GUARD (matchar dina andra sidor)
    // -----------------------------------------------------
    (function authGuard(){
      try{
        if(sessionStorage.getItem("demo_auth") !== "1"){
          window.location.href = "../index.html";
        }
      }catch{}
    })();

    // -----------------------------------------------------
    // Keys (m√•ste matcha slaktkort.html)
    // -----------------------------------------------------
    const PLACE_CTX_KEY = "slakttradet_place_pick_ctx";
    const PLACE_RES_KEY = "slakttradet_place_pick_result";

    // Draft key (f√∂r att kunna l√§sa ev coords fr√•n utkast)
    const KEY_ACTIVE = "slakttradet_active_tree_id";
    const draftKey = (treeId) => "slakttradet_person_draft_" + String(treeId);

    // -----------------------------------------------------
    // DOM
    // -----------------------------------------------------
    const pillCtx = document.getElementById("pillCtx");
    const pillPick = document.getElementById("pillPick");

    const labelEl = document.getElementById("label");
    const coordsEl = document.getElementById("coords");

    const saveBtn = document.getElementById("saveBtn");
    const clearBtn = document.getElementById("clearBtn");
    const backBtn = document.getElementById("backBtn");

    const msg = document.getElementById("msg");

    // -----------------------------------------------------
    // Helpers
    // -----------------------------------------------------
    function safeParse(raw, fallback){
      try{ return JSON.parse(raw); }catch{ return fallback; }
    }
    function loadJson(key, fallback){
      const raw = localStorage.getItem(key);
      return raw ? safeParse(raw, fallback) : fallback;
    }
    function saveJson(key, value){
      localStorage.setItem(key, JSON.stringify(value));
    }

    function inLatLonRange(lat, lon){
      return Number.isFinite(lat) && Number.isFinite(lon) && lat >= -90 && lat <= 90 && lon >= -180 && lon <= 180;
    }
    function fmt(lat, lon){
      return lat.toFixed(4) + ", " + lon.toFixed(4);
    }
    function show(kind, html){
      msg.hidden = false;
      msg.style.borderColor = (kind === "ok") ? "#cfe8cf" : (kind === "err" ? "#ffb3b3" : "#ffe1a6");
      msg.style.background = (kind === "ok") ? "#f5fff5" : (kind === "err" ? "#fff2f2" : "#fff9ee");
      msg.innerHTML = html;
    }
    function hideMsg(){
      msg.hidden = true;
      msg.innerHTML = "";
    }
    function setSaveEnabled(on){
      if(on){
        saveBtn.classList.remove("disabled");
        saveBtn.setAttribute("aria-disabled","false");
      }else{
        saveBtn.classList.add("disabled");
        saveBtn.setAttribute("aria-disabled","true");
      }
    }

    // -----------------------------------------------------
    // Read ctx + draft
    // -----------------------------------------------------
    function activeTreeId(){
      return localStorage.getItem(KEY_ACTIVE) || "";
    }

    const ctx = loadJson(PLACE_CTX_KEY, null);
    const treeIdNow = activeTreeId();

    if(ctx && ctx.treeId && treeIdNow && String(ctx.treeId) === String(treeIdNow)){
      pillCtx.className = "pill ok";
      pillCtx.innerHTML = "Koppling: <strong>OK</strong>";
    }else{
      pillCtx.className = "pill warn";
      pillCtx.innerHTML = "Koppling: <strong>saknas</strong>";
      show("warn",
        "<strong>‚ö†Ô∏è Koppling saknas.</strong> " +
        "Du kan fortfarande v√§lja koordinater, men b√§sta fl√∂det √§r att √∂ppna platsval via <code>V√§lj plats</code> i Personkort."
      );
    }

    // -----------------------------------------------------
    // Leaflet map
    // -----------------------------------------------------
    function markerIconHtml(){
      return "<div class='mkWrap'><span class='mkFlag'>üá∏üá™</span></div>";
    }
    const MK_ICON = L.divIcon({
      className: "mkIcon",
      html: markerIconHtml(),
      iconSize: [22, 22],
      iconAnchor: [11, 11]
    });

    const map = L.map("map", { zoomControl: true });
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap'
    }).addTo(map);

    // Default: Sverige
    map.setView([62.0, 16.0], 4);

    let picked = null; // {lat, lon}
    let marker = null;

    function setPicked(lat, lon){
      if(!inLatLonRange(lat, lon)) return;

      picked = { lat, lon };
      coordsEl.value = fmt(lat, lon);

      pillPick.className = "pill ok";
      pillPick.innerHTML = "Vald plats: <strong>" + coordsEl.value + "</strong>";

      setSaveEnabled(true);

      if(marker) marker.remove();
      marker = L.marker([lat, lon], { icon: MK_ICON }).addTo(map);

      hideMsg();
    }

    // Pre-fill from draft coords if available (s√• man ser nuvarande position)
    (function prefillFromDraft(){
      const t = treeIdNow || (ctx && ctx.treeId) || "";
      if(!t) return;

      const d = loadJson(draftKey(t), null);
      if(d && d.coords && typeof d.coords === "object"){
        const lat = Number(d.coords.lat);
        const lon = Number(d.coords.lon);
        if(inLatLonRange(lat, lon)){
          setPicked(lat, lon);
          map.setView([lat, lon], Math.max(map.getZoom(), 9), { animate: false });
          show("ok", "‚úÖ Nuvarande plats fr√•n utkastet √§r inl√§st. Klicka i kartan om du vill √§ndra.");
        }
      }
    })();

    map.on("click", (e) => {
      const lat = Number(e.latlng.lat);
      const lon = Number(e.latlng.lng);
      setPicked(lat, lon);
    });

    // -----------------------------------------------------
    // Buttons
    // -----------------------------------------------------
    setSaveEnabled(false);
    pillPick.innerHTML = "Vald plats: <strong>‚Äî</strong>";

    clearBtn.addEventListener("click", () => {
      picked = null;
      coordsEl.value = "";
      pillPick.className = "pill";
      pillPick.innerHTML = "Vald plats: <strong>‚Äî</strong>";
      setSaveEnabled(false);
      if(marker) { marker.remove(); marker = null; }
      show("warn", "Plats rensad. Klicka i kartan f√∂r att v√§lja en ny.");
    });

    backBtn.addEventListener("click", () => {
      window.location.href = "./slaktkort.html";
    });

    saveBtn.addEventListener("click", () => {
      if(saveBtn.classList.contains("disabled")) return;
      if(!picked) return;

      const lat = Number(picked.lat);
      const lon = Number(picked.lon);
      if(!inLatLonRange(lat, lon)){
        show("err", "<span class='error'>‚õî Ogiltiga koordinater.</span>");
        return;
      }

      const label = String(labelEl.value || "").trim();

      // Skriv resultat som slaktkort.html konsumerar
      saveJson(PLACE_RES_KEY, { lat, lon, label });

      // Tillbaka till personkortet
      window.location.href = "./slaktkort.html";
    });
  </script>
</body>
</html>
