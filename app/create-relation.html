<!doctype html>
<html lang="sv">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Skapa relation (förälder → barn)</title>
    <meta name="description" content="Skapa en relation mellan två släktkort: förälder → barn." />
    <style>
      :root { color-scheme: light; }
      body {
        font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
        line-height: 1.5;
        margin: 0;
        padding: 24px;
        max-width: 900px;
      }
      a { color: inherit; }
      header { margin-bottom: 18px; }
      h1 { margin: 0 0 6px; }
      p { margin: 0 0 12px; }
      .muted { color: #555; }
      .card {
        border: 1px solid #ddd;
        border-radius: 10px;
        padding: 16px;
        margin: 14px 0;
      }
      label { display: block; margin: 10px 0 6px; font-weight: 600; }
      select, input {
        width: 100%;
        box-sizing: border-box;
        padding: 10px 10px;
        border: 1px solid #bbb;
        border-radius: 8px;
        font: inherit;
        background: #fff;
      }
      .row {
        display: grid;
        gap: 12px;
        grid-template-columns: 1fr;
      }
      @media (min-width: 720px) {
        .row.two { grid-template-columns: 1fr 1fr; }
      }
      .actions {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        margin-top: 14px;
      }
      button, .button-link {
        display: inline-block;
        padding: 10px 12px;
        border: 1px solid #333;
        border-radius: 8px;
        background: #fff;
        font: inherit;
        cursor: pointer;
        text-decoration: none;
      }
      button:focus, .button-link:focus { outline: 2px solid #000; outline-offset: 2px; }
      pre {
        background: #f4f4f4;
        padding: 12px;
        border-radius: 10px;
        overflow: auto;
      }
      code { background: #f4f4f4; padding: 2px 6px; border-radius: 6px; }
      .hint { margin-top: 10px; }
      .error { color: #b00020; font-weight: 600; }
      .ok { font-weight: 700; }

      .small { font-size: 0.95rem; }
      .pill {
        display: inline-block;
        padding: 2px 8px;
        border: 1px solid #bbb;
        border-radius: 999px;
        font-size: 0.9rem;
        margin-left: 6px;
      }
    </style>
  </head>

  <body>
    <header>
      <a href="./index.html">← Tillbaka</a>
      <h1>Skapa relation <span class="pill">Förälder → barn</span></h1>
      <p class="muted">
        Relationer är separata från släktkort. Här skapar du bara kopplingen.
      </p>
    </header>

    <section class="card" aria-label="Förutsättningar">
      <h2 style="margin:0 0 8px;">Förutsättning</h2>
      <p class="muted" style="margin-top:0;">
        Sidan läser personer från <code>data/slaktkort.json</code>. Om listorna är tomma:
      </p>
      <ul class="muted" style="margin:8px 0 0 18px;">
        <li>Skapa först släktkort i <code>create-slaktkort.html</code> och kopiera in dem i <code>data/slaktkort.json</code>.</li>
        <li>Kör gärna via GitHub Pages eller en lokal server (inte bara dubbelklick).</li>
      </ul>
    
      <p id="loadMsg" class="hint muted" aria-live="polite"></p>
    </section>

    <section class="card" aria-label="Relation formulär">
      <form id="form">
        <div class="row two">
          <div>
            <label for="parentSelect">Förälder *</label>
            <select id="parentSelect" required>
              <option value="" selected>Välj förälder…</option>
            </select>
          </div>
          <div>
            <label for="childSelect">Barn *</label>
            <select id="childSelect" required>
              <option value="" selected>Välj barn…</option>
            </select>
          </div>
        </div>

        <div class="actions">
          <button type="submit">Skapa relation (generera JSON)</button>
          <button type="button" id="resetBtn">Rensa</button>
          <a class="button-link" href="./index.html">Avbryt</a>
        </div>

        <p id="msg" class="hint muted" aria-live="polite"></p>
      </form>
    </section>

    <section class="card" aria-label="JSON output">
      <h2 style="margin:0 0 8px;">JSON (kopiera in i <code>data/relationer.json</code>)</h2>
      <p class="muted" style="margin-top:0;">
        Kopiera objektet nedan och lägg in det i listan <code>"relationer"</code>.
      </p>
      <pre><code id="out">{}</code></pre>
      <div class="actions">
        <button type="button" id="copyBtn">Kopiera JSON</button>
      </div>
      <p class="muted small" style="margin-top:10px;">
        Regler (låst): max 2 föräldrar per barn, inga cirklar, ingen självrelation.
        I detta steg gör vi bara grundkontroller.
      </p>
    </section>

    <script>
      const parentSelect = document.getElementById("parentSelect");
      const childSelect = document.getElementById("childSelect");
      const form = document.getElementById("form");
      const out = document.getElementById("out");
      const msg = document.getElementById("msg");
      const loadMsg = document.getElementById("loadMsg");
      const reloadBtn = document.getElementById("reloadBtn");
      const resetBtn = document.getElementById("resetBtn");
      const copyBtn = document.getElementById("copyBtn");

      let persons = [];

      function makeRelationId() {
        const s = String(Date.now());
        return "r" + s.slice(-6);
      }

      function labelPerson(p) {
        const name = `${p.fornamn || ""} ${p.efternamn || ""}`.trim();
        const years = [
          (p.fodelsear ?? "") !== null && (p.fodelsear ?? "") !== "" ? p.fodelsear : "",
          (p.dodsar ?? "") !== null && (p.dodsar ?? "") !== "" ? p.dodsar : ""
        ];
        const yearText = (years[0] || years[1]) ? ` (${years[0] || "?"}–${years[1] || "?"})` : "";
        return `${name}${yearText} — ${p.id}`;
      }

      function setOptions(select, items) {
        // behåll första option (placeholder)
        while (select.options.length > 1) select.remove(1);
        for (const p of items) {
          const opt = document.createElement("option");
          opt.value = p.id;
          opt.textContent = labelPerson(p);
          select.appendChild(opt);
        }
      }

      async function loadPersons() {
        loadMsg.textContent = "Laddar personer…";
        msg.textContent = "";
        out.textContent = "{}";

        try {
          const res = await fetch("../data/slaktkort.json", { cache: "no-store" });
          if (!res.ok) throw new Error("HTTP " + res.status);
          const data = await res.json();
          const list = Array.isArray(data?.slaktkort) ? data.slaktkort : [];
          persons = list.filter(p => p && typeof p.id === "string" && p.id.trim().length > 0);

          setOptions(parentSelect, persons);
          setOptions(childSelect, persons);

          if (persons.length === 0) {
            loadMsg.innerHTML = '<span class="error">Inga släktkort hittades.</span> Lägg in minst 2 personer i <code>data/slaktkort.json</code>.';
          } else {
            loadMsg.innerHTML = `<span class="ok">Klart.</span> Hittade ${persons.length} släktkort.`;
          }
        } catch (e) {
          loadMsg.innerHTML =
            '<span class="error">Kunde inte läsa data/slaktkort.json.</span> ' +
            'Kör via GitHub Pages eller en lokal server. (Dubbelklick kan blocka fetch.)';
        }
      }

      function basicValidate(parentId, childId) {
        if (!parentId || !childId) return "Du måste välja både förälder och barn.";
        if (parentId === childId) return "En person kan inte vara förälder till sig själv.";
        return null;
      }

      function escapeForDisplay(obj) {
        return JSON.stringify(obj, null, 2);
      }

      form.addEventListener("submit", (e) => {
        e.preventDefault();
        msg.textContent = "";

        const parentId = parentSelect.value;
        const childId = childSelect.value;

        const err = basicValidate(parentId, childId);
        if (err) {
          msg.innerHTML = `<span class="error">${err}</span>`;
          out.textContent = "{}";
          return;
        }

        const obj = {
          id: makeRelationId(),
          typ: "FORALDER_BARN",
          franPersonId: parentId,
          tillPersonId: childId
        };

        out.textContent = escapeForDisplay(obj);
        msg.innerHTML = '<span class="ok">Klart.</span> Kopiera JSON och lägg in i <code>data/relationer.json</code>.';
      });

      resetBtn.addEventListener("click", () => {
        form.reset();
        out.textContent = "{}";
        msg.textContent = "";
      });

      copyBtn.addEventListener("click", async () => {
        const text = out.textContent.trim();
        if (!text || text === "{}") {
          msg.innerHTML = '<span class="error">Inget att kopiera. Skapa en relation först.</span>';
          return;
        }
        try {
          await navigator.clipboard.writeText(text);
          msg.innerHTML = '<span class="ok">Kopierat.</span>';
        } catch {
          msg.innerHTML = '<span class="error">Kunde inte kopiera automatiskt. Markera JSON manuellt och kopiera.</span>';
        }
      });

      reloadBtn.addEventListener("click", loadPersons);

      // Ladda direkt vid sidstart
      loadPersons();
    </script>
  </body>
</html>

