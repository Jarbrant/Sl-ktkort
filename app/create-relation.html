<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Skapa relation ‚Äì Sl√§ktkort</title>
  <meta name="description" content="Skapa relationer (F√∂r√§lder‚ÜíBarn + Partner) i aktivt tr√§d. localStorage-first." />

  <style>
    :root { color-scheme: light; }
    body{
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      line-height: 1.5;
      margin: 0;
      padding: 24px;
      max-width: 980px;
      margin-inline: auto;
      background: #fff;
      color: #111;
    }
    a{ color: inherit; text-decoration:none; }
    header{ margin-bottom: 14px; }
    h1{ margin: 0 0 6px; font-size: 1.6rem; }
    .muted{ color:#555; margin: 0 0 12px; }

    .topbar{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      margin: 10px 0 16px;
    }
    .btn, button{
      display:inline-block;
      padding:10px 12px;
      border:1px solid #333;
      border-radius:10px;
      background:#fff;
      font:inherit;
      cursor:pointer;
      text-decoration:none;
    }
    .btn.secondary{ border-color:#bbb; }

    .pillRow{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      margin: 10px 0 18px;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border:1px solid #ddd;
      border-radius:999px;
      background:#fafafa;
      font-size:.95rem;
    }
    .pill strong{ font-weight:950; }

    .card{
      border:1px solid #ddd;
      border-radius:12px;
      padding:16px;
      margin: 14px 0;
      background:#fff;
    }
    .card h2{ margin:0 0 6px; font-size:1.15rem; }
    .small{ font-size:.95rem; color:#555; margin:0 0 10px; }

    label{ display:block; margin:10px 0 6px; font-weight:900; }
    select, input{
      width:100%;
      box-sizing:border-box;
      padding:10px;
      border-radius:10px;
      border:1px solid #bbb;
      font:inherit;
      background:#fff;
    }

    .row{ display:grid; gap:12px; grid-template-columns: 1fr; }
    @media (min-width: 740px){
      .row.two{ grid-template-columns: 1fr 1fr; }
      .row.three{ grid-template-columns: 1fr 1fr 1fr; }
    }

    .actions{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      margin-top: 12px;
    }

    .error{ color:#b00020; font-weight:950; }
    .ok{ font-weight:950; }
    code{ background:#f4f4f4; padding:2px 6px; border-radius:6px; }
  </style>
</head>

<body>
<header>
  <h1>üîó Skapa relation</h1>
  <p class="muted">Steg 3 i fl√∂det. Fokusperson f√∂rst ‚Üí relationstyp ‚Üí v√§lj motpart.</p>

  <nav class="topbar" aria-label="Navigation">
    <a class="btn secondary" href="../start.html">Start</a>
    <a class="btn secondary" href="./trees.html">Tr√§d</a>
    <a class="btn secondary" href="./slaktkort.html">Personer</a>
    <a class="btn" href="./create-relation.html">Skapa relation</a>
    <a class="btn secondary" href="./relations.html">√ñversikt relationer</a>
    <a class="btn secondary" href="./map.html">Karta</a>
    <button id="logoutBtn" class="btn secondary" type="button">Logga ut</button>
  </nav>

  <div class="pillRow" aria-label="Status">
    <span class="pill">Aktivt tr√§d: <strong id="pillTree">‚Äî</strong></span>
    <span class="pill">Personer: <strong id="pillPeople">0</strong></span>
    <span class="pill">Relationer: <strong id="pillRels">0</strong></span>
    <span class="pill">N√§sta steg: <strong>üìç Karta</strong></span>
  </div>
</header>

<section class="card">
  <h2>1) V√§lj fokusperson</h2>
  <p class="small">Fokuspersonen blir ‚ÄúBarn‚Äù i F√∂r√§lder‚ÜíBarn, eller ‚ÄúPartner A‚Äù i Partner.</p>

  <form id="form">
    <div class="row three">
      <div>
        <label for="focusSelect">Fokusperson *</label>
        <select id="focusSelect" required>
          <option value="">V√§lj‚Ä¶</option>
        </select>
      </div>

      <div>
        <label for="relationType">Relationstyp *</label>
        <select id="relationType" required>
          <option value="FORALDER_BARN" selected>F√∂r√§lder ‚Üí Barn</option>
          <option value="PARTNER">Partner (gift/sambo/s√§rbo/skilda)</option>
        </select>
      </div>

      <div id="partnerStatusWrap" hidden>
        <label for="partnerStatus">Partnerstatus</label>
        <select id="partnerStatus">
          <option value="GIFT">Gift</option>
          <option value="SAMBO">Sambo</option>
          <option value="SARBO">S√§rbo</option>
          <option value="SKILDA">Skilda</option>
        </select>
      </div>
    </div>

    <div class="row two" style="margin-top:10px;">
      <div>
        <label for="aSelect" id="aLabel">F√∂r√§lder *</label>
        <select id="aSelect" required>
          <option value="">V√§lj‚Ä¶</option>
        </select>
        <p class="small" id="aHelp">
          V√§lj en f√∂r√§lder som kopplas till fokuspersonen (barnet). Max 2 f√∂r√§ldrar per barn.
        </p>
      </div>

      <div>
        <label for="bSelect" id="bLabel">Barn *</label>
        <select id="bSelect" required>
          <option value="">V√§lj‚Ä¶</option>
        </select>
        <p class="small" id="bHelp">Barn = fokuspersonen (l√•st f√∂r enkel r√∂d tr√•d).</p>
      </div>
    </div>

    <div class="actions">
      <button type="submit" class="btn">Spara relation</button>
      <button type="button" id="resetBtn" class="btn secondary">Rensa val</button>
      <a class="btn secondary" href="./relations.html">√ñppna √∂versikt</a>
      <a class="btn secondary" href="./map.html">Forts√§tt ‚Üí Karta</a>
    </div>

    <p id="msg" class="muted" aria-live="polite"></p>
  </form>
</section>

<script>
  // ============================
  // Estetisk auth-guard
  // ============================
  (function authGuard(){
    try{
      if(sessionStorage.getItem("demo_auth") !== "1"){
        window.location.href = "../index.html";
      }
    }catch{}
  })();

  // ============================
  // Keys (M√ÖSTE matcha √∂vriga sidor)
  // ============================
  const KEY_TREES  = "slakttradet_trees";
  const KEY_ACTIVE = "slakttradet_active_tree_id";
  const cardsKey = (treeId) => "slakttradet_slaktkort_" + String(treeId);
  const relKey   = (treeId) => "slakttradet_relationer_" + String(treeId);

  // DOM
  const logoutBtn = document.getElementById("logoutBtn");

  const pillTree = document.getElementById("pillTree");
  const pillPeople = document.getElementById("pillPeople");
  const pillRels = document.getElementById("pillRels");

  const relationType = document.getElementById("relationType");
  const partnerStatusWrap = document.getElementById("partnerStatusWrap");
  const partnerStatus = document.getElementById("partnerStatus");

  const focusSelect = document.getElementById("focusSelect");
  const aSelect = document.getElementById("aSelect");
  const bSelect = document.getElementById("bSelect");
  const aLabel = document.getElementById("aLabel");
  const bLabel = document.getElementById("bLabel");
  const aHelp = document.getElementById("aHelp");
  const bHelp = document.getElementById("bHelp");

  const msg = document.getElementById("msg");

  // Utils
  function safeParse(raw, fallback){ try{ return JSON.parse(raw); }catch{ return fallback; } }
  function loadJson(key, fallback){
    const raw = localStorage.getItem(key);
    return raw ? safeParse(raw, fallback) : fallback;
  }
  function saveJson(key, value){ localStorage.setItem(key, JSON.stringify(value)); }

  function getTrees(){
    const trees = loadJson(KEY_TREES, []);
    return Array.isArray(trees) ? trees : [];
  }
  function activeTreeId(){ return localStorage.getItem(KEY_ACTIVE) || ""; }
  function activeTreeLabel(){
    const id = activeTreeId();
    if(!id) return "‚Äî";
    const t = getTrees().find(x => String(x.id) === String(id));
    return t ? (t.name || t.id) : id;
  }

  function escapeHtml(s){
    return String(s || "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function personName(p){
    const n = `${p.fornamn || ""} ${p.efternamn || ""}`.trim();
    return n || "(namnl√∂s)";
  }

  function setMsg(type, text){
    msg.innerHTML = type === "error"
      ? "<span class='error'>" + escapeHtml(text) + "</span>"
      : type === "ok"
        ? "<span class='ok'>" + escapeHtml(text) + "</span>"
        : escapeHtml(text || "");
  }

  function loadPeople(){
    const t = activeTreeId();
    if(!t) return [];
    const arr = loadJson(cardsKey(t), []);
    return Array.isArray(arr) ? arr : [];
  }

  function loadRels(){
    const t = activeTreeId();
    if(!t) return [];
    const arr = loadJson(relKey(t), []);
    return Array.isArray(arr) ? arr : [];
  }

  function saveRels(rels){
    const t = activeTreeId();
    if(!t) return;
    saveJson(relKey(t), rels);
  }

  // Parent limit helpers
  function parentsOfChild(rels, childId){
    return new Set(
      rels
        .filter(r => r.typ === "FORALDER_BARN" && String(r.tillPersonId) === String(childId))
        .map(r => String(r.franPersonId))
    );
  }

  // Duplicate detection
  function hasSameParentChild(rels, parentId, childId){
    return rels.some(r =>
      r.typ === "FORALDER_BARN" &&
      String(r.franPersonId) === String(parentId) &&
      String(r.tillPersonId) === String(childId)
    );
  }
  function hasSamePartner(rels, aId, bId){
    const A = String(aId), B = String(bId);
    return rels.some(r => {
      if(r.typ !== "PARTNER") return false;
      const x = String(r.personAId), y = String(r.personBId);
      return (x === A && y === B) || (x === B && y === A);
    });
  }

  // UI fill
  function fillPeopleSelects(){
    const people = loadPeople();

    focusSelect.innerHTML = "<option value=''>V√§lj‚Ä¶</option>";
    aSelect.innerHTML = "<option value=''>V√§lj‚Ä¶</option>";
    bSelect.innerHTML = "<option value=''>V√§lj‚Ä¶</option>";

    for(const p of people){
      if(!p || !p.id) continue;

      const opt1 = document.createElement("option");
      opt1.value = String(p.id);
      opt1.textContent = personName(p);
      focusSelect.appendChild(opt1);

      const opt2 = document.createElement("option");
      opt2.value = String(p.id);
      opt2.textContent = personName(p);
      aSelect.appendChild(opt2);

      const opt3 = document.createElement("option");
      opt3.value = String(p.id);
      opt3.textContent = personName(p);
      bSelect.appendChild(opt3);
    }

    pillTree.textContent = activeTreeLabel();
    pillPeople.textContent = String(people.length);
    pillRels.textContent = String(loadRels().length);

    if(!activeTreeId()){
      setMsg("error", "V√§lj ett aktivt tr√§d f√∂rst (Tr√§d).");
    } else if(people.length === 0){
      setMsg("error", "Inga personer √§n. Skapa personer f√∂rst.");
    } else {
      setMsg("", "");
    }
  }

  // Relation type behavior
  function applyTypeUI(){
    const typ = relationType.value;
    const focus = String(focusSelect.value || "").trim();

    if(typ === "FORALDER_BARN"){
      partnerStatusWrap.hidden = true;

      aLabel.textContent = "F√∂r√§lder *";
      bLabel.textContent = "Barn *";
      aHelp.textContent = "V√§lj en f√∂r√§lder som kopplas till fokuspersonen (barnet). Max 2 f√∂r√§ldrar per barn.";
      bHelp.textContent = "Barn = fokuspersonen (l√•st f√∂r enkel r√∂d tr√•d).";

      // Fokus -> Barn (l√•st)
      if(focus) bSelect.value = focus;

      // F√∂r√§lder ska v√§ljas manuellt (ingen auto)
      if(aSelect.value === focus) aSelect.value = "";

      aSelect.required = true;
      bSelect.required = true;
    }

    if(typ === "PARTNER"){
      partnerStatusWrap.hidden = false;

      aLabel.textContent = "Partner A *";
      bLabel.textContent = "Partner B *";
      aHelp.textContent = "Partner A = fokuspersonen (l√•st f√∂r enkel r√∂d tr√•d).";
      bHelp.textContent = "V√§lj andra personen.";

      // Fokus -> Partner A (l√•st)
      if(focus) aSelect.value = focus;
      if(bSelect.value === focus) bSelect.value = "";

      aSelect.required = true;
      bSelect.required = true;
    }
  }

  focusSelect.addEventListener("change", () => {
    // N√§r fokus √§ndras: uppdatera default f√∂r A/B
    applyTypeUI();
  });

  relationType.addEventListener("change", () => {
    // reset val s√• man inte r√•kar spara fel typ med gamla val
    aSelect.value = "";
    bSelect.value = "";
    applyTypeUI();
  });

  // Save relation
  document.getElementById("form").addEventListener("submit", (e) => {
    e.preventDefault();
    const t = activeTreeId();
    if(!t) return setMsg("error", "V√§lj ett aktivt tr√§d f√∂rst.");

    const typ = relationType.value;
    const focusId = String(focusSelect.value || "").trim();
    const a = String(aSelect.value || "").trim();
    const b = String(bSelect.value || "").trim();

    if(!focusId) return setMsg("error", "V√§lj en fokusperson f√∂rst.");
    if(!a || !b) return setMsg("error", "V√§lj b√•da personer f√∂rst.");
    if(a === b) return setMsg("error", "Du kan inte v√§lja samma person tv√• g√•nger.");

    const rels = loadRels();

    if(typ === "FORALDER_BARN"){
      const parentId = a;
      const childId = b;

      // L√•s fokus = barn (r√∂d tr√•d)
      if(childId !== focusId) return setMsg("error", "I F√∂r√§lder‚ÜíBarn m√•ste fokusperson vara Barn (byt fokus eller barn).");

      if(hasSameParentChild(rels, parentId, childId)) return setMsg("error", "Redan kopplad.");
      const parents = parentsOfChild(rels, childId);
      if(parents.size >= 2) return setMsg("error", "Barnet har redan 2 f√∂r√§ldrar.");

      rels.push({
        id: "r" + Date.now(),
        typ: "FORALDER_BARN",
        franPersonId: parentId,
        tillPersonId: childId,
        createdAt: new Date().toISOString()
      });

      saveRels(rels);
      setMsg("ok", "Relation sparad: F√∂r√§lder ‚Üí Barn.");
    }

    if(typ === "PARTNER"){
      const personAId = a;
      const personBId = b;

      // L√•s fokus = Partner A (r√∂d tr√•d)
      if(personAId !== focusId) return setMsg("error", "I Partner m√•ste fokusperson vara Partner A (byt fokus eller Partner A).");

      if(hasSamePartner(rels, personAId, personBId)) return setMsg("error", "Partnerrelation finns redan.");

      rels.push({
        id: "r" + Date.now(),
        typ: "PARTNER",
        personAId,
        personBId,
        status: partnerStatus.value,
        createdAt: new Date().toISOString()
      });

      saveRels(rels);
      setMsg("ok", "Relation sparad: Partner.");
    }

    pillRels.textContent = String(loadRels().length);
  });

  // Buttons
  document.getElementById("resetBtn").addEventListener("click", () => {
    document.getElementById("form").reset();
    setMsg("", "");
    fillPeopleSelects();
    applyTypeUI();
  });

  logoutBtn.addEventListener("click", () => {
    try{ sessionStorage.removeItem("demo_auth"); }catch{}
    window.location.href = "../index.html";
  });

  // Init
  fillPeopleSelects();
  applyTypeUI();
</script>
</body>
</html>
