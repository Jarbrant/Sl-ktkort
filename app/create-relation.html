<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Relationer ‚Äì Sl√§ktkort</title>
  <meta name="description" content="Skapa relationer i aktivt tr√§d (localStorage-first). F√∂r√§lder‚Äìbarn + Partner. + Ber√§knad vy: Alla relationer." />

  <style>
    :root { color-scheme: light; }

    body{
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      line-height: 1.5;
      margin: 0;
      padding: 24px;
      max-width: 1180px;
      margin-inline: auto;
      background: #fff;
      color: #111;
    }
    a{ color: inherit; text-decoration:none; }

    header{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      margin-bottom:18px;
    }
    h1{ margin:0 0 6px; font-size:1.6rem; }
    .muted{ color:#555; margin:0 0 12px; }

    .topbar{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      margin: 10px 0 0;
    }
    .btn, button{
      display:inline-block;
      padding:10px 12px;
      border:1px solid #333;
      border-radius:10px;
      background:#fff;
      font:inherit;
      cursor:pointer;
      text-decoration:none;
      user-select:none;
    }
    .btn.secondary{ border-color:#bbb; }
    .btn:disabled, button:disabled{ opacity:.55; cursor:not-allowed; }
    .btn.disabled{ opacity:.45; cursor:not-allowed; pointer-events:none; }

    .btn.navActive{
      border-color:#cfe8cf;
      background:#f5fff5;
      color:#111;
    }

    .pillRow{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      margin: 10px 0 18px;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border:1px solid #ddd;
      border-radius:999px;
      background:#fafafa;
      font-size:.95rem;
    }
    .pill strong{ font-weight:900; }
    .pill.ok{ border-color:#cfe8cf; background:#f5fff5; }
    .pill.warn{ border-color:#ffe1a6; background:#fff9ee; }
    .pill.err{ border-color:#ffb3b3; background:#fff2f2; }

    .grid{
      display:grid;
      gap:14px;
      grid-template-columns: 1fr;
      align-items: stretch;
    }
    @media (min-width: 1080px){
      .grid{ grid-template-columns: 420px 1fr; }
    }

    .card{
      border:1px solid #ddd;
      border-radius:12px;
      padding:16px;
      background:#fff;
      position: relative;
      height: 100%;
      box-sizing: border-box;
    }
    .card h2{ margin:0 0 6px; font-size:1.15rem; }
    .small{ font-size:.95rem; color:#555; margin:0 0 10px; }

    label{ display:block; margin:10px 0 6px; font-weight:800; }
    input, select{
      width:100%;
      box-sizing:border-box;
      padding:10px;
      border-radius:10px;
      border:1px solid #bbb;
      font:inherit;
      background:#fff;
    }

    .actions{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      margin-top: 12px;
    }

    .hintBox{
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid #ffe1a6;
      background: #fff9ee;
    }
    .okBox{
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid #cfe8cf;
      background: #f5fff5;
    }
    .errBox{
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid #ffb3b3;
      background: #fff2f2;
    }

    .list{
      margin: 10px 0 0;
      padding: 0;
      list-style:none;
      display:flex;
      flex-direction:column;
      gap:10px;
      max-height: 520px;
      overflow:auto;
      border-top: 1px solid #eee;
      padding-top: 10px;
    }
    .item{
      border:1px solid #eee;
      border-radius:12px;
      padding:10px;
      background:#fff;
    }
    .itemRow{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
    }
    .itemTitle{
      font-weight:900;
      margin:0 0 2px;
    }
    .itemSub{ margin:4px 0 0; color:#333; font-size:.95rem; }
    .itemMeta{ margin:4px 0 0; color:#555; font-size:.95rem; }

    .badge{
      font-size:.85rem;
      border:1px solid #ddd;
      padding:2px 8px;
      border-radius:999px;
      background:#fafafa;
      display:inline-flex;
      align-items:center;
      gap:6px;
      white-space:nowrap;
    }
    .badge.ok{
      border-color:#cfe8cf;
      background:#f5fff5;
    }
    .badge.warn{
      border-color:#ffe1a6;
      background:#fff9ee;
    }

    .splitHdr{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
      margin-bottom: 8px;
    }

    .relGrid{
      display:grid;
      gap:12px;
      grid-template-columns: 1fr;
    }
    @media (min-width: 820px){
      .relGrid{ grid-template-columns: 1fr 1fr; }
    }

    .group{
      border:1px solid #eee;
      border-radius:12px;
      padding:12px;
      background:#fff;
    }
    .group h3{
      margin:0 0 6px;
      font-size:1.02rem;
      font-weight:950;
    }
    .lines{
      list-style:none;
      padding:0;
      margin:0;
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .lineBtn{
      width:100%;
      text-align:left;
      padding:10px 12px;
      border:1px solid #ddd;
      border-radius:12px;
      background:#fff;
      cursor:pointer;
      font:inherit;
    }
    .lineBtn:hover{ background:#fafafa; }
    .lineBtn:disabled{ cursor:default; opacity:.7; }

    code{ background:#f4f4f4; padding:2px 6px; border-radius:6px; }
  </style>
</head>

<body>
<header>
  <div>
    <h1>Relationer</h1>
    <p class="muted">Skapa grundrelationer (f√∂r√§lder‚Äìbarn, partner). Du kan ocks√• visa ‚ÄúAlla relationer‚Äù som en ber√§knad vy.</p>

    <nav class="topbar" aria-label="Navigation">
      <a class="btn secondary" href="../start.html">Start</a>
      <a class="btn secondary" href="./trees.html">Tr√§d</a>
      <a class="btn secondary" href="./slaktkort.html">Personer</a>
      <a class="btn navActive" href="./create-relation.html" aria-current="page">Relationer</a>
      <a class="btn secondary" href="./map.html">Karta</a>
    </nav>
  </div>

  <div class="actions" style="justify-content:flex-end; margin-top:0;">
    <button id="logoutBtn" class="btn secondary" type="button">Logga ut</button>
  </div>
</header>

<section class="pillRow" aria-label="Status">
  <span id="pillTree" class="pill warn">Aktivt tr√§d: <strong>‚Äî</strong></span>
  <span id="pillPeople" class="pill">Personer: <strong>0</strong></span>
  <span id="pillRels" class="pill">Relationer: <strong>0</strong></span>
</section>

<div class="grid">
  <!-- V√ÑNSTER: SKAPA / VY -->
  <section class="card" aria-label="Skapa relation">
    <div class="splitHdr">
      <h2 style="margin:0;">Skapa & visa</h2>
      <span class="badge" id="modeBadge">Grundrelationer (sparade)</span>
    </div>

    <label for="viewMode">Vy</label>
    <select id="viewMode">
      <option value="SAVED">Grundrelationer (sparade)</option>
      <option value="ALL">Alla relationer (ber√§knat)</option>
    </select>

    <div id="hint" class="hintBox" hidden></div>
    <div id="ok" class="okBox" hidden></div>
    <div id="err" class="errBox" hidden></div>

    <!-- FORM: endast f√∂r SAVED -->
    <div id="savedFormWrap">
      <label for="focusPerson">Fokusperson</label>
      <select id="focusPerson"></select>

      <label for="relType">Relationstyp</label>
      <select id="relType">
        <option value="FORALDER_BARN">F√∂r√§lder ‚Üí Barn</option>
        <option value="PARTNER">Partner</option>
      </select>

      <div id="pcWrap">
        <p class="small" style="margin:8px 0 0;">
          V√§lj vem som √§r <strong>f√∂r√§lder</strong> och vem som √§r <strong>barn</strong>.
        </p>

        <label for="pcParent">F√∂r√§lder</label>
        <select id="pcParent"></select>

        <label for="pcChild">Barn</label>
        <select id="pcChild"></select>
      </div>

      <div id="partnerWrap" hidden>
        <p class="small" style="margin:8px 0 0;">
          V√§lj tv√• personer som √§r partners.
        </p>

        <label for="partnerA">Person A</label>
        <select id="partnerA"></select>

        <label for="partnerB">Person B</label>
        <select id="partnerB"></select>

        <label for="partnerVariant">Variant (valfri)</label>
        <select id="partnerVariant">
          <option value="">‚Äî</option>
          <option value="GIFT">Gift</option>
          <option value="SAMBO">Sambo</option>
          <option value="SARBO">S√§rbo</option>
          <option value="SKILDA">Skilda</option>
        </select>
      </div>

      <div class="actions">
        <button id="createBtn" type="button" class="btn">Skapa relation</button>
        <button id="resetBtn" type="button" class="btn secondary">Nollst√§ll</button>
      </div>

      <p class="small" style="margin:10px 0 0;">
        Tips: Saknas personer? G√• till <a href="./slaktkort.html"><code>Personer</code></a>.
      </p>
    </div>

    <!-- BER√ÑKNAD VY: endast f√∂r ALL -->
    <div id="allWrap" hidden style="margin-top:12px;">
      <h2 style="margin:0 0 6px; font-size:1.15rem;">Alla relationer (ber√§knat)</h2>
      <p class="small" style="margin:0 0 10px;">
        Visar syskon, mor-/farf√∂r√§ldrar och barnbarn genom att r√§kna fr√•n sparade relationer.
        Inget sparas.
      </p>

      <label for="allFocus">Fokusperson</label>
      <select id="allFocus"></select>

      <div class="actions" style="margin-top:10px;">
        <button id="allRefreshBtn" type="button" class="btn secondary">Uppdatera vy</button>
        <button id="allClearBtn" type="button" class="btn secondary">Rensa fokus</button>
      </div>

      <div id="allOut" style="margin-top:12px;"></div>
    </div>
  </section>

  <!-- H√ñGER: LISTA SPARADE RELATIONER -->
  <section class="card" aria-label="Sparade relationer">
    <div class="splitHdr">
      <h2 style="margin:0;">Sparade relationer</h2>
      <button id="refreshBtn" type="button" class="btn secondary">Uppdatera</button>
    </div>
    <p class="small">Det h√§r √§r de relationer som faktiskt √§r sparade i aktivt tr√§d.</p>
    <ul id="relList" class="list" aria-label="Relationer"></ul>

    <details class="tech" style="margin-top:14px; border-radius:12px; border:1px solid #eee; background:#fafafa; padding:10px 12px;">
      <summary style="cursor:pointer; font-weight:900; list-style:none;">Visa tekniskt</summary>
      <div class="small" style="margin-top:8px;">
        Tr√§d: <code>slakttradet_trees</code><br/>
        Aktivt tr√§d: <code>slakttradet_active_tree_id</code><br/>
        Personer per tr√§d: <code>slakttradet_slaktkort_&lt;treeId&gt;</code><br/>
        Relationer per tr√§d: <code>slakttradet_relationer_&lt;treeId&gt;</code>
      </div>
      <p class="small" id="tech" style="margin:10px 0 0;">‚Äî</p>
    </details>
  </section>
</div>

<script>
  "use strict";

  // =====================================================
  // DEMO AUTH GUARD (matchar dina andra sidor)
  // =====================================================
  (function authGuard(){
    try{
      if(sessionStorage.getItem("demo_auth") !== "1"){
        window.location.href = "../index.html";
      }
    }catch{}
  })();

  // =====================================================
  // STORAGE KEYS (M√ÖSTE MATCHA ANDRA SIDOR)
  // =====================================================
  const KEY_TREES  = "slakttradet_trees";
  const KEY_ACTIVE = "slakttradet_active_tree_id";
  const cardsKey = (treeId) => "slakttradet_slaktkort_" + String(treeId);
  const relKey   = (treeId) => "slakttradet_relationer_" + String(treeId);

  // =====================================================
  // DOM
  // =====================================================
  const logoutBtn = document.getElementById("logoutBtn");

  const pillTree = document.getElementById("pillTree");
  const pillPeople = document.getElementById("pillPeople");
  const pillRels = document.getElementById("pillRels");

  const hint = document.getElementById("hint");
  const ok = document.getElementById("ok");
  const err = document.getElementById("err");

  const viewModeEl = document.getElementById("viewMode");
  const modeBadge = document.getElementById("modeBadge");

  const savedFormWrap = document.getElementById("savedFormWrap");
  const allWrap = document.getElementById("allWrap");

  const focusPersonEl = document.getElementById("focusPerson");
  const relTypeEl = document.getElementById("relType");

  const pcWrap = document.getElementById("pcWrap");
  const pcParentEl = document.getElementById("pcParent");
  const pcChildEl = document.getElementById("pcChild");

  const partnerWrap = document.getElementById("partnerWrap");
  const partnerAEl = document.getElementById("partnerA");
  const partnerBEl = document.getElementById("partnerB");
  const partnerVariantEl = document.getElementById("partnerVariant");

  const createBtn = document.getElementById("createBtn");
  const resetBtn = document.getElementById("resetBtn");

  const refreshBtn = document.getElementById("refreshBtn");
  const relList = document.getElementById("relList");
  const techEl = document.getElementById("tech");

  // ALL (ber√§knat)
  const allFocusEl = document.getElementById("allFocus");
  const allRefreshBtn = document.getElementById("allRefreshBtn");
  const allClearBtn = document.getElementById("allClearBtn");
  const allOut = document.getElementById("allOut");

  // =====================================================
  // HELPERS
  // =====================================================
  function safeParse(raw, fallback){
    try{ return JSON.parse(raw); }catch{ return fallback; }
  }
  function loadJson(key, fallback){
    const raw = localStorage.getItem(key);
    return raw ? safeParse(raw, fallback) : fallback;
  }
  function saveJson(key, value){
    localStorage.setItem(key, JSON.stringify(value));
  }
  function escapeHtml(s){
    return String(s || "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }
  function idGen(){
    return "r_" + Date.now().toString(36) + "_" + Math.random().toString(36).slice(2,8);
  }

  function activeTreeId(){
    return localStorage.getItem(KEY_ACTIVE) || "";
  }
  function getTrees(){
    const trees = loadJson(KEY_TREES, []);
    return Array.isArray(trees) ? trees : [];
  }
  function activeTreeLabel(){
    const id = activeTreeId();
    if(!id) return "‚Äî";
    const t = getTrees().find(x => String(x.id) === String(id));
    return t ? (t.name || t.id) : id;
  }

  function personName(p){
    const n = `${p.fornamn || ""} ${p.efternamn || ""}`.trim();
    return n || "(namnl√∂s)";
  }
  function yearsLine(p){
    const a = (p && p.fodelsear != null && String(p.fodelsear).trim() !== "") ? String(p.fodelsear).trim() : "";
    const b = (p && p.dodsar != null && String(p.dodsar).trim() !== "") ? String(p.dodsar).trim() : "";
    if(!a && !b) return "";
    if(a && b) return `${a}‚Äì${b}`;
    return a ? `${a}‚Äì` : `‚Äì${b}`;
  }
  function formatPersonLine(p){
    const nm = personName(p);
    const y = yearsLine(p);
    return y ? `${nm} (${y})` : nm;
  }

  function showBox(el, html, ms){
    el.hidden = false;
    el.innerHTML = html;
    if(ms){
      setTimeout(() => { try{ el.hidden = true; }catch{} }, ms);
    }
  }
  function clearBoxes(){
    hint.hidden = true; hint.innerHTML = "";
    ok.hidden = true; ok.innerHTML = "";
    err.hidden = true; err.innerHTML = "";
  }

  // =====================================================
  // LOADERS
  // =====================================================
  function loadPeople(){
    const t = activeTreeId();
    if(!t) return [];
    const arr = loadJson(cardsKey(t), []);
    return Array.isArray(arr) ? arr : [];
  }
  function loadRelations(){
    const t = activeTreeId();
    if(!t) return [];
    const arr = loadJson(relKey(t), []);
    return Array.isArray(arr) ? arr : [];
  }
  function saveRelations(arr){
    const t = activeTreeId();
    if(!t) return;
    saveJson(relKey(t), Array.isArray(arr) ? arr : []);
  }
  function getPersonById(people, id){
    return people.find(p => String(p.id) === String(id)) || null;
  }

  // Partner-compat (matchar map.html)
  function getPartnerPair(r){
    const a1 = r && (r.personAId ?? r.personA ?? r.aId ?? r.a);
    const b1 = r && (r.personBId ?? r.personB ?? r.bId ?? r.b);
    if(a1 != null && b1 != null) return { aId: String(a1), bId: String(b1) };

    const a2 = r && (r.person1Id ?? r.personId1 ?? r.person1);
    const b2 = r && (r.person2Id ?? r.personId2 ?? r.person2);
    if(a2 != null && b2 != null) return { aId: String(a2), bId: String(b2) };

    const a3 = r && (r.franPersonId ?? r.fromPersonId ?? r.fromId);
    const b3 = r && (r.tillPersonId ?? r.toPersonId ?? r.toId);
    if(a3 != null && b3 != null && String(r.typ) === "PARTNER") return { aId: String(a3), bId: String(b3) };

    return null;
  }

  // =====================================================
  // UI: options
  // =====================================================
  function fillPersonSelect(selectEl, people, placeholder){
    selectEl.innerHTML = "";
    const opt0 = document.createElement("option");
    opt0.value = "";
    opt0.textContent = placeholder || "‚Äî";
    selectEl.appendChild(opt0);

    for(const p of people){
      const o = document.createElement("option");
      o.value = String(p.id);
      o.textContent = formatPersonLine(p);
      selectEl.appendChild(o);
    }
  }

  function syncAllSelects(people){
    fillPersonSelect(focusPersonEl, people, "V√§lj fokusperson‚Ä¶");
    fillPersonSelect(pcParentEl, people, "V√§lj f√∂r√§lder‚Ä¶");
    fillPersonSelect(pcChildEl, people, "V√§lj barn‚Ä¶");
    fillPersonSelect(partnerAEl, people, "V√§lj person A‚Ä¶");
    fillPersonSelect(partnerBEl, people, "V√§lj person B‚Ä¶");
    fillPersonSelect(allFocusEl, people, "V√§lj fokusperson‚Ä¶");
  }

  function setRelTypeUI(){
    const t = String(relTypeEl.value || "FORALDER_BARN");
    const isPartner = (t === "PARTNER");

    pcWrap.hidden = isPartner;
    partnerWrap.hidden = !isPartner;
  }

  function setModeUI(){
    const m = String(viewModeEl.value || "SAVED");
    const isAll = (m === "ALL");

    modeBadge.textContent = isAll ? "Alla relationer (ber√§knat)" : "Grundrelationer (sparade)";
    savedFormWrap.hidden = isAll;
    allWrap.hidden = !isAll;

    clearBoxes();

    if(isAll){
      // sm√• guidetext-rutor kan vara kvar men vi h√•ller det rent
    }
  }

  function renderPills(peopleCount, relCount){
    const hasActive = !!activeTreeId();
    const hasTrees = getTrees().length > 0;

    pillTree.className = "pill " + (hasActive ? "ok" : (hasTrees ? "warn" : "err"));
    pillTree.innerHTML = "Aktivt tr√§d: <strong>" + (hasActive ? escapeHtml(activeTreeLabel()) : "‚Äî") + "</strong>";

    pillPeople.innerHTML = "Personer: <strong>" + String(peopleCount) + "</strong>";
    pillRels.innerHTML = "Relationer: <strong>" + String(relCount) + "</strong>";
  }

  function renderHints(hasTrees, hasActive, people){
    if(!hasTrees){
      showBox(hint, "<strong>üö© Inga tr√§d:</strong> G√• till <a href='./trees.html'><code>Tr√§d</code></a> och skapa ett tr√§d.", 0);
      return;
    }
    if(!hasActive){
      showBox(hint, "<strong>üö© Inget aktivt tr√§d:</strong> V√§lj aktivt tr√§d i <a href='./trees.html'><code>Tr√§d</code></a>.", 0);
      return;
    }
    if(people.length === 0){
      showBox(hint, "<strong>Tips:</strong> Du har inga personer √§nnu. G√• till <a href='./slaktkort.html'><code>Personer</code></a> och skapa n√•gra.", 0);
      return;
    }
    hint.hidden = true;
    hint.innerHTML = "";
  }

  // =====================================================
  // SAVED RELATIONS: list + delete
  // =====================================================
  function relLabel(r, people){
    if(!r || !r.typ) return "Ok√§nd";

    if(String(r.typ) === "FORALDER_BARN"){
      const a = getPersonById(people, r.franPersonId);
      const b = getPersonById(people, r.tillPersonId);
      return {
        title: "F√∂r√§lder ‚Üí Barn",
        sub: (a ? formatPersonLine(a) : "‚Äî") + " ‚Üí " + (b ? formatPersonLine(b) : "‚Äî"),
        meta: ""
      };
    }

    if(String(r.typ) === "PARTNER"){
      const pair = getPartnerPair(r);
      const a = pair ? getPersonById(people, pair.aId) : null;
      const b = pair ? getPersonById(people, pair.bId) : null;

      const variant = String(r.variant || r.partnerVariant || r.status || "").trim();
      const vtxt = variant ? (" ¬∑ " + variant) : "";

      return {
        title: "Partner",
        sub: (a ? formatPersonLine(a) : "‚Äî") + " ‚Üî " + (b ? formatPersonLine(b) : "‚Äî") + vtxt,
        meta: ""
      };
    }

    return { title: String(r.typ), sub: "‚Äî", meta: "" };
  }

  function renderSavedRelations(people, rels){
    relList.innerHTML = "";

    if(!activeTreeId()){
      const li = document.createElement("li");
      li.className = "item";
      li.innerHTML = "<p class='itemTitle'>‚Äî</p><p class='itemSub'>V√§lj ett aktivt tr√§d f√∂r att se relationer.</p>";
      relList.appendChild(li);
      return;
    }

    if(rels.length === 0){
      const li = document.createElement("li");
      li.className = "item";
      li.innerHTML = "<p class='itemTitle'>Inga relationer √§nnu</p><p class='itemSub'>Skapa en relation till v√§nster.</p>";
      relList.appendChild(li);
      return;
    }

    for(const r of rels){
      const li = document.createElement("li");
      li.className = "item";

      const info = relLabel(r, people);

      const top = document.createElement("div");
      top.className = "itemRow";

      const left = document.createElement("div");
      left.style.minWidth = "0";
      left.innerHTML =
        "<p class='itemTitle'>" + escapeHtml(info.title) + "</p>" +
        "<p class='itemSub'>" + escapeHtml(info.sub) + "</p>";

      const right = document.createElement("div");
      right.style.flex = "0 0 auto";

      const del = document.createElement("button");
      del.type = "button";
      del.className = "btn secondary";
      del.style.padding = "8px 10px";
      del.textContent = "Ta bort";
      del.addEventListener("click", () => {
        const relsNow = loadRelations();
        const id = String(r.id || "");
        let next = [];

        if(id){
          next = relsNow.filter(x => String(x.id || "") !== id);
        }else{
          // fallback (om √§ldre relationer saknar id)
          next = relsNow.filter(x => x !== r);
        }

        saveRelations(next);
        showBox(ok, "<strong>Borttagen.</strong>", 1200);
        refresh();
      });

      right.appendChild(del);
      top.appendChild(left);
      top.appendChild(right);

      li.appendChild(top);

      if(r && r.createdAt){
        const p = document.createElement("p");
        p.className = "itemMeta";
        p.textContent = "Skapad: " + new Date(r.createdAt).toLocaleString();
        li.appendChild(p);
      }

      relList.appendChild(li);
    }
  }

  // =====================================================
  // CREATE RELATION (SAVED)
  // =====================================================
  function resetFormToReady(){
    // ARBETORDER 6: nollst√§ll s√• man kan skapa n√§sta direkt
    relTypeEl.value = "FORALDER_BARN";
    setRelTypeUI();

    focusPersonEl.value = "";
    pcParentEl.value = "";
    pcChildEl.value = "";

    partnerAEl.value = "";
    partnerBEl.value = "";
    partnerVariantEl.value = "";

    try{ focusPersonEl.focus(); }catch{}
  }

  function createRelation(){
    clearBoxes();

    const t = activeTreeId();
    if(!t){
      showBox(err, "<strong>Inget aktivt tr√§d.</strong> V√§lj i <a href='./trees.html'><code>Tr√§d</code></a>.", 0);
      return;
    }

    const people = loadPeople();
    if(people.length < 2){
      showBox(err, "<strong>F√∂r f√• personer.</strong> Skapa minst tv√• personer i <a href='./slaktkort.html'><code>Personer</code></a>.", 0);
      return;
    }

    const rels = loadRelations();
    const typ = String(relTypeEl.value || "FORALDER_BARN");

    if(typ === "FORALDER_BARN"){
      const parentId = String(pcParentEl.value || "");
      const childId = String(pcChildEl.value || "");

      if(!parentId || !childId){
        showBox(err, "<strong>V√§lj b√•de f√∂r√§lder och barn.</strong>", 1600);
        return;
      }
      if(parentId === childId){
        showBox(err, "<strong>Samma person kan inte vara b√•de f√∂r√§lder och barn.</strong>", 1800);
        return;
      }

      // undvik dubblett
      const exists = rels.some(r =>
        r && String(r.typ) === "FORALDER_BARN" &&
        String(r.franPersonId) === parentId &&
        String(r.tillPersonId) === childId
      );
      if(exists){
        showBox(err, "<strong>Relationen finns redan.</strong>", 1500);
        return;
      }

      const rel = {
        id: idGen(),
        typ: "FORALDER_BARN",
        franPersonId: parentId,
        tillPersonId: childId,
        createdAt: Date.now(),
        updatedAt: Date.now()
      };

      rels.unshift(rel);
      saveRelations(rels);

      showBox(ok, "<strong>Relation skapad.</strong>", 1200);
      resetFormToReady();
      refresh();
      return;
    }

    if(typ === "PARTNER"){
      const aId = String(partnerAEl.value || "");
      const bId = String(partnerBEl.value || "");
      const variant = String(partnerVariantEl.value || "").trim();

      if(!aId || !bId){
        showBox(err, "<strong>V√§lj tv√• personer.</strong>", 1600);
        return;
      }
      if(aId === bId){
        showBox(err, "<strong>V√§lj tv√• olika personer.</strong>", 1800);
        return;
      }

      // dubblett: oberoende ordning
      const low = aId < bId ? aId : bId;
      const high = aId < bId ? bId : aId;

      const exists = rels.some(r => {
        if(!r || String(r.typ) !== "PARTNER") return false;
        const pair = getPartnerPair(r);
        if(!pair) return false;
        const lo = pair.aId < pair.bId ? pair.aId : pair.bId;
        const hi = pair.aId < pair.bId ? pair.bId : pair.aId;
        return lo === low && hi === high;
      });
      if(exists){
        showBox(err, "<strong>Partnerrelationen finns redan.</strong>", 1500);
        return;
      }

      // Spara i samma f√§ltpar som map.html redan accepterar: franPersonId/tillPersonId
      const rel = {
        id: idGen(),
        typ: "PARTNER",
        franPersonId: aId,
        tillPersonId: bId,
        ...(variant ? { variant } : {}),
        createdAt: Date.now(),
        updatedAt: Date.now()
      };

      rels.unshift(rel);
      saveRelations(rels);

      showBox(ok, "<strong>Partnerrelation skapad.</strong>", 1200);
      resetFormToReady();
      refresh();
      return;
    }

    showBox(err, "<strong>Ok√§nd relationstyp.</strong>", 1500);
  }

  // =====================================================
  // ALL RELATIONS (BER√ÑKNAT) ‚Äì ARBETORDER 20
  // =====================================================
  function addToSet(map, key, value){
    const k = String(key || "");
    const v = String(value || "");
    if(!k || !v) return;
    let s = map.get(k);
    if(!s){ s = new Set(); map.set(k, s); }
    s.add(v);
  }

  function buildIndex(people, rels){
    const personById = new Map();
    const childrenByParent = new Map();
    const parentsByChild = new Map();
    const partnersByPerson = new Map();

    for(const p of people){
      if(!p) continue;
      const id = String(p.id || "");
      if(!id) continue;
      personById.set(id, p);
    }

    for(const r of rels){
      if(!r || !r.typ) continue;

      if(String(r.typ) === "FORALDER_BARN"){
        const fromId = String(r.franPersonId || "");
        const toId = String(r.tillPersonId || "");
        if(!fromId || !toId) continue;

        addToSet(childrenByParent, fromId, toId);
        addToSet(parentsByChild, toId, fromId);
        continue;
      }

      if(String(r.typ) === "PARTNER"){
        const pair = getPartnerPair(r);
        if(!pair) continue;
        const aId = String(pair.aId || "");
        const bId = String(pair.bId || "");
        if(!aId || !bId) continue;

        addToSet(partnersByPerson, aId, bId);
        addToSet(partnersByPerson, bId, aId);
      }
    }

    return { personById, childrenByParent, parentsByChild, partnersByPerson };
  }

  function idsToPeople(idx, ids){
    const out = [];
    const seen = new Set();
    for(const id of (ids || [])){
      const k = String(id || "");
      if(!k || seen.has(k)) continue;
      seen.add(k);
      const p = idx.personById.get(k);
      if(p) out.push(p);
    }
    return out;
  }

  function uniqIds(arr){
    return [...new Set((arr || []).map(x => String(x || "")).filter(Boolean))];
  }

  function getParents(idx, id){
    const s = idx.parentsByChild.get(String(id)) || new Set();
    return idsToPeople(idx, s);
  }
  function getChildren(idx, id){
    const s = idx.childrenByParent.get(String(id)) || new Set();
    return idsToPeople(idx, s);
  }
  function getPartners(idx, id){
    const s = idx.partnersByPerson.get(String(id)) || new Set();
    return idsToPeople(idx, s);
  }

  function getSiblings(idx, id){
    const me = String(id || "");
    if(!me) return [];
    const parentIds = [...(idx.parentsByChild.get(me) || new Set())].map(String);
    const sibIds = new Set();

    for(const pid of parentIds){
      const kids = idx.childrenByParent.get(String(pid)) || new Set();
      for(const kid of kids){
        const k = String(kid);
        if(k && k !== me) sibIds.add(k);
      }
    }
    return idsToPeople(idx, sibIds);
  }

  function getGrandParents(idx, id){
    const parents = getParents(idx, id).map(p => String(p.id));
    const gpIds = [];
    for(const pid of parents){
      const pps = getParents(idx, pid).map(p => String(p.id));
      gpIds.push(...pps);
    }
    return idsToPeople(idx, uniqIds(gpIds));
  }

  function getGrandChildren(idx, id){
    const kids = getChildren(idx, id).map(p => String(p.id));
    const gcIds = [];
    for(const cid of kids){
      const cKids = getChildren(idx, cid).map(p => String(p.id));
      gcIds.push(...cKids);
    }
    return idsToPeople(idx, uniqIds(gcIds));
  }

  function makeGroup(title, people, onPick){
    const box = document.createElement("div");
    box.className = "group";
    const h = document.createElement("h3");
    h.textContent = title;
    box.appendChild(h);

    const ul = document.createElement("ul");
    ul.className = "lines";

    if(!people || people.length === 0){
      const li = document.createElement("li");
      const b = document.createElement("button");
      b.type = "button";
      b.className = "lineBtn";
      b.disabled = true;
      b.textContent = "‚Äî";
      li.appendChild(b);
      ul.appendChild(li);
    }else{
      for(const p of people){
        const li = document.createElement("li");
        const b = document.createElement("button");
        b.type = "button";
        b.className = "lineBtn";
        b.textContent = formatPersonLine(p);
        b.addEventListener("click", () => onPick(String(p.id)));
        li.appendChild(b);
        ul.appendChild(li);
      }
    }

    box.appendChild(ul);
    return box;
  }

  function renderAllRelations(){
    allOut.innerHTML = "";

    const t = activeTreeId();
    const people = loadPeople();
    const rels = loadRelations();

    if(!t){
      allOut.innerHTML = "<div class='hintBox'><strong>üö© Inget aktivt tr√§d:</strong> v√§lj i <a href='./trees.html'><code>Tr√§d</code></a>.</div>";
      return;
    }
    if(people.length === 0){
      allOut.innerHTML = "<div class='hintBox'><strong>Tips:</strong> skapa personer i <a href='./slaktkort.html'><code>Personer</code></a>.</div>";
      return;
    }

    const focusId = String(allFocusEl.value || "");
    if(!focusId){
      allOut.innerHTML = "<div class='hintBox'><strong>V√§lj en fokusperson</strong> f√∂r att visa ber√§knade relationer.</div>";
      return;
    }

    const idx = buildIndex(people, rels);

    const focus = idx.personById.get(focusId);
    if(!focus){
      allOut.innerHTML = "<div class='hintBox'><strong>Ok√§nd fokusperson.</strong></div>";
      return;
    }

    const parents = getParents(idx, focusId);
    const partners = getPartners(idx, focusId);
    const children = getChildren(idx, focusId);
    const siblings = getSiblings(idx, focusId);
    const grandParents = getGrandParents(idx, focusId);
    const grandChildren = getGrandChildren(idx, focusId);

    const head = document.createElement("div");
    head.className = "okBox";
    head.innerHTML =
      "<strong>Fokus:</strong> " + escapeHtml(formatPersonLine(focus)) +
      "<br/><span class='small'>Detta √§r en ber√§knad vy. Inget sparas.</span>";
    allOut.appendChild(head);

    const grid = document.createElement("div");
    grid.className = "relGrid";
    allOut.appendChild(grid);

    function pick(newId){
      allFocusEl.value = String(newId || "");
      renderAllRelations();
    }

    grid.appendChild(makeGroup("F√∂r√§ldrar", parents, pick));
    grid.appendChild(makeGroup("Partner", partners, pick));
    grid.appendChild(makeGroup("Barn", children, pick));
    grid.appendChild(makeGroup("Syskon", siblings, pick));
    grid.appendChild(makeGroup("Mor-/farf√∂r√§ldrar", grandParents, pick));
    grid.appendChild(makeGroup("Barnbarn", grandChildren, pick));
  }

  // =====================================================
  // TECH
  // =====================================================
  function renderTech(people, rels){
    const t = activeTreeId();
    techEl.textContent =
      "Aktivt tr√§d: " + (t || "‚Äî") +
      " ¬∑ Personer: " + String(people.length) +
      " ¬∑ Relationer: " + String(rels.length) +
      " ¬∑ Key: " + relKey(t || "‚Äî");
  }

  // =====================================================
  // REFRESH
  // =====================================================
  function refresh(){
    clearBoxes();

    const trees = getTrees();
    const hasTrees = trees.length > 0;
    const t = activeTreeId();
    const hasActive = !!t;

    const people = hasActive ? loadPeople() : [];
    const rels = hasActive ? loadRelations() : [];

    renderPills(people.length, rels.length);
    renderHints(hasTrees, hasActive, people);

    syncAllSelects(people);
    renderSavedRelations(people, rels);
    renderTech(people, rels);

    // Smarta defaults: om fokus inte satt, v√§lj f√∂rsta (bara f√∂r dropdowns ‚Äì inget sparas)
    if(people.length > 0){
      if(!focusPersonEl.value) focusPersonEl.value = String(people[0].id);
      if(!pcParentEl.value) pcParentEl.value = String(people[0].id);
      if(people[1] && !pcChildEl.value) pcChildEl.value = String(people[1].id);

      if(!partnerAEl.value) partnerAEl.value = String(people[0].id);
      if(people[1] && !partnerBEl.value) partnerBEl.value = String(people[1].id);
    }

    setRelTypeUI();
    setModeUI();

    // Om ALL-l√§get: rendera direkt om fokus finns
    if(String(viewModeEl.value) === "ALL"){
      renderAllRelations();
    }
  }

  // =====================================================
  // EVENTS
  // =====================================================
  relTypeEl.addEventListener("change", setRelTypeUI);

  viewModeEl.addEventListener("change", () => {
    setModeUI();
    if(String(viewModeEl.value) === "ALL") renderAllRelations();
  });

  createBtn.addEventListener("click", createRelation);

  resetBtn.addEventListener("click", () => {
    clearBoxes();
    resetFormToReady();
    showBox(ok, "<strong>Nollst√§llt.</strong>", 1000);
  });

  refreshBtn.addEventListener("click", () => {
    refresh();
    showBox(ok, "<strong>Uppdaterat.</strong>", 900);
  });

  allRefreshBtn.addEventListener("click", () => {
    renderAllRelations();
  });

  allClearBtn.addEventListener("click", () => {
    allFocusEl.value = "";
    renderAllRelations();
  });

  logoutBtn.addEventListener("click", () => {
    try{ sessionStorage.removeItem("demo_auth"); }catch{}
    window.location.href = "../index.html";
  });

  // =====================================================
  // START
  // =====================================================
  refresh();

  // =====================================================
  // LEVERANS-BEKR√ÑFTELSE (f√∂r din arbetsorder)
  // =====================================================
  // Endast UI + ber√§knad vy ‚Äì ingen lagring/keys/datalogik √§ndrad
</script>
</body>
</html>
