<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Skapa relation</title>
  <meta name="description" content="Skapa relationer i aktivt släktträd (localStorage)." />
  <style>
    :root { color-scheme: light; }
    body{
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      line-height: 1.5;
      margin: 0;
      padding: 24px;
      max-width: 900px;
      margin-inline: auto;
      background: #fff;
      color: #111;
    }
    a { color: inherit; }
    header { margin-bottom: 18px; }
    h1 { margin: 0 0 6px; }
    p { margin: 0 0 12px; }
    .muted { color: #555; }
    .card{
      border: 1px solid #ddd;
      border-radius: 10px;
      padding: 16px;
      margin: 14px 0;
      background: #fff;
    }
    label { display: block; margin: 10px 0 6px; font-weight: 600; }
    select, input{
      width: 100%;
      box-sizing: border-box;
      padding: 10px 10px;
      border: 1px solid #bbb;
      border-radius: 8px;
      font: inherit;
      background: #fff;
    }
    .row{ display: grid; gap: 12px; grid-template-columns: 1fr; }
    @media (min-width: 720px){
      .row.two{ grid-template-columns: 1fr 1fr; }
    }
    .actions{
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 14px;
      align-items: center;
    }
    button, .button-link{
      display: inline-block;
      padding: 10px 12px;
      border: 1px solid #333;
      border-radius: 8px;
      background: #fff;
      font: inherit;
      cursor: pointer;
      text-decoration: none;
    }
    pre{
      background: #f4f4f4;
      padding: 12px;
      border-radius: 10px;
      overflow: auto;
      white-space: pre-wrap;
    }
    code{ background: #f4f4f4; padding: 2px 6px; border-radius: 6px; }
    .error{ color: #b00020; font-weight: 700; }
    .ok{ font-weight: 800; }
    .hidden{ display:none !important; }
  </style>
</head>

<body>
<header>
  <a href="../start.html">← Tillbaka</a>
  <h1>Skapa relation</h1>
  <p class="muted">Förälder → barn (max 2 föräldrar per barn). Data sparas i localStorage.</p>
</header>

<section class="card">
  <h2>Relation</h2>

  <form id="form">
    <div class="row two">
      <div>
        <label for="relationType">Relationstyp *</label>
        <select id="relationType">
          <option value="FORALDER_BARN" selected>Förälder → Barn</option>
        </select>
      </div>
    </div>

    <div class="row two">
      <div>
        <label for="aSelect" id="aLabel">Förälder *</label>
        <select id="aSelect" required>
          <option value="">Välj…</option>
        </select>
      </div>
      <div>
        <label for="bSelect" id="bLabel">Barn *</label>
        <select id="bSelect" required>
          <option value="">Välj…</option>
        </select>
      </div>
    </div>

    <div class="actions">
      <button type="submit">Spara relation</button>
      <button type="button" id="resetBtn">Rensa</button>
      <a class="button-link" href="../start.html">Avbryt</a>
    </div>

    <p id="msg" class="muted"></p>
  </form>
</section>

<section class="card">
  <h2>Relationer (aktivt träd)</h2>
  <div class="actions">
    <button type="button" id="listBtn">Visa</button>
    <button type="button" id="clearBtn">Töm</button>
  </div>
  <pre><code id="out">[]</code></pre>
</section>

<script>
  const KEY_TREES  = "slakttradet_trees";
  const KEY_ACTIVE = "slakttradet_active_tree_id";
  const cardsKey = id => "slakttradet_slaktkort_" + id;
  const relKey   = id => "slakttradet_relationer_" + id;

  const aSelect = document.getElementById("aSelect");
  const bSelect = document.getElementById("bSelect");
  const msg = document.getElementById("msg");
  const out = document.getElementById("out");

  function loadJson(k,f){ try{const r=localStorage.getItem(k);return r?JSON.parse(r):f}catch{return f}}
  function saveJson(k,v){ localStorage.setItem(k,JSON.stringify(v)); }
  function activeTree(){ return localStorage.getItem(KEY_ACTIVE)||""; }

  function buildChildCount(rels){
    const c={};
    rels.filter(r=>r.typ==="FORALDER_BARN").forEach(r=>{
      c[r.franPersonId]=(c[r.franPersonId]||0)+1;
    });
    return c;
  }

  function parentsOfChild(rels, childId){
    return new Set(
      rels.filter(r=>r.typ==="FORALDER_BARN" && r.tillPersonId===childId)
          .map(r=>r.franPersonId)
    );
  }

  function label(p,count){
    const n=`${p.fornamn||""} ${p.efternamn||""}`.trim();
    return `${n} (barn: ${count||0})`;
  }

  function loadPersons(){
    const t=activeTree();
    if(!t){ msg.textContent="Välj ett träd först."; return; }

    const cards=loadJson(cardsKey(t),[]);
    const rels =loadJson(relKey(t),[]);
    const counts=buildChildCount(rels);

    aSelect.innerHTML='<option value="">Välj…</option>';
    bSelect.innerHTML='<option value="">Välj…</option>';

    cards.forEach(p=>{
      if(!p.id) return;
      const o1=document.createElement("option");
      o1.value=p.id;
      o1.textContent=label(p,counts[p.id]);
      aSelect.appendChild(o1);

      const o2=document.createElement("option");
      o2.value=p.id;
      o2.textContent=`${p.fornamn||""} ${p.efternamn||""}`.trim();
      bSelect.appendChild(o2);
    });
  }

  document.getElementById("form").addEventListener("submit",e=>{
    e.preventDefault();
    const t=activeTree();
    if(!t) return;

    const a=aSelect.value,b=bSelect.value;
    if(!a||!b||a===b){ msg.textContent="Ogiltigt val."; return; }

    const rels=loadJson(relKey(t),[]);
    const parents=parentsOfChild(rels,b);
    if(parents.has(a)) return msg.textContent="Redan kopplad.";
    if(parents.size>=2) return msg.textContent="Barnet har redan 2 föräldrar.";

    rels.push({
      id:"r"+Date.now(),
      typ:"FORALDER_BARN",
      franPersonId:a,
      tillPersonId:b,
      createdAt:new Date().toISOString()
    });
    saveJson(relKey(t),rels);
    msg.textContent="Relation sparad.";
    out.textContent=JSON.stringify(rels,null,2);
    loadPersons();
  });

  document.getElementById("listBtn").onclick=()=>{
    const t=activeTree();
    out.textContent=JSON.stringify(loadJson(relKey(t),[]),null,2);
  };
  document.getElementById("clearBtn").onclick=()=>{
    const t=activeTree();
    saveJson(relKey(t),[]);
    out.textContent="[]";
    loadPersons();
  };
  document.getElementById("resetBtn").onclick=()=>{
    document.getElementById("form").reset();
    msg.textContent="";
  };

  loadPersons();
</script>
</body>
</html>
