<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Relationer ‚Äì Sl√§ktkort</title>
  <meta name="description" content="Skapa relationer i aktivt tr√§d (localStorage-first). F√∂r√§lder‚Äìbarn + Partner." />

  <style>
    :root { color-scheme: light; }
    body{
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      line-height: 1.5;
      margin: 0;
      padding: 24px;
      max-width: 1180px;
      margin-inline: auto;
      background: #fff;
      color: #111;
    }
    a{ color: inherit; text-decoration:none; }

    header{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      margin-bottom:18px;
    }
    h1{ margin:0 0 6px; font-size:1.6rem; }
    .muted{ color:#555; margin:0 0 12px; }

    .topbar{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      margin: 10px 0 0;
    }
    .btn, button{
      display:inline-block;
      padding:10px 12px;
      border:1px solid #333;
      border-radius:10px;
      background:#fff;
      font:inherit;
      cursor:pointer;
      text-decoration:none;
      user-select:none;
    }
    .btn.secondary{ border-color:#bbb; }
    .btn.danger{ border-color:#b00020; color:#b00020; }
    .btn:disabled{ opacity:.5; cursor:not-allowed; }

    .pillRow{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      margin: 10px 0 18px;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border:1px solid #ddd;
      border-radius:999px;
      background:#fafafa;
      font-size:.95rem;
    }
    .pill strong{ font-weight:900; }
    .pill.ok{ border-color:#cfe8cf; background:#f5fff5; }
    .pill.warn{ border-color:#ffe1a6; background:#fff9ee; }
    .pill.err{ border-color:#ffb3b3; background:#fff2f2; }

    .grid{
      display:grid;
      gap:14px;
      grid-template-columns: 1fr;
    }
    @media (min-width: 1080px){
      .grid{ grid-template-columns: 420px 1fr; }
    }

    .card{
      border:1px solid #ddd;
      border-radius:12px;
      padding:16px;
      background:#fff;
      position: relative;
    }
    .card h2{ margin:0 0 6px; font-size:1.15rem; }
    .small{ font-size:.95rem; color:#555; margin:0 0 10px; }

    label{ display:block; margin:10px 0 6px; font-weight:800; }
    select, input{
      width:100%;
      box-sizing:border-box;
      padding:10px;
      border-radius:10px;
      border:1px solid #bbb;
      font:inherit;
      background:#fff;
    }

    .row2{
      display:grid;
      grid-template-columns: 1fr;
      gap:12px;
    }
    @media (min-width: 720px){
      .row2{ grid-template-columns: 1fr 1fr; }
    }

    .actions{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      margin-top: 12px;
    }

    .hintBox{
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid #ffe1a6;
      background: #fff9ee;
    }
    .okBox{
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid #cfe8cf;
      background: #f5fff5;
    }
    .errBox{
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid #ffb3b3;
      background: #fff2f2;
    }

    .list{
      margin: 10px 0 0;
      padding: 0;
      list-style:none;
      display:flex;
      flex-direction:column;
      gap:10px;
      max-height: 520px;
      overflow:auto;
      border-top: 1px solid #eee;
      padding-top: 10px;
    }
    .item{
      border:1px solid #eee;
      border-radius:12px;
      padding:10px;
      background:#fff;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
    }
    .itemTitle{ font-weight:900; margin:0 0 2px; }
    .itemMeta{ margin:0; color:#555; font-size:.95rem; }
    .itemLeft{ min-width:0; }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }

    code{ background:#f4f4f4; padding:2px 6px; border-radius:6px; }

    .sr-only{
      position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px;
      overflow: hidden; clip: rect(0,0,0,0); white-space: nowrap; border: 0;
    }

    /* ARKIV-ID: CR-03 | S√∂k (min 3 bokst√§ver) ‚Äì UI-komponenter */
    .searchWrap{ position: relative; }
    .suggest{
      position:absolute;
      left:0; right:0;
      top: calc(100% + 6px);
      border:1px solid #ddd;
      background:#fff;
      border-radius:12px;
      overflow:hidden;
      box-shadow: 0 10px 30px rgba(0,0,0,.06);
      max-height: 220px;
      overflow:auto;
      z-index: 10;
    }
    .sItem{
      display:block;
      width:100%;
      text-align:left;
      border:0;
      border-bottom:1px solid #f1f1f1;
      padding:10px 10px;
      background:#fff;
      cursor:pointer;
      font:inherit;
    }
    .sItem:last-child{ border-bottom:0; }
    .sItem:hover{ background:#fafafa; }
    .stepTitle{ margin:12px 0 6px; font-weight:900; }
  </style>
</head>

<body>
<header>
  <div>
    <h1>Relationer</h1>
    <p class="muted">Skapa relationer i <strong>aktivt tr√§d</strong>. F√∂r√§lder‚ÄìBarn och Partner.</p>

    <nav class="topbar" aria-label="Navigation">
      <a class="btn secondary" href="../start.html">Start</a>
      <a class="btn secondary" href="./trees.html">Tr√§d</a>
      <a class="btn secondary" href="./slaktkort.html">Personer</a>
      <a class="btn" href="./create-relation.html">Relationer</a>
      <a class="btn secondary" href="./map.html">Karta</a>
    </nav>
  </div>

  <div class="actions" style="justify-content:flex-end;">
    <button id="logoutBtn" class="btn secondary" type="button">Logga ut</button>
  </div>
</header>

<section class="pillRow" aria-label="Status">
  <span id="pillTree" class="pill warn">Aktivt tr√§d: <strong>‚Äî</strong></span>
  <span id="pillPeople" class="pill">Personer: <strong>0</strong></span>
  <span id="pillRel" class="pill">Relationer: <strong>0</strong></span>
</section>

<div class="grid">
  <!-- V√ÑNSTER: FORM -->
  <section class="card" aria-label="Skapa relation">
    <h2>Skapa relation</h2>
    <p class="small">F√∂lj stegen. Systemet hindrar relation till sig sj√§lv.</p>

    <div id="hint" class="hintBox" hidden></div>
    <div id="ok" class="okBox" hidden></div>
    <div id="err" class="errBox" hidden></div>

    <!-- ARKIV-ID: CR-03 | Steg 1 ‚Äì S√∂k + f√∂rslag (fokusperson) -->
    <div class="stepTitle">Steg 1 ‚Äì V√§lj fokusperson</div>
    <div class="searchWrap">
      <label for="focusSearch">S√∂k (min 3 bokst√§ver)</label>
      <input id="focusSearch" type="text" autocomplete="off" placeholder="Skriv minst 3 bokst√§ver‚Ä¶" />
      <div id="focusSuggest" class="suggest" hidden aria-label="F√∂rslag fokusperson"></div>
    </div>
    <p class="small" id="focusPicked" style="margin:8px 0 0;">‚Äî</p>

    <!-- ARKIV-ID: CR-04 | Steg 2 ‚Äì Relationstyp -->
    <div class="stepTitle">Steg 2 ‚Äì V√§lj relationstyp</div>
    <label for="relType">Relationstyp</label>
    <select id="relType">
      <option value="FORALDER_BARN">F√∂r√§lder</option>
      <option value="BARN">Barn</option>
      <option value="SYSKON">Syskon</option>
      <option value="MORFARFORALDER">Mor- och farf√∂r√§ldrar</option>
      <option value="BARNBARN">Barnbarn</option>
      <option value="PARTNER">Partner</option>
      <option value="MOSTER_MORBROR">Moster / Morbror</option>
      <option value="FASTER_FARBROR">Faster / Farbror</option>
      <option value="KUSIN">Kusin</option>
      <option value="STYV">Styvrelationer</option>
    </select>
    <p class="small" id="relTypeNote" style="margin:8px 0 0;">
      Obs: F√∂r att inte √§ndra kopplingslogiken sparas just nu endast <strong>F√∂r√§lder</strong> och <strong>Partner</strong>.
    </p>

    <!-- ARKIV-ID: CR-04 | Steg 3 ‚Äì Variant -->
    <div class="stepTitle">Steg 3 ‚Äì V√§lj variant</div>
    <label for="relVariant">Variant</label>
    <select id="relVariant"></select>

    <!-- ARKIV-ID: CR-03 | Steg 4 ‚Äì S√∂k + f√∂rslag (m√•lperson) -->
    <div class="stepTitle">Steg 4 ‚Äì V√§lj m√•lperson (till vem)</div>
    <div class="searchWrap">
      <label for="targetSearch">S√∂k (min 3 bokst√§ver)</label>
      <input id="targetSearch" type="text" autocomplete="off" placeholder="Skriv minst 3 bokst√§ver‚Ä¶" />
      <div id="targetSuggest" class="suggest" hidden aria-label="F√∂rslag m√•lperson"></div>
    </div>
    <p class="small" id="targetPicked" style="margin:8px 0 0;">‚Äî</p>

    <!-- Backup (beh√•lls) -->
    <div class="row2" style="margin-top:12px;">
      <div>
        <label for="personA">Person A (backup)</label>
        <select id="personA"></select>
      </div>
      <div>
        <label for="personB">Person B (backup)</label>
        <select id="personB"></select>
      </div>
    </div>

    <div class="actions">
      <!-- ARKIV-ID: CR-05 | Skapa relation (sparlogik of√∂r√§ndrad) -->
      <button id="createBtn" class="btn" type="button">Skapa relation</button>
      <button id="swapBtn" class="btn secondary" type="button">Byt plats (A‚ÜîB)</button>
      <button id="clearBtn" class="btn secondary" type="button">Rensa</button>
    </div>

    <div class="hintBox" style="margin-top:14px;">
      <strong>Viktigt</strong>
      <div class="small" style="margin-top:6px;">
        Relationer sparas per tr√§d i <code>slakttradet_relationer_&lt;treeId&gt;</code>.<br/>
        Partner sparas √§ven som <code>personAId</code>/<code>personBId</code> (kompatibelt med kartan).
      </div>
    </div>
  </section>

  <!-- H√ñGER: LISTA -->
  <section class="card" aria-label="Relationer i aktivt tr√§d">
    <h2>Relationer i aktivt tr√§d</h2>
    <p class="small">Du kan ta bort en relation h√§r.</p>

    <div class="actions">
      <button id="refreshBtn" class="btn secondary" type="button">Uppdatera</button>
      <a class="btn secondary" href="./slaktkort.html">G√• till Personer</a>
      <a class="btn secondary" href="./map.html">G√• till Karta</a>
    </div>

    <ul id="list" class="list" aria-label="Lista med relationer"></ul>

    <p class="small" id="tech" style="margin-top:10px;">‚Äî</p>
  </section>
</div>

<script>
  "use strict";

  // =====================================================
  // DEMO AUTH GUARD (matchar dina andra sidor)
  // =====================================================
  (function authGuard(){
    try{
      if(sessionStorage.getItem("demo_auth") !== "1"){
        window.location.href = "../index.html";
      }
    }catch{}
  })();

  // =====================================================
  // STORAGE KEYS (L√ÖSTA)
  // =====================================================
  const KEY_TREES  = "slakttradet_trees";
  const KEY_ACTIVE = "slakttradet_active_tree_id";
  const cardsKey = (treeId) => "slakttradet_slaktkort_" + String(treeId);
  const relKey   = (treeId) => "slakttradet_relationer_" + String(treeId);

  // =====================================================
  // DOM
  // =====================================================
  const logoutBtn = document.getElementById("logoutBtn");

  const pillTree = document.getElementById("pillTree");
  const pillPeople = document.getElementById("pillPeople");
  const pillRel = document.getElementById("pillRel");

  const hintEl = document.getElementById("hint");
  const okEl = document.getElementById("ok");
  const errEl = document.getElementById("err");

  const relTypeEl = document.getElementById("relType");
  const relTypeNoteEl = document.getElementById("relTypeNote");
  const relVariantEl = document.getElementById("relVariant");

  const focusSearchEl = document.getElementById("focusSearch");
  const focusSuggestEl = document.getElementById("focusSuggest");
  const focusPickedEl = document.getElementById("focusPicked");

  const targetSearchEl = document.getElementById("targetSearch");
  const targetSuggestEl = document.getElementById("targetSuggest");
  const targetPickedEl = document.getElementById("targetPicked");

  const personAEl = document.getElementById("personA");
  const personBEl = document.getElementById("personB");

  const createBtn = document.getElementById("createBtn");
  const swapBtn = document.getElementById("swapBtn");
  const clearBtn = document.getElementById("clearBtn");

  const refreshBtn = document.getElementById("refreshBtn");
  const listEl = document.getElementById("list");
  const techEl = document.getElementById("tech");

  // =====================================================
  // HELPERS
  // =====================================================
  function safeParse(raw, fallback){
    try{ return JSON.parse(raw); }catch{ return fallback; }
  }
  function loadJson(key, fallback){
    const raw = localStorage.getItem(key);
    return raw ? safeParse(raw, fallback) : fallback;
  }
  function saveJson(key, value){
    localStorage.setItem(key, JSON.stringify(value));
  }
  function escapeHtml(s){
    return String(s || "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }
  function nowId(){
    return "r_" + Date.now().toString(36) + "_" + Math.random().toString(36).slice(2,8);
  }
  function setBox(el, html){
    el.hidden = false;
    el.innerHTML = html;
  }
  function clearBoxes(){
    hintEl.hidden = true; hintEl.innerHTML = "";
    okEl.hidden = true; okEl.innerHTML = "";
    errEl.hidden = true; errEl.innerHTML = "";
  }

  /* ARKIV-ID: CR-01 | H√§mta aktivt tr√§d */
  function getTrees(){
    const arr = loadJson(KEY_TREES, []);
    return Array.isArray(arr) ? arr : [];
  }
  function activeTreeId(){
    return localStorage.getItem(KEY_ACTIVE) || "";
  }
  function activeTreeLabel(){
    const id = activeTreeId();
    if(!id) return "‚Äî";
    const t = getTrees().find(x => String(x.id) === String(id));
    return t ? (t.name || t.id) : id;
  }

  /* ARKIV-ID: CR-02 | L√§s personer */
  function loadPeople(){
    const t = activeTreeId();
    if(!t) return [];
    const arr = loadJson(cardsKey(t), []);
    return Array.isArray(arr) ? arr : [];
  }

  /* ARKIV-ID: CR-05 | L√§s/spara relationer (of√∂r√§ndrat) */
  function loadRelations(){
    const t = activeTreeId();
    if(!t) return [];
    const arr = loadJson(relKey(t), []);
    return Array.isArray(arr) ? arr : [];
  }
  function saveRelations(arr){
    const t = activeTreeId();
    if(!t) return;
    saveJson(relKey(t), Array.isArray(arr) ? arr : []);
  }

  function personName(p){
    const n = `${p.fornamn || ""} ${p.efternamn || ""}`.trim();
    return n || "(namnl√∂s)";
  }
  function yearsLine(p){
    const a = (p && p.fodelsear != null && String(p.fodelsear).trim() !== "") ? String(p.fodelsear).trim() : "";
    const b = (p && p.dodsar != null && String(p.dodsar).trim() !== "") ? String(p.dodsar).trim() : "";
    if(!a && !b) return "";
    if(a && b) return `${a}‚Äì${b}`;
    return a ? `${a}‚Äì` : `‚Äì${b}`;
  }

  // =====================================================
  // DROPDOWN (backup) ‚Äì of√∂r√§ndrad logik
  // =====================================================
  let cachedPeople = [];

  function buildOptions(selectEl, people, selectedId, disallowId){
    selectEl.innerHTML = "";

    const opt0 = document.createElement("option");
    opt0.value = "";
    opt0.textContent = "V√§lj‚Ä¶";
    selectEl.appendChild(opt0);

    for(const p of people){
      const pid = String(p.id);
      if(disallowId && pid === String(disallowId)) continue;

      const opt = document.createElement("option");
      opt.value = pid;
      opt.textContent = personName(p) + (yearsLine(p) ? (" ¬∑ " + yearsLine(p)) : "");
      if(selectedId && pid === String(selectedId)) opt.selected = true;
      selectEl.appendChild(opt);
    }
  }

  function syncDropdowns(keepA, keepB){
    const a = keepA != null ? String(keepA) : String(personAEl.value || "");
    const b = keepB != null ? String(keepB) : String(personBEl.value || "");

    buildOptions(personAEl, cachedPeople, a, b || null);
    buildOptions(personBEl, cachedPeople, b, a || null);

    if(a && personAEl.value !== a) personAEl.value = "";
    if(b && personBEl.value !== b) personBEl.value = "";
  }

  // =====================================================
  // RELATION NORMALIZATION + DUPLICATE CHECK (of√∂r√§ndrat)
  // =====================================================
  function normalizeForStore(rel){
    const r = Object.assign({}, rel);
    if(!r.id) r.id = nowId();
    if(!r.createdAt) r.createdAt = Date.now();

    r.typ = String(r.typ || "").toUpperCase();

    if(r.typ === "FORALDER_BARN"){
      r.franPersonId = String(r.franPersonId || "");
      r.tillPersonId = String(r.tillPersonId || "");
    }
    if(r.typ === "PARTNER"){
      r.personAId = String(r.personAId || r.personA || r.aId || r.a || "");
      r.personBId = String(r.personBId || r.personB || r.bId || r.b || "");
      r.variant = String(r.variant || "").toUpperCase();
    }
    return r;
  }

  function isDuplicate(existing, candidate){
    if(!existing || !candidate) return false;

    if(existing.typ === "FORALDER_BARN" && candidate.typ === "FORALDER_BARN"){
      const a1 = String(existing.franPersonId || "");
      const b1 = String(existing.tillPersonId || "");
      const a2 = String(candidate.franPersonId || "");
      const b2 = String(candidate.tillPersonId || "");
      return a1 === a2 && b1 === b2;
    }

    if(existing.typ === "PARTNER" && candidate.typ === "PARTNER"){
      const ea = String(existing.personAId || existing.personA || existing.aId || existing.a || "");
      const eb = String(existing.personBId || existing.personB || existing.bId || existing.b || "");
      const ca = String(candidate.personAId || candidate.personA || candidate.aId || candidate.a || "");
      const cb = String(candidate.personBId || candidate.personB || candidate.bId || candidate.b || "");

      const lowE = ea < eb ? ea : eb;
      const highE = ea < eb ? eb : ea;
      const lowC = ca < cb ? ca : cb;
      const highC = ca < cb ? cb : ca;

      return lowE === lowC && highE === highC;
    }

    return false;
  }

  // =====================================================
  // ARKIV-ID: CR-04 | Variantlistor (UI-only)
  // =====================================================
  const VARIANTS_BY_TYPE = {
    FORALDER_BARN: [
      { v: "MAMMA", label: "Mamma" },
      { v: "PAPPA", label: "Pappa" }
    ],
    BARN: [
      { v: "SON", label: "Son" },
      { v: "DOTTER", label: "Dotter" }
    ],
    SYSKON: [
      { v: "BROR", label: "Bror" },
      { v: "SYSTER", label: "Syster" }
    ],
    MORFARFORALDER: [
      { v: "MORMOR", label: "Mormor" },
      { v: "MORFAR", label: "Morfar" },
      { v: "FARMOR", label: "Farmor" },
      { v: "FARFAR", label: "Farfar" }
    ],
    BARNBARN: [
      { v: "BARNBARN", label: "Barnbarn" }
    ],
    PARTNER: [
      { v: "GIFT", label: "Make/Maka" },
      { v: "SAMBO", label: "Sambo" }
    ],
    MOSTER_MORBROR: [
      { v: "MOSTER", label: "Moster" },
      { v: "MORBROR", label: "Morbror" }
    ],
    FASTER_FARBROR: [
      { v: "FASTER", label: "Faster" },
      { v: "FARBROR", label: "Farbror" }
    ],
    KUSIN: [
      { v: "KUSIN", label: "Kusin" }
    ],
    STYV: [
      { v: "STYVFORALDER", label: "Styvf√∂r√§lder" },
      { v: "STYVBARN", label: "Styvbarn" }
    ]
  };

  function renderVariantOptions(){
    const typ = String(relTypeEl.value || "").toUpperCase();
    const variants = VARIANTS_BY_TYPE[typ] || [{ v: "OKAND", label: "‚Äî" }];

    relVariantEl.innerHTML = "";
    for(const it of variants){
      const opt = document.createElement("option");
      opt.value = it.v;
      opt.textContent = it.label;
      relVariantEl.appendChild(opt);
    }

    // St√∂dinfo (utan designbyte, bara text)
    const supported = (typ === "FORALDER_BARN" || typ === "PARTNER");
    relTypeNoteEl.innerHTML =
      "Obs: F√∂r att inte √§ndra kopplingslogiken sparas just nu endast <strong>F√∂r√§lder</strong> och <strong>Partner</strong>."
      + (supported ? "" : " (Vald typ finns som UI, men kan inte sparas √§nnu.)");
  }

  // =====================================================
  // ARKIV-ID: CR-03 | S√∂k + f√∂rslag (ingen scanning/magi)
  // =====================================================
  let pickedAId = ""; // fokus
  let pickedBId = ""; // m√•l

  function normalizeStr(s){ return String(s || "").trim().toLowerCase(); }

  function searchPeople(query){
    const q = normalizeStr(query);
    if(q.length < 3) return [];
    const res = [];
    for(const p of cachedPeople){
      const name = normalizeStr(personName(p));
      if(name.includes(q)) res.push(p);
    }
    return res.slice(0, 12);
  }

  function closeSuggest(which){
    if(which === "A"){
      focusSuggestEl.hidden = true;
      focusSuggestEl.innerHTML = "";
    }else{
      targetSuggestEl.hidden = true;
      targetSuggestEl.innerHTML = "";
    }
  }

  function renderSuggest(which, items){
    const box = (which === "A") ? focusSuggestEl : targetSuggestEl;
    box.innerHTML = "";
    if(items.length === 0){
      box.hidden = true;
      return;
    }

    for(const p of items){
      const btn = document.createElement("button");
      btn.type = "button";
      btn.className = "sItem";
      btn.textContent = personName(p) + (yearsLine(p) ? (" ¬∑ " + yearsLine(p)) : "");
      btn.addEventListener("click", () => {
        if(which === "A"){
          pickFocus(String(p.id));
          focusSearchEl.value = personName(p);
          closeSuggest("A");
          try{ relTypeEl.focus(); }catch{}
        }else{
          pickTarget(String(p.id));
          targetSearchEl.value = personName(p);
          closeSuggest("B");
          try{ createBtn.focus(); }catch{}
        }
      });
      box.appendChild(btn);
    }

    box.hidden = false;
  }

  function pickFocus(id){
    clearBoxes();
    pickedAId = String(id || "");
    if(pickedAId && pickedAId === pickedBId){
      pickedBId = "";
      targetPickedEl.textContent = "‚Äî";
      targetSearchEl.value = "";
    }
    syncDropdowns(pickedAId, pickedBId);

    const p = cachedPeople.find(x => String(x.id) === pickedAId) || null;
    focusPickedEl.textContent = pickedAId ? ("Vald: " + (p ? personName(p) : ("#" + pickedAId))) : "‚Äî";
  }

  function pickTarget(id){
    clearBoxes();
    const next = String(id || "");
    if(next && next === pickedAId){
      setBox(errEl, "<strong>M√•lperson f√•r inte vara samma som fokusperson.</strong>");
      return;
    }
    pickedBId = next;
    syncDropdowns(pickedAId, pickedBId);

    const p = cachedPeople.find(x => String(x.id) === pickedBId) || null;
    targetPickedEl.textContent = pickedBId ? ("Vald: " + (p ? personName(p) : ("#" + pickedBId))) : "‚Äî";
  }

  function applyPickedFromDropdowns(){
    pickedAId = String(personAEl.value || "");
    pickedBId = String(personBEl.value || "");

    if(pickedAId && pickedAId === pickedBId){
      pickedBId = "";
      personBEl.value = "";
    }

    const pa = cachedPeople.find(p => String(p.id) === String(pickedAId)) || null;
    const pb = cachedPeople.find(p => String(p.id) === String(pickedBId)) || null;

    focusPickedEl.textContent = pickedAId ? ("Vald: " + (pa ? personName(pa) : ("#" + pickedAId))) : "‚Äî";
    targetPickedEl.textContent = pickedBId ? ("Vald: " + (pb ? personName(pb) : ("#" + pickedBId))) : "‚Äî";
  }

  // =====================================================
  // UI RENDER
  // =====================================================
  function renderPills(){
    const trees = getTrees();
    const act = activeTreeId();
    const hasTrees = trees.length > 0;
    const hasActive = !!act && trees.some(t => String(t.id) === String(act));

    pillTree.className = "pill " + (hasActive ? "ok" : (hasTrees ? "warn" : "err"));
    pillTree.innerHTML = "Aktivt tr√§d: <strong>" + escapeHtml(hasActive ? activeTreeLabel() : "‚Äî") + "</strong>";

    const ppl = hasActive ? cachedPeople.length : 0;
    const rels = hasActive ? loadRelations().length : 0;

    pillPeople.innerHTML = "Personer: <strong>" + ppl + "</strong>";
    pillRel.innerHTML = "Relationer: <strong>" + rels + "</strong>";
  }

  function renderHint(){
    const trees = getTrees();
    const act = activeTreeId();
    const hasTrees = trees.length > 0;
    const hasActive = !!act && trees.some(t => String(t.id) === String(act));

    if(!hasTrees){
      setBox(hintEl, "<strong>üö© Inga tr√§d:</strong> G√• till <a href='./trees.html'><code>Tr√§d</code></a> och skapa ett tr√§d.");
      return false;
    }
    if(!hasActive){
      setBox(hintEl, "<strong>üö© Inget aktivt tr√§d:</strong> V√§lj aktivt tr√§d i <a href='./trees.html'><code>Tr√§d</code></a>.");
      return false;
    }
    if(cachedPeople.length < 2){
      setBox(hintEl, "<strong>üö© F√∂r f√• personer:</strong> Du beh√∂ver minst <code>2</code> personer i aktivt tr√§d. G√• till <a href='./slaktkort.html'><code>Personer</code></a>.");
      return false;
    }
    return true;
  }

  function relLabel(r, peopleById){
    if(!r || !r.typ) return "‚Äî";

    if(r.typ === "FORALDER_BARN"){
      const a = peopleById.get(String(r.franPersonId)) || null;
      const b = peopleById.get(String(r.tillPersonId)) || null;
      const an = a ? personName(a) : ("#" + String(r.franPersonId || "‚Äî"));
      const bn = b ? personName(b) : ("#" + String(r.tillPersonId || "‚Äî"));
      return "F√∂r√§lder ‚Üí Barn: " + an + " ‚Üí " + bn;
    }

    if(r.typ === "PARTNER"){
      const aId = String(r.personAId || "");
      const bId = String(r.personBId || "");
      const a = peopleById.get(aId) || null;
      const b = peopleById.get(bId) || null;
      const an = a ? personName(a) : ("#" + (aId || "‚Äî"));
      const bn = b ? personName(b) : ("#" + (bId || "‚Äî"));
      const v = r.variant ? (" ¬∑ " + r.variant) : "";
      return "Partner: " + an + " ‚Üî " + bn + v;
    }

    return r.typ;
  }

  function renderList(){
    listEl.innerHTML = "";

    const trees = getTrees();
    const act = activeTreeId();
    const hasActive = !!act && trees.some(t => String(t.id) === String(act));

    if(!hasActive){
      const li = document.createElement("li");
      li.className = "item";
      li.style.cursor = "default";
      li.innerHTML = "<div class='itemLeft'><p class='itemTitle'>‚Äî</p><p class='itemMeta'>V√§lj aktivt tr√§d f√∂rst.</p></div>";
      listEl.appendChild(li);
      return;
    }

    const people = cachedPeople;
    const rels = loadRelations();

    if(rels.length === 0){
      const li = document.createElement("li");
      li.className = "item";
      li.style.cursor = "default";
      li.innerHTML = "<div class='itemLeft'><p class='itemTitle'>Inga relationer √§nnu</p><p class='itemMeta'>Skapa en relation till v√§nster.</p></div>";
      listEl.appendChild(li);
      return;
    }

    const peopleById = new Map(people.map(p => [String(p.id), p]));

    for(const r of rels){
      const li = document.createElement("li");
      li.className = "item";

      const left = document.createElement("div");
      left.className = "itemLeft";

      const title = document.createElement("p");
      title.className = "itemTitle";
      title.textContent = relLabel(r, peopleById);

      const meta = document.createElement("p");
      meta.className = "itemMeta mono";
      meta.textContent = "id: " + (r.id || "‚Äî") + " ¬∑ typ: " + (r.typ || "‚Äî");

      left.appendChild(title);
      left.appendChild(meta);

      const del = document.createElement("button");
      del.className = "btn danger";
      del.type = "button";
      del.textContent = "Ta bort";
      del.addEventListener("click", () => {
        const ok = confirm("Ta bort relation?\n\n" + relLabel(r, peopleById));
        if(!ok) return;
        const next = rels.filter(x => String(x.id) !== String(r.id));
        saveRelations(next);
        clearBoxes();
        setBox(okEl, "<strong>Borttaget.</strong>");
        refresh();
      });

      li.appendChild(left);
      li.appendChild(del);
      listEl.appendChild(li);
    }
  }

  function renderTech(){
    const t = activeTreeId();
    techEl.textContent =
      "Aktivt treeId: " + (t || "‚Äî") +
      " ¬∑ PeopleKey: " + (t ? cardsKey(t) : "‚Äî") +
      " ¬∑ RelationsKey: " + (t ? relKey(t) : "‚Äî");
  }

  // =====================================================
  // ARKIV-ID: CR-05 | CREATE (sparlogik intakt)
  // =====================================================
  function createRelation(){
    clearBoxes();

    const trees = getTrees();
    const act = activeTreeId();
    const hasActive = !!act && trees.some(t => String(t.id) === String(act));
    if(!hasActive){
      setBox(errEl, "<strong>V√§lj aktivt tr√§d f√∂rst.</strong> G√• till <a href='./trees.html'><code>Tr√§d</code></a>.");
      return;
    }

    // Prim√§rt: s√∂kval om finns, annars backup dropdowns
    const aId = String(pickedAId || personAEl.value || "");
    const bId = String(pickedBId || personBEl.value || "");

    if(!aId || !bId){
      setBox(errEl, "<strong>V√§lj fokusperson och m√•lperson.</strong>");
      return;
    }
    if(aId === bId){
      setBox(errEl, "<strong>Du kan inte koppla en person till sig sj√§lv.</strong>");
      return;
    }

    const uiType = String(relTypeEl.value || "").toUpperCase();
    const uiVariant = String(relVariantEl.value || "").toUpperCase();

    // F√∂rbud: √§ndra kopplingslogik -> vi sparar bara det som redan st√∂ds
    if(uiType !== "FORALDER_BARN" && uiType !== "PARTNER"){
      setBox(errEl, "<strong>Den relationstypen kan inte sparas √§nnu.</strong> V√§lj <code>F√∂r√§lder</code> eller <code>Partner</code>.");
      return;
    }

    const rels = loadRelations();
    let candidate = null;

    if(uiType === "FORALDER_BARN"){
      // (Variant √§r UI-only och sparas inte, f√∂r att inte √§ndra format.)
      candidate = normalizeForStore({
        id: nowId(),
        typ: "FORALDER_BARN",
        franPersonId: aId,
        tillPersonId: bId
      });
    }else if(uiType === "PARTNER"){
      // Mappa UI-variant till befintliga partner-varianter
      const variant = (uiVariant === "SAMBO") ? "SAMBO" : "GIFT";
      candidate = normalizeForStore({
        id: nowId(),
        typ: "PARTNER",
        personAId: aId,
        personBId: bId,
        variant
      });
    }

    if(rels.some(x => isDuplicate(x, candidate))){
      setBox(errEl, "<strong>Relationen finns redan.</strong>");
      return;
    }

    rels.unshift(candidate);
    saveRelations(rels);

    setBox(okEl, "<strong>Sparat.</strong> Relation skapad i aktivt tr√§d.");
    refresh();
  }

  // =====================================================
  // EVENTS
  // =====================================================
  relTypeEl.addEventListener("change", () => {
    renderVariantOptions();
  });

  /* ARKIV-ID: CR-03 | S√∂k-input events */
  focusSearchEl.addEventListener("input", () => {
    clearBoxes();
    const q = focusSearchEl.value || "";
    if(String(q).trim().length < 3){
      closeSuggest("A");
      return;
    }
    renderSuggest("A", searchPeople(q));
  });

  targetSearchEl.addEventListener("input", () => {
    clearBoxes();
    const q = targetSearchEl.value || "";
    if(String(q).trim().length < 3){
      closeSuggest("B");
      return;
    }
    const items = searchPeople(q).filter(p => String(p.id) !== String(pickedAId || ""));
    renderSuggest("B", items);
  });

  document.addEventListener("click", (e) => {
    const t = e.target;
    if(!t) return;
    if(!focusSuggestEl.contains(t) && t !== focusSearchEl) closeSuggest("A");
    if(!targetSuggestEl.contains(t) && t !== targetSearchEl) closeSuggest("B");
  });

  focusSearchEl.addEventListener("keydown", (e) => { if(e.key === "Escape") closeSuggest("A"); });
  targetSearchEl.addEventListener("keydown", (e) => { if(e.key === "Escape") closeSuggest("B"); });

  personAEl.addEventListener("change", () => {
    syncDropdowns(personAEl.value, personBEl.value);
    applyPickedFromDropdowns();
  });
  personBEl.addEventListener("change", () => {
    syncDropdowns(personAEl.value, personBEl.value);
    applyPickedFromDropdowns();
  });

  createBtn.addEventListener("click", createRelation);

  swapBtn.addEventListener("click", () => {
    clearBoxes();
    const a = String(pickedAId || personAEl.value || "");
    const b = String(pickedBId || personBEl.value || "");

    pickedAId = b;
    pickedBId = a;

    if(pickedAId && pickedAId === pickedBId) pickedBId = "";

    syncDropdowns(pickedAId, pickedBId);

    const pa = cachedPeople.find(p => String(p.id) === String(pickedAId)) || null;
    const pb = cachedPeople.find(p => String(p.id) === String(pickedBId)) || null;
    focusSearchEl.value = pa ? personName(pa) : "";
    targetSearchEl.value = pb ? personName(pb) : "";
    focusPickedEl.textContent = pickedAId ? ("Vald: " + (pa ? personName(pa) : ("#" + pickedAId))) : "‚Äî";
    targetPickedEl.textContent = pickedBId ? ("Vald: " + (pb ? personName(pb) : ("#" + pickedBId))) : "‚Äî";
  });

  clearBtn.addEventListener("click", () => {
    clearBoxes();

    pickedAId = "";
    pickedBId = "";
    focusSearchEl.value = "";
    targetSearchEl.value = "";
    focusPickedEl.textContent = "‚Äî";
    targetPickedEl.textContent = "‚Äî";
    closeSuggest("A");
    closeSuggest("B");

    relTypeEl.value = "FORALDER_BARN";
    renderVariantOptions();

    syncDropdowns("", "");
    try{ focusSearchEl.focus(); }catch{}
  });

  refreshBtn.addEventListener("click", () => {
    clearBoxes();
    refresh();
  });

  logoutBtn.addEventListener("click", () => {
    try{ sessionStorage.removeItem("demo_auth"); }catch{}
    window.location.href = "../index.html";
  });

  // =====================================================
  // REFRESH
  // =====================================================
  function refresh(){
    clearBoxes();

    cachedPeople = loadPeople();
    renderPills();
    renderTech();

    const ok = renderHint();

    renderVariantOptions();
    syncDropdowns(personAEl.value, personBEl.value);
    applyPickedFromDropdowns();

    createBtn.disabled = !ok;

    renderList();
  }

  // =====================================================
  // START
  // =====================================================
  refresh();
</script>
</body>
</html>
