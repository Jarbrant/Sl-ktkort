<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Relationer ‚Äì Sl√§ktkort</title>
  <meta name="description" content="Skapa relationer i aktivt tr√§d (localStorage-first). Fokusperson ‚Üí relationstyp ‚Üí variant ‚Üí annan person." />

  <style>
    :root { color-scheme: light; }
    body{
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      line-height: 1.5;
      margin: 0;
      padding: 24px;
      max-width: 980px;
      margin-inline: auto;
      background: #fff;
      color: #111;
    }
    a{ color: inherit; text-decoration:none; }
    header{ margin-bottom: 14px; }
    h1{ margin:0 0 6px; font-size:1.6rem; }
    .muted{ color:#555; margin:0 0 12px; }

    .topbar{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      margin: 10px 0 16px;
    }
    .btn, button{
      display:inline-block;
      padding:10px 12px;
      border:1px solid #333;
      border-radius:10px;
      background:#fff;
      font:inherit;
      cursor:pointer;
      text-decoration:none;
    }
    .btn.secondary{ border-color:#bbb; }
    .btn.danger{ border-color:#b00020; color:#b00020; }

    .pillRow{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      margin: 10px 0 18px;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border:1px solid #ddd;
      border-radius:999px;
      background:#fafafa;
      font-size:.95rem;
    }
    .pill strong{ font-weight:950; }

    .card{
      border:1px solid #ddd;
      border-radius:12px;
      padding:16px;
      margin: 14px 0;
      background:#fff;
    }
    .card h2{ margin:0 0 6px; font-size:1.15rem; }
    .small{ font-size:.95rem; color:#555; margin:0 0 10px; }

    label{ display:block; margin:10px 0 6px; font-weight:900; }
    select, input{
      width:100%;
      box-sizing:border-box;
      padding:10px;
      border-radius:10px;
      border:1px solid #bbb;
      font:inherit;
      background:#fff;
      color:#111;
    }

    .row{ display:grid; gap:12px; grid-template-columns: 1fr; }
    @media (min-width: 740px){
      .row.two{ grid-template-columns: 1fr 1fr; }
      .row.three{ grid-template-columns: 1fr 1fr 1fr; }
      .row.four{ grid-template-columns: 1fr 1fr 1fr 1fr; }
    }

    .actions{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      margin-top: 12px;
    }

    .error{ color:#b00020; font-weight:950; }
    .ok{ font-weight:950; }

    /* S√∂kresultat */
    .list{
      margin: 10px 0 0;
      padding: 0;
      list-style:none;
      display:flex;
      flex-direction:column;
      gap:10px;
      max-height: 320px;
      overflow:auto;
      border-top:1px solid #eee;
      padding-top:10px;
    }
    .item{
      border:1px solid #eee;
      border-radius:12px;
      padding:10px;
      background:#fff;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
      cursor:pointer;
    }
    .item:hover{ background:#fafafa; }
    .item.active{ border-color:#333; background:#f7f7f7; }
    .itemTitle{ font-weight:950; margin:0 0 2px; }
    .itemMeta{ margin:0; color:#555; font-size:.95rem; }

    code{ background:#f4f4f4; padding:2px 6px; border-radius:6px; }
  </style>
</head>

<body>
<header>
  <h1>üîó Relationer</h1>
  <p class="muted">Fokusperson ‚Üí Relationstyp ‚Üí Variant (ibland) ‚Üí V√§lj person.</p>

  <nav class="topbar" aria-label="Navigation">
    <a class="btn secondary" href="../start.html">Start</a>
    <a class="btn secondary" href="./trees.html">Tr√§d</a>
    <a class="btn secondary" href="./slaktkort.html">Personer</a>
    <a class="btn" href="./create-relation.html" aria-current="page">Relationer</a>
    <a class="btn secondary" href="./map.html">Karta</a>
    <button id="logoutBtn" class="btn secondary" type="button">Logga ut</button>
  </nav>

  <div class="pillRow" aria-label="Status">
    <span class="pill">Aktivt tr√§d: <strong id="pillTree">‚Äî</strong></span>
    <span class="pill">Personer: <strong id="pillPeople">0</strong></span>
    <span class="pill">Relationer: <strong id="pillRels">0</strong></span>
    <span class="pill">N√§sta steg: <strong>üó∫Ô∏è Karta</strong></span>
  </div>
</header>

<section class="card">
  <h2>1) V√§lj fokusperson</h2>
  <p class="small">S√∂k person genom att skriva minst 3 bokst√§ver.</p>

  <div class="row two">
    <div>
      <label for="focusSearch">S√∂k fokusperson *</label>
      <input id="focusSearch" placeholder="minst 3 bokst√§ver‚Ä¶" autocomplete="off" />
      <ul id="focusList" class="list" aria-label="Fokusperson-f√∂rslag"></ul>
    </div>

    <div>
      <label>Vald fokusperson</label>
      <p class="small" id="focusSummary">‚Äî</p>
    </div>
  </div>

  <p id="msgTop" class="muted" aria-live="polite"></p>
</section>

<section class="card">
  <h2>2) Skapa relation</h2>
  <p class="small">Variant-rutan visas bara n√§r den g√∂r nytta (t.ex. farmor/farfar/mormor/morfar).</p>

  <form id="form">
    <div class="row four">
      <div>
        <label for="relationKey">Relationstyp *</label>
        <select id="relationKey" required>
          <option value="PARENT_OF" selected>F√∂r√§lder till</option>
          <option value="CHILD_OF">Barn till</option>

          <option value="SIBLING_OF">Syskon med</option>

          <option value="GRANDPARENT_OF">Far-/morf√∂r√§lder till</option>
          <option value="GRANDCHILD_OF">Barnbarn till</option>

          <option value="PARTNER_OF">Partner med</option>

          <option value="AUNTUNCLE_MATERNAL">Moster/Morbror till</option>
          <option value="AUNTUNCLE_PATERNAL">Faster/Farbror till</option>

          <option value="COUSIN_OF">Kusin med</option>

          <option value="STEP_PARENT_OF">Styvf√∂r√§lder till</option>
          <option value="STEP_CHILD_OF">Styvbarn till</option>
        </select>
      </div>

      <div id="variantWrap" hidden>
        <label for="variantSelect" id="variantLabel">Variant (valfri)</label>
        <select id="variantSelect">
          <option value="">Ingen</option>
        </select>
        <p class="small" id="variantHelp">‚Äî</p>
      </div>

      <div>
        <label for="otherSelect" id="otherLabel">Person *</label>
        <select id="otherSelect" required>
          <option value="">V√§lj‚Ä¶</option>
        </select>
        <p class="small" id="otherHelp">‚Äî</p>
      </div>

      <div>
        <label>F√∂rhandsvisning</label>
        <p class="small" id="previewLine">V√§lj fokusperson f√∂rst.</p>
      </div>
    </div>

    <div class="actions">
      <button type="submit" class="btn">Spara relation</button>
      <button type="button" id="resetBtn" class="btn secondary">Rensa val</button>
      <a class="btn secondary" href="./map.html">Forts√§tt ‚Üí Karta</a>
    </div>

    <p id="msgSave" class="muted" aria-live="polite"></p>
  </form>
</section>

<script>
  (function authGuard(){
    try{
      if(sessionStorage.getItem("demo_auth") !== "1"){
        window.location.href = "../index.html";
      }
    }catch{}
  })();

  const KEY_TREES  = "slakttradet_trees";
  const KEY_ACTIVE = "slakttradet_active_tree_id";
  const cardsKey = (treeId) => "slakttradet_slaktkort_" + String(treeId);
  const relKey   = (treeId) => "slakttradet_relationer_" + String(treeId);

  const logoutBtn = document.getElementById("logoutBtn");

  const pillTree = document.getElementById("pillTree");
  const pillPeople = document.getElementById("pillPeople");
  const pillRels = document.getElementById("pillRels");

  const focusSearch = document.getElementById("focusSearch");
  const focusList = document.getElementById("focusList");
  const focusSummary = document.getElementById("focusSummary");
  const msgTop = document.getElementById("msgTop");

  const relationKeyEl = document.getElementById("relationKey");

  const variantWrap = document.getElementById("variantWrap");
  const variantSelect = document.getElementById("variantSelect");
  const variantLabel = document.getElementById("variantLabel");
  const variantHelp = document.getElementById("variantHelp");

  const otherSelect = document.getElementById("otherSelect");
  const otherLabel = document.getElementById("otherLabel");
  const otherHelp = document.getElementById("otherHelp");

  const previewLine = document.getElementById("previewLine");
  const msgSave = document.getElementById("msgSave");

  const resetBtn = document.getElementById("resetBtn");
  const form = document.getElementById("form");

  function safeParse(raw, fallback){ try{ return JSON.parse(raw); }catch{ return fallback; } }
  function loadJson(key, fallback){
    const raw = localStorage.getItem(key);
    return raw ? safeParse(raw, fallback) : fallback;
  }
  function saveJson(key, value){ localStorage.setItem(key, JSON.stringify(value)); }

  function escapeHtml(s){
    return String(s || "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }
  function setMsg(el, type, text){
    el.innerHTML = type === "error"
      ? "<span class='error'>" + escapeHtml(text) + "</span>"
      : type === "ok"
        ? "<span class='ok'>" + escapeHtml(text) + "</span>"
        : escapeHtml(text || "");
  }

  function getTrees(){
    const trees = loadJson(KEY_TREES, []);
    return Array.isArray(trees) ? trees : [];
  }
  function activeTreeId(){ return localStorage.getItem(KEY_ACTIVE) || ""; }
  function activeTreeLabel(){
    const id = activeTreeId();
    if(!id) return "‚Äî";
    const t = getTrees().find(x => String(x.id) === String(id));
    return t ? (t.name || t.id) : id;
  }

  function loadPeople(){
    const t = activeTreeId();
    if(!t) return [];
    const arr = loadJson(cardsKey(t), []);
    return Array.isArray(arr) ? arr : [];
  }
  function loadRels(){
    const t = activeTreeId();
    if(!t) return [];
    const arr = loadJson(relKey(t), []);
    return Array.isArray(arr) ? arr : [];
  }
  function saveRels(rels){
    const t = activeTreeId();
    if(!t) return;
    saveJson(relKey(t), rels);
  }

  function personName(p){
    const n = `${p.fornamn || ""} ${p.efternamn || ""}`.trim();
    return n || "(namnl√∂s)";
  }
  function getPersonById(people, id){
    return people.find(x => String(x.id) === String(id)) || null;
  }

  const REL_META = {
    PARENT_OF:          { label:"F√∂r√§lder till",         otherLabel:"Barn *",            help:"Fokuspersonen √§r f√∂r√§lder. Den andra √§r barn.", symmetric:false, type:"PARENTCHILD" },
    CHILD_OF:           { label:"Barn till",             otherLabel:"F√∂r√§lder *",        help:"Fokuspersonen √§r barn. Den andra √§r f√∂r√§lder.", symmetric:false, type:"PARENTCHILD" },

    SIBLING_OF:         { label:"Syskon med",            otherLabel:"Syskon *",          help:"Syskonrelation (symmetrisk).", symmetric:true,  type:"GENERIC" },

    GRANDPARENT_OF:     { label:"Far-/morf√∂r√§lder till", otherLabel:"Barnbarn *",        help:"Fokuspersonen √§r far-/morf√∂r√§lder. Den andra √§r barnbarn.", symmetric:false, type:"GENERIC" },
    GRANDCHILD_OF:      { label:"Barnbarn till",         otherLabel:"Far-/morf√∂r√§lder *",help:"Fokuspersonen √§r barnbarn. Den andra √§r far-/morf√∂r√§lder.", symmetric:false, type:"GENERIC" },

    PARTNER_OF:         { label:"Partner med",           otherLabel:"Partner *",         help:"Partnerrelation (symmetrisk).", symmetric:true,  type:"PARTNER" },

    AUNTUNCLE_MATERNAL: { label:"Moster/Morbror till",   otherLabel:"Syskonbarn *",      help:"Fokuspersonen √§r moster/morbror. Den andra √§r syskonbarn.", symmetric:false, type:"GENERIC" },
    AUNTUNCLE_PATERNAL: { label:"Faster/Farbror till",   otherLabel:"Syskonbarn *",      help:"Fokuspersonen √§r faster/farbror. Den andra √§r syskonbarn.", symmetric:false, type:"GENERIC" },

    COUSIN_OF:          { label:"Kusin med",             otherLabel:"Kusin *",           help:"Kusinrelation (symmetrisk).", symmetric:true,  type:"GENERIC" },

    STEP_PARENT_OF:     { label:"Styvf√∂r√§lder till",     otherLabel:"Styvbarn *",        help:"Relation via omgifte/ny partner.", symmetric:false, type:"GENERIC" },
    STEP_CHILD_OF:      { label:"Styvbarn till",         otherLabel:"Styvf√∂r√§lder *",    help:"Relation via omgifte/ny partner.", symmetric:false, type:"GENERIC" }
  };

  const VARIANTS = {
    PARENT_OF:     { label:"F√∂r√§ldervariant", help:"Valfritt: mamma eller pappa.", options:[
      {v:"MAMMA", t:"Mamma"}, {v:"PAPPA", t:"Pappa"}
    ]},
    CHILD_OF:      { label:"Barnvariant", help:"Valfritt: son eller dotter.", options:[
      {v:"SON", t:"Son"}, {v:"DOTTER", t:"Dotter"}
    ]},
    GRANDPARENT_OF:{ label:"Variant", help:"Valfritt: farmor/farfar/mormor/morfar.", options:[
      {v:"FARMOR", t:"Farmor"}, {v:"FARFAR", t:"Farfar"}, {v:"MORMOR", t:"Mormor"}, {v:"MORFAR", t:"Morfar"}
    ]},
    GRANDCHILD_OF: { label:"Variant", help:"Valfritt: barnbarn (om du vill skriva ut).", options:[
      {v:"BARNBARN", t:"Barnbarn"}
    ]},
    AUNTUNCLE_MATERNAL:{ label:"Variant", help:"Valfritt: moster eller morbror.", options:[
      {v:"MOSTER", t:"Moster"}, {v:"MORBROR", t:"Morbror"}
    ]},
    AUNTUNCLE_PATERNAL:{ label:"Variant", help:"Valfritt: faster eller farbror.", options:[
      {v:"FASTER", t:"Faster"}, {v:"FARBROR", t:"Farbror"}
    ]},
    PARTNER_OF: { label:"Partnerstatus", help:"Valfritt: typ av partnerrelation.", options:[
      {v:"MAKE_MAKA", t:"Make/Maka"}, {v:"SAMBO", t:"Sambo"}, {v:"SARBO", t:"S√§rbo"}, {v:"SKILDA", t:"Skilda"}
    ]},
    STEP_PARENT_OF:{ label:"Variant", help:"Valfritt: styvf√∂r√§lder.", options:[
      {v:"STYVFORALDER", t:"Styvf√∂r√§lder"}
    ]},
    STEP_CHILD_OF:{ label:"Variant", help:"Valfritt: styvbarn.", options:[
      {v:"STYVBARN", t:"Styvbarn"}
    ]}
  };

  function relLabel(key){
    return (REL_META[key] && REL_META[key].label) ? REL_META[key].label : key;
  }

  function hasSameParentChild(rels, parentId, childId){
    return rels.some(r =>
      r && r.typ === "FORALDER_BARN" &&
      String(r.franPersonId) === String(parentId) &&
      String(r.tillPersonId) === String(childId)
    );
  }
  function parentsOfChild(rels, childId){
    return rels
      .filter(r => r && r.typ === "FORALDER_BARN" && String(r.tillPersonId) === String(childId))
      .map(r => String(r.franPersonId));
  }
  function hasSamePartner(rels, aId, bId){
    const A = String(aId), B = String(bId);
    return rels.some(r => {
      if(!r || r.typ !== "PARTNER") return false;
      const x = String(r.personAId), y = String(r.personBId);
      return (x === A && y === B) || (x === B && y === A);
    });
  }
  function hasSameGeneric(rels, relationKey, aId, bId, symmetric, variant){
    const A = String(aId), B = String(bId);
    const V = String(variant || "");
    return rels.some(r => {
      if(!r || r.typ !== "GENERIC") return false;
      if(String(r.relationKey) !== String(relationKey)) return false;
      if(String(r.variant || "") !== V) return false;
      const x = String(r.personAId), y = String(r.personBId);
      if(symmetric) return (x === A && y === B) || (x === B && y === A);
      return (x === A && y === B);
    });
  }

  function renderStatus(){
    const t = activeTreeId();
    const people = loadPeople();
    const rels = loadRels();

    pillTree.textContent = activeTreeLabel();
    pillPeople.textContent = String(people.length);
    pillRels.textContent = String(rels.length);

    if(!t){
      setMsg(msgTop, "error", "V√§lj ett aktivt tr√§d f√∂rst (Tr√§d).");
      return false;
    }
    if(people.length === 0){
      setMsg(msgTop, "error", "Inga personer √§n. Skapa personer f√∂rst.");
      return false;
    }
    setMsg(msgTop, "", "");
    return true;
  }

  function fillSelect(select, people, includeEmpty=true, excludeId=""){
    const ex = String(excludeId || "");
    select.innerHTML = includeEmpty ? "<option value=''>V√§lj‚Ä¶</option>" : "";
    for(const p of people){
      if(!p || !p.id) continue;
      if(ex && String(p.id) === ex) continue;
      const opt = document.createElement("option");
      opt.value = String(p.id);
      opt.textContent = personName(p);
      select.appendChild(opt);
    }
  }

  let focusId = "";

  function renderFocusSummary(){
    const people = loadPeople();
    const p = focusId ? getPersonById(people, focusId) : null;
    focusSummary.textContent = p ? personName(p) : "‚Äî";
    renderPreview();
  }

  function applyVariantUI(){
    const key = String(relationKeyEl.value || "");
    const v = VARIANTS[key];

    if(!v){
      variantWrap.hidden = true;
      variantSelect.innerHTML = "<option value=''>Ingen</option>";
      variantHelp.textContent = "‚Äî";
      return;
    }

    variantWrap.hidden = false;
    variantLabel.textContent = (v.label || "Variant") + " (valfri)";
    variantHelp.textContent = v.help || "‚Äî";

    const prev = String(variantSelect.value || "");
    variantSelect.innerHTML = "<option value=''>Ingen</option>";
    for(const o of v.options || []){
      const opt = document.createElement("option");
      opt.value = o.v;
      opt.textContent = o.t;
      variantSelect.appendChild(opt);
    }
    if(prev) variantSelect.value = prev;
  }

  function applyRelationUI(){
    const k = String(relationKeyEl.value || "");
    const meta = REL_META[k] || { otherLabel:"Person *", help:"‚Äî" };

    otherLabel.textContent = meta.otherLabel || "Person *";
    otherHelp.textContent = meta.help || "‚Äî";

    applyVariantUI();

    const people = loadPeople();
    const prevOther = String(otherSelect.value || "");
    fillSelect(otherSelect, people, true, focusId);
    if(prevOther && prevOther !== focusId) otherSelect.value = prevOther;
    if(otherSelect.value === focusId) otherSelect.value = "";

    renderPreview();
  }

  function renderPreview(){
    const people = loadPeople();
    const otherId = String(otherSelect.value || "");
    const relK = String(relationKeyEl.value || "");
    const variant = String(variantSelect.value || "");

    const a = focusId ? getPersonById(people, focusId) : null;
    const b = otherId ? getPersonById(people, otherId) : null;

    if(!a){
      previewLine.textContent = "V√§lj fokusperson f√∂rst.";
      return;
    }

    const mid = relLabel(relK) + (variant ? (" (" + variant + ")") : "");
    previewLine.textContent = personName(a) + " ‚Äî " + mid + " ‚Äî " + (b ? personName(b) : "‚Ä¶");
  }

  function renderFocusResults(){
    focusList.innerHTML = "";
    const ok = renderStatus();
    if(!ok) return;

    const q = String(focusSearch.value || "").trim().toLowerCase();
    if(q.length < 3) return; // AUTOPATCH: visa inget innan 3 tecken

    const people = loadPeople();
    const hits = people
      .filter(p => personName(p).toLowerCase().includes(q))
      .slice(0, 40);

    if(hits.length === 0) return;

    for(const p of hits){
      const li = document.createElement("li");
      li.className = "item" + (String(p.id) === String(focusId) ? " active" : "");
      li.innerHTML =
        "<div style='min-width:0;'>" +
          "<p class='itemTitle'>" + escapeHtml(personName(p)) + "</p>" +
          "<p class='itemMeta'>ID: " + escapeHtml(String(p.id)) + "</p>" +
        "</div>";

      li.addEventListener("click", () => {
        focusId = String(p.id);
        setMsg(msgSave, "", "");
        renderFocusSummary();
        applyRelationUI();
        renderFocusResults();
      });

      focusList.appendChild(li);
    }
  }

  function refreshAll(){
    setMsg(msgSave, "", "");
    const ok = renderStatus();
    if(!ok) return;

    const people = loadPeople();
    if(focusId && !getPersonById(people, focusId)) focusId = "";

    renderFocusSummary();
    applyRelationUI();
    renderFocusResults();
  }

  form.addEventListener("submit", (e) => {
    e.preventDefault();

    const t = activeTreeId();
    if(!t) return setMsg(msgSave, "error", "V√§lj ett aktivt tr√§d f√∂rst.");

    const otherId = String(otherSelect.value || "").trim();
    const key = String(relationKeyEl.value || "").trim();
    const variant = String(variantSelect.value || "");

    if(!focusId) return setMsg(msgSave, "error", "V√§lj fokusperson f√∂rst.");
    if(!key) return setMsg(msgSave, "error", "V√§lj relationstyp.");
    if(!otherId) return setMsg(msgSave, "error", "V√§lj den andra personen.");
    if(otherId === focusId) return setMsg(msgSave, "error", "Du kan inte v√§lja samma person.");

    const rels = loadRels();
    const meta = REL_META[key] || { symmetric:false, type:"GENERIC" };

    if(meta.type === "PARENTCHILD"){
      const parentId = (key === "PARENT_OF") ? focusId : otherId;
      const childId  = (key === "PARENT_OF") ? otherId : focusId;

      if(hasSameParentChild(rels, parentId, childId)) return setMsg(msgSave, "error", "Redan kopplad.");
      const parents = new Set(parentsOfChild(rels, childId));
      if(parents.size >= 2) return setMsg(msgSave, "error", "Barnet har redan 2 f√∂r√§ldrar.");

      rels.push({
        id: "r" + Date.now(),
        typ: "FORALDER_BARN",
        franPersonId: parentId,
        tillPersonId: childId,
        variant: variant || "",
        createdAt: new Date().toISOString()
      });

      saveRels(rels);
      pillRels.textContent = String(rels.length);
      otherSelect.value = "";
      setMsg(msgSave, "ok", "Sparat: F√∂r√§lder ‚Üî Barn.");
      renderPreview();
      return;
    }

    if(meta.type === "PARTNER"){
      if(hasSamePartner(rels, focusId, otherId)) return setMsg(msgSave, "error", "Partnerrelation finns redan.");

      rels.push({
        id: "r" + Date.now(),
        typ: "PARTNER",
        personAId: focusId,
        personBId: otherId,
        variant: variant || "",
        createdAt: new Date().toISOString()
      });

      saveRels(rels);
      pillRels.textContent = String(rels.length);
      otherSelect.value = "";
      setMsg(msgSave, "ok", "Sparat: Partner.");
      renderPreview();
      return;
    }

    if(hasSameGeneric(rels, key, focusId, otherId, !!meta.symmetric, variant)) {
      return setMsg(msgSave, "error", "Relationen finns redan.");
    }

    rels.push({
      id: "r" + Date.now(),
      typ: "GENERIC",
      relationKey: key,
      personAId: focusId,
      personBId: otherId,
      symmetric: !!meta.symmetric,
      variant: variant || "",
      createdAt: new Date().toISOString()
    });

    saveRels(rels);
    pillRels.textContent = String(rels.length);
    otherSelect.value = "";
    setMsg(msgSave, "ok", "Sparat: " + relLabel(key) + ".");
    renderPreview();
  });

  relationKeyEl.addEventListener("change", () => applyRelationUI());
  variantSelect.addEventListener("change", () => renderPreview());
  otherSelect.addEventListener("change", () => renderPreview());

  resetBtn.addEventListener("click", () => {
    otherSelect.value = "";
    variantSelect.value = "";
    setMsg(msgSave, "", "");
    renderPreview();
  });

  logoutBtn.addEventListener("click", () => {
    try{ sessionStorage.removeItem("demo_auth"); }catch{}
    window.location.href = "../index.html";
  });

  let t1 = null;
  focusSearch.addEventListener("input", () => {
    if(t1) clearTimeout(t1);
    t1 = setTimeout(renderFocusResults, 120);
  });

  window.addEventListener("focus", () => refreshAll());

  refreshAll();
</script>
</body>
</html>
