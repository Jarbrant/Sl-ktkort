<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Relationer ‚Äì Steg 2</title>
  <meta name="description" content="Steg 2: V√§lj person ‚Üí koppla f√∂r√§lder ‚Üí se relationer f√∂r vald person (localStorage, GitHub Pages)." />

  <style>
    :root { color-scheme: light; }
    body{
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      line-height: 1.5;
      margin: 0;
      padding: 24px;
      max-width: 980px;
      margin-inline: auto;
      background: #fff;
      color: #111;
    }
    a{ color: inherit; text-decoration:none; }
    header{ margin-bottom: 16px; }
    h1{ margin: 0 0 6px; font-size: 1.6rem; }
    .muted{ color:#555; margin: 0 0 12px; }

    .topbar{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      margin: 10px 0 16px;
    }
    .btn, button{
      display:inline-block;
      padding:10px 12px;
      border:1px solid #333;
      border-radius:10px;
      background:#fff;
      font:inherit;
      cursor:pointer;
      text-decoration:none;
    }
    .btn.secondary{ border-color:#bbb; }
    .btn.danger{ border-color:#b00020; color:#b00020; }
    .btn.disabled{ opacity:.45; cursor:not-allowed; pointer-events:none; }

    .grid{
      display:grid;
      gap:14px;
      grid-template-columns: 1fr;
    }
    @media (min-width: 900px){
      .grid{ grid-template-columns: 1fr 1fr; }
    }

    .card{
      border:1px solid #ddd;
      border-radius:12px;
      padding:16px;
      background:#fff;
    }
    .card h2{ margin:0 0 6px; font-size:1.15rem; }
    .small{ font-size:.95rem; color:#555; margin:0 0 10px; }

    label{ display:block; margin:10px 0 6px; font-weight:800; }
    select{
      width:100%;
      box-sizing:border-box;
      padding:10px;
      border-radius:10px;
      border:1px solid #bbb;
      font:inherit;
      background:#fff;
    }

    .actions{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      margin-top: 12px;
    }

    .msg{ margin-top: 10px; }
    .error{ color:#b00020; font-weight:900; }
    .ok{ font-weight:900; }

    .focusBox{
      border:1px solid #eee;
      border-radius:12px;
      padding:10px 12px;
      background:#fafafa;
      margin-top: 10px;
    }
    .focusTitle{ font-weight:900; margin:0 0 4px; }
    .focusMeta{ margin:0; color:#444; }

    .list{
      margin: 10px 0 0;
      padding: 0;
      list-style:none;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .item{
      border:1px solid #eee;
      border-radius:12px;
      padding:10px;
      background:#fff;
      display:flex;
      justify-content:space-between;
      gap:12px;
      align-items:flex-start;
    }
    .itemMain{ min-width: 0; }
    .itemTitle{ font-weight:900; margin:0 0 2px; }
    .itemMeta{ margin:0; color:#555; font-size:.95rem; }
    .miniBtn{
      padding:8px 10px;
      border-radius:10px;
      border:1px solid #b00020;
      color:#b00020;
      background:#fff;
      cursor:pointer;
      white-space:nowrap;
    }
    code{ background:#f4f4f4; padding:2px 6px; border-radius:6px; }
  </style>
</head>

<body>
<header>
  <h1>üîó Relationer</h1>
  <p class="muted">Steg 2 i fl√∂det: <strong>V√§lj person</strong> ‚Üí <strong>L√§gg till f√∂r√§lder</strong> ‚Üí <strong>Se relationer</strong>.</p>

  <nav class="topbar" aria-label="Navigation">
    <a class="btn secondary" href="../start.html">Start</a>
    <a class="btn secondary" href="./trees.html">Tr√§d</a>
    <a class="btn secondary" href="./slaktkort.html">üë§ Personer</a>
    <a class="btn" href="./create-relation.html">üîó Relationer</a>
    <a class="btn secondary" href="./map.html">üó∫Ô∏è Karta</a>
    <a class="btn secondary" href="./place-picker.html">Plats-picker</a>
    <button id="logoutBtn" class="btn secondary" type="button">Logga ut</button>
  </nav>
</header>

<section class="grid" aria-label="Relationer steg f√∂r steg">
  <!-- 1) V√§lj fokusperson -->
  <article class="card">
    <h2>1) V√§lj person</h2>
    <p class="small">Den h√§r personen √§r ‚Äúfokus‚Äù. Du l√§gger till f√∂r√§lder till fokuspersonen.</p>

    <label for="focusSelect">Person *</label>
    <select id="focusSelect" required>
      <option value="">V√§lj‚Ä¶</option>
    </select>

    <div class="actions">
      <a class="btn secondary" href="./slaktkort.html">Skapa person</a>
      <button id="reloadBtn" class="btn secondary" type="button">Ladda om</button>
    </div>

    <div id="focusBox" class="focusBox" hidden>
      <p class="focusTitle" id="focusName">‚Äî</p>
      <p class="focusMeta" id="focusMeta">‚Äî</p>
    </div>

    <p id="step1Msg" class="msg muted" aria-live="polite"></p>
  </article>

  <!-- 2) L√§gg till f√∂r√§lder -->
  <article class="card">
    <h2>2) L√§gg till f√∂r√§lder</h2>
    <p class="small">V√§lj en f√∂r√§lder som kopplas till fokuspersonen. Max <strong>2</strong> f√∂r√§ldrar per barn.</p>

    <label for="parentSelect">F√∂r√§lder *</label>
    <select id="parentSelect" required>
      <option value="">V√§lj‚Ä¶</option>
    </select>

    <div class="actions">
      <button id="addParentBtn" class="btn" type="button">Spara koppling</button>
      <button id="resetBtn" class="btn secondary" type="button">Rensa val</button>
    </div>

    <p id="step2Msg" class="msg muted" aria-live="polite"></p>

    <div class="actions" style="margin-top:14px;">
      <a id="goMap" class="btn secondary disabled" href="./map.html" aria-disabled="true" tabindex="-1">Forts√§tt ‚Üí Karta</a>
    </div>
  </article>

  <!-- 3) Visa relationer f√∂r vald person -->
  <article class="card" style="grid-column: 1 / -1;">
    <h2>3) Relationer f√∂r vald person</h2>
    <p class="small">H√§r ser du f√∂r√§ldrar och barn f√∂r fokuspersonen. Du kan √§ven ta bort kopplingar.</p>

    <div class="grid" style="grid-template-columns: 1fr; gap:14px;">
      <div class="card" style="border-color:#eee;">
        <h3 style="margin:0 0 6px;">F√∂r√§ldrar</h3>
        <p class="small" id="parentsLine">‚Äî</p>
        <ul id="parentsList" class="list"></ul>
      </div>

      <div class="card" style="border-color:#eee;">
        <h3 style="margin:0 0 6px;">Barn</h3>
        <p class="small" id="childrenLine">‚Äî</p>
        <ul id="childrenList" class="list"></ul>
      </div>
    </div>

    <div class="actions" style="margin-top:14px;">
      <a class="btn secondary" href="./slaktkort.html">‚Üê Tillbaka (Personer)</a>
      <a class="btn secondary" href="./map.html">G√• till (Karta)</a>
    </div>

    <p class="small" style="margin-top:10px;">
      Data sparas i <code>localStorage</code> per tr√§d: <code>slakttradet_relationer_&lt;treeId&gt;</code>.
    </p>
  </article>
</section>

<script>
  // ============================
  // Estetisk auth-guard
  // ============================
  (function authGuard(){
    try{
      if(sessionStorage.getItem("demo_auth") !== "1"){
        window.location.href = "../index.html";
      }
    }catch{}
  })();

  // ============================
  // Keys (M√ÖSTE matcha √∂vriga sidor)
  // ============================
  const KEY_TREES  = "slakttradet_trees";
  const KEY_ACTIVE = "slakttradet_active_tree_id";
  const cardsKey = (treeId) => "slakttradet_slaktkort_" + String(treeId);
  const relKey   = (treeId) => "slakttradet_relationer_" + String(treeId);

  // ============================
  // DOM
  // ============================
  const logoutBtn = document.getElementById("logoutBtn");

  const focusSelect = document.getElementById("focusSelect");
  const parentSelect = document.getElementById("parentSelect");

  const reloadBtn = document.getElementById("reloadBtn");
  const addParentBtn = document.getElementById("addParentBtn");
  const resetBtn = document.getElementById("resetBtn");

  const step1Msg = document.getElementById("step1Msg");
  const step2Msg = document.getElementById("step2Msg");

  const focusBox = document.getElementById("focusBox");
  const focusName = document.getElementById("focusName");
  const focusMeta = document.getElementById("focusMeta");

  const parentsLine = document.getElementById("parentsLine");
  const childrenLine = document.getElementById("childrenLine");
  const parentsList = document.getElementById("parentsList");
  const childrenList = document.getElementById("childrenList");

  const goMap = document.getElementById("goMap");

  // ============================
  // Helpers
  // ============================
  function safeParse(raw, fallback){ try{ return JSON.parse(raw); }catch{ return fallback; } }
  function loadJson(key, fallback){
    const raw = localStorage.getItem(key);
    return raw ? safeParse(raw, fallback) : fallback;
  }
  function saveJson(key, value){
    localStorage.setItem(key, JSON.stringify(value));
  }

  function setMsg(el, type, text){
    el.innerHTML = type === "error"
      ? "<span class='error'>" + escapeHtml(text) + "</span>"
      : type === "ok"
        ? "<span class='ok'>" + escapeHtml(text) + "</span>"
        : escapeHtml(text || "");
  }

  function escapeHtml(s){
    return String(s || "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function activeTreeId(){ return localStorage.getItem(KEY_ACTIVE) || ""; }
  function hasTrees(){ return Array.isArray(loadJson(KEY_TREES, [])) && loadJson(KEY_TREES, []).length > 0; }

  function loadCards(treeId){
    const arr = loadJson(cardsKey(treeId), []);
    return Array.isArray(arr) ? arr : [];
  }
  function loadRels(treeId){
    const arr = loadJson(relKey(treeId), []);
    return Array.isArray(arr) ? arr : [];
  }

  function personName(p){
    const n = `${p.fornamn || ""} ${p.efternamn || ""}`.trim();
    return n || "(namnl√∂s)";
  }

  function metaLine(p){
    const years = [p.fodelsear, p.dodsar].filter(v => v !== null && v !== undefined && v !== "").join("‚Äì");
    const place = String(p.plats || "").trim();
    const parts = [];
    if(years) parts.push(years);
    if(place) parts.push(place);
    return parts.length ? parts.join(" ¬∑ ") : "‚Äî";
  }

  function setDisabledLink(a, disabled){
    if(disabled){
      a.classList.add("disabled");
      a.setAttribute("aria-disabled","true");
      a.setAttribute("tabindex","-1");
    }else{
      a.classList.remove("disabled");
      a.removeAttribute("aria-disabled");
      a.removeAttribute("tabindex");
    }
  }

  // ============================
  // Domain logic
  // ============================
  function parentsOfChild(rels, childId){
    return rels
      .filter(r => r && r.typ === "FORALDER_BARN" && String(r.tillPersonId) === String(childId))
      .map(r => String(r.franPersonId));
  }

  function childrenOfParent(rels, parentId){
    return rels
      .filter(r => r && r.typ === "FORALDER_BARN" && String(r.franPersonId) === String(parentId))
      .map(r => String(r.tillPersonId));
  }

  function hasParentLink(rels, parentId, childId){
    return rels.some(r =>
      r &&
      r.typ === "FORALDER_BARN" &&
      String(r.franPersonId) === String(parentId) &&
      String(r.tillPersonId) === String(childId)
    );
  }

  function makeRelId(){
    return "r" + Date.now().toString(36) + Math.random().toString(36).slice(2, 6);
  }

  // ============================
  // UI render
  // ============================
  function fillSelects(){
    const t = activeTreeId();
    focusSelect.innerHTML = "<option value=''>V√§lj‚Ä¶</option>";
    parentSelect.innerHTML = "<option value=''>V√§lj‚Ä¶</option>";

    if(!hasTrees()){
      setMsg(step1Msg, "error", "Inga tr√§d finns. Skapa ett tr√§d f√∂rst (Tr√§d).");
      setMsg(step2Msg, "", "");
      setDisabledLink(goMap, true);
      focusBox.hidden = true;
      parentsList.innerHTML = "";
      childrenList.innerHTML = "";
      parentsLine.textContent = "‚Äî";
      childrenLine.textContent = "‚Äî";
      return;
    }

    if(!t){
      setMsg(step1Msg, "error", "Inget aktivt tr√§d valt. G√• till Tr√§d och v√§lj ett aktivt tr√§d.");
      setMsg(step2Msg, "", "");
      setDisabledLink(goMap, true);
      focusBox.hidden = true;
      parentsList.innerHTML = "";
      childrenList.innerHTML = "";
      parentsLine.textContent = "‚Äî";
      childrenLine.textContent = "‚Äî";
      return;
    }

    const cards = loadCards(t);
    if(cards.length === 0){
      setMsg(step1Msg, "error", "Inga personer i aktivt tr√§d. Skapa personer f√∂rst.");
      setMsg(step2Msg, "", "");
      setDisabledLink(goMap, true);
      focusBox.hidden = true;
      parentsList.innerHTML = "";
      childrenList.innerHTML = "";
      parentsLine.textContent = "‚Äî";
      childrenLine.textContent = "‚Äî";
      return;
    }

    // Fyll fokus + parent med samma lista
    for(const p of cards){
      if(!p || !p.id) continue;
      const opt1 = document.createElement("option");
      opt1.value = String(p.id);
      opt1.textContent = personName(p);
      focusSelect.appendChild(opt1);

      const opt2 = document.createElement("option");
      opt2.value = String(p.id);
      opt2.textContent = personName(p);
      parentSelect.appendChild(opt2);
    }

    // Auto-v√§lj f√∂rsta person om inget valt
    if(!focusSelect.value && focusSelect.options.length > 1){
      focusSelect.selectedIndex = 1;
    }

    setMsg(step1Msg, "ok", "Personer laddade.");
    renderFocus();
  }

  function renderFocus(){
    const t = activeTreeId();
    if(!t) return;

    const cards = loadCards(t);
    const rels = loadRels(t);

    const focusId = focusSelect.value;
    if(!focusId){
      focusBox.hidden = true;
      setMsg(step2Msg, "", "V√§lj en person f√∂rst.");
      parentsList.innerHTML = "";
      childrenList.innerHTML = "";
      parentsLine.textContent = "‚Äî";
      childrenLine.textContent = "‚Äî";
      setDisabledLink(goMap, true);
      return;
    }

    const focus = cards.find(p => String(p.id) === String(focusId));
    focusBox.hidden = false;
    focusName.textContent = focus ? personName(focus) : "(ok√§nd)";
    focusMeta.textContent = focus ? metaLine(focus) : "‚Äî";

    // I alternativ A: fokuspersonen √§r "barnet" i kopplingar n√§r du l√§gger till f√∂r√§lder
    // Filtrera f√∂r√§ldralista s√• att samma person inte kan vara sin egen f√∂r√§lder
    // och s√• att "Redan kopplad" inte blir ett vanligt misstag
    const existingParents = new Set(parentsOfChild(rels, focusId));

    // rebuild parentSelect (f√∂r att kunna markera/filtrera)
    const currentParent = parentSelect.value;
    parentSelect.innerHTML = "<option value=''>V√§lj‚Ä¶</option>";

    for(const p of cards){
      if(!p || !p.id) continue;
      const pid = String(p.id);

      if(pid === String(focusId)) continue; // f√•r inte vara sin egen f√∂r√§lder

      const opt = document.createElement("option");
      opt.value = pid;
      opt.textContent = personName(p) + (existingParents.has(pid) ? " (redan)" : "");
      parentSelect.appendChild(opt);
    }

    // beh√•ll val om m√∂jligt
    if(currentParent){
      parentSelect.value = currentParent;
      if(parentSelect.value !== currentParent) parentSelect.value = "";
    }

    // Render relationer f√∂r fokus
    renderRelationsForFocus(cards, rels, focusId);

    // Enable "forts√§tt till karta" om det finns minst 1 person med coords (du kan √§nd√• se karta)
    const hasAnyCoords = cards.some(p => p && p.coords && (typeof p.coords === "object" || typeof p.coords === "string"));
    setDisabledLink(goMap, !hasAnyCoords);
  }

  function renderRelationsForFocus(cards, rels, focusId){
    parentsList.innerHTML = "";
    childrenList.innerHTML = "";

    const parentIds = parentsOfChild(rels, focusId);
    const childIds  = childrenOfParent(rels, focusId);

    parentsLine.textContent = parentIds.length ? (parentIds.length + " st") : "Inga f√∂r√§ldrar kopplade.";
    childrenLine.textContent = childIds.length ? (childIds.length + " st") : "Inga barn kopplade.";

    // F√∂r√§ldrar
    if(parentIds.length){
      for(const pid of parentIds){
        const p = cards.find(x => String(x.id) === String(pid));
        const li = document.createElement("li");
        li.className = "item";
        li.innerHTML =
          "<div class='itemMain'>" +
            "<p class='itemTitle'>" + escapeHtml(p ? personName(p) : "(ok√§nd)") + "</p>" +
            "<p class='itemMeta'>F√∂r√§lder</p>" +
          "</div>" +
          "<button class='miniBtn' type='button' data-remove='parent' data-parent='" + escapeHtml(pid) + "'>Ta bort</button>";
        parentsList.appendChild(li);
      }
    }

    // Barn
    if(childIds.length){
      for(const cid of childIds){
        const c = cards.find(x => String(x.id) === String(cid));
        const li = document.createElement("li");
        li.className = "item";
        li.innerHTML =
          "<div class='itemMain'>" +
            "<p class='itemTitle'>" + escapeHtml(c ? personName(c) : "(ok√§nd)") + "</p>" +
            "<p class='itemMeta'>Barn</p>" +
          "</div>" +
          "<button class='miniBtn' type='button' data-remove='child' data-child='" + escapeHtml(cid) + "'>Ta bort</button>";
        childrenList.appendChild(li);
      }
    }

    // Handlers: ta bort relation
    parentsList.querySelectorAll("button[data-remove='parent']").forEach(btn => {
      btn.addEventListener("click", () => {
        const t = activeTreeId();
        if(!t) return;
        const parentId = btn.getAttribute("data-parent");
        const relsNow = loadRels(t).filter(r =>
          !(r && r.typ === "FORALDER_BARN" && String(r.franPersonId) === String(parentId) && String(r.tillPersonId) === String(focusId))
        );
        saveJson(relKey(t), relsNow);
        setMsg(step2Msg, "ok", "Koppling borttagen.");
        renderFocus();
      });
    });

    childrenList.querySelectorAll("button[data-remove='child']").forEach(btn => {
      btn.addEventListener("click", () => {
        const t = activeTreeId();
        if(!t) return;
        const childId = btn.getAttribute("data-child");
        const relsNow = loadRels(t).filter(r =>
          !(r && r.typ === "FORALDER_BARN" && String(r.franPersonId) === String(focusId) && String(r.tillPersonId) === String(childId))
        );
        saveJson(relKey(t), relsNow);
        setMsg(step2Msg, "ok", "Koppling borttagen.");
        renderFocus();
      });
    });
  }

  function addParent(){
    const t = activeTreeId();
    if(!t) return setMsg(step2Msg, "error", "Inget aktivt tr√§d.");

    const focusId = focusSelect.value;
    const parentId = parentSelect.value;

    if(!focusId) return setMsg(step2Msg, "error", "V√§lj person f√∂rst (Steg 1).");
    if(!parentId) return setMsg(step2Msg, "error", "V√§lj f√∂r√§lder f√∂rst.");
    if(String(parentId) === String(focusId)) return setMsg(step2Msg, "error", "En person kan inte vara sin egen f√∂r√§lder.");

    const rels = loadRels(t);
    const currentParents = parentsOfChild(rels, focusId);

    if(currentParents.includes(String(parentId))){
      return setMsg(step2Msg, "error", "Redan kopplad som f√∂r√§lder.");
    }
    if(currentParents.length >= 2){
      return setMsg(step2Msg, "error", "Barnet har redan 2 f√∂r√§ldrar.");
    }

    rels.push({
      id: makeRelId(),
      typ: "FORALDER_BARN",
      franPersonId: String(parentId),
      tillPersonId: String(focusId),
      createdAt: new Date().toISOString()
    });

    saveJson(relKey(t), rels);
    setMsg(step2Msg, "ok", "Koppling sparad.");
    parentSelect.value = "";
    renderFocus();
  }

  // ============================
  // Events
  // ============================
  logoutBtn.addEventListener("click", () => {
    try{ sessionStorage.removeItem("demo_auth"); }catch{}
    window.location.href = "../index.html";
  });

  reloadBtn.addEventListener("click", () => {
    setMsg(step1Msg, "", "Laddar om‚Ä¶");
    fillSelects();
  });

  focusSelect.addEventListener("change", () => {
    setMsg(step2Msg, "", "");
    renderFocus();
  });

  addParentBtn.addEventListener("click", addParent);

  resetBtn.addEventListener("click", () => {
    parentSelect.value = "";
    setMsg(step2Msg, "", "");
  });

  // ============================
  // Start
  // ============================
  fillSelects();
</script>
</body>
</html>
