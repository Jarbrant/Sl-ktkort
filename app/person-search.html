<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sök historisk person – Släktkort</title>
  <meta name="description" content="Sök efter historiska personer (Riksarkivet när möjligt, annars demo) och skicka kandidater till Person puzzle." />

  <style>
    :root{ color-scheme: light; }
    body{
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      line-height: 1.5;
      margin: 0;
      padding: 24px;
      max-width: 1180px;
      margin-inline: auto;
      background: #fff;
      color: #111;
    }
    a{ color: inherit; text-decoration: none; }
    header{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      margin-bottom:18px;
    }
    .topbar{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      margin: 10px 0 0;
    }
    .btn, button{
      display:inline-block;
      padding:10px 12px;
      border:1px solid #333;
      border-radius:10px;
      background:#fff;
      font:inherit;
      cursor:pointer;
      text-decoration:none;
      user-select:none;
    }
    .btn.secondary{ border-color:#bbb; background:#fafafa; }
    .btn.primary{ background:#111; color:#fff; border-color:#111; }
    .btn:disabled, button:disabled{ opacity:.55; cursor:not-allowed; }
    .spacer{ flex:1 1 auto; }

    h1{ margin:0 0 6px; font-size: 28px; }
    .muted{ color:#555; margin:0; }

    .pillRow{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      margin: 10px 0 18px;
    }
    .pill{
      display:inline-flex;
      gap:8px;
      align-items:center;
      padding:8px 10px;
      border:1px solid #ddd;
      border-radius:999px;
      background:#fafafa;
      font-size: .95rem;
    }
    .pill strong{ font-weight:900; }
    .pill.ok{ border-color:#cfe8cf; background:#f5fff5; }
    .pill.warn{ border-color:#ffe1a6; background:#fff9ee; }
    .pill.err{ border-color:#ffb3b3; background:#fff2f2; }

    .grid{
      display:grid;
      gap: 14px;
      grid-template-columns: 1fr;
    }
    @media (min-width: 980px){
      .grid{ grid-template-columns: 460px 1fr; }
    }

    .card{
      border:1px solid #e6e8eb;
      border-radius: 16px;
      padding: 14px;
      background:#fff;
      box-shadow: 0 1px 0 rgba(0,0,0,.03);
    }
    .card h2{ margin:0 0 6px; font-size: 18px; }
    .small{ margin:0 0 10px; color:#555; font-size: 13px; }

    label{ display:block; font-weight:800; margin: 10px 0 6px; }
    input{
      width:100%;
      box-sizing:border-box;
      padding: 10px;
      border-radius: 12px;
      border: 1px solid #bbb;
      font: inherit;
      background:#fff;
    }

    .actions{
      display:flex;
      flex-wrap:wrap;
      gap: 10px;
      align-items:center;
      margin-top: 12px;
    }

    .list{
      margin: 10px 0 0;
      padding: 0;
      list-style:none;
      display:flex;
      flex-direction:column;
      gap:10px;
      max-height: 560px;
      overflow:auto;
      border-top: 1px solid #eee;
      padding-top: 10px;
    }
    .item{
      border:1px solid #eee;
      border-radius: 14px;
      padding: 10px;
      background:#fff;
      cursor:pointer;
    }
    .item:hover{ background:#fafafa; }
    .itemTitle{ font-weight:900; margin:0 0 2px; }
    .itemMeta{ margin:0; color:#555; font-size: 13px; }

    .liftBox{
      border: 1px solid #e6e8eb;
      background: #fafafa;
      border-radius: 12px;
      padding: 10px 12px;
      font-size: 13px;
      color:#333;
    }
    .liftBox.ok{ border-color:#cfe8cf; background:#f5fff5; }
    .liftBox.warn{ border-color:#ffe1a6; background:#fff9ee; }
    .liftBox.err{ border-color:#ffb3b3; background:#fff2f2; }
    code{ background:#f4f4f4; padding:2px 6px; border-radius:6px; }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; }
  </style>

  <!-- RA provider-lager -->
  <script src="./assets/js/ra-providers.js"></script>
</head>

<body>
  <header style="display:block;">
    <h1>Sök historisk person</h1>
    <p class="muted">Sök via Riksarkivet när det går. Om webbläsaren blockerar (CORS/timeout) faller vi tillbaka till demo.</p>

    <nav class="topbar" aria-label="Huvudmeny">
      <a class="btn secondary" href="../start.html">Start</a>
      <a class="btn secondary" href="./trees.html">Träd</a>
      <a class="btn secondary" href="./slaktkort.html">Personer</a>
      <a class="btn secondary" href="./create-relation.html">Relationer</a>
      <a class="btn secondary" href="./map.html">Karta</a>
      <span class="spacer"></span>
      <button class="btn secondary" id="logoutBtn" type="button">Logga ut</button>
    </nav>
  </header>

  <section class="pillRow" aria-label="Status">
    <span id="pillTree" class="pill warn">Aktivt träd: <strong>—</strong></span>
    <span id="pillResults" class="pill">Träffar: <strong>0</strong></span>
    <span id="pillMode" class="pill">Källa: <strong>—</strong></span>
  </section>

  <div class="grid">
    <section class="card" aria-label="Sök">
      <h2>Sök</h2>
      <p class="small">
        Sök på namn (minsta input). Fler frågor/poäng sker i <span class="mono">person-puzzle.html</span>.
      </p>

      <div id="topMsg" class="liftBox warn" hidden></div>

      <label for="q">Sökterm</label>
      <input id="q" placeholder="t.ex. Karl Johansson" autocomplete="off" />

      <div class="actions">
        <button class="btn primary" id="searchBtn" type="button">Sök</button>
        <button class="btn secondary" id="clearBtn" type="button">Rensa</button>
        <button class="btn secondary" id="backBtn" type="button">Tillbaka</button>
      </div>

      <div class="liftBox" style="margin-top:10px;">
        <strong>Policy</strong><br/>
        Inga externa persondata sparas automatiskt. Kandidater skickas till Puzzle via <code>sessionStorage</code> (tillfälligt).<br/>
        Import skapar först då en intern personpost i aktivt träd (localStorage).
      </div>

      <ul id="results" class="list" aria-label="Sökresultat"></ul>
    </section>

    <section class="card" aria-label="Förhandsvisning och nästa steg">
      <h2>Förhandsvisning</h2>
      <p class="small">Klicka en träff för preview. Nästa steg: öppna i Puzzle och ringa in rätt person.</p>

      <div id="previewBox" class="liftBox" aria-live="polite">
        Välj en träff för att se detaljer här.
      </div>

      <div class="actions">
        <button class="btn primary" id="puzzleBtn" type="button" disabled>Öppna i Puzzle</button>
        <button class="btn secondary" id="copyBtn" type="button" disabled>Kopiera som text</button>
      </div>

      <div class="liftBox" style="margin-top:10px;">
        <strong>Teknik</strong><br/>
        Provider-pipeline: <code>searchapi</code> → fallback <code>demo</code> vid fel (CORS/timeout) eller 0 träffar.<br/>
        Feature flag ligger i kod (inte storage).
      </div>
    </section>
  </div>

  <script>
    "use strict";

    // ==========================================================
    // FEATURE FLAGS (LÅST: inte i storage)
    // - "auto" => försök searchapi först, fallback demo
    // - "demo" => tvinga demo
    // - "searchapi" => tvinga searchapi (men fallback i UI om fel)
    // ==========================================================
    const FEATURE_PROVIDER = "auto";
    const FEATURE_ALLOW_NETWORK = true; // sätt false om du vill tvinga offline

    // Session keys (inte core localStorage-keys/datamodell)
    const SS_CANDIDATES = "ra_session_candidates_v1";
    const SS_CONTEXT    = "ra_session_context_v1";

    (function authGuard(){
      try{
        if(sessionStorage.getItem("demo_auth") !== "1"){
          window.location.href = "../index.html";
        }
      }catch{}
    })();

    const KEY_TREES  = "slakttradet_trees";
    const KEY_ACTIVE = "slakttradet_active_tree_id";

    const logoutBtn = document.getElementById("logoutBtn");

    const pillTree = document.getElementById("pillTree");
    const pillResults = document.getElementById("pillResults");
    const pillMode = document.getElementById("pillMode");

    const qEl = document.getElementById("q");
    const searchBtn = document.getElementById("searchBtn");
    const clearBtn = document.getElementById("clearBtn");
    const backBtn = document.getElementById("backBtn");

    const topMsg = document.getElementById("topMsg");
    const resultsEl = document.getElementById("results");

    const previewBox = document.getElementById("previewBox");
    const puzzleBtn = document.getElementById("puzzleBtn");
    const copyBtn = document.getElementById("copyBtn");

    function safeParse(raw, fallback){
      try{ return JSON.parse(raw); }catch{ return fallback; }
    }
    function loadJson(key, fallback){
      const raw = localStorage.getItem(key);
      return raw ? safeParse(raw, fallback) : fallback;
    }

    function escapeHtml(s){
      return String(s || "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function activeTreeId(){
      return localStorage.getItem(KEY_ACTIVE) || "";
    }
    function getTrees(){
      const arr = loadJson(KEY_TREES, []);
      return Array.isArray(arr) ? arr : [];
    }
    function activeTreeLabel(){
      const id = activeTreeId();
      if(!id) return "—";
      const t = getTrees().find(x => String(x.id) === String(id));
      return t ? (t.name || t.id) : id;
    }

    function refreshPills(resultCount, providerLabel){
      const t = activeTreeId();
      const trees = getTrees();
      const hasTrees = trees.length > 0;
      const hasActive = !!t;

      pillTree.className = "pill " + (hasActive ? "ok" : (hasTrees ? "warn" : "err"));
      pillTree.innerHTML = "Aktivt träd: <strong>" + escapeHtml(hasActive ? activeTreeLabel() : "—") + "</strong>";

      pillResults.innerHTML = "Träffar: <strong>" + String(resultCount || 0) + "</strong>";
      pillMode.innerHTML = "Källa: <strong>" + escapeHtml(providerLabel || "—") + "</strong>";
    }

    function showTopMsg(kind, text){
      topMsg.hidden = false;
      topMsg.className = "liftBox " + (kind || "warn");
      topMsg.innerHTML = escapeHtml(text);
    }
    function clearTopMsg(){
      topMsg.hidden = true;
      topMsg.innerHTML = "";
      topMsg.className = "liftBox";
    }

    function yearsText(c){
      const b = (c && c.birthYear != null) ? String(c.birthYear) : "—";
      const d = (c && c.deathYear != null) ? String(c.deathYear) : "—";
      if(b === "—" && d === "—") return "";
      return " (" + b + "–" + d + ")";
    }

    function candidateTitle(c){
      return (c && c.name ? String(c.name) : "(namn saknas)") + yearsText(c);
    }

    // ----------------------------------------------------------
    // Provider pipeline
    // ----------------------------------------------------------
    const primaryProvider = (window.RAProviders && window.RAProviders.pickProvider)
      ? window.RAProviders.pickProvider({ preferred: FEATURE_PROVIDER, allowNetwork: FEATURE_ALLOW_NETWORK })
      : null;

    const demoProvider = (window.RAProviders && window.RAProviders.getProvider)
      ? window.RAProviders.getProvider("demo")
      : null;

    let selected = null;
    let lastCandidates = [];
    let lastProviderId = primaryProvider ? primaryProvider.id : "demo";
    let lastProviderLabel = primaryProvider ? primaryProvider.label : "Demo";

    function setPreview(c){
      selected = c || null;

      if(!selected){
        previewBox.className = "liftBox";
        previewBox.innerHTML = "Välj en träff för att se detaljer här.";
        puzzleBtn.disabled = true;
        copyBtn.disabled = true;
        return;
      }

      previewBox.className = "liftBox ok";
      previewBox.innerHTML =
        "<div><strong>" + escapeHtml(candidateTitle(selected)) + "</strong></div>" +
        "<div class='small' style='margin-top:6px;'>" +
          "Plats: <span class='mono'>" + escapeHtml(selected.place || "—") + "</span><br/>" +
          "Källa: <span class='mono'>" + escapeHtml(selected.source || "—") + "</span><br/>" +
          (selected.url ? ("URL: <span class='mono'>" + escapeHtml(selected.url) + "</span><br/>") : "") +
          (Array.isArray(selected.why) && selected.why.length ? ("Varför: <span class='mono'>" + escapeHtml(selected.why.join(" · ")) + "</span>") : "") +
        "</div>";

      puzzleBtn.disabled = false;
      copyBtn.disabled = false;
    }

    function renderResults(arr){
      resultsEl.innerHTML = "";
      const list = Array.isArray(arr) ? arr : [];

      if(list.length === 0){
        const li = document.createElement("li");
        li.className = "item";
        li.style.cursor = "default";
        li.innerHTML =
          "<p class='itemTitle'>Inga träffar</p>" +
          "<p class='itemMeta'>Prova ett annat namn eller kortare sökterm.</p>";
        resultsEl.appendChild(li);
        setPreview(null);
        return;
      }

      for(const c of list){
        const li = document.createElement("li");
        li.className = "item";
        li.innerHTML =
          "<p class='itemTitle'>" + escapeHtml(candidateTitle(c)) + "</p>" +
          "<p class='itemMeta'>" +
            (c.place ? ("Plats: " + escapeHtml(c.place)) : "Plats: —") +
            (c.source ? (" · Källa: " + escapeHtml(c.source)) : "") +
          "</p>";
        li.addEventListener("click", () => setPreview(c));
        resultsEl.appendChild(li);
      }

      setPreview(null);
    }

    async function doSearch(){
      clearTopMsg();

      const t = activeTreeId();
      if(!t){
        showTopMsg("err", "⛔ Inget aktivt träd. Gå till Träd och välj ett aktivt träd innan du kan importera.");
        renderResults([]);
        refreshPills(0, lastProviderLabel);
        return;
      }

      const q = String(qEl.value || "").trim();
      if(!q || q.length < 2){
        showTopMsg("warn", "⚠️ Skriv minst 2 tecken för att söka.");
        renderResults([]);
        refreshPills(0, lastProviderLabel);
        return;
      }

      if(!primaryProvider){
        showTopMsg("err", "⛔ Provider-lagret saknas (RAProviders). Kontrollera att ./assets/js/ra-providers.js laddas.");
        renderResults([]);
        refreshPills(0, "—");
        return;
      }

      searchBtn.disabled = true;

      try{
        // 1) Försök primär provider
        lastProviderId = primaryProvider.id;
        lastProviderLabel = primaryProvider.label;

        let candidates = await primaryProvider.search(q);

        // 2) Om 0 träffar => demo fallback (för att aldrig bli tomt)
        if((!candidates || candidates.length === 0) && demoProvider){
          candidates = await demoProvider.search(q);
          lastProviderId = demoProvider.id;
          lastProviderLabel = demoProvider.label + " (fallback: 0 träffar i primär)";
        }

        lastCandidates = Array.isArray(candidates) ? candidates : [];
        renderResults(lastCandidates);
        refreshPills(lastCandidates.length, lastProviderLabel);

        if(lastCandidates.length === 0){
          showTopMsg("warn", "⚠️ Inga träffar. Prova ett annat namn.");
        }else{
          showTopMsg("ok", "✅ Klar. Nästa steg: välj en kandidat och öppna i Puzzle.");
        }

      }catch(e){
        // 3) Vid fel (CORS/timeout): fail-closed → demo fallback
        const msg = String(e && e.message ? e.message : e);

        if(demoProvider){
          try{
            const candidates = await demoProvider.search(q);
            lastCandidates = Array.isArray(candidates) ? candidates : [];
            lastProviderId = demoProvider.id;
            lastProviderLabel = demoProvider.label + " (fallback: " + (msg || "fel") + ")";
            renderResults(lastCandidates);
            refreshPills(lastCandidates.length, lastProviderLabel);

            showTopMsg("warn", "⚠️ Kunde inte nå Riksarkivet (CORS/timeout). Kör demo-fallback.");
          }catch{
            lastCandidates = [];
            renderResults([]);
            refreshPills(0, "—");
            showTopMsg("err", "⛔ Sök misslyckades och fallback misslyckades. (fail-closed)");
          }
        }else{
          lastCandidates = [];
          renderResults([]);
          refreshPills(0, "—");
          showTopMsg("err", "⛔ Sök misslyckades. (fail-closed)");
        }
      }finally{
        searchBtn.disabled = false;
      }
    }

    function writePuzzleSession(){
      // POLICY: session-only, rensas i puzzle fail-closed.
      try{
        sessionStorage.setItem(SS_CANDIDATES, JSON.stringify(lastCandidates || []));
        sessionStorage.setItem(SS_CONTEXT, JSON.stringify({
          q: String(qEl.value || "").trim(),
          providerId: lastProviderId,
          providerLabel: lastProviderLabel,
          selectedId: selected ? String(selected.id) : ""
        }));
      }catch{
        showTopMsg("err", "⛔ Kunde inte förbereda Puzzle-session (webbläsaren blockerade lagring).");
        return false;
      }
      return true;
    }

    function openPuzzle(){
      clearTopMsg();
      if(!selected){
        showTopMsg("warn", "⚠️ Välj en träff först.");
        return;
      }
      if(!Array.isArray(lastCandidates) || lastCandidates.length === 0){
        showTopMsg("warn", "⚠️ Inga kandidater att skicka till Puzzle.");
        return;
      }
      if(!writePuzzleSession()) return;

      window.location.href = "./person-puzzle.html";
    }

    async function copySelected(){
      if(!selected) return;

      const b = (selected.birthYear != null) ? String(selected.birthYear) : "—";
      const d = (selected.deathYear != null) ? String(selected.deathYear) : "—";

      const text =
        (selected.name || "—") + "\n" +
        "Födelseår: " + b + " · Dödsår: " + d + "\n" +
        "Plats: " + (selected.place || "—") + "\n" +
        "Källa: " + (selected.source || "—") + "\n" +
        (selected.url ? ("URL: " + selected.url + "\n") : "") +
        (Array.isArray(selected.why) && selected.why.length ? ("Varför: " + selected.why.join(" · ") + "\n") : "");

      try{
        await navigator.clipboard.writeText(text);
        showTopMsg("ok", "✅ Kopierat till urklipp.");
      }catch{
        showTopMsg("warn", "⚠️ Kunde inte kopiera (webbläsaren blockerade).");
      }
    }

    function goBack(){ window.location.href = "./slaktkort.html"; }

    // Events
    logoutBtn.addEventListener("click", () => {
      try{ sessionStorage.removeItem("demo_auth"); }catch{}
      window.location.href = "../index.html";
    });

    searchBtn.addEventListener("click", doSearch);
    clearBtn.addEventListener("click", () => {
      qEl.value = "";
      resultsEl.innerHTML = "";
      setPreview(null);
      clearTopMsg();
      refreshPills(0, lastProviderLabel);
      try{ qEl.focus(); }catch{}
    });
    backBtn.addEventListener("click", goBack);

    puzzleBtn.addEventListener("click", openPuzzle);
    copyBtn.addEventListener("click", copySelected);

    qEl.addEventListener("keydown", (e) => {
      if(e.key === "Enter"){
        e.preventDefault();
        doSearch();
      }
    });

    // Init
    refreshPills(0, primaryProvider ? primaryProvider.label : "—");
    renderResults([]);
    showTopMsg("warn", "ℹ️ Skriv ett namn och sök. Om Riksarkivet blockeras i webbläsaren faller sidan tillbaka till demo.");
    try{ qEl.focus(); }catch{}
  </script>
</body>
</html>
