<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sök historisk person – Släktkort</title>
  <meta name="description" content="Sök historiska personer via öppna källor och öppna kandidatpool i Puzzle (in-memory, ingen lagring)." />

  <style>
    :root{ color-scheme: light; }
    body{
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      line-height: 1.5;
      margin: 0;
      padding: 24px;
      max-width: 980px;
      margin-inline: auto;
      background: #fff;
      color: #111;
    }
    a{ color: inherit; text-decoration:none; }
    header{ margin-bottom:18px; }
    h1{ margin:0 0 6px; font-size: 26px; }
    .muted{ color:#555; margin:0; }

    .row{ display:flex; gap:10px; margin-top:12px; flex-wrap:wrap; }
    input{
      flex:1;
      min-width: 240px;
      padding:10px;
      border-radius:12px;
      border:1px solid #bbb;
      font:inherit;
    }
    button{
      padding:10px 14px;
      border-radius:12px;
      border:1px solid #333;
      background:#111;
      color:#fff;
      font:inherit;
      cursor:pointer;
    }
    button.secondary{
      background:#fff;
      color:#111;
      border-color:#bbb;
    }
    button:disabled{ opacity:.55; cursor:not-allowed; }

    .badgeRow{
      margin-top:10px;
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      align-items:center;
      font-size:13px;
      color:#555;
    }
    .badge{
      display:inline-flex;
      gap:8px;
      align-items:center;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid #e6e8eb;
      background:#fafafa;
    }
    .badge.ok{ background:#f5fff5; border-color:#cfe8cf; }
    .badge.warn{ background:#fff9ee; border-color:#ffe1a6; }
    .badge.err{ background:#fff2f2; border-color:#ffb3b3; }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; }

    .list{
      margin-top:18px;
      list-style:none;
      padding:0;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .item{
      border:1px solid #eee;
      border-radius:14px;
      padding:12px;
      background:#fff;
    }
    .item h3{ margin:0 0 4px; font-size:16px; }
    .meta{ font-size:13px; color:#555; margin:2px 0; }
    .actions{ margin-top:8px; display:flex; gap:8px; flex-wrap:wrap; }

    .hint{
      margin-top:10px;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid #e6e8eb;
      background:#fafafa;
      font-size:13px;
      color:#333;
    }
  </style>
</head>

<body>
  <header>
    <h1>Sök historisk person</h1>
    <p class="muted">Sök i öppna källor och öppna kandidatpool i Puzzle (in-memory, ingen lagring).</p>

    <div class="badgeRow" aria-label="Status">
      <span class="badge" id="providerBadge">Källa: <strong id="providerName">—</strong></span>
      <span class="badge" id="countBadge">Träffar: <strong id="countNum">—</strong></span>
      <span class="badge warn" id="capBadge" hidden>Max 150 visas – förfina din sökning</span>
    </div>

    <div class="hint">
      Tips: använd <span class="mono">+</span> för tokens: <span class="mono">Erik+Leksand+1820</span>
    </div>
  </header>

  <div class="row">
    <input id="q" placeholder="t.ex. Erik+Leksand+1820" autocomplete="off" />
    <button id="searchBtn" type="button">Sök</button>
    <button id="openPoolBtn" class="secondary" type="button" disabled>Öppna Puzzle (pool)</button>
    <button id="clearBtn" class="secondary" type="button">Rensa</button>
  </div>

  <ul id="results" class="list" aria-label="Sökresultat"></ul>

  <!-- RA Providers -->
  <script src="./assets/js/ra-providers.js"></script>

  <script>
    "use strict";

    // =====================================================
    // DOM
    // =====================================================
    const qEl = document.getElementById("q");
    const searchBtn = document.getElementById("searchBtn");
    const openPoolBtn = document.getElementById("openPoolBtn");
    const clearBtn = document.getElementById("clearBtn");

    const resultsEl = document.getElementById("results");

    const providerNameEl = document.getElementById("providerName");
    const countNumEl = document.getElementById("countNum");
    const capBadge = document.getElementById("capBadge");

    // =====================================================
    // STATE (in-memory only)
    // =====================================================
    let lastCandidates = [];     // senaste sökresultat (Candidate[])
    let lastProviderId = "—";

    // =====================================================
    // Helpers
    // =====================================================
    function escapeHtml(s){
      return String(s || "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function normalize(s){ return String(s||"").trim().toLowerCase(); }

    function safeArray(v){ return Array.isArray(v) ? v : []; }

    function candidateYears(c){
      const by = Number.isFinite(Number(c.birthYear)) ? c.birthYear : "—";
      const dy = Number.isFinite(Number(c.deathYear)) ? c.deathYear : "—";
      if(by==="—" && dy==="—") return "";
      return " (" + by + "–" + dy + ")";
    }

    function setProvider(id){
      lastProviderId = id || "—";
      providerNameEl.textContent = lastProviderId;
    }

    function setCount(n){
      countNumEl.textContent = Number.isFinite(Number(n)) ? String(n) : "—";
    }

    function showCapWarning(show){
      capBadge.hidden = !show;
    }

    function showMessage(text, kind){
      resultsEl.innerHTML =
        "<li class='item'>" +
          "<div class='meta'>" + escapeHtml(text) + "</div>" +
        "</li>";
      setCount(kind === "empty" ? 0 : "—");
    }

    // URL-encode single candidate (fallback fortfarande användbar)
    function base64ToBase64Url(b64){
      return b64.replaceAll("+","-").replaceAll("/","_").replaceAll("=","");
    }
    function encodeCandidateForUrl(candidate){
      const json = JSON.stringify(candidate);
      const b64 = btoa(unescape(encodeURIComponent(json)));
      return base64ToBase64Url(b64);
    }

    function openInPuzzleSingle(candidate){
      const payload = encodeCandidateForUrl(candidate);
      window.location.href =
        "./person-puzzle.html?candidate=" + encodeURIComponent(payload);
    }

    // =====================================================
    // Pool -> Puzzle (postMessage)
    // - Ingen lagring, allt in-memory
    // - Fail-closed: om popup blockeras -> fallback tips
    // =====================================================
    function openPuzzleWithPool(candidates){
      const items = safeArray(candidates).slice(0, 150); // policy: max 150
      if(!items.length){
        alert("Inga kandidater att skicka till Puzzle.");
        return;
      }

      // Öppna Puzzle i ny flik (bäst för att behålla poolen i denna flik)
      const w = window.open("./person-puzzle.html", "_blank", "noopener,noreferrer");

      if(!w){
        alert("Popup blockerad. Tillåt popup för att öppna Puzzle i pool-läge.");
        return;
      }

      // Skicka i chunkar för stabilitet
      const CHUNK = 50;
      const total = items.length;

      function sendChunk(i){
        const slice = items.slice(i, i + CHUNK);
        try{
          w.postMessage({
            type: "PUZZLE_POOL",
            items: slice,
            total: total,
            offset: i
          }, "*");
        }catch{}
      }

      // Skicka några gånger (race med laddning)
      // 1) direkt, 2) efter 300ms, 3) efter 900ms
      let offset = 0;

      // Vi skickar ALLA chunkar vid varje försök, så Puzzle kan ta emot det som hinner fram.
      function sendAll(){
        for(let i=0; i<total; i+=CHUNK) sendChunk(i);
      }

      sendAll();
      setTimeout(sendAll, 300);
      setTimeout(sendAll, 900);
    }

    // =====================================================
    // Render list
    // =====================================================
    function renderList(items){
      resultsEl.innerHTML = "";
      const arr = safeArray(items);

      if(!arr.length){
        showMessage("Inga träffar (eller källa blockerades av CORS/timeout).", "empty");
        openPoolBtn.disabled = true;
        return;
      }

      // max 150 visas (enligt provider limit)
      setCount(arr.length);
      showCapWarning(arr.length >= 150);

      openPoolBtn.disabled = false;

      for(const c of arr){
        const li = document.createElement("li");
        li.className = "item";

        li.innerHTML =
          "<h3>" + escapeHtml(c.name + candidateYears(c)) + "</h3>" +
          "<div class='meta'>Plats: " + escapeHtml(c.place || "—") + "</div>" +
          "<div class='meta'>Källa: " + escapeHtml(c.source || "—") + "</div>" +
          (c.url ? ("<div class='meta'>URL: <span class='mono'>" + escapeHtml(c.url) + "</span></div>") : "");

        const actions = document.createElement("div");
        actions.className = "actions";

        const poolBtn = document.createElement("button");
        poolBtn.className = "secondary";
        poolBtn.textContent = "Öppna i Puzzle (pool)";
        poolBtn.addEventListener("click", () => openPuzzleWithPool(lastCandidates));

        const singleBtn = document.createElement("button");
        singleBtn.className = "secondary";
        singleBtn.textContent = "Öppna i Puzzle (1)";
        singleBtn.addEventListener("click", () => openInPuzzleSingle(c));

        actions.appendChild(poolBtn);
        actions.appendChild(singleBtn);

        li.appendChild(actions);
        resultsEl.appendChild(li);
      }

    // =====================================================
    // Search runner
    // =====================================================
    async function runSearch(){
      showCapWarning(false);
      openPoolBtn.disabled = true;
      setProvider("—");
      setCount("—");
      resultsEl.innerHTML = "";

      const q = qEl.value.trim();
      if(q.length < 2){
        showMessage("Skriv minst 2 tecken.", "empty");
        lastCandidates = [];
        return;
      }

      if(!window.RAProviders){
        showMessage("RAProviders saknas. Kontrollera att ./assets/js/ra-providers.js laddas.", "empty");
        lastCandidates = [];
        return;
      }

      const provider = window.RAProviders.pickProvider("auto");

      searchBtn.disabled = true;
      searchBtn.textContent = "Söker…";

      let items = [];
      let used = (provider && provider.id) ? provider.id : "auto";

      try{
        items = await provider.search(q);
      }catch{
        items = [];
      }

      // demo fallback om upstream strular
      if(!items.length){
        try{
          const demo = window.RAProviders.pickProvider("demo");
          used = (demo && demo.id) ? demo.id : used;
          items = await demo.search(q);
        }catch{
          items = [];
        }
      
      searchBtn.disabled = false;
      searchBtn.textContent = "Sök";

      setProvider(used);

      lastCandidates = safeArray(items).slice(0, 150);
      renderList(lastCandidates);
    }

    // =====================================================
    // Events
    // =====================================================
    searchBtn.addEventListener("click", runSearch);
    qEl.addEventListener("keydown", e => {
      if(e.key === "Enter"){
        e.preventDefault();
        runSearch();
      }
    });

    openPoolBtn.addEventListener("click", () => {
      openPuzzleWithPool(lastCandidates);
    });

    clearBtn.addEventListener("click", () => {
      qEl.value = "";
      lastCandidates = [];
      setProvider("—");
      setCount("—");
      showCapWarning(false);
      openPoolBtn.disabled = true;
      resultsEl.innerHTML = "";
      qEl.focus();
    });

    // Init
    setProvider("—");
    setCount("—");
  </script>
</body>
</html>
