<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sök historisk person – Släktkort</title>
  <meta name="description" content="Sök efter historiska personer (demo/placeholder) och importera som person i aktivt träd." />

  <style>
    :root{ color-scheme: light; }
    body{
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      line-height: 1.5;
      margin: 0;
      padding: 24px;
      max-width: 1180px;
      margin-inline: auto;
      background: #fff;
      color: #111;
    }
    a{ color: inherit; text-decoration: none; }
    header{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      margin-bottom:18px;
    }
    .topbar{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      margin: 10px 0 0;
    }
    .btn, button{
      display:inline-block;
      padding:10px 12px;
      border:1px solid #333;
      border-radius:10px;
      background:#fff;
      font:inherit;
      cursor:pointer;
      text-decoration:none;
      user-select:none;
    }
    .btn.secondary{ border-color:#bbb; background:#fafafa; }
    .btn.primary{ background:#111; color:#fff; border-color:#111; }
    .btn:disabled, button:disabled{ opacity:.55; cursor:not-allowed; }
    .btn.navActive{
      background:#f5fff5;
      border-color:#cfe8cf;
      color:#111;
    }
    .spacer{ flex:1 1 auto; }

    h1{ margin:0 0 6px; font-size: 28px; }
    .muted{ color:#555; margin:0; }

    .pillRow{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      margin: 10px 0 18px;
    }
    .pill{
      display:inline-flex;
      gap:8px;
      align-items:center;
      padding:8px 10px;
      border:1px solid #ddd;
      border-radius:999px;
      background:#fafafa;
      font-size: .95rem;
    }
    .pill strong{ font-weight:900; }
    .pill.ok{ border-color:#cfe8cf; background:#f5fff5; }
    .pill.warn{ border-color:#ffe1a6; background:#fff9ee; }
    .pill.err{ border-color:#ffb3b3; background:#fff2f2; }

    .grid{
      display:grid;
      gap: 14px;
      grid-template-columns: 1fr;
    }
    @media (min-width: 980px){
      .grid{ grid-template-columns: 460px 1fr; }
    }

    .card{
      border:1px solid #e6e8eb;
      border-radius: 16px;
      padding: 14px;
      background:#fff;
      box-shadow: 0 1px 0 rgba(0,0,0,.03);
    }
    .card h2{ margin:0 0 6px; font-size: 18px; }
    .small{ margin:0 0 10px; color:#555; font-size: 13px; }

    label{ display:block; font-weight:800; margin: 10px 0 6px; }
    input, select, textarea{
      width:100%;
      box-sizing:border-box;
      padding: 10px;
      border-radius: 12px;
      border: 1px solid #bbb;
      font: inherit;
      background:#fff;
    }
    textarea{ min-height: 90px; resize: vertical; }

    .actions{
      display:flex;
      flex-wrap:wrap;
      gap: 10px;
      align-items:center;
      margin-top: 12px;
    }

    .list{
      margin: 10px 0 0;
      padding: 0;
      list-style:none;
      display:flex;
      flex-direction:column;
      gap:10px;
      max-height: 560px;
      overflow:auto;
      border-top: 1px solid #eee;
      padding-top: 10px;
    }
    .item{
      border:1px solid #eee;
      border-radius: 14px;
      padding: 10px;
      background:#fff;
      cursor:pointer;
    }
    .item:hover{ background:#fafafa; }
    .itemTitle{ font-weight:900; margin:0 0 2px; }
    .itemMeta{ margin:0; color:#555; font-size: 13px; }

    .liftBox{
      border: 1px solid #e6e8eb;
      background: #fafafa;
      border-radius: 12px;
      padding: 10px 12px;
      font-size: 13px;
      color:#333;
    }
    .liftBox.ok{ border-color:#cfe8cf; background:#f5fff5; }
    .liftBox.warn{ border-color:#ffe1a6; background:#fff9ee; }
    .liftBox.err{ border-color:#ffb3b3; background:#fff2f2; }
    code{ background:#f4f4f4; padding:2px 6px; border-radius:6px; }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; }
  </style>
</head>

<body>
  <header style="display:block;">
    <h1>Sök historisk person</h1>
    <p class="muted">Demo/placeholder: sök lokalt i en enkel datakälla och importera till aktivt träd.</p>

    <nav class="topbar" aria-label="Huvudmeny">
      <a class="btn secondary" href="../start.html">Start</a>
      <a class="btn secondary" href="./trees.html">Träd</a>
      <a class="btn secondary" href="./slaktkort.html">Personer</a>
      <a class="btn secondary" href="./create-relation.html">Relationer</a>
      <a class="btn secondary" href="./map.html">Karta</a>
      <span class="spacer"></span>
      <button class="btn secondary" id="logoutBtn" type="button">Logga ut</button>
    </nav>
  </header>

  <section class="pillRow" aria-label="Status">
    <span id="pillTree" class="pill warn">Aktivt träd: <strong>—</strong></span>
    <span id="pillResults" class="pill">Träffar: <strong>0</strong></span>
    <span id="pillMode" class="pill">Källa: <strong>Demo</strong></span>
  </section>

  <div class="grid">
    <section class="card" aria-label="Sök">
      <h2>Sök</h2>
      <p class="small">Sök på namn. Denna sida är byggd för att senare kunna kopplas mot externa källor, men kör nu som demo.</p>

      <div id="topMsg" class="liftBox warn" hidden></div>

      <label for="q">Sökterm</label>
      <input id="q" placeholder="t.ex. Karl Johansson" autocomplete="off" />

      <div class="actions">
        <button class="btn primary" id="searchBtn" type="button">Sök</button>
        <button class="btn secondary" id="clearBtn" type="button">Rensa</button>
        <button class="btn secondary" id="backBtn" type="button">Tillbaka</button>
      </div>

      <div class="liftBox" style="margin-top:10px;">
        <strong>Obs</strong><br/>
        Ingen känslig data lagras. Importen skapar bara en personpost i aktivt träd (localStorage).<br/>
        Senare kan FORGE koppla denna sida till öppna källor och matchningslogik.
      </div>

      <ul id="results" class="list" aria-label="Sökresultat"></ul>
    </section>

    <section class="card" aria-label="Förhandsvisning och import">
      <h2>Förhandsvisning</h2>
      <p class="small">Klicka ett resultat för att förhandsvisa. Import skapar personen i aktivt träd och öppnar den i Personer.</p>

      <div id="previewBox" class="liftBox" aria-live="polite">
        Välj en träff för att se detaljer här.
      </div>

      <div class="actions">
        <button class="btn primary" id="importBtn" type="button" disabled>Importera till Personer</button>
        <button class="btn secondary" id="copyBtn" type="button" disabled>Kopiera som text</button>
      </div>

      <div class="liftBox" style="margin-top:10px;">
        <strong>Teknik</strong><br/>
        Personer lagras per träd i <code>slakttradet_slaktkort_&lt;treeId&gt;</code>.<br/>
        Efter import navigerar vi till <code>slaktkort.html#open=&lt;personId&gt;</code>.
      </div>
    </section>
  </div>

  <script>
    "use strict";

    (function authGuard(){
      try{
        if(sessionStorage.getItem("demo_auth") !== "1"){
          window.location.href = "../index.html";
        }
      }catch{}
    })();

    const KEY_TREES  = "slakttradet_trees";
    const KEY_ACTIVE = "slakttradet_active_tree_id";
    const cardsKey = (treeId) => "slakttradet_slaktkort_" + String(treeId);

    const logoutBtn = document.getElementById("logoutBtn");

    const pillTree = document.getElementById("pillTree");
    const pillResults = document.getElementById("pillResults");
    const pillMode = document.getElementById("pillMode");

    const qEl = document.getElementById("q");
    const searchBtn = document.getElementById("searchBtn");
    const clearBtn = document.getElementById("clearBtn");
    const backBtn = document.getElementById("backBtn");

    const topMsg = document.getElementById("topMsg");
    const resultsEl = document.getElementById("results");

    const previewBox = document.getElementById("previewBox");
    const importBtn = document.getElementById("importBtn");
    const copyBtn = document.getElementById("copyBtn");

    function safeParse(raw, fallback){
      try{ return JSON.parse(raw); }catch{ return fallback; }
    }
    function loadJson(key, fallback){
      const raw = localStorage.getItem(key);
      return raw ? safeParse(raw, fallback) : fallback;
    }
    function saveJson(key, value){
      localStorage.setItem(key, JSON.stringify(value));
    }

    function escapeHtml(s){
      return String(s || "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function activeTreeId(){
      return localStorage.getItem(KEY_ACTIVE) || "";
    }
    function getTrees(){
      const arr = loadJson(KEY_TREES, []);
      return Array.isArray(arr) ? arr : [];
    }
    function activeTreeLabel(){
      const id = activeTreeId();
      if(!id) return "—";
      const t = getTrees().find(x => String(x.id) === String(id));
      return t ? (t.name || t.id) : id;
    }

    function refreshPills(resultCount){
      const t = activeTreeId();
      const trees = getTrees();
      const hasTrees = trees.length > 0;
      const hasActive = !!t;

      pillTree.className = "pill " + (hasActive ? "ok" : (hasTrees ? "warn" : "err"));
      pillTree.innerHTML = "Aktivt träd: <strong>" + escapeHtml(hasActive ? activeTreeLabel() : "—") + "</strong>";

      pillResults.innerHTML = "Träffar: <strong>" + String(resultCount || 0) + "</strong>";
      pillMode.innerHTML = "Källa: <strong>Demo</strong>";
    }

    function showTopMsg(kind, text){
      topMsg.hidden = false;
      topMsg.className = "liftBox " + (kind || "warn");
      topMsg.innerHTML = escapeHtml(text);
    }
    function clearTopMsg(){
      topMsg.hidden = true;
      topMsg.innerHTML = "";
      topMsg.className = "liftBox";
    }

    function normalize(s){
      return String(s || "").trim().toLowerCase();
    }

    function parseYear(v){
      const s = String(v || "").trim();
      if(!s) return "";
      const n = Number(s);
      if(!Number.isFinite(n)) return "";
      const i = Math.trunc(n);
      if(i < 0 || i > 3000) return "";
      return String(i);
    }

    function newId(){
      return "p_" + Date.now().toString(36) + "_" + Math.random().toString(36).slice(2,7);
    }

    // ==========================================================
    // DEMO DATASET (placeholder)
    // - Byt ut detta senare mot riktig källa (Riksarkivet etc.)
    // ==========================================================
    const DEMO = [
      { fornamn:"Karl", efternamn:"Johansson", fodelsear:"1872", dodsar:"1939", plats:"Falun", kon:"man", yrke:"Smed", notes:"Demo-post." },
      { fornamn:"Anna", efternamn:"Persdotter", fodelsear:"1878", dodsar:"1951", plats:"Leksand", kon:"kvinna", yrke:"Piga", notes:"Demo-post." },
      { fornamn:"Erik", efternamn:"Lind", fodelsear:"1901", dodsar:"1977", plats:"Gävle", kon:"man", yrke:"Lokförare", notes:"Demo-post." },
      { fornamn:"Maria", efternamn:"Nilsdotter", fodelsear:"1822", dodsar:"1890", plats:"Uppsala", kon:"kvinna", yrke:"Sömmerska", notes:"Demo-post." },
      { fornamn:"Olof", efternamn:"Bergström", fodelsear:"1799", dodsar:"1866", plats:"Örebro", kon:"man", yrke:"Handlare", notes:"Demo-post." }
    ];

    function personTitle(x){
      const n = (String(x.fornamn||"") + " " + String(x.efternamn||"")).trim();
      const born = parseYear(x.fodelsear);
      const dead = parseYear(x.dodsar);
      const years = (born || dead) ? (" (" + (born || "—") + "–" + (dead || "—") + ")") : "";
      return (n || "(namnlös)") + years;
    }

    function doSearch(){
      clearTopMsg();
      const t = activeTreeId();
      if(!t){
        showTopMsg("err", "⛔ Inget aktivt träd. Gå till Träd och välj ett aktivt träd innan import.");
        resultsEl.innerHTML = "";
        setPreview(null);
        refreshPills(0);
        return;
      }

      const q = normalize(qEl.value);
      if(!q || q.length < 2){
        showTopMsg("warn", "⚠️ Skriv minst 2 tecken för att söka.");
        resultsEl.innerHTML = "";
        setPreview(null);
        refreshPills(0);
        return;
      }

      const hits = DEMO.filter(x => {
        const full = normalize((x.fornamn||"") + " " + (x.efternamn||""));
        const place = normalize(x.plats||"");
        return full.includes(q) || place.includes(q);
      });

      renderResults(hits);
      refreshPills(hits.length);

      if(hits.length === 0){
        showTopMsg("warn", "⚠️ Inga träffar (demo). Prova t.ex. “Karl”, “Anna”, “Falun”, “Uppsala”.");
      }
    }

    let selected = null;

    function setPreview(x){
      selected = x || null;
      if(!selected){
        previewBox.className = "liftBox";
        previewBox.innerHTML = "Välj en träff för att se detaljer här.";
        importBtn.disabled = true;
        copyBtn.disabled = true;
        return;
      }

      const born = parseYear(selected.fodelsear);
      const dead = parseYear(selected.dodsar);

      previewBox.className = "liftBox ok";
      previewBox.innerHTML =
        "<div><strong>" + escapeHtml(personTitle(selected)) + "</strong></div>" +
        "<div class='small' style='margin-top:6px;'>" +
          "Kön: <span class='mono'>" + escapeHtml(selected.kon || "—") + "</span><br/>" +
          "Yrke: <span class='mono'>" + escapeHtml(selected.yrke || "—") + "</span><br/>" +
          "Plats: <span class='mono'>" + escapeHtml(selected.plats || "—") + "</span><br/>" +
          "Födelseår: <span class='mono'>" + escapeHtml(born || "—") + "</span> · " +
          "Dödsår: <span class='mono'>" + escapeHtml(dead || "—") + "</span><br/>" +
          (selected.notes ? ("Notis: <span class='mono'>" + escapeHtml(selected.notes) + "</span>") : "") +
        "</div>";

      importBtn.disabled = false;
      copyBtn.disabled = false;
    }

    function renderResults(arr){
      resultsEl.innerHTML = "";

      if(!arr || arr.length === 0){
        const li = document.createElement("li");
        li.className = "item";
        li.style.cursor = "default";
        li.innerHTML =
          "<p class='itemTitle'>Inga träffar</p>" +
          "<p class='itemMeta'>Denna sida är demo. Byt ut datakällan när ni kopplar mot riktig källa.</p>";
        resultsEl.appendChild(li);
        return;
      }

      for(const x of arr){
        const li = document.createElement("li");
        li.className = "item";
        li.innerHTML =
          "<p class='itemTitle'>" + escapeHtml(personTitle(x)) + "</p>" +
          "<p class='itemMeta'>" +
            (x.plats ? ("Plats: " + escapeHtml(x.plats)) : "Plats: —") +
            (x.yrke ? (" · Yrke: " + escapeHtml(x.yrke)) : "") +
          "</p>";

        li.addEventListener("click", () => {
          setPreview(x);
        });

        resultsEl.appendChild(li);
      }

      setPreview(null);
    }

    function importSelected(){
      clearTopMsg();
      const t = activeTreeId();
      if(!t){
        showTopMsg("err", "⛔ Inget aktivt träd. Gå till Träd och välj ett aktivt träd innan import.");
        return;
      }
      if(!selected){
        showTopMsg("warn", "⚠️ Välj en träff först.");
        return;
      }

      const people = loadJson(cardsKey(t), []);
      const arr = Array.isArray(people) ? people : [];

      const id = newId();

      const created = {
        id,
        fornamn: String(selected.fornamn || "").trim(),
        efternamn: String(selected.efternamn || "").trim(),
        kon: String(selected.kon || ""),
        yrke: String(selected.yrke || "").trim(),
        fodelsear: parseYear(selected.fodelsear),
        dodsar: parseYear(selected.dodsar),
        plats: String(selected.plats || "").trim(),
        coords: null,
        anteckning: ("Importerad från demo-sök. " + (selected.notes ? String(selected.notes) : "")).trim()
      };

      // minimal validering
      if(!created.fornamn || !created.efternamn){
        showTopMsg("err", "⛔ Kan inte importera: saknar förnamn/efternamn.");
        return;
      }

      arr.push(created);
      saveJson(cardsKey(t), arr);

      // Navigera tillbaka och öppna personen
      window.location.href = "./slaktkort.html#open=" + encodeURIComponent(id);
    }

    async function copySelected(){
      if(!selected) return;

      const born = parseYear(selected.fodelsear);
      const dead = parseYear(selected.dodsar);

      const text =
        personTitle(selected) + "\n" +
        "Kön: " + (selected.kon || "—") + "\n" +
        "Yrke: " + (selected.yrke || "—") + "\n" +
        "Plats: " + (selected.plats || "—") + "\n" +
        "Födelseår: " + (born || "—") + " · Dödsår: " + (dead || "—") + "\n";

      try{
        await navigator.clipboard.writeText(text);
        showTopMsg("ok", "✅ Kopierat till urklipp.");
      }catch{
        showTopMsg("warn", "⚠️ Kunde inte kopiera (webbläsaren blockerade). Markera texten manuellt i förhandsvisningen.");
      }
    }

    function goBack(){
      window.location.href = "./slaktkort.html";
    }

    // Events
    logoutBtn.addEventListener("click", () => {
      try{ sessionStorage.removeItem("demo_auth"); }catch{}
      window.location.href = "../index.html";
    });

    searchBtn.addEventListener("click", doSearch);
    clearBtn.addEventListener("click", () => {
      qEl.value = "";
      resultsEl.innerHTML = "";
      setPreview(null);
      clearTopMsg();
      refreshPills(0);
      try{ qEl.focus(); }catch{}
    });
    backBtn.addEventListener("click", goBack);

    importBtn.addEventListener("click", importSelected);
    copyBtn.addEventListener("click", copySelected);

    qEl.addEventListener("keydown", (e) => {
      if(e.key === "Enter"){
        e.preventDefault();
        doSearch();
      }
    });

    // Init
    refreshPills(0);
    renderResults([]);
    showTopMsg("warn", "⚠️ Demo-läge: detta är en placeholder. Nästa steg är att koppla mot riktig källa och matchningslogik.");
    try{ qEl.focus(); }catch{}
  </script>
</body>
</html>
