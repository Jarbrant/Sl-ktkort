<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sök historisk person – Släktkort</title>
  <meta name="description" content="Starta en sökning (namn) och gå vidare till Puzzle för avgränsning, sök mot källor och manuell import." />

  <style>
    :root{ color-scheme: light; }
    body{
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      line-height: 1.5;
      margin: 0;
      padding: 24px;
      max-width: 1180px;
      margin-inline: auto;
      background: #fff;
      color:#111;
    }
    a{ color: inherit; text-decoration: none; }
    header{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      margin-bottom:18px;
    }
    .topbar{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      margin: 10px 0 0;
    }
    .btn, button{
      display:inline-block;
      padding:10px 12px;
      border:1px solid #333;
      border-radius:10px;
      background:#fff;
      font:inherit;
      cursor:pointer;
      text-decoration:none;
      user-select:none;
    }
    .btn.secondary{ border-color:#bbb; background:#fafafa; }
    .btn.primary{ background:#111; color:#fff; border-color:#111; }
    .btn:disabled, button:disabled{ opacity:.55; cursor:not-allowed; }
    .btn.navActive{
      background:#f5fff5;
      border-color:#cfe8cf;
      color:#111;
    }
    .spacer{ flex:1 1 auto; }

    h1{ margin:0 0 6px; font-size: 28px; }
    .muted{ color:#555; margin:0; }

    .pillRow{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      margin: 10px 0 18px;
    }
    .pill{
      display:inline-flex;
      gap:8px;
      align-items:center;
      padding:8px 10px;
      border:1px solid #ddd;
      border-radius:999px;
      background:#fafafa;
      font-size: .95rem;
    }
    .pill strong{ font-weight:900; }
    .pill.ok{ border-color:#cfe8cf; background:#f5fff5; }
    .pill.warn{ border-color:#ffe1a6; background:#fff9ee; }
    .pill.err{ border-color:#ffb3b3; background:#fff2f2; }

    .grid{
      display:grid;
      gap: 14px;
      grid-template-columns: 1fr;
    }
    @media (min-width: 980px){
      .grid{ grid-template-columns: 460px 1fr; }
    }

    .card{
      border:1px solid #e6e8eb;
      border-radius: 16px;
      padding: 14px;
      background:#fff;
      box-shadow: 0 1px 0 rgba(0,0,0,.03);
    }
    .card h2{ margin:0 0 6px; font-size: 18px; }
    .small{ margin:0 0 10px; color:#555; font-size: 13px; }

    label{ display:block; font-weight:800; margin: 10px 0 6px; }
    input, select, textarea{
      width:100%;
      box-sizing:border-box;
      padding: 10px;
      border-radius: 12px;
      border: 1px solid #bbb;
      font: inherit;
      background:#fff;
    }
    textarea{ min-height: 90px; resize: vertical; }

    .actions{
      display:flex;
      flex-wrap:wrap;
      gap: 10px;
      align-items:center;
      margin-top: 12px;
    }

    .list{
      margin: 10px 0 0;
      padding: 0;
      list-style:none;
      display:flex;
      flex-direction:column;
      gap:10px;
      max-height: 560px;
      overflow:auto;
      border-top: 1px solid #eee;
      padding-top: 10px;
    }
    .item{
      border:1px solid #eee;
      border-radius: 14px;
      padding: 10px;
      background:#fff;
      cursor:default;
    }
    .itemTitle{ font-weight:900; margin:0 0 2px; }
    .itemMeta{ margin:0; color:#555; font-size: 13px; }

    .liftBox{
      border: 1px solid #e6e8eb;
      background: #fafafa;
      border-radius: 12px;
      padding: 10px 12px;
      font-size: 13px;
      color:#333;
    }
    .liftBox.ok{ border-color:#cfe8cf; background:#f5fff5; }
    .liftBox.warn{ border-color:#ffe1a6; background:#fff9ee; }
    .liftBox.err{ border-color:#ffb3b3; background:#fff2f2; }
    code{ background:#f4f4f4; padding:2px 6px; border-radius:6px; }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; }
  </style>
</head>

<body>
  <header style="display:block;">
    <h1>Sök historisk person</h1>
    <p class="muted">Steg 1: skriv namn och gå vidare till <strong>Puzzle</strong> där alla källfrågor och avgränsningar sker.</p>

    <nav class="topbar" aria-label="Huvudmeny">
      <a class="btn secondary" href="../start.html">Start</a>
      <a class="btn secondary" href="./trees.html">Träd</a>
      <a class="btn secondary" href="./slaktkort.html">Personer</a>
      <a class="btn secondary" href="./create-relation.html">Relationer</a>
      <a class="btn secondary" href="./map.html">Karta</a>
      <span class="spacer"></span>
      <button class="btn secondary" id="logoutBtn" type="button">Logga ut</button>
    </nav>
  </header>

  <section class="pillRow" aria-label="Status">
    <span id="pillTree" class="pill warn">Aktivt träd: <strong>—</strong></span>
    <span id="pillResults" class="pill">Träffar: <strong>0</strong></span>
    <span id="pillMode" class="pill">Läge: <strong>Start → Puzzle</strong></span>
  </section>

  <div class="grid">
    <section class="card" aria-label="Starta sökning">
      <h2>Starta sökning</h2>
      <p class="small">Den här sidan gör <strong>inga API-anrop</strong>. Den sparar bara en sökstart kopplad till <code>activePersonId</code> och skickar dig till Puzzle.</p>

      <div id="topMsg" class="liftBox warn" hidden></div>

      <label for="q">Sökterm (namn)</label>
      <input id="q" placeholder="t.ex. Stina Nilsson" autocomplete="off" />

      <div class="actions">
        <button class="btn primary" id="searchBtn" type="button">Nästa: Puzzle</button>
        <button class="btn secondary" id="clearBtn" type="button">Rensa</button>
        <button class="btn secondary" id="backBtn" type="button">Tillbaka</button>
      </div>

      <div class="liftBox" style="margin-top:10px;">
        <strong>Obs</strong><br/>
        Inga externa data hämtas här. Alla “frågor till databasen” och matchning sker i <code>person-puzzle.html</code>.<br/>
        Endast en lokal “startmarkör” skapas kopplad till <code>activePersonId</code> för att bära sökstarten vidare.
      </div>

      <ul id="results" class="list" aria-label="Info">
        <li class="item">
          <p class="itemTitle">Hur flödet fungerar</p>
          <p class="itemMeta">person-search → person-puzzle (avgränsa, fråga källor, poäng) → slaktkort (valfritt spara)</p>
        </li>
      </ul>
    </section>

    <section class="card" aria-label="Förhandsinfo">
      <h2>Puzzle (nästa steg)</h2>
      <p class="small">I Puzzle kan fler frågor ställas (år/plats/varianter). Kandidater kan stärkas/försvagas via poäng tills en är rätt.</p>

      <div id="previewBox" class="liftBox" aria-live="polite">
        När du klickar <strong>Nästa: Puzzle</strong> skapas en lokal startmarkör och du skickas vidare.
      </div>

      <div class="actions">
        <button class="btn secondary" id="goPuzzleBtn" type="button" disabled>Öppna Puzzle</button>
      </div>

      <div class="liftBox" style="margin-top:10px;">
        <strong>Teknik</strong><br/>
        Aktivt träd: <code>slakttradet_active_tree_id</code><br/>
        Personkort per träd: <code>slakttradet_slaktkort_&lt;treeId&gt;</code><br/>
        Fokus mellan sidor: <code>activePersonId</code> (LÅST)
      </div>
    </section>
  </div>

  <script>
    "use strict";

    (function authGuard(){
      try{
        if(sessionStorage.getItem("demo_auth") !== "1"){
          window.location.href = "../index.html";
        }
      }catch{}
    })();

    // ==========================================================
    // STATE / KEYS (LÅST)
    // ==========================================================
    const KEY_TREES       = "slakttradet_trees";
    const KEY_ACTIVE_TREE = "slakttradet_active_tree_id";
    const KEY_ACTIVE_PID  = "activePersonId"; // LÅST: används för fokus mellan sidor

    const cardsKey = (treeId) => "slakttradet_slaktkort_" + String(treeId);

    // ==========================================================
    // DOM
    // ==========================================================
    const logoutBtn   = document.getElementById("logoutBtn");
    const pillTree    = document.getElementById("pillTree");
    const pillResults = document.getElementById("pillResults");
    const pillMode    = document.getElementById("pillMode");

    const qEl        = document.getElementById("q");
    const searchBtn  = document.getElementById("searchBtn");
    const clearBtn   = document.getElementById("clearBtn");
    const backBtn    = document.getElementById("backBtn");

    const topMsg     = document.getElementById("topMsg");
    const previewBox = document.getElementById("previewBox");
    const goPuzzleBtn= document.getElementById("goPuzzleBtn");

    // ==========================================================
    // STORAGE HELPERS
    // ==========================================================
    function safeParse(raw, fallback){
      try{ return JSON.parse(raw); }catch{ return fallback; }
    }
    function loadJson(key, fallback){
      const raw = localStorage.getItem(key);
      return raw ? safeParse(raw, fallback) : fallback;
    }
    function saveJson(key, value){
      localStorage.setItem(key, JSON.stringify(value));
    }

    // ==========================================================
    // UI HELPERS
    // ==========================================================
    function escapeHtml(s){
      return String(s || "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function showTopMsg(kind, text){
      topMsg.hidden = false;
      topMsg.className = "liftBox " + (kind || "warn");
      topMsg.innerHTML = escapeHtml(text);
    }
    function clearTopMsg(){
      topMsg.hidden = true;
      topMsg.innerHTML = "";
      topMsg.className = "liftBox";
    }

    // ==========================================================
    // TREE / CONTEXT
    // ==========================================================
    function activeTreeId(){
      return localStorage.getItem(KEY_ACTIVE_TREE) || "";
    }
    function getTrees(){
      const arr = loadJson(KEY_TREES, []);
      return Array.isArray(arr) ? arr : [];
    }
    function activeTreeLabel(){
      const id = activeTreeId();
      if(!id) return "—";
      const t = getTrees().find(x => String(x.id) === String(id));
      return t ? (t.name || t.id) : id;
    }
    function refreshPills(){
      const t = activeTreeId();
      const trees = getTrees();
      const hasTrees = trees.length > 0;
      const hasActive = !!t;

      pillTree.className = "pill " + (hasActive ? "ok" : (hasTrees ? "warn" : "err"));
      pillTree.innerHTML = "Aktivt träd: <strong>" + escapeHtml(hasActive ? activeTreeLabel() : "—") + "</strong>";

      // Den här sidan visar inga resultat (det sker i puzzle)
      pillResults.innerHTML = "Träffar: <strong>0</strong>";
      pillMode.innerHTML = "Läge: <strong>Start → Puzzle</strong>";
    }

    // ==========================================================
    // VALIDATION
    // ==========================================================
    function normalize(s){
      return String(s || "").trim();
    }
    function splitName(full){
      // Minimal, deterministisk split: sista ordet = efternamn, resten = förnamn.
      const s = normalize(full).replace(/\s+/g, " ");
      const parts = s ? s.split(" ") : [];
      if(parts.length === 0) return { fornamn:"", efternamn:"" };
      if(parts.length === 1) return { fornamn: parts[0], efternamn: "" };
      const efternamn = parts[parts.length - 1];
      const fornamn = parts.slice(0, -1).join(" ");
      return { fornamn, efternamn };
    }
    function newId(){
      return "p_" + Date.now().toString(36) + "_" + Math.random().toString(36).slice(2,7);
    }

    // ==========================================================
    // NAVIGATION
    // ==========================================================
    function goBack(){
      window.location.href = "./slaktkort.html";
    }
    function goPuzzle(){
      window.location.href = "./person-puzzle.html";
    }

    // ==========================================================
    // CORE: START PUZZLE (0 FETCH)
    // ==========================================================
    function startPuzzle(){
      clearTopMsg();

      const treeId = activeTreeId();
      if(!treeId){
        showTopMsg("err", "⛔ Inget aktivt träd. Gå till Träd och välj ett aktivt träd innan du fortsätter.");
        return;
      }

      const q = normalize(qEl.value);
      if(!q || q.length < 3){
        showTopMsg("warn", "⚠️ Skriv minst 3 tecken (namn) för att gå vidare till Puzzle.");
        return;
      }

      // ----------------------------------------------------------
      // STATE / activePersonId (LÅST)
      // Vi skapar en lokal “startmarkör” (ingen extern data)
      // som puzzle kan läsa och använda för att ställa fler frågor.
      // ----------------------------------------------------------
      const listKey = cardsKey(treeId);
      const people = loadJson(listKey, []);
      const arr = Array.isArray(people) ? people : [];

      const id = newId();
      const nm = splitName(q);

      const seed = {
        id,
        fornamn: String(nm.fornamn || "").trim(),
        efternamn: String(nm.efternamn || "").trim(),
        kon: "",
        yrke: "",
        fodelsear: "",
        dodsar: "",
        plats: "",
        coords: null,
        // LÅST: endast query-seed, ingen extern data
        anteckning: ("PUZZLE-SEED (namn): " + q).trim()
      };

      // Minimal validering: måste ha minst förnamn (efternamn kan vara tomt i seed)
      if(!seed.fornamn){
        showTopMsg("err", "⛔ Ogiltigt namn. Skriv minst ett namn.");
        return;
      }

      arr.push(seed);
      saveJson(listKey, arr);

      // LÅST: fokus mellan sidor
      localStorage.setItem(KEY_ACTIVE_PID, String(id));

      // UI feedback + navigation
      previewBox.className = "liftBox ok";
      previewBox.innerHTML =
        "✅ Startmarkör skapad. <br/>" +
        "Fokus satt via <code>activePersonId</code>: <span class='mono'>" + escapeHtml(id) + "</span><br/>" +
        "Du skickas nu till <code>person-puzzle.html</code>.";

      goPuzzleBtn.disabled = false;

      // Direkt vidare (enligt flöde)
      goPuzzle();
    }

    // ==========================================================
    // EVENTS
    // ==========================================================
    logoutBtn.addEventListener("click", () => {
      try{ sessionStorage.removeItem("demo_auth"); }catch{}
      window.location.href = "../index.html";
    });

    searchBtn.addEventListener("click", startPuzzle);

    clearBtn.addEventListener("click", () => {
      qEl.value = "";
      clearTopMsg();
      previewBox.className = "liftBox";
      previewBox.innerHTML = "När du klickar <strong>Nästa: Puzzle</strong> skapas en lokal startmarkör och du skickas vidare.";
      goPuzzleBtn.disabled = true;
      try{ qEl.focus(); }catch{}
    });

    backBtn.addEventListener("click", goBack);

    goPuzzleBtn.addEventListener("click", goPuzzle);

    qEl.addEventListener("keydown", (e) => {
      if(e.key === "Enter"){
        e.preventDefault();
        startPuzzle();
      }
    });

    // ==========================================================
    // INIT
    // ==========================================================
    refreshPills();
    showTopMsg("warn", "⚠️ Startläge: inga externa sökningar här. Klicka “Nästa: Puzzle” för att fortsätta.");
    try{ qEl.focus(); }catch{}
  </script>
</body>
</html>
