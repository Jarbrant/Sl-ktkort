<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sök historisk person – Släktkort</title>
  <meta name="description" content="Sök historiska personer via öppna källor och öppna vald kandidat i Puzzle." />

  <style>
    :root{ color-scheme: light; }
    body{
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      line-height: 1.5;
      margin: 0;
      padding: 24px;
      max-width: 980px;
      margin-inline: auto;
      background: #fff;
      color: #111;
    }
    a{ color: inherit; text-decoration:none; }
    header{ margin-bottom:18px; }
    h1{ margin:0 0 6px; font-size: 26px; }
    .muted{ color:#555; margin:0; }

    .row{ display:flex; gap:10px; margin-top:12px; }
    input{
      flex:1;
      padding:10px;
      border-radius:12px;
      border:1px solid #bbb;
      font:inherit;
    }
    button{
      padding:10px 14px;
      border-radius:12px;
      border:1px solid #333;
      background:#111;
      color:#fff;
      font:inherit;
      cursor:pointer;
    }
    button.secondary{
      background:#fff;
      color:#111;
      border-color:#bbb;
    }

    .list{
      margin-top:18px;
      list-style:none;
      padding:0;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .item{
      border:1px solid #eee;
      border-radius:14px;
      padding:12px;
      background:#fff;
    }
    .item h3{ margin:0 0 4px; font-size:16px; }
    .meta{ font-size:13px; color:#555; }
    .actions{ margin-top:8px; display:flex; gap:8px; }
  </style>
</head>

<body>
  <header>
    <h1>Sök historisk person</h1>
    <p class="muted">Sök i öppna källor och öppna vald kandidat i Puzzle.</p>
  </header>

  <div class="row">
    <input id="q" placeholder="t.ex. Stina Nilsson" autocomplete="off" />
    <button id="searchBtn">Sök</button>
  </div>

  <ul id="results" class="list" aria-label="Sökresultat"></ul>

  <!-- RA Providers -->
  <script src="./assets/js/ra-providers.js"></script>

  <script>
    "use strict";

    const qEl = document.getElementById("q");
    const searchBtn = document.getElementById("searchBtn");
    const resultsEl = document.getElementById("results");

    function escapeHtml(s){
      return String(s || "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function candidateYears(c){
      const by = Number.isFinite(Number(c.birthYear)) ? c.birthYear : "—";
      const dy = Number.isFinite(Number(c.deathYear)) ? c.deathYear : "—";
      if(by==="—" && dy==="—") return "";
      return " (" + by + "–" + dy + ")";
    }

    function base64ToBase64Url(b64){
      return b64.replaceAll("+","-").replaceAll("/","_").replaceAll("=","");
    }

    function encodeCandidateForUrl(candidate){
      const json = JSON.stringify(candidate);
      const b64 = btoa(unescape(encodeURIComponent(json)));
      return base64ToBase64Url(b64);
    }

    function openInPuzzle(candidate){
      const payload = encodeCandidateForUrl(candidate);
      window.location.href =
        "./person-puzzle.html?candidate=" + encodeURIComponent(payload);
    }

    async function runSearch(){
      resultsEl.innerHTML = "";
      const q = qEl.value.trim();
      if(q.length < 2){
        resultsEl.innerHTML =
          "<li class='item'><div class='meta'>Skriv minst 2 tecken.</div></li>";
        return;
      }

      if(!window.RAProviders){
        resultsEl.innerHTML =
          "<li class='item'><div class='meta'>RAProviders saknas.</div></li>";
        return;
      }

      const provider = window.RAProviders.pickProvider("auto");

      let items = [];
      try{
        items = await provider.search(q);
      }catch{
        items = [];
      }

      if(!items.length){
        resultsEl.innerHTML =
          "<li class='item'><div class='meta'>Inga träffar.</div></li>";
        return;
      }

      for(const c of items){
        const li = document.createElement("li");
        li.className = "item";
        li.innerHTML =
          "<h3>" + escapeHtml(c.name + candidateYears(c)) + "</h3>" +
          "<div class='meta'>Plats: " + escapeHtml(c.place || "—") + "</div>" +
          "<div class='meta'>Källa: " + escapeHtml(c.source || "—") + "</div>";

        const actions = document.createElement("div");
        actions.className = "actions";

        const btn = document.createElement("button");
        btn.className = "secondary";
        btn.textContent = "Öppna i Puzzle";
        btn.addEventListener("click", () => openInPuzzle(c));

        actions.appendChild(btn);
        li.appendChild(actions);
        resultsEl.appendChild(li);
      }
    }

    searchBtn.addEventListener("click", runSearch);
    qEl.addEventListener("keydown", e => {
      if(e.key === "Enter"){
        e.preventDefault();
        runSearch();
      }
    });
  </script>
</body>
</html>
