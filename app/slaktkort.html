<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Släktkort</title>

  <style>
    body { font-family: system-ui, Arial, sans-serif; padding: 24px; max-width: 900px; margin: 0 auto; }
    a { display:inline-block; margin-bottom: 16px; margin-right: 12px; }
    h1 { margin-bottom: 6px; }
    .muted { color:#555; }
    .card { border:1px solid #ddd; border-radius:12px; padding:16px; margin-top: 16px; }
    label { display:block; margin-top: 12px; font-weight: 800; }
    input, select, textarea, button { width:100%; padding:10px; margin-top:6px; font-size:1rem; box-sizing: border-box; }
    textarea { min-height: 90px; resize: vertical; }
    button { border:1px solid #333; background:#fff; cursor:pointer; margin-top: 16px; border-radius: 10px; }
    .error { color:#b00020; font-weight: 800; }
    .ok { font-weight: 800; }
    code { background:#f4f4f4; padding:2px 6px; border-radius:6px; }
    .row { display:grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    @media (max-width: 700px) { .row { grid-template-columns: 1fr; } }
    .actionsRow { display:flex; gap: 12px; flex-wrap: wrap; align-items: center; margin-top: 10px; }
    .actionsRow button { width: auto; padding: 10px 14px; margin-top: 0; }
    .actionsRow a { margin: 0; }
    pre { white-space:pre-wrap; background:#f4f4f4; padding:12px; border-radius:10px; overflow:auto; }
  </style>
</head>

<body>
  <!-- OBS: Denna fil ligger i /app/ så adminpanelen ligger ett steg upp -->
  <a href="../index.html">← Adminpanel</a>
  <a href="./trees.html">Skapa/Välj träd</a>
  <a href="./place-picker.html">Välj plats (karta)</a>

  <h1>Släktkort</h1>
  <p class="muted">
    LocalStorage-first (funkar på GitHub Pages). Backend kan kopplas på senare.
  </p>

  <!-- 1) Välj träd -->
  <div class="card">
    <h2>1) Välj träd</h2>
    <p class="muted">Släktkort sparas per träd i localStorage.</p>

    <label for="treeSelect">Träd</label>
    <select id="treeSelect" aria-label="Välj träd"></select>

    <div class="actionsRow">
      <button id="reloadTreesBtn" type="button">Ladda träd</button>
      <a href="./trees.html">Gå till Skapa/Välj träd</a>
    </div>

    <p id="treeMsg" class="muted" aria-live="polite"></p>
  </div>

  <!-- 2) Skapa släktkort -->
  <div class="card">
    <h2>2) Skapa släktkort</h2>

    <div class="row">
      <div>
        <label for="fornamn">Förnamn</label>
        <input id="fornamn" placeholder="t.ex. Anna" />
      </div>
      <div>
        <label for="efternamn">Efternamn</label>
        <input id="efternamn" placeholder="t.ex. Andersson" />
      </div>
    </div>

    <label for="kon">Kön</label>
    <select id="kon">
      <option>Okänt</option>
      <option>Man</option>
      <option>Kvinna</option>
    </select>

    <div class="row">
      <div>
        <label for="fodelsear">Födelseår (valfritt)</label>
        <input id="fodelsear" type="number" placeholder="t.ex. 1874" />
      </div>
      <div>
        <label for="dodsar">Dödsår (valfritt)</label>
        <input id="dodsar" type="number" placeholder="t.ex. 1942" />
      </div>
    </div>

    <label for="plats">Plats (valfritt)</label>
    <input id="plats" placeholder="t.ex. Uppsala" />

    <label for="coords">Koordinater (lat, lon) (valfritt)</label>
    <input id="coords" placeholder="t.ex. 59.3293, 18.0686" />

    <div class="actionsRow">
      <a href="./place-picker.html">Välj koordinater i karta-vyn</a>
      <button type="button" id="clearCoordsBtn">Rensa koordinater</button>
    </div>

    <label for="anteckning">Anteckning (valfritt)</label>
    <textarea id="anteckning" placeholder="fri text"></textarea>

    <div class="actionsRow">
      <button id="createBtn" type="button">Spara släktkort</button>
    </div>

    <p id="createMsg" class="muted" aria-live="polite"></p>
  </div>

  <!-- 3) Lista släktkort -->
  <div class="card">
    <h2>3) Lista släktkort i valt träd</h2>
    <p class="muted">Visas som JSON (demo).</p>

    <div class="actionsRow">
      <button id="listBtn" type="button">Hämta släktkort</button>
      <button id="clearOutBtn" type="button">Töm listan</button>
    </div>

    <pre id="out">[]</pre>
  </div>

<script>
  // ============================================================
  // LocalStorage keys (måste matcha trees.html + place-picker.html)
  // ============================================================
  const KEY_TREES = "slakttradet_trees";
  const KEY_ACTIVE = "slakttradet_active_tree_id";
  const KEY_LAST_LOC = "slakttradet_last_location";

  // Per träd: slaktkort lagras under nyckeln "slakttradet_slaktkort_<treeId>"
  function cardsKey(treeId) { return "slakttradet_slaktkort_" + String(treeId); }

  // DOM
  const treeSelect = document.getElementById("treeSelect");
  const reloadTreesBtn = document.getElementById("reloadTreesBtn");
  const treeMsg = document.getElementById("treeMsg");

  const fornamnEl = document.getElementById("fornamn");
  const efternamnEl = document.getElementById("efternamn");
  const konEl = document.getElementById("kon");
  const fodelsearEl = document.getElementById("fodelsear");
  const dodsarEl = document.getElementById("dodsar");
  const platsEl = document.getElementById("plats");
  const coordsEl = document.getElementById("coords");
  const clearCoordsBtn = document.getElementById("clearCoordsBtn");
  const anteckningEl = document.getElementById("anteckning");

  const createBtn = document.getElementById("createBtn");
  const createMsg = document.getElementById("createMsg");

  const listBtn = document.getElementById("listBtn");
  const clearOutBtn = document.getElementById("clearOutBtn");
  const out = document.getElementById("out");

  // UI helpers
  function setMsg(el, type, text) {
    el.innerHTML = type === "error"
      ? "<span class='error'>" + text + "</span>"
      : type === "ok"
        ? "<span class='ok'>" + text + "</span>"
        : text;
  }

  function loadJson(key, fallback) {
    try {
      const raw = localStorage.getItem(key);
      if (!raw) return fallback;
      return JSON.parse(raw);
    } catch {
      return fallback;
    }
  }

  function saveJson(key, value) {
    localStorage.setItem(key, JSON.stringify(value));
  }

  function getActiveTreeId() {
    return localStorage.getItem(KEY_ACTIVE) || "";
  }

  function setActiveTreeId(id) {
    localStorage.setItem(KEY_ACTIVE, String(id));
  }

  function getSelectedTreeId() {
    const v = treeSelect.value;
    return v ? v : null;
  }

  function parseOptionalInt(el) {
    const raw = String(el.value || "").trim();
    if (!raw) return null;
    const n = Number(raw);
    return Number.isFinite(n) ? n : null;
  }

  function parseCoords(text) {
    const raw = String(text || "").trim();
    if (!raw) return null;

    const normalized = raw.replace(/\s+/g, " ");
    const partsComma = normalized.split(",").map(s => s.trim()).filter(Boolean);

    let a, b;
    if (partsComma.length === 2) { a = partsComma[0]; b = partsComma[1]; }
    else {
      const partsSpace = normalized.split(" ").filter(Boolean);
      if (partsSpace.length !== 2) return null;
      a = partsSpace[0]; b = partsSpace[1];
    }

    const lat = Number(a);
    const lon = Number(b);

    if (!Number.isFinite(lat) || !Number.isFinite(lon)) return null;
    if (lat < -90 || lat > 90) return null;
    if (lon < -180 || lon > 180) return null;

    return { lat, lon };
  }

  // ============================================================
  // Prefill coords från place-picker.html (localStorage)
  // ============================================================
  (function prefillCoordsFromLocalStorage() {
    const data = loadJson(KEY_LAST_LOC, null);
    if (!data || typeof data.lat !== "number" || typeof data.lon !== "number") return;
    coordsEl.value = `${data.lat}, ${data.lon}`;
  })();

  clearCoordsBtn.addEventListener("click", () => {
    coordsEl.value = "";
    setMsg(createMsg, "", "Koordinater rensade.");
  });

  // ============================================================
  // Trees (localStorage)
  // ============================================================
  function loadTrees() {
    setMsg(treeMsg, "", "Laddar…");
    const trees = loadJson(KEY_TREES, []);
    const activeId = getActiveTreeId();

    treeSelect.innerHTML = "";

    if (!Array.isArray(trees) || trees.length === 0) {
      treeSelect.innerHTML = "<option value=''>Inga träd ännu</option>";
      setMsg(treeMsg, "error", "Inga träd sparade. Gå till 'Skapa/Välj träd' och skapa ett träd.");
      return;
    }

    treeSelect.innerHTML = "<option value=''>Välj…</option>";
    for (const t of trees) {
      const opt = document.createElement("option");
      opt.value = String(t.id);
      opt.textContent = `${t.name}${String(t.id) === activeId ? " (aktivt)" : ""}`;
      treeSelect.appendChild(opt);
    }

    if (activeId) {
      treeSelect.value = activeId;
    } else {
      const firstId = String(trees[0].id);
      treeSelect.value = firstId;
      setActiveTreeId(firstId);
    }

    setMsg(treeMsg, "ok", "Träd laddade (localStorage).");
  }

  treeSelect.addEventListener("change", () => {
    if (treeSelect.value) setActiveTreeId(treeSelect.value);
  });

  reloadTreesBtn.addEventListener("click", loadTrees);

  // ============================================================
  // Släktkort (localStorage per tree)
  // ============================================================
  function makeCardId() {
    return "p" + Date.now().toString().slice(-10);
  }

  function loadCards(treeId) {
    return loadJson(cardsKey(treeId), []);
  }

  function saveCards(treeId, cards) {
    saveJson(cardsKey(treeId), cards);
  }

  function createSlaktkort() {
    createMsg.textContent = "";

    const treeId = getSelectedTreeId();
    if (!treeId) return setMsg(createMsg, "error", "Välj ett träd först.");

    const coords = parseCoords(coordsEl.value);

    const payload = {
      id: makeCardId(),
      fornamn: String(fornamnEl.value || "").trim(),
      efternamn: String(efternamnEl.value || "").trim(),
      kon: konEl.value,
      fodelsear: parseOptionalInt(fodelsearEl),
      dodsar: parseOptionalInt(dodsarEl),
      plats: String(platsEl.value || "").trim(),
      coords: coords,
      anteckning: String(anteckningEl.value || "").trim(),
      createdAt: new Date().toISOString()
    };

    if (!payload.fornamn && !payload.efternamn) {
      return setMsg(createMsg, "error", "Fyll i minst förnamn eller efternamn.");
    }
    if (coordsEl.value.trim() && !coords) {
      return setMsg(createMsg, "error", "Koordinater måste vara 'lat, lon' (ex: 59.3293, 18.0686).");
    }

    const cards = loadCards(treeId);
    cards.push(payload);
    saveCards(treeId, cards);

    setMsg(createMsg, "ok", `Släktkort sparat lokalt (id: ${payload.id}).`);
  }

  function listSlaktkort() {
    const treeId = getSelectedTreeId();
    if (!treeId) {
      out.textContent = "[]";
      return setMsg(treeMsg, "error", "Välj ett träd först.");
    }

    const cards = loadCards(treeId);
    out.textContent = JSON.stringify({ slaktkort: cards }, null, 2);
    setMsg(treeMsg, "ok", `Hämtade ${cards.length} släktkort (localStorage).`);
  }

  createBtn.addEventListener("click", createSlaktkort);
  listBtn.addEventListener("click", listSlaktkort);
  clearOutBtn.addEventListener("click", () => { out.textContent = "[]"; });

  // Start
  loadTrees();
</script>
</body>
</html>
