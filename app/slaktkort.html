<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Personer ‚Äì Sl√§ktkort</title>
  <meta name="description" content="Skapa och lista sl√§ktkort per aktivt tr√§d (localStorage)." />

  <style>
    :root { color-scheme: light; }
    body{
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      line-height: 1.5;
      margin: 0;
      padding: 24px;
      max-width: 980px;
      margin-inline: auto;
      background: #fff;
      color: #111;
    }
    a{ color: inherit; text-decoration: none; }
    header{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 12px;
      margin-bottom: 18px;
    }
    h1{ margin: 0 0 6px; font-size: 1.6rem; }
    p{ margin: 0 0 12px; }
    .muted{ color:#555; }

    .topbar{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      margin: 10px 0 0;
    }

    .btn, button{
      display:inline-block;
      padding: 10px 12px;
      border: 1px solid #333;
      border-radius: 10px;
      background: #fff;
      font: inherit;
      cursor: pointer;
      text-decoration:none;
    }
    .btn.secondary{
      border-color:#bbb;
      color:#111;
    }
    .btn.danger{
      border-color:#b00020;
      color:#b00020;
    }
    .btn.disabled{
      opacity: .45;
      cursor: not-allowed;
      pointer-events: none;
    }

    .pillRow{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      margin: 10px 0 18px;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 8px 10px;
      border: 1px solid #ddd;
      border-radius: 999px;
      background: #fafafa;
      font-size: .95rem;
    }
    .pill strong{ font-weight: 900; }
    .pill.ok{ border-color:#cfe8cf; background:#f5fff5; }
    .pill.warn{ border-color:#ffe1a6; background:#fff9ee; }

    .note{
      margin: 0 0 18px;
      padding: 12px;
      border-radius: 12px;
      border: 1px solid #ffe1a6;
      background: #fff9ee;
    }
    .note strong{ font-weight: 900; }

    .grid{
      display:grid;
      gap: 14px;
      grid-template-columns: 1fr;
    }
    @media (min-width: 860px){
      .grid{ grid-template-columns: 1fr 1fr; }
    }

    .card{
      border: 1px solid #ddd;
      border-radius: 12px;
      padding: 16px;
      background: #fff;
    }
    .card h2{
      margin: 0 0 6px;
      font-size: 1.15rem;
    }
    .small{ font-size: .95rem; color:#555; margin: 0 0 10px; }

    label{ display:block; margin: 10px 0 6px; font-weight: 800; }
    input, select, textarea{
      width: 100%;
      box-sizing: border-box;
      padding: 10px;
      border-radius: 10px;
      border: 1px solid #bbb;
      font: inherit;
      background: #fff;
    }
    textarea{ min-height: 96px; resize: vertical; }

    .row2{
      display:grid;
      grid-template-columns: 1fr;
      gap: 12px;
    }
    @media (min-width: 720px){
      .row2{ grid-template-columns: 1fr 1fr; }
    }

    .actionsRow{
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
      margin-top: 10px;
    }

    .error{ color:#b00020; font-weight: 900; }
    .ok{ font-weight: 900; }

    pre{
      white-space: pre-wrap;
      background:#f4f4f4;
      padding: 12px;
      border-radius: 12px;
      overflow:auto;
      margin: 10px 0 0;
    }
    code{ background:#f4f4f4; padding:2px 6px; border-radius:6px; }

    footer{
      margin-top: 18px;
      color:#666;
      font-size: .95rem;
    }
    hr{ border:none; border-top:1px solid #eee; margin: 18px 0; }
  </style>
</head>

<body>
<header>
  <div>
    <h1>üë§ Personer ‚Äì Sl√§ktkort</h1>
    <p class="muted">Steg 2 i fl√∂det. Skapa personer i det aktiva tr√§det (localStorage-first).</p>

    <nav class="topbar" aria-label="Navigation">
      <a class="btn secondary" href="start.html">Start</a>
      <a class="btn secondary" href="trees.html">Tr√§d</a>
      <a class="btn secondary" href="slaktkort.html">Personer</a>
      <a class="btn secondary" href="create-relation.html">Relationer</a>
      <a class="btn secondary" href="map.html">Karta</a>
    </nav>
  </div>

  <div class="actionsRow" style="justify-content:flex-end; max-width: 360px;">
    <a class="btn secondary" href="place-picker.html" title="V√§lj koordinater via karta">Plats-picker</a>
    <button id="logoutBtn" class="btn secondary" type="button" title="Estetisk utloggning">Logga ut</button>
  </div>
</header>

<section class="pillRow" aria-label="Status">
  <span id="pillTree" class="pill warn">Aktivt tr√§d: <strong>‚Äî</strong></span>
  <span id="pillPeople" class="pill">Personer i tr√§det: <strong>0</strong></span>
  <span id="pillNext" class="pill warn">N√§sta steg: <strong>V√§lj tr√§d</strong></span>
</section>

<div id="noteBox" class="note" hidden></div>

<section class="grid" aria-label="Personfunktioner">
  <!-- 1) Tr√§dval -->
  <article class="card">
    <h2>1) Tr√§d</h2>
    <p class="small">Personer sparas per tr√§d. Du kan byta aktivt tr√§d h√§r.</p>

    <label for="treeSelect">Tr√§d</label>
    <select id="treeSelect" aria-label="V√§lj tr√§d"></select>

    <div class="actionsRow">
      <button id="reloadTreesBtn" type="button" class="btn secondary">Ladda tr√§d</button>
      <a class="btn" href="trees.html">G√• till Tr√§d</a>
      <a id="continueToRelsTop" class="btn disabled" href="create-relation.html" aria-disabled="true" tabindex="-1">Forts√§tt ‚Üí Relationer</a>
    </div>

    <p id="treeMsg" class="small" aria-live="polite"></p>
  </article>

  <!-- 2) Skapa person -->
  <article class="card">
    <h2>2) Skapa sl√§ktkort</h2>

    <div class="row2">
      <div>
        <label for="fornamn">F√∂rnamn</label>
        <input id="fornamn" placeholder="t.ex. Anna" />
      </div>
      <div>
        <label for="efternamn">Efternamn</label>
        <input id="efternamn" placeholder="t.ex. Andersson" />
      </div>
    </div>

    <label for="kon">K√∂n</label>
    <select id="kon">
      <option>Ok√§nt</option>
      <option>Man</option>
      <option>Kvinna</option>
    </select>

    <div class="row2">
      <div>
        <label for="fodelsear">F√∂delse√•r (valfritt)</label>
        <input id="fodelsear" type="number" placeholder="t.ex. 1874" />
      </div>
      <div>
        <label for="dodsar">D√∂ds√•r (valfritt)</label>
        <input id="dodsar" type="number" placeholder="t.ex. 1942" />
      </div>
    </div>

    <label for="plats">Plats (valfritt)</label>
    <input id="plats" placeholder="t.ex. Uppsala" />

    <label for="coords">Koordinater (lat, lon) (valfritt)</label>
    <input id="coords" placeholder="t.ex. 59.3293, 18.0686" />

    <div class="actionsRow">
      <a class="btn secondary" href="place-picker.html">V√§lj koordinater via karta</a>
      <button type="button" class="btn secondary" id="clearCoordsBtn">Rensa koordinater</button>
      <button type="button" class="btn" id="useLastLocBtn" title="H√§mtar senaste platsen fr√•n place-picker">Anv√§nd senaste plats</button>
    </div>

    <label for="anteckning">Anteckning (valfritt)</label>
    <textarea id="anteckning" placeholder="fri text"></textarea>

    <div class="actionsRow">
      <button id="createBtn" type="button" class="btn">Spara sl√§ktkort</button>
      <button id="resetFormBtn" type="button" class="btn secondary">Rensa f√§lt</button>
      <a id="continueToRels" class="btn disabled" href="create-relation.html" aria-disabled="true" tabindex="-1">Forts√§tt ‚Üí Relationer</a>
    </div>

    <p id="createMsg" class="small" aria-live="polite"></p>
  </article>

  <!-- 3) Lista -->
  <article class="card" style="grid-column: 1 / -1;">
    <h2>3) Lista personer i aktivt tr√§d</h2>
    <p class="small">Visas som JSON (demo).</p>

    <div class="actionsRow">
      <button id="listBtn" type="button" class="btn secondary">H√§mta sl√§ktkort</button>
      <button id="clearOutBtn" type="button" class="btn secondary">T√∂m listan</button>
      <button id="deleteAllCardsBtn" type="button" class="btn danger" title="Tar bort alla personer i aktivt tr√§d">Radera alla personer i tr√§det</button>
    </div>

    <pre id="out">[]</pre>
  </article>
</section>

<footer>
  Tips: N√§r du har minst <strong>2 personer</strong> kan du g√• vidare till <strong>Relationer</strong>.
</footer>

<script>
  // ============================
  // Estetisk "auth" (flow, inte s√§kerhet)
  // ============================
  (function authGuard(){
    try{
      if(sessionStorage.getItem("demo_auth") !== "1"){
        window.location.href = "index.html";
      }
    }catch{
      // Om sessionStorage √§r l√•st: till√•t √§nd√• (demo)
    }
  })();

  // ============================================================
  // LocalStorage keys (m√•ste matcha trees.html + place-picker.html)
  // ============================================================
  const KEY_TREES    = "slakttradet_trees";
  const KEY_ACTIVE   = "slakttradet_active_tree_id";
  const KEY_LAST_LOC = "slakttradet_last_location";

  function cardsKey(treeId){ return "slakttradet_slaktkort_" + String(treeId); }

  // DOM
  const pillTree   = document.getElementById("pillTree");
  const pillPeople = document.getElementById("pillPeople");
  const pillNext   = document.getElementById("pillNext");
  const noteBox    = document.getElementById("noteBox");

  const logoutBtn  = document.getElementById("logoutBtn");

  const treeSelect     = document.getElementById("treeSelect");
  const reloadTreesBtn = document.getElementById("reloadTreesBtn");
  const treeMsg        = document.getElementById("treeMsg");

  const fornamnEl   = document.getElementById("fornamn");
  const efternamnEl = document.getElementById("efternamn");
  const konEl       = document.getElementById("kon");
  const fodelsearEl = document.getElementById("fodelsear");
  const dodsarEl    = document.getElementById("dodsar");
  const platsEl     = document.getElementById("plats");
  const coordsEl    = document.getElementById("coords");
  const clearCoordsBtn = document.getElementById("clearCoordsBtn");
  const useLastLocBtn  = document.getElementById("useLastLocBtn");
  const anteckningEl   = document.getElementById("anteckning");

  const createBtn   = document.getElementById("createBtn");
  const resetFormBtn= document.getElementById("resetFormBtn");
  const createMsg   = document.getElementById("createMsg");

  const listBtn     = document.getElementById("listBtn");
  const clearOutBtn = document.getElementById("clearOutBtn");
  const deleteAllCardsBtn = document.getElementById("deleteAllCardsBtn");
  const out         = document.getElementById("out");

  const continueToRels = document.getElementById("continueToRels");
  const continueToRelsTop = document.getElementById("continueToRelsTop");

  // Helpers
  function setDisabled(el, disabled){
    if(disabled){
      el.classList.add("disabled");
      el.setAttribute("aria-disabled","true");
      el.setAttribute("tabindex","-1");
    }else{
      el.classList.remove("disabled");
      el.removeAttribute("aria-disabled");
      el.removeAttribute("tabindex");
    }
  }

  function setMsg(el, type, text){
    el.innerHTML = type === "error"
      ? "<span class='error'>" + text + "</span>"
      : type === "ok"
        ? "<span class='ok'>" + text + "</span>"
        : text;
  }

  function loadJson(key, fallback){
    try{
      const raw = localStorage.getItem(key);
      if(!raw) return fallback;
      return JSON.parse(raw);
    }catch{
      return fallback;
    }
  }

  function saveJson(key, value){
    localStorage.setItem(key, JSON.stringify(value));
  }

  function getActiveTreeId(){
    return localStorage.getItem(KEY_ACTIVE) || "";
  }

  function setActiveTreeId(id){
    localStorage.setItem(KEY_ACTIVE, String(id || ""));
  }

  function getSelectedTreeId(){
    const v = treeSelect.value;
    return v ? v : null;
  }

  function parseOptionalInt(el){
    const raw = String(el.value || "").trim();
    if(!raw) return null;
    const n = Number(raw);
    return Number.isFinite(n) ? n : null;
  }

  function parseCoords(text){
    const raw = String(text || "").trim();
    if(!raw) return null;

    const normalized = raw.replace(/\s+/g, " ");
    const partsComma = normalized.split(",").map(s => s.trim()).filter(Boolean);

    let a, b;
    if(partsComma.length === 2){ a = partsComma[0]; b = partsComma[1]; }
    else{
      const partsSpace = normalized.split(" ").filter(Boolean);
      if(partsSpace.length !== 2) return null;
      a = partsSpace[0]; b = partsSpace[1];
    }

    const lat = Number(a);
    const lon = Number(b);

    if(!Number.isFinite(lat) || !Number.isFinite(lon)) return null;
    if(lat < -90 || lat > 90) return null;
    if(lon < -180 || lon > 180) return null;

    return { lat, lon };
  }

  function normalizeCoordsString(coords){
    if(!coords) return "";
    return `${coords.lat}, ${coords.lon}`;
  }

  function makeCardId(){
    return "p" + Date.now().toString(36) + Math.random().toString(36).slice(2, 6);
  }

  function loadCards(treeId){
    const cards = loadJson(cardsKey(treeId), []);
    return Array.isArray(cards) ? cards : [];
  }

  function saveCards(treeId, cards){
    saveJson(cardsKey(treeId), cards);
  }

  function countCards(treeId){
    if(!treeId) return 0;
    return loadCards(treeId).filter(p => p && p.id).length;
  }

  function refreshStatus(){
    const trees = loadJson(KEY_TREES, []);
    const activeId = getActiveTreeId();
    const activeTree = Array.isArray(trees) ? trees.find(t => String(t.id) === String(activeId)) : null;

    const treeLabel = activeTree ? (activeTree.name || activeTree.id) : (activeId || "‚Äî");

    const peopleCount = activeId ? countCards(activeId) : 0;

    // PILL: tree
    pillTree.classList.remove("ok","warn");
    pillTree.classList.add(activeId ? "ok" : "warn");
    pillTree.innerHTML = 'Aktivt tr√§d: <strong>' + (activeId ? treeLabel : "‚Äî") + '</strong>';

    // PILL: people count
    pillPeople.innerHTML = 'Personer i tr√§det: <strong>' + peopleCount + '</strong>';

    // Note + Next
    if(!Array.isArray(trees) || trees.length === 0){
      noteBox.hidden = false;
      noteBox.innerHTML = '<strong>üö© Inga tr√§d sparade:</strong> G√• till <a href="trees.html">Tr√§d</a> och skapa ett tr√§d.';
      pillNext.classList.remove("ok"); pillNext.classList.add("warn");
      pillNext.innerHTML = 'N√§sta steg: <strong>Skapa tr√§d</strong>';
      setDisabled(continueToRels, true);
      setDisabled(continueToRelsTop, true);
      return;
    }

    if(!activeId){
      noteBox.hidden = false;
      noteBox.innerHTML = '<strong>üö© Inget aktivt tr√§d valt:</strong> G√• till <a href="trees.html">Tr√§d</a> och v√§lj ett aktivt tr√§d.';
      pillNext.classList.remove("ok"); pillNext.classList.add("warn");
      pillNext.innerHTML = 'N√§sta steg: <strong>V√§lj aktivt tr√§d</strong>';
      setDisabled(continueToRels, true);
      setDisabled(continueToRelsTop, true);
      return;
    }

    // Active tree exists
    if(peopleCount < 2){
      noteBox.hidden = false;
      noteBox.innerHTML = '<strong>Tip:</strong> L√§gg till minst <strong>2 personer</strong> innan du g√•r vidare till Relationer.';
      pillNext.classList.remove("ok"); pillNext.classList.add("warn");
      pillNext.innerHTML = 'N√§sta steg: <strong>L√§gg till fler personer</strong>';
      setDisabled(continueToRels, true);
      setDisabled(continueToRelsTop, true);
      return;
    }

    // Ready for relations
    noteBox.hidden = true;
    pillNext.classList.remove("warn"); pillNext.classList.add("ok");
    pillNext.innerHTML = 'N√§sta steg: <strong>Relationer</strong>';
    setDisabled(continueToRels, false);
    setDisabled(continueToRelsTop, false);
  }

  // Prefill coords fr√•n place-picker (localStorage)
  function prefillCoordsFromLocalStorage(){
    const data = loadJson(KEY_LAST_LOC, null);
    if(!data || typeof data.lat !== "number" || typeof data.lon !== "number") return;
    coordsEl.value = normalizeCoordsString({ lat: data.lat, lon: data.lon });
  }

  // Trees
  function loadTrees(){
    setMsg(treeMsg, "", "Laddar‚Ä¶");

    const trees = loadJson(KEY_TREES, []);
    const activeId = getActiveTreeId();

    treeSelect.innerHTML = "";

    if(!Array.isArray(trees) || trees.length === 0){
      treeSelect.innerHTML = "<option value=''>Inga tr√§d √§nnu</option>";
      setMsg(treeMsg, "error", "Inga tr√§d sparade. G√• till 'Tr√§d' och skapa ett tr√§d.");
      refreshStatus();
      return;
    }

    treeSelect.innerHTML = "<option value=''>V√§lj‚Ä¶</option>";
    for(const t of trees){
      const opt = document.createElement("option");
      opt.value = String(t.id);
      opt.textContent = `${t.name}${String(t.id) === String(activeId) ? " (aktivt)" : ""}`;
      treeSelect.appendChild(opt);
    }

    if(activeId){
      treeSelect.value = activeId;
    }else{
      const firstId = String(trees[0].id);
      treeSelect.value = firstId;
      setActiveTreeId(firstId);
    }

    setMsg(treeMsg, "ok", "Tr√§d laddade (localStorage).");
    refreshStatus();
  }

  treeSelect.addEventListener("change", () => {
    if(treeSelect.value){
      setActiveTreeId(treeSelect.value);
      refreshStatus();
    }
  });

  reloadTreesBtn.addEventListener("click", loadTrees);

  // Actions
  clearCoordsBtn.addEventListener("click", () => {
    coordsEl.value = "";
    setMsg(createMsg, "", "Koordinater rensade.");
  });

  useLastLocBtn.addEventListener("click", () => {
    const data = loadJson(KEY_LAST_LOC, null);
    if(!data || typeof data.lat !== "number" || typeof data.lon !== "number"){
      setMsg(createMsg, "error", "Ingen senaste plats hittades. √ñppna Plats-picker och v√§lj en punkt f√∂rst.");
      return;
    }
    coordsEl.value = normalizeCoordsString({ lat: data.lat, lon: data.lon });
    setMsg(createMsg, "ok", "Senaste platsen anv√§ndes.");
  });

  resetFormBtn.addEventListener("click", () => {
    fornamnEl.value = "";
    efternamnEl.value = "";
    konEl.value = "Ok√§nt";
    fodelsearEl.value = "";
    dodsarEl.value = "";
    platsEl.value = "";
    coordsEl.value = "";
    anteckningEl.value = "";
    setMsg(createMsg, "", "");
  });

  function createSlaktkort(){
    createMsg.textContent = "";

    const treeId = getSelectedTreeId() || getActiveTreeId();
    if(!treeId) return setMsg(createMsg, "error", "V√§lj ett tr√§d f√∂rst.");

    const coords = parseCoords(coordsEl.value);

    const payload = {
      id: makeCardId(),
      fornamn: String(fornamnEl.value || "").trim(),
      efternamn: String(efternamnEl.value || "").trim(),
      kon: konEl.value,
      fodelsear: parseOptionalInt(fodelsearEl),
      dodsar: parseOptionalInt(dodsarEl),
      plats: String(platsEl.value || "").trim(),
      coords: coords,
      anteckning: String(anteckningEl.value || "").trim(),
      createdAt: new Date().toISOString()
    };

    if(!payload.fornamn && !payload.efternamn){
      return setMsg(createMsg, "error", "Fyll i minst f√∂rnamn eller efternamn.");
    }
    if(coordsEl.value.trim() && !coords){
      return setMsg(createMsg, "error", "Koordinater m√•ste vara 'lat, lon' (ex: 59.3293, 18.0686).");
    }

    const cards = loadCards(treeId);
    cards.push(payload);
    saveCards(treeId, cards);

    setMsg(createMsg, "ok", `Sl√§ktkort sparat lokalt (id: ${payload.id}).`);
    refreshStatus();
  }

  function listSlaktkort(){
    const treeId = getSelectedTreeId() || getActiveTreeId();
    if(!treeId){
      out.textContent = "[]";
      return setMsg(treeMsg, "error", "V√§lj ett tr√§d f√∂rst.");
    }

    const cards = loadCards(treeId);
    out.textContent = JSON.stringify({ slaktkort: cards }, null, 2);
    setMsg(treeMsg, "ok", `H√§mtade ${cards.length} sl√§ktkort (localStorage).`);
    refreshStatus();
  }

  function deleteAllCardsInTree(){
    const treeId = getSelectedTreeId() || getActiveTreeId();
    if(!treeId) return setMsg(treeMsg, "error", "V√§lj ett tr√§d f√∂rst.");

    saveCards(treeId, []);
    out.textContent = "[]";
    setMsg(treeMsg, "ok", "Alla personer i aktivt tr√§d raderade.");
    refreshStatus();
  }

  createBtn.addEventListener("click", createSlaktkort);
  listBtn.addEventListener("click", listSlaktkort);
  clearOutBtn.addEventListener("click", () => { out.textContent = "[]"; });
  deleteAllCardsBtn.addEventListener("click", deleteAllCardsInTree);

  // Prefill coords on load (om senaste plats finns)
  prefillCoordsFromLocalStorage();

  // Logout
  logoutBtn.addEventListener("click", () => {
    try{ sessionStorage.removeItem("demo_auth"); }catch{}
    window.location.href = "index.html";
  });

  // Start
  loadTrees();
</script>
</body>
</html>
