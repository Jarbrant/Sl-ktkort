<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Personer ‚Äì Sl√§ktkort</title>
  <meta name="description" content="Skapa och redigera personer i aktivt tr√§d. Grundrelationer skapas i Relationer." />

  <style>
    :root{
      color-scheme: light;

      --bg: #fbfaf7;
      --panel: #ffffff;
      --text: #1b1f24;
      --muted: #5a6672;
      --border: rgba(27,31,36,.14);

      --accent: #2f7d5c;
      --accent-2: #1f6f8b;
      --warn: #b07a1a;
      --danger: #a33a3a;

      --soft-accent: rgba(47,125,92,.10);
      --soft-accent-2: rgba(31,111,139,.10);
      --soft-warn: rgba(176,122,26,.12);
      --soft-danger: rgba(163,58,58,.10);

      --shadow: 0 10px 34px rgba(0,0,0,.06);
      --radius: 16px;
    }

    body{
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      line-height: 1.5;
      margin: 0;
      padding: 24px;
      max-width: 1180px;
      margin-inline: auto;
      background: var(--bg);
      color: var(--text);
    }

    a{ color: inherit; text-decoration: none; }

    header{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      margin-bottom: 16px;
    }

    h1{
      margin:0 0 6px;
      font-size: 1.7rem;
      letter-spacing: -0.01em;
    }
    .muted{ color: var(--muted); margin:0; }
    .small{ font-size:.95rem; color: var(--muted); margin:0; }

    .topbar{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      margin-top: 10px;
    }

    .btn, button{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      padding:10px 12px;
      border:1px solid var(--border);
      border-radius: 12px;
      background: var(--panel);
      font: inherit;
      cursor: pointer;
      text-decoration:none;
      box-shadow: 0 6px 18px rgba(0,0,0,.04);
    }
    .btn.secondary{ background: var(--panel); }
    .btn.primary{
      border-color: rgba(47,125,92,.35);
      background: linear-gradient(180deg, rgba(47,125,92,.14), rgba(47,125,92,.08));
      color: var(--text);
      font-weight: 900;
    }
    .btn.ghost{
      background: transparent;
      box-shadow:none;
    }
    .btn.danger{
      border-color: rgba(163,58,58,.35);
      background: linear-gradient(180deg, rgba(163,58,58,.12), rgba(163,58,58,.06));
      color: var(--danger);
      font-weight: 900;
    }
    .btn.disabled, button:disabled{
      opacity: .45;
      cursor: not-allowed;
      pointer-events: none;
      box-shadow:none;
    }

    .btn:focus-visible, button:focus-visible, a:focus-visible, input:focus-visible, textarea:focus-visible, select:focus-visible{
      outline: 3px solid rgba(31,111,139,.22);
      outline-offset: 2px;
      border-radius: 12px;
    }

    .stack{ display:flex; flex-direction:column; gap:12px; }

    .card{
      border:1px solid var(--border);
      border-radius: var(--radius);
      padding: 16px;
      background: var(--panel);
      box-shadow: var(--shadow);
    }

    .pillRow{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border:1px solid var(--border);
      border-radius:999px;
      background: rgba(255,255,255,.75);
      font-size:.95rem;
      white-space:nowrap;
    }
    .pill strong{ font-weight: 950; }
    .pill.ok{
      border-color: rgba(47,125,92,.30);
      background: var(--soft-accent);
    }
    .pill.warn{
      border-color: rgba(176,122,26,.30);
      background: var(--soft-warn);
    }
    .pill.info{
      border-color: rgba(31,111,139,.30);
      background: var(--soft-accent-2);
    }

    .grid{
      display:grid;
      gap:14px;
      grid-template-columns: 1fr;
      align-items:start;
    }
    @media (min-width: 980px){
      .grid{ grid-template-columns: 0.9fr 1.1fr; } /* v√§nster: s√∂k/lista, h√∂ger: formul√§r */
    }

    .sectionTitle{
      margin:0 0 6px;
      font-size: 1.12rem;
      font-weight: 950;
      letter-spacing: -0.01em;
    }

    label{
      display:block;
      margin: 10px 0 6px;
      font-weight: 850;
    }

    input, select, textarea{
      width:100%;
      box-sizing:border-box;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(27,31,36,.22);
      font: inherit;
      background: #fff;
      color: var(--text);
    }
    textarea{ min-height: 110px; resize: vertical; }

    .row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      margin-top: 10px;
    }
    .row > *{ flex: 1; min-width: 180px; }

    .hintBox{
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(31,111,139,.25);
      background: rgba(31,111,139,.08);
      color: var(--text);
    }

    .noteBox{
      padding: 12px;
      border-radius: 14px;
      border: 1px solid rgba(176,122,26,.25);
      background: rgba(176,122,26,.10);
    }
    .noteBox strong{ font-weight: 950; }

    .msg{
      margin: 10px 0 0;
      color: var(--muted);
    }
    .msg strong{ color: var(--text); }

    .list{
      margin: 10px 0 0;
      padding: 0;
      list-style: none;
      display:flex;
      flex-direction:column;
      gap:10px;
      max-height: 520px;
      overflow:auto;
      border-top: 1px solid rgba(27,31,36,.08);
      padding-top: 10px;
    }

    .item{
      border:1px solid rgba(27,31,36,.10);
      border-radius: 14px;
      padding: 10px 12px;
      background: #fff;
      cursor:pointer;
      transition: transform .10s ease, background .10s ease, border-color .10s ease;
    }
    .item:hover{
      transform: translateY(-1px);
      background: rgba(47,125,92,.06);
      border-color: rgba(47,125,92,.18);
    }
    .item.active{
      background: rgba(47,125,92,.10);
      border-color: rgba(47,125,92,.28);
      box-shadow: 0 10px 28px rgba(47,125,92,.12);
    }
    .itemTitle{
      margin:0 0 2px;
      font-weight: 950;
      letter-spacing: -0.01em;
    }
    .itemMeta{
      margin:0;
      color: var(--muted);
      font-size: .95rem;
    }

    .chips{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-top: 8px;
    }
    .chip{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border: 1px solid rgba(27,31,36,.12);
      border-radius: 999px;
      background: rgba(255,255,255,.7);
      cursor:pointer;
      font: inherit;
    }
    .chip:hover{
      background: rgba(31,111,139,.08);
      border-color: rgba(31,111,139,.20);
    }
    .chip small{ color: var(--muted); font-weight: 800; }

    details{
      border:1px solid rgba(27,31,36,.10);
      border-radius: 14px;
      padding: 10px 12px;
      background: rgba(255,255,255,.75);
    }
    summary{ cursor:pointer; font-weight: 950; }
    pre{
      background: rgba(27,31,36,.06);
      padding: 12px;
      border-radius: 14px;
      overflow:auto;
      white-space: pre-wrap;
      margin: 10px 0 0;
    }
    code{ background: rgba(27,31,36,.06); padding: 2px 6px; border-radius: 8px; }

    .srOnly{
      position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden;
      clip: rect(0,0,0,0); border:0;
    }
  </style>
</head>

<body>
  <script>
    (function authGuard(){
      try{
        if(sessionStorage.getItem("demo_auth") !== "1"){
          window.location.href = "../index.html";
        }
      }catch{}
    })();
  </script>

  <header>
    <div style="min-width:0;">
      <h1>Personer</h1>
      <p class="muted">Skapa och √§ndra personer. Grundrelationer skapas i <code>Relationer</code>.</p>

      <nav class="topbar" aria-label="Navigation">
        <a class="btn secondary" href="../start.html">Start</a>
        <a class="btn secondary" href="./trees.html">Tr√§d</a>
        <a class="btn secondary" href="./slaktkort.html" aria-current="page">Personer</a>
        <a class="btn secondary" href="./create-relation.html">Relationer</a>
        <a class="btn secondary" href="./map.html">Karta</a>
      </nav>
    </div>

    <div class="row" style="justify-content:flex-end; max-width: 520px;">
      <button id="supportBtn" class="btn ghost" type="button" title="Kommer senare" aria-disabled="true" disabled>
        Support (kommer)
      </button>
      <button id="logoutBtn" class="btn secondary" type="button">Logga ut</button>
    </div>
  </header>

  <main class="stack" aria-label="Personpanel">
    <!-- STATUS / GUIDANCE -->
    <section class="card" aria-label="Status">
      <div class="pillRow" role="group" aria-label="Statusrader">
        <span id="pillActive" class="pill warn">Tr√§d: <strong>‚Äî</strong></span>
        <span id="pillCounts" class="pill info">Personer: <strong>0</strong></span>
        <span id="pillRel" class="pill info">Relationer: <strong>0</strong></span>
        <span id="pillCoords" class="pill info">Med plats: <strong>0</strong></span>
      </div>

      <div id="guideBox" class="hintBox" style="margin-top:12px;">
        Steg 1: S√∂k och v√§lj en person (minst 3 bokst√§ver) ‚Äì eller klicka <strong>Skapa person</strong>.
      </div>

      <div id="noteBox" class="noteBox" style="margin-top:12px;" hidden></div>
    </section>

    <div class="grid">
      <!-- V√ÑNSTER: S√ñK + LISTA -->
      <section class="card" aria-label="Personer i aktivt tr√§d">
        <p class="sectionTitle" style="margin-bottom:2px;">S√∂k person</p>
        <p class="small">Skriv minst 3 bokst√§ver. D√• visas f√∂rslag. (Du kan ocks√• visa alla.)</p>

        <label for="search">S√∂k</label>
        <input id="search" placeholder="t.ex. sti / nil / falun‚Ä¶" autocomplete="off" />

        <div class="row">
          <button id="showAllBtn" class="btn secondary" type="button">Visa alla</button>
          <button id="clearSearchBtn" class="btn ghost" type="button">Rensa</button>
        </div>

        <p id="listMsg" class="msg" aria-live="polite"></p>
        <ul id="peopleList" class="list" aria-label="Personlista"></ul>

        <details id="debugDetails" style="margin-top:12px;" hidden>
          <summary>Visa JSON (debug)</summary>
          <pre id="debugOut">[]</pre>
        </details>
      </section>

      <!-- H√ñGER: FORM + RELATIONER -->
      <section class="stack" aria-label="Form & relationer">
        <section class="card" aria-label="Skapa person">
          <p class="sectionTitle" style="margin-bottom:2px;">Skapa person</p>
          <p class="small">V√§lj en person i listan f√∂r att redigera. Annars skapar du ny h√§r.</p>

          <div class="row">
            <div>
              <label for="fornamn">F√∂rnamn</label>
              <input id="fornamn" placeholder="t.ex. Anna" autocomplete="off" />
            </div>
            <div>
              <label for="efternamn">Efternamn</label>
              <input id="efternamn" placeholder="t.ex. Nilsson" autocomplete="off" />
            </div>
          </div>

          <div class="row">
            <div>
              <label for="kon">K√∂n</label>
              <select id="kon">
                <option value="">Ok√§nt</option>
                <option value="Man">Man</option>
                <option value="Kvinna">Kvinna</option>
                <option value="Annat">Annat</option>
              </select>
            </div>
            <div>
              <label for="fodelsear">F√∂delse√•r (valfritt)</label>
              <input id="fodelsear" inputmode="numeric" placeholder="t.ex. 1874" />
            </div>
            <div>
              <label for="dodsar">D√∂ds√•r (valfritt)</label>
              <input id="dodsar" inputmode="numeric" placeholder="t.ex. 1932" />
            </div>
          </div>

          <div class="row">
            <div>
              <label for="plats">Plats (valfritt)</label>
              <input id="plats" placeholder="t.ex. Sm√•land / Falun" autocomplete="off" />
            </div>
            <div>
              <label for="coords">Koordinater (lat, lon) (valfritt)</label>
              <input id="coords" placeholder="t.ex. 60.6070, 15.6355" autocomplete="off" />
            </div>
          </div>

          <div class="row">
            <a class="btn secondary" href="./map.html">V√§lj p√• karta</a>
            <button id="clearCoordsBtn" class="btn ghost" type="button">Rensa coords</button>
          </div>

          <label for="anteckning">Anteckning (valfritt)</label>
          <textarea id="anteckning" placeholder="Skriv en kort anteckning‚Ä¶"></textarea>

          <div class="row">
            <button id="saveBtn" class="btn primary" type="button">Spara</button>
            <button id="newBtn" class="btn secondary" type="button">Skapa person</button>
            <button id="moreBtn" class="btn ghost" type="button" aria-expanded="false" aria-controls="morePanel">‚ãØ Mer</button>
          </div>

          <div id="morePanel" class="hintBox" style="margin-top:12px;" hidden>
            <div class="row" style="margin-top:0;">
              <button id="deleteBtn" class="btn danger" type="button">Ta bort person</button>
              <button id="clearDraftBtn" class="btn secondary" type="button">Rensa utkast</button>
            </div>
            <p class="small" style="margin-top:8px;">
              Tips: ‚ÄúRensa utkast‚Äù tar bara bort lokalt utkast ‚Äì inte sparade personer.
            </p>
          </div>

          <p id="formMsg" class="msg" aria-live="polite"></p>
        </section>

        <details class="card" aria-label="Ber√§knade relationer" id="relDetails">
          <summary>Ber√§knade relationer</summary>
          <p class="small" style="margin-top:8px;">
            Bygger p√• sparade relationer i <code>Relationer</code>. √Ñndra relationer d√§r ‚Äì s√• uppdateras det h√§r automatiskt.
          </p>

          <div id="relBox" class="hintBox" style="margin-top:12px;">
            V√§lj en person i listan (eller spara en ny) f√∂r att se relationer h√§r.
          </div>

          <div id="relGroups" class="stack" style="margin-top:12px;" hidden>
            <div>
              <p class="sectionTitle" style="font-size:1rem; margin:0 0 6px;">F√∂r√§ldrar</p>
              <div id="relParents" class="chips" aria-label="F√∂r√§ldrar"></div>
            </div>
            <div>
              <p class="sectionTitle" style="font-size:1rem; margin:0 0 6px;">Partner</p>
              <div id="relPartners" class="chips" aria-label="Partner"></div>
            </div>
            <div>
              <p class="sectionTitle" style="font-size:1rem; margin:0 0 6px;">Barn</p>
              <div id="relChildren" class="chips" aria-label="Barn"></div>
            </div>
            <div>
              <p class="sectionTitle" style="font-size:1rem; margin:0 0 6px;">Syskon</p>
              <div id="relSiblings" class="chips" aria-label="Syskon"></div>
            </div>
          </div>
        </details>
      </section>
    </div>
  </main>

  <script>
    // ============================
    // Storage keys (m√•ste matcha √∂vriga sidor)
    // ============================
    const KEY_TREES   = "slakttradet_trees";
    const KEY_ACTIVE  = "slakttradet_active_tree_id";

    const cardsKey = (treeId) => "slakttradet_slaktkort_" + String(treeId);
    const relKey   = (treeId) => "slakttradet_relationer_" + String(treeId);
    const draftKey = (treeId) => "slakttradet_person_draft_" + String(treeId);

    // ============================
    // DOM
    // ============================
    const logoutBtn = document.getElementById("logoutBtn");

    const pillActive = document.getElementById("pillActive");
    const pillCounts = document.getElementById("pillCounts");
    const pillRel    = document.getElementById("pillRel");
    const pillCoords = document.getElementById("pillCoords");

    const guideBox = document.getElementById("guideBox");
    const noteBox = document.getElementById("noteBox");

    const fornamnEl = document.getElementById("fornamn");
    const efternamnEl = document.getElementById("efternamn");
    const konEl = document.getElementById("kon");
    const fodelsearEl = document.getElementById("fodelsear");
    const dodsarEl = document.getElementById("dodsar");
    const platsEl = document.getElementById("plats");
    const coordsEl = document.getElementById("coords");
    const anteckningEl = document.getElementById("anteckning");

    const clearCoordsBtn = document.getElementById("clearCoordsBtn");
    const clearDraftBtn = document.getElementById("clearDraftBtn");

    const saveBtn = document.getElementById("saveBtn");
    const newBtn = document.getElementById("newBtn");
    const deleteBtn = document.getElementById("deleteBtn");
    const moreBtn = document.getElementById("moreBtn");
    const morePanel = document.getElementById("morePanel");
    const formMsg = document.getElementById("formMsg");

    const relBox = document.getElementById("relBox");
    const relGroups = document.getElementById("relGroups");
    const relParents = document.getElementById("relParents");
    const relPartners = document.getElementById("relPartners");
    const relChildren = document.getElementById("relChildren");
    const relSiblings = document.getElementById("relSiblings");

    const searchEl = document.getElementById("search");
    const showAllBtn = document.getElementById("showAllBtn");
    const clearSearchBtn = document.getElementById("clearSearchBtn");
    const listMsg = document.getElementById("listMsg");
    const peopleList = document.getElementById("peopleList");

    const debugDetails = document.getElementById("debugDetails");
    const debugOut = document.getElementById("debugOut");

    // ============================
    // Helpers
    // ============================
    function safeParse(raw, fallback){
      try{ return JSON.parse(raw); }catch{ return fallback; }
    }
    function loadJson(key, fallback){
      const raw = localStorage.getItem(key);
      return raw ? safeParse(raw, fallback) : fallback;
    }
    function saveJson(key, value){
      localStorage.setItem(key, JSON.stringify(value));
    }

    function activeTreeId(){
      return localStorage.getItem(KEY_ACTIVE) || "";
    }
    function getTrees(){
      const arr = loadJson(KEY_TREES, []);
      return Array.isArray(arr) ? arr : [];
    }
    function activeTreeObj(){
      const id = activeTreeId();
      if(!id) return null;
      return getTrees().find(t => String(t.id) === String(id)) || null;
    }

    function loadPeople(){
      const t = activeTreeId();
      if(!t) return [];
      const arr = loadJson(cardsKey(t), []);
      return Array.isArray(arr) ? arr : [];
    }
    function savePeople(arr){
      const t = activeTreeId();
      if(!t) return;
      saveJson(cardsKey(t), arr);
    }

    function loadRelations(){
      const t = activeTreeId();
      if(!t) return [];
      const arr = loadJson(relKey(t), []);
      return Array.isArray(arr) ? arr : [];
    }

    function makeId(){
      return "p" + Date.now().toString(36) + Math.random().toString(36).slice(2, 6);
    }

    function personName(p){
      const n = `${p.fornamn || ""} ${p.efternamn || ""}`.trim();
      return n || "(namnl√∂s)";
    }
    function yearsLine(p){
      const a = (p && p.fodelsear != null && String(p.fodelsear).trim() !== "") ? String(p.fodelsear).trim() : "";
      const b = (p && p.dodsar != null && String(p.dodsar).trim() !== "") ? String(p.dodsar).trim() : "";
      if(!a && !b) return "";
      if(a && b) return `${a}‚Äì${b}`;
      return a ? `${a}‚Äì` : `‚Äì${b}`;
    }

    function inLatLonRange(lat, lon){
      return Number.isFinite(lat) && Number.isFinite(lon) &&
        lat >= -90 && lat <= 90 &&
        lon >= -180 && lon <= 180;
    }
    function parseCoords(str){
      const s = String(str || "").trim();
      if(!s) return null;
      const parts = s.includes(",")
        ? s.split(",").map(x => x.trim()).filter(Boolean)
        : s.split(/\s+/).map(x => x.trim()).filter(Boolean);
      if(parts.length !== 2) return null;
      const lat = Number(parts[0]);
      const lon = Number(parts[1]);
      if(!inLatLonRange(lat, lon)) return null;
      return { lat, lon };
    }

    function setPill(el, kind, html){
      el.className = "pill " + (kind || "");
      el.innerHTML = html;
    }

    function getPersonById(people, id){
      return people.find(p => String(p.id) === String(id)) || null;
    }

    // ============================
    // Draft (utkast)
    // ============================
    let draftTimer = null;
    function saveDraft(){
      const t = activeTreeId();
      if(!t) return;

      const d = {
        selectedId,
        fornamn: fornamnEl.value,
        efternamn: efternamnEl.value,
        kon: konEl.value,
        fodelsear: fodelsearEl.value,
        dodsar: dodsarEl.value,
        plats: platsEl.value,
        coords: coordsEl.value,
        anteckning: anteckningEl.value,
        savedAt: new Date().toISOString()
      };

      localStorage.setItem(draftKey(t), JSON.stringify(d));
    }
    function scheduleDraft(){
      if(draftTimer) clearTimeout(draftTimer);
      draftTimer = setTimeout(saveDraft, 180);
    }
    function loadDraft(){
      const t = activeTreeId();
      if(!t) return null;
      const raw = localStorage.getItem(draftKey(t));
      return raw ? safeParse(raw, null) : null;
    }
    function clearDraft(){
      const t = activeTreeId();
      if(!t) return;
      localStorage.removeItem(draftKey(t));
    }

    // ============================
    // State
    // ============================
    let selectedId = ""; // person.id (edit) or "" (new)
    let forceShowAll = false;

    function resetForm(){
      selectedId = "";
      fornamnEl.value = "";
      efternamnEl.value = "";
      konEl.value = "";
      fodelsearEl.value = "";
      dodsarEl.value = "";
      platsEl.value = "";
      coordsEl.value = "";
      anteckningEl.value = "";
      formMsg.textContent = "";
      deleteBtn.disabled = true;
      scheduleDraft();
      renderRelations();
      renderList();
      updateGuide();
    }

    function fillFormFromPerson(p){
      selectedId = String(p.id || "");
      fornamnEl.value = String(p.fornamn || "");
      efternamnEl.value = String(p.efternamn || "");
      konEl.value = String(p.kon || "");
      fodelsearEl.value = (p.fodelsear == null) ? "" : String(p.fodelsear);
      dodsarEl.value = (p.dodsar == null) ? "" : String(p.dodsar);
      platsEl.value = String(p.plats || "");

      if(p && typeof p.coords === "object" && p.coords){
        const lat = Number(p.coords.lat), lon = Number(p.coords.lon);
        coordsEl.value = (inLatLonRange(lat, lon)) ? (lat + ", " + lon) : "";
      }else{
        coordsEl.value = String(p.coords || "");
      }

      anteckningEl.value = String(p.anteckning || "");
      formMsg.innerHTML = "<strong>Redigerar:</strong> " + personName(p);
      deleteBtn.disabled = false;

      scheduleDraft();
      renderRelations();
      renderList();
      updateGuide();
      try{ window.scrollTo({ top: 0, behavior: "smooth" }); }catch{}
    }

    // ============================
    // Partner adapter (kompatibilitet)
    // ============================
    function getPartnerPair(r){
      const a1 = r && (r.personAId ?? r.personA ?? r.aId ?? r.a);
      const b1 = r && (r.personBId ?? r.personB ?? r.bId ?? r.b);
      if(a1 != null && b1 != null) return { aId: String(a1), bId: String(b1) };

      const a2 = r && (r.person1Id ?? r.personId1 ?? r.person1);
      const b2 = r && (r.person2Id ?? r.personId2 ?? r.person2);
      if(a2 != null && b2 != null) return { aId: String(a2), bId: String(b2) };

      const a3 = r && (r.franPersonId ?? r.fromPersonId ?? r.fromId);
      const b3 = r && (r.tillPersonId ?? r.toPersonId ?? r.toId);
      if(a3 != null && b3 != null && String(r.typ) === "PARTNER") return { aId: String(a3), bId: String(b3) };

      return null;
    }

    // ============================
    // Relations compute
    // ============================
    function computeRelations(){
      const people = loadPeople();
      const rels = loadRelations();
      const focusId = String(selectedId || "");
      if(!focusId) return null;

      const focus = getPersonById(people, focusId);
      if(!focus) return null;

      const parentIds = rels
        .filter(r => r && r.typ === "FORALDER_BARN" && String(r.tillPersonId) === focusId)
        .map(r => String(r.franPersonId))
        .filter(Boolean);

      const childIds = rels
        .filter(r => r && r.typ === "FORALDER_BARN" && String(r.franPersonId) === focusId)
        .map(r => String(r.tillPersonId))
        .filter(Boolean);

      const partnerIds = rels
        .filter(r => r && r.typ === "PARTNER")
        .map(r => {
          const pair = getPartnerPair(r);
          if(!pair) return null;
          if(pair.aId === focusId) return pair.bId;
          if(pair.bId === focusId) return pair.aId;
          return null;
        })
        .filter(Boolean);

      const sibSet = new Set();
      for(const pid of parentIds){
        const kids = rels
          .filter(r => r && r.typ === "FORALDER_BARN" && String(r.franPersonId) === String(pid))
          .map(r => String(r.tillPersonId))
          .filter(Boolean);
        for(const k of kids){
          if(k !== focusId) sibSet.add(k);
        }
      }

      const uniqPeople = (ids) => [...new Set(ids)].map(id => getPersonById(people, id)).filter(Boolean);

      return {
        focus,
        parents: uniqPeople(parentIds),
        children: uniqPeople(childIds),
        partners: uniqPeople(partnerIds),
        siblings: uniqPeople([...sibSet])
      };
    }

    function makeChip(p, label){
      const b = document.createElement("button");
      b.type = "button";
      b.className = "chip";
      b.innerHTML = "<span>" + personName(p) + "</span>" + (label ? (" <small>" + label + "</small>") : "");
      b.addEventListener("click", () => fillFormFromPerson(p));
      return b;
    }

    function renderRelations(){
      const t = activeTreeId();
      if(!t || !selectedId){
        relBox.textContent = "V√§lj en person i listan (eller spara en ny) f√∂r att se relationer h√§r.";
        relGroups.hidden = true;
        return;
      }

      const computed = computeRelations();
      if(!computed){
        relBox.textContent = "Kunde inte l√§sa relationer f√∂r vald person.";
        relGroups.hidden = true;
        return;
      }

      relBox.innerHTML =
        "<strong>Fokus:</strong> " + personName(computed.focus) +
        (yearsLine(computed.focus) ? (" <span class='small'>(" + yearsLine(computed.focus) + ")</span>") : "");

      relGroups.hidden = false;

      function fill(container, arr, emptyLabel){
        container.innerHTML = "";
        if(!arr || arr.length === 0){
          const s = document.createElement("span");
          s.className = "small";
          s.textContent = emptyLabel;
          container.appendChild(s);
          return;
        }
        for(const p of arr){
          container.appendChild(makeChip(p, yearsLine(p) || ""));
        }
      }

      fill(relParents, computed.parents, "‚Äî Inga f√∂r√§ldrar angivna");
      fill(relPartners, computed.partners, "‚Äî Ingen partner angiven");
      fill(relChildren, computed.children, "‚Äî Inga barn angivna");
      fill(relSiblings, computed.siblings, "‚Äî Inga syskon hittades");

      refreshStatusPills();
    }

    // ============================
    // List render + typeahead (>=3 tecken)
    // ============================
    function getQuery(){
      return String(searchEl.value || "").trim().toLowerCase();
    }

    function matchesQuery(p, q){
      const n = personName(p).toLowerCase();
      const place = String(p.plats || "").toLowerCase();
      return n.includes(q) || place.includes(q);
    }

    function shouldShowSuggestions(){
      const q = getQuery();
      return forceShowAll || q.length >= 3;
    }

    function filteredPeople(people){
      const q = getQuery();
      if(forceShowAll) return people;
      if(q.length < 3) return [];
      return people.filter(p => matchesQuery(p, q));
    }

    function renderList(){
      const t = activeTreeId();
      const people = t ? loadPeople() : [];
      peopleList.innerHTML = "";

      if(!t){
        listMsg.textContent = "V√§lj ett aktivt tr√§d i Tr√§d.";
        return;
      }

      const q = getQuery();
      const show = shouldShowSuggestions();
      const vis = filteredPeople(people);

      if(!show){
        listMsg.textContent = people.length + " personer i tr√§det. Skriv minst 3 bokst√§ver f√∂r att s√∂ka.";
        // tom lista
        if(debugDetails && !debugDetails.hidden){
          debugOut.textContent = JSON.stringify(people, null, 2);
        }
        return;
      }

      if(forceShowAll && !q){
        listMsg.textContent = people.length + " personer i tr√§det (visar alla).";
      }else{
        listMsg.textContent = vis.length + " tr√§ffar (av " + people.length + ").";
      }

      if(vis.length === 0){
        const li = document.createElement("li");
        li.className = "item";
        li.style.cursor = "default";
        li.innerHTML =
          "<p class='itemTitle'>Inga tr√§ffar</p>" +
          "<p class='itemMeta'>Prova ett annat namn, eller klicka ‚ÄúVisa alla‚Äù.</p>";
        peopleList.appendChild(li);
      }else{
        for(const p of vis.slice(0, 80)){
          const li = document.createElement("li");
          li.className = "item" + (String(p.id) === String(selectedId) ? " active" : "");
          li.dataset.id = String(p.id);

          const metaParts = [];
          const y = yearsLine(p);
          if(y) metaParts.push(y);
          const pl = String(p.plats || "").trim();
          if(pl) metaParts.push(pl);

          li.innerHTML =
            "<p class='itemTitle'>" + personName(p) + "</p>" +
            "<p class='itemMeta'>" + (metaParts.join(" ¬∑ ") || "‚Äî") + "</p>";

          li.addEventListener("click", () => fillFormFromPerson(p));
          peopleList.appendChild(li);
        }
      }

      if(debugDetails && !debugDetails.hidden){
        debugOut.textContent = JSON.stringify(people, null, 2);
      }
    }

    // ============================
    // Status pills + guidance
    // ============================
    function refreshStatusPills(){
      const trees = getTrees();
      const t = activeTreeId();
      const active = activeTreeObj();

      const people = t ? loadPeople() : [];
      const rels = t ? loadRelations() : [];

      const withCoords = people.filter(p => {
        if(p && typeof p.coords === "object" && p.coords){
          return inLatLonRange(Number(p.coords.lat), Number(p.coords.lon));
        }
        if(typeof p.coords === "string"){
          return !!parseCoords(p.coords);
        }
        return false;
      }).length;

      if(!trees.length){
        setPill(pillActive, "warn", "Tr√§d: <strong>‚Äî</strong>");
      }else if(!active){
        setPill(pillActive, "warn", "Tr√§d: <strong>‚ö†Ô∏è v√§lj aktivt</strong>");
      }else{
        setPill(pillActive, "ok", "Tr√§d: <strong>" + (active.name || active.id) + "</strong>");
      }

      pillCounts.innerHTML = "Personer: <strong>" + people.length + "</strong>";
      pillRel.innerHTML = "Relationer: <strong>" + rels.length + "</strong>";
      pillCoords.innerHTML = "Med plats: <strong>" + withCoords + "</strong>";
    }

    function renderTreeState(){
      const trees = getTrees();
      const active = activeTreeObj();

      if(!trees.length){
        noteBox.hidden = false;
        noteBox.innerHTML = "<strong>üö© Inga tr√§d:</strong> Skapa ett tr√§d i <a href='./trees.html'><code>Tr√§d</code></a>.";
        return false;
      }

      if(!active){
        noteBox.hidden = false;
        noteBox.innerHTML = "<strong>üö© Inget aktivt tr√§d:</strong> V√§lj aktivt tr√§d i <a href='./trees.html'><code>Tr√§d</code></a>.";
        return false;
      }

      noteBox.hidden = true;
      return true;
    }

    function updateGuide(){
      if(!activeTreeId()){
        guideBox.textContent = "G√• till Tr√§d och v√§lj ett aktivt tr√§d.";
        return;
      }
      if(selectedId){
        guideBox.innerHTML = "Du redigerar en person. Steg: √§ndra f√§lt ‚Üí <strong>Spara</strong>.";
      }else{
        guideBox.innerHTML = "Steg 1: S√∂k och v√§lj en person (minst 3 bokst√§ver) ‚Äì eller klicka <strong>Skapa person</strong> och spara.";
      }
    }

    // ============================
    // Draft apply
    // ============================
    function applyDraftIfAny(){
      const t = activeTreeId();
      if(!t) return;

      const d = loadDraft();
      if(!d) return;

      const people = loadPeople();
      const exists = d.selectedId ? getPersonById(people, d.selectedId) : null;

      selectedId = exists ? String(exists.id) : "";

      fornamnEl.value = String(d.fornamn || "");
      efternamnEl.value = String(d.efternamn || "");
      konEl.value = String(d.kon || "");
      fodelsearEl.value = String(d.fodelsear || "");
      dodsarEl.value = String(d.dodsar || "");
      platsEl.value = String(d.plats || "");
      coordsEl.value = String(d.coords || "");
      anteckningEl.value = String(d.anteckning || "");

      deleteBtn.disabled = !selectedId;

      formMsg.innerHTML = d.savedAt
        ? ("<strong>Utkast √•terst√§llt.</strong> (" + new Date(d.savedAt).toLocaleString("sv-SE") + ")")
        : "<strong>Utkast √•terst√§llt.</strong>";

      renderRelations();
      renderList();
      refreshStatusPills();
      updateGuide();
    }

    // ============================
    // Events
    // ============================
    logoutBtn.addEventListener("click", () => {
      try{ sessionStorage.removeItem("demo_auth"); }catch{}
      window.location.href = "../index.html";
    });

    function attachDraftEvents(el){
      el.addEventListener("input", scheduleDraft);
      el.addEventListener("change", scheduleDraft);
    }
    for(const el of [fornamnEl, efternamnEl, konEl, fodelsearEl, dodsarEl, platsEl, coordsEl, anteckningEl]){
      attachDraftEvents(el);
    }

    clearCoordsBtn.addEventListener("click", () => {
      coordsEl.value = "";
      formMsg.textContent = "Coords rensade (sparas n√§r du klickar Spara).";
      scheduleDraft();
      refreshStatusPills();
    });

    clearDraftBtn.addEventListener("click", () => {
      clearDraft();
      formMsg.textContent = "Utkast rensat.";
      scheduleDraft();
    });

    moreBtn.addEventListener("click", () => {
      const open = !morePanel.hidden;
      morePanel.hidden = open;
      moreBtn.setAttribute("aria-expanded", String(!open));
    });

    saveBtn.addEventListener("click", () => {
      formMsg.textContent = "";

      const t = activeTreeId();
      if(!t){
        formMsg.textContent = "V√§lj aktivt tr√§d f√∂rst (Tr√§d).";
        return;
      }

      const fn = String(fornamnEl.value || "").trim();
      const en = String(efternamnEl.value || "").trim();

      if(!fn && !en){
        formMsg.textContent = "Fyll i √•tminstone f√∂rnamn eller efternamn.";
        return;
      }

      const people = loadPeople();
      const coordsParsed = parseCoords(coordsEl.value);

      const obj = {
        id: selectedId || makeId(),
        fornamn: fn,
        efternamn: en,
        kon: String(konEl.value || ""),
        fodelsear: String(fodelsearEl.value || "").trim(),
        dodsar: String(dodsarEl.value || "").trim(),
        plats: String(platsEl.value || "").trim(),
        coords: coordsParsed ? { lat: coordsParsed.lat, lon: coordsParsed.lon } : "",
        anteckning: String(anteckningEl.value || "").trim(),
        updatedAt: new Date().toISOString()
      };

      if(!obj.fodelsear) obj.fodelsear = "";
      if(!obj.dodsar) obj.dodsar = "";

      const ix = people.findIndex(p => String(p.id) === String(obj.id));
      if(ix >= 0){
        people[ix] = { ...people[ix], ...obj };
        formMsg.innerHTML = "<strong>Sparat:</strong> " + personName(obj);
      }else{
        obj.createdAt = new Date().toISOString();
        people.push(obj);
        formMsg.innerHTML = "<strong>Skapat:</strong> " + personName(obj);
      }

      savePeople(people);

      selectedId = String(obj.id);
      deleteBtn.disabled = false;

      clearDraft();
      morePanel.hidden = true;
      moreBtn.setAttribute("aria-expanded", "false");

      // efter save: h√•ll s√∂k/lista stabilt men uppdatera
      renderList();
      renderRelations();
      refreshStatusPills();
      updateGuide();
    });

    newBtn.addEventListener("click", () => {
      resetForm();
      formMsg.innerHTML = "<strong>Ny person.</strong> Fyll i och spara.";
      morePanel.hidden = true;
      moreBtn.setAttribute("aria-expanded", "false");
    });

    deleteBtn.addEventListener("click", () => {
      const t = activeTreeId();
      if(!t || !selectedId) return;

      const people = loadPeople();
      const p = getPersonById(people, selectedId);

      const ok = window.confirm("Ta bort " + (p ? personName(p) : "vald person") + "?");
      if(!ok) return;

      const next = people.filter(x => String(x.id) !== String(selectedId));
      savePeople(next);

      clearDraft();
      selectedId = "";
      resetForm();
      refreshStatusPills();
      updateGuide();

      formMsg.innerHTML = "<strong>Borttagen.</strong>";
    });

    showAllBtn.addEventListener("click", () => {
      forceShowAll = true;
      renderList();
    });

    clearSearchBtn.addEventListener("click", () => {
      searchEl.value = "";
      forceShowAll = false;
      renderList();
    });

    let searchTimer = null;
    searchEl.addEventListener("input", () => {
      forceShowAll = false;
      if(searchTimer) clearTimeout(searchTimer);
      searchTimer = setTimeout(renderList, 120);
    });

    // Auto-refresh on focus
    window.addEventListener("focus", () => {
      refreshStatusPills();
      renderList();
      renderRelations();
      updateGuide();
    });

    // Debug endast via ?debug=1
    (function setupDebug(){
      try{
        const params = new URLSearchParams(window.location.search);
        const debug = params.get("debug") === "1";
        debugDetails.hidden = !debug;
      }catch{
        debugDetails.hidden = true;
      }
    })();

    // ============================
    // Start
    // ============================
    const okTree = renderTreeState();
    refreshStatusPills();
    renderList();
    if(okTree) applyDraftIfAny();
    renderRelations();
    updateGuide();
  </script>
</body>
</html>
