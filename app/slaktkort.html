<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Personer – Släktkort</title>
  <meta name="description" content="Steg 2: Skapa personer i aktivt träd (localStorage-first). Draft sparas så fält inte tappas när du går till karta." />

  <style>
    :root { color-scheme: light; }
    body{
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      line-height: 1.5;
      margin: 0;
      padding: 24px;
      max-width: 980px;
      margin-inline: auto;
      background: #fff;
      color: #111;
    }
    a{ color: inherit; text-decoration:none; }
    header{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      margin-bottom:18px;
    }
    h1{ margin:0 0 6px; font-size:1.6rem; }
    .muted{ color:#555; margin:0 0 12px; }

    .topbar{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      margin: 10px 0 0;
    }
    .btn, button{
      display:inline-block;
      padding:10px 12px;
      border:1px solid #333;
      border-radius:10px;
      background:#fff;
      font:inherit;
      cursor:pointer;
      text-decoration:none;
    }
    .btn.secondary{ border-color:#bbb; }
    .btn.danger{ border-color:#b00020; color:#b00020; }
    .btn.disabled{
      opacity:.45;
      cursor:not-allowed;
      pointer-events:none;
    }

    .pillRow{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      margin: 10px 0 18px;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border:1px solid #ddd;
      border-radius:999px;
      background:#fafafa;
      font-size:.95rem;
    }
    .pill strong{ font-weight:900; }
    .pill.ok{ border-color:#cfe8cf; background:#f5fff5; }
    .pill.warn{ border-color:#ffe1a6; background:#fff9ee; }

    .card{
      border:1px solid #ddd;
      border-radius:12px;
      padding:16px;
      background:#fff;
      margin: 14px 0;
    }
    .card h2{ margin:0 0 6px; font-size:1.15rem; }
    .small{ font-size:.95rem; color:#555; margin:0 0 10px; }

    label{ display:block; margin:10px 0 6px; font-weight:800; }
    input, select, textarea{
      width:100%;
      box-sizing:border-box;
      padding:10px;
      border-radius:10px;
      border:1px solid #bbb;
      font:inherit;
      background:#fff;
    }
    textarea{ min-height: 90px; resize: vertical; }

    .row{ display:grid; grid-template-columns: 1fr; gap:12px; }
    @media (min-width: 720px){
      .row.two{ grid-template-columns: 1fr 1fr; }
    }

    .actions{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      margin-top: 12px;
    }

    .error{ color:#b00020; font-weight:900; }
    .ok{ font-weight:900; }

    pre{
      background:#f4f4f4;
      padding:12px;
      border-radius:12px;
      overflow:auto;
      white-space: pre-wrap;
      margin: 10px 0 0;
    }
    code{ background:#f4f4f4; padding:2px 6px; border-radius:6px; }
  </style>
</head>

<body>
<header>
  <div>
    <h1>Personer – Släktkort</h1>
    <p class="muted">Steg 2 i flödet. Draft sparas automatiskt så du inte tappar namn när du går till karta.</p>

    <nav class="topbar" aria-label="Navigation">
      <a class="btn secondary" href="../start.html">Start</a>
      <a class="btn secondary" href="./trees.html">Träd</a>
      <a class="btn" href="./slaktkort.html">Personer</a>
      <a class="btn secondary" href="./create-relation.html">Relationer</a>
      <a class="btn secondary" href="./map.html">Karta</a>
      <a class="btn secondary" id="placeLink" href="./place-picker.html">Plats-picker</a>
    </nav>
  </div>

  <div class="actions" style="justify-content:flex-end;">
    <button id="logoutBtn" class="btn secondary" type="button">Logga ut</button>
  </div>
</header>

<section class="pillRow" aria-label="Status">
  <span id="pillTree" class="pill warn">Aktivt träd: <strong>—</strong></span>
  <span id="pillCount" class="pill">Personer i trädet: <strong>0</strong></span>
  <span id="pillNext" class="pill warn">Nästa steg: <strong>Välj träd</strong></span>
</section>

<section class="card">
  <h2>1) Träd</h2>
  <p class="small">Personer sparas per träd. Du kan byta aktivt träd här.</p>

  <label for="treeSelect">Träd</label>
  <select id="treeSelect" aria-label="Välj träd"></select>

  <div class="actions">
    <button id="reloadTreesBtn" type="button" class="btn">Ladda träd</button>
    <a class="btn secondary" href="./trees.html">Gå till Träd</a>
    <a class="btn disabled" id="continueRelsTop" href="./create-relation.html" aria-disabled="true" tabindex="-1">Fortsätt → Relationer</a>
  </div>

  <p id="treeMsg" class="muted" aria-live="polite"></p>
</section>

<section class="card">
  <h2>2) Skapa släktkort</h2>

  <div class="row two">
    <div>
      <label for="fornamn">Förnamn</label>
      <input id="fornamn" placeholder="t.ex. Anna" />
    </div>
    <div>
      <label for="efternamn">Efternamn</label>
      <input id="efternamn" placeholder="t.ex. Andersson" />
    </div>
  </div>

  <label for="kon">Kön</label>
  <select id="kon">
    <option>Okänt</option>
    <option>Man</option>
    <option>Kvinna</option>
  </select>

  <div class="row two">
    <div>
      <label for="fodelsear">Födelseår (valfritt)</label>
      <input id="fodelsear" type="number" placeholder="t.ex. 1874" />
    </div>
    <div>
      <label for="dodsar">Dödsår (valfritt)</label>
      <input id="dodsar" type="number" placeholder="t.ex. 1942" />
    </div>
  </div>

  <label for="plats">Plats (valfritt)</label>
  <input id="plats" placeholder="t.ex. Uppsala" />

  <label for="coords">Koordinater (lat, lon) (valfritt)</label>
  <input id="coords" placeholder="t.ex. 59.3293, 18.0686" />

  <div class="actions">
    <a class="btn secondary" id="pickCoordsBtn" href="./place-picker.html">Välj koordinater via karta</a>
    <button type="button" class="btn secondary" id="clearCoordsBtn">Rensa koordinater</button>
    <button type="button" class="btn secondary" id="useLastBtn">Använd senaste plats</button>
  </div>

  <label for="anteckning">Anteckning (valfritt)</label>
  <textarea id="anteckning" placeholder="fri text"></textarea>

  <div class="actions">
    <button id="createBtn" type="button" class="btn">Spara släktkort</button>
    <button id="resetBtn" type="button" class="btn secondary">Rensa fält</button>
    <a class="btn disabled" id="continueRelsBottom" href="./create-relation.html" aria-disabled="true" tabindex="-1">Fortsätt → Relationer</a>
  </div>

  <p id="createMsg" class="muted" aria-live="polite"></p>
</section>

<section class="card">
  <h2>3) Lista personer i aktivt träd</h2>
  <p class="small">Visas som JSON (demo).</p>

  <div class="actions">
    <button id="listBtn" type="button" class="btn secondary">Hämta släktkort</button>
    <button id="clearOutBtn" type="button" class="btn secondary">Töm listan</button>
    <button id="wipeTreeBtn" type="button" class="btn danger">Radera alla personer i trädet</button>
  </div>

  <pre id="out">[]</pre>

  <p class="small" style="margin-top:10px;">
    Tips: När du har minst 2 personer kan du gå vidare till Relationer.
  </p>
</section>

<script>
  // ============================
  // Estetisk auth
  // ============================
  (function authGuard(){
    try{
      if(sessionStorage.getItem("demo_auth") !== "1"){
        window.location.href = "../index.html";
      }
    }catch{}
  })();

  // ============================
  // LocalStorage keys
  // ============================
  const KEY_TREES    = "slakttradet_trees";
  const KEY_ACTIVE   = "slakttradet_active_tree_id";
  const KEY_LAST_LOC = "slakttradet_last_location";

  const cardsKey = (treeId) => "slakttradet_slaktkort_" + String(treeId);
  const relKey   = (treeId) => "slakttradet_relationer_" + String(treeId);

  // Draft (så fält inte tappas när man går till karta)
  // sessionStorage = rensas när fliken stängs (bra för “tillfälligt utkast”)
  const draftKey = (treeId) => "slakttradet_draft_person_" + String(treeId);

  // DOM
  const logoutBtn = document.getElementById("logoutBtn");

  const pillTree = document.getElementById("pillTree");
  const pillCount = document.getElementById("pillCount");
  const pillNext = document.getElementById("pillNext");

  const treeSelect = document.getElementById("treeSelect");
  const reloadTreesBtn = document.getElementById("reloadTreesBtn");
  const treeMsg = document.getElementById("treeMsg");

  const fornamnEl = document.getElementById("fornamn");
  const efternamnEl = document.getElementById("efternamn");
  const konEl = document.getElementById("kon");
  const fodelsearEl = document.getElementById("fodelsear");
  const dodsarEl = document.getElementById("dodsar");
  const platsEl = document.getElementById("plats");
  const coordsEl = document.getElementById("coords");
  const anteckningEl = document.getElementById("anteckning");

  const pickCoordsBtn = document.getElementById("pickCoordsBtn");
  const placeLink = document.getElementById("placeLink");
  const clearCoordsBtn = document.getElementById("clearCoordsBtn");
  const useLastBtn = document.getElementById("useLastBtn");

  const createBtn = document.getElementById("createBtn");
  const resetBtn = document.getElementById("resetBtn");
  const createMsg = document.getElementById("createMsg");

  const listBtn = document.getElementById("listBtn");
  const clearOutBtn = document.getElementById("clearOutBtn");
  const wipeTreeBtn = document.getElementById("wipeTreeBtn");
  const out = document.getElementById("out");

  const continueRelsTop = document.getElementById("continueRelsTop");
  const continueRelsBottom = document.getElementById("continueRelsBottom");

  // Helpers
  function safeParse(raw, fallback){ try{ return JSON.parse(raw); }catch{ return fallback; } }
  function loadJson(key, fallback){
    const raw = localStorage.getItem(key);
    return raw ? safeParse(raw, fallback) : fallback;
  }
  function saveJson(key, value){ localStorage.setItem(key, JSON.stringify(value)); }

  function activeTreeId(){ return localStorage.getItem(KEY_ACTIVE) || ""; }
  function setActiveTreeId(id){ localStorage.setItem(KEY_ACTIVE, String(id || "")); }

  function getTrees(){
    const trees = loadJson(KEY_TREES, []);
    return Array.isArray(trees) ? trees : [];
  }

  function getActiveTreeLabel(){
    const id = activeTreeId();
    if(!id) return "—";
    const t = getTrees().find(x => String(x.id) === String(id));
    return t ? (t.name || t.id) : id;
  }

  function setDisabled(el, disabled){
    if(disabled){
      el.classList.add("disabled");
      el.setAttribute("aria-disabled","true");
      el.setAttribute("tabindex","-1");
    }else{
      el.classList.remove("disabled");
      el.removeAttribute("aria-disabled");
      el.removeAttribute("tabindex");
    }
  }

  function setMsg(el, type, text){
    el.innerHTML = type === "error"
      ? "<span class='error'>" + text + "</span>"
      : type === "ok"
        ? "<span class='ok'>" + text + "</span>"
        : text;
  }

  function parseOptionalInt(el){
    const raw = String(el.value || "").trim();
    if(!raw) return null;
    const n = Number(raw);
    return Number.isFinite(n) ? n : null;
  }

  function parseCoords(text){
    const raw = String(text || "").trim();
    if(!raw) return null;

    const normalized = raw.replace(/\s+/g, " ");
    const partsComma = normalized.split(",").map(s => s.trim()).filter(Boolean);

    let a, b;
    if(partsComma.length === 2){ a = partsComma[0]; b = partsComma[1]; }
    else{
      const partsSpace = normalized.split(" ").filter(Boolean);
      if(partsSpace.length !== 2) return null;
      a = partsSpace[0]; b = partsSpace[1];
    }

    const lat = Number(a);
    const lon = Number(b);
    if(!Number.isFinite(lat) || !Number.isFinite(lon)) return null;
    if(lat < -90 || lat > 90) return null;
    if(lon < -180 || lon > 180) return null;
    return { lat, lon };
  }

  function makeCardId(){
    return "p" + Date.now().toString(36) + Math.random().toString(36).slice(2, 6);
  }

  function loadCards(treeId){
    const arr = loadJson(cardsKey(treeId), []);
    return Array.isArray(arr) ? arr : [];
  }
  function saveCards(treeId, cards){
    saveJson(cardsKey(treeId), cards);
  }

  // ============================
  // Draft: spara/återställ
  // ============================
  function buildDraft(){
    return {
      fornamn: String(fornamnEl.value || ""),
      efternamn: String(efternamnEl.value || ""),
      kon: String(konEl.value || "Okänt"),
      fodelsear: String(fodelsearEl.value || ""),
      dodsar: String(dodsarEl.value || ""),
      plats: String(platsEl.value || ""),
      coords: String(coordsEl.value || ""),
      anteckning: String(anteckningEl.value || "")
    };
  }

  function applyDraft(d){
    if(!d || typeof d !== "object") return;
    fornamnEl.value = d.fornamn ?? "";
    efternamnEl.value = d.efternamn ?? "";
    konEl.value = d.kon ?? "Okänt";
    fodelsearEl.value = d.fodelsear ?? "";
    dodsarEl.value = d.dodsar ?? "";
    platsEl.value = d.plats ?? "";
    coordsEl.value = d.coords ?? "";
    anteckningEl.value = d.anteckning ?? "";
  }

  function saveDraftNow(){
    const t = activeTreeId();
    if(!t) return;
    try{
      sessionStorage.setItem(draftKey(t), JSON.stringify(buildDraft()));
    }catch{}
  }

  function loadDraftNow(){
    const t = activeTreeId();
    if(!t) return;
    try{
      const raw = sessionStorage.getItem(draftKey(t));
      if(!raw) return;
      const d = safeParse(raw, null);
      applyDraft(d);
    }catch{}
  }

  function clearDraft(){
    const t = activeTreeId();
    if(!t) return;
    try{ sessionStorage.removeItem(draftKey(t)); }catch{}
  }

  // Debounce så vi inte skriver varje tangent
  let draftTimer = null;
  function scheduleDraftSave(){
    if(draftTimer) clearTimeout(draftTimer);
    draftTimer = setTimeout(() => saveDraftNow(), 180);
  }

  // autosave på alla fält
  [fornamnEl, efternamnEl, konEl, fodelsearEl, dodsarEl, platsEl, coordsEl, anteckningEl]
    .forEach(el => {
      el.addEventListener("input", scheduleDraftSave);
      el.addEventListener("change", scheduleDraftSave);
    });

  // ============================
  // Trees UI
  // ============================
  function fillTreeSelect(){
    const trees = getTrees();
    const activeId = activeTreeId();

    treeSelect.innerHTML = "";

    if(trees.length === 0){
      treeSelect.innerHTML = "<option value=''>Inga träd ännu</option>";
      treeSelect.disabled = true;
      setMsg(treeMsg, "error", "Inga träd sparade. Gå till Träd och skapa ett träd.");
      return;
    }

    treeSelect.disabled = false;
    treeSelect.innerHTML = "<option value=''>Välj…</option>";
    for(const t of trees){
      const opt = document.createElement("option");
      opt.value = String(t.id);
      opt.textContent = `${t.name}${String(t.id) === activeId ? " (aktivt)" : ""}`;
      treeSelect.appendChild(opt);
    }

    if(activeId){
      treeSelect.value = activeId;
    }else{
      treeSelect.value = String(trees[0].id);
      setActiveTreeId(treeSelect.value);
    }

    setMsg(treeMsg, "ok", "Träd laddade.");
  }

  treeSelect.addEventListener("change", () => {
    const newId = treeSelect.value;
    if(!newId) return;

    // Spara draft i gamla trädet (om något), byt träd, ladda draft för nya trädet
    saveDraftNow();
    setActiveTreeId(newId);
    loadDraftNow();
    refreshStatus();
  });

  reloadTreesBtn.addEventListener("click", () => {
    fillTreeSelect();
    loadDraftNow();
    refreshStatus();
  });

  // ============================
  // Status pills
  // ============================
  function refreshStatus(){
    const t = activeTreeId();
    const label = getActiveTreeLabel();

    if(!t){
      pillTree.className = "pill warn";
      pillTree.innerHTML = "Aktivt träd: <strong>—</strong>";
      pillCount.innerHTML = "Personer i trädet: <strong>0</strong>";
      pillNext.className = "pill warn";
      pillNext.innerHTML = "Nästa steg: <strong>Välj träd</strong>";
      setDisabled(continueRelsTop, true);
      setDisabled(continueRelsBottom, true);
      return;
    }

    const count = loadCards(t).length;
    pillTree.className = "pill ok";
    pillTree.innerHTML = "Aktivt träd: <strong>" + label + "</strong>";
    pillCount.innerHTML = "Personer i trädet: <strong>" + count + "</strong>";

    if(count >= 2){
      pillNext.className = "pill ok";
      pillNext.innerHTML = "Nästa steg: <strong>Relationer</strong>";
      setDisabled(continueRelsTop, false);
      setDisabled(continueRelsBottom, false);
    }else{
      pillNext.className = "pill warn";
      pillNext.innerHTML = "Nästa steg: <strong>Lägg till fler personer</strong>";
      setDisabled(continueRelsTop, true);
      setDisabled(continueRelsBottom, true);
    }
  }

  // ============================
  // Place picker integration
  // ============================
  function prefillCoordsFromLast(){
    const data = loadJson(KEY_LAST_LOC, null);
    if(!data || typeof data.lat !== "number" || typeof data.lon !== "number") return;
    coordsEl.value = `${data.lat}, ${data.lon}`;
    scheduleDraftSave();
  }

  clearCoordsBtn.addEventListener("click", () => {
    coordsEl.value = "";
    scheduleDraftSave();
    setMsg(createMsg, "", "Koordinater rensade.");
  });

  useLastBtn.addEventListener("click", () => {
    prefillCoordsFromLast();
    setMsg(createMsg, "ok", "Senaste plats satt i koordinater.");
  });

  // Viktigt: spara draft innan du lämnar sidan till place-picker
  function goToPlacePicker(e){
    saveDraftNow();
    // navigera som vanligt
  }
  pickCoordsBtn.addEventListener("click", goToPlacePicker);
  placeLink.addEventListener("click", goToPlacePicker);

  // När man kommer tillbaka från place-picker: fyll coords automatiskt
  (function prefillFromPlacePicker(){
    prefillCoordsFromLast();
  })();

  // ============================
  // Create person
  // ============================
  function createSlaktkort(){
    createMsg.textContent = "";

    const t = activeTreeId();
    if(!t) return setMsg(createMsg, "error", "Välj ett träd först.");

    const coords = parseCoords(coordsEl.value);

    const payload = {
      id: makeCardId(),
      fornamn: String(fornamnEl.value || "").trim(),
      efternamn: String(efternamnEl.value || "").trim(),
      kon: konEl.value,
      fodelsear: parseOptionalInt(fodelsearEl),
      dodsar: parseOptionalInt(dodsarEl),
      plats: String(platsEl.value || "").trim(),
      coords,
      anteckning: String(anteckningEl.value || "").trim(),
      createdAt: new Date().toISOString()
    };

    if(!payload.fornamn && !payload.efternamn){
      return setMsg(createMsg, "error", "Fyll i minst förnamn eller efternamn.");
    }
    if(coordsEl.value.trim() && !coords){
      return setMsg(createMsg, "error", "Koordinater måste vara 'lat, lon' (ex: 59.3293, 18.0686).");
    }

    const cards = loadCards(t);
    cards.push(payload);
    saveCards(t, cards);

    setMsg(createMsg, "ok", `Släktkort sparat (id: ${payload.id}).`);
    clearDraft();                 // <-- viktigt: när sparat, rensa draft
    out.textContent = JSON.stringify({ slaktkort: cards }, null, 2);
    refreshStatus();
  }

  function listSlaktkort(){
    const t = activeTreeId();
    if(!t){
      out.textContent = "[]";
      return setMsg(treeMsg, "error", "Välj ett träd först.");
    }
    const cards = loadCards(t);
    out.textContent = JSON.stringify({ slaktkort: cards }, null, 2);
    setMsg(treeMsg, "ok", `Hämtade ${cards.length} släktkort.`);
  }

  createBtn.addEventListener("click", createSlaktkort);

  resetBtn.addEventListener("click", () => {
    // rensa endast fält (draft ligger kvar tills du sparar eller byter träd)
    fornamnEl.value = "";
    efternamnEl.value = "";
    konEl.value = "Okänt";
    fodelsearEl.value = "";
    dodsarEl.value = "";
    platsEl.value = "";
    coordsEl.value = "";
    anteckningEl.value = "";
    scheduleDraftSave();
    setMsg(createMsg, "", "Fälten rensade (draft uppdaterad).");
  });

  listBtn.addEventListener("click", listSlaktkort);
  clearOutBtn.addEventListener("click", () => { out.textContent = "[]"; });

  wipeTreeBtn.addEventListener("click", () => {
    const t = activeTreeId();
    if(!t) return setMsg(treeMsg, "error", "Välj ett träd först.");
    const yes = confirm("Radera alla personer i aktivt träd?\n\nDetta tar bort personer lokalt i webbläsaren.");
    if(!yes) return;
    saveCards(t, []);
    clearDraft();
    out.textContent = "[]";
    setMsg(treeMsg, "ok", "Alla personer raderade i aktivt träd.");
    refreshStatus();
  });

  logoutBtn.addEventListener("click", () => {
    try{ sessionStorage.removeItem("demo_auth"); }catch{}
    window.location.href = "../index.html";
  });

  // ============================
  // Start
  // ============================
  fillTreeSelect();
  loadDraftNow();     // <-- här kommer namnen tillbaka när du återvänder från karta
  refreshStatus();
</script>
</body>
</html>
