<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Personer – Släktkort</title>
  <meta name="description" content="Skapa och redigera personer i aktivt träd. Plats väljs från kartan." />

  <style>
    /* ARKIV-ID: UI-GLOBAL-01 | Global designstandard
       Syfte: Gemensam baseline för alla Släktkort-sidor (GitHub Pages, local HTML).
       Placering: Klistra in HÖGST UPP i varje sidas <style>-tagg.
       Obs: Endast CSS. Ingen JS/keys/logik påverkas.
    */
    :root{
      color-scheme: light;
    }
    body{
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      line-height: 1.5;
      margin: 0;
      padding: 24px;
      max-width: 1180px;
      margin-inline: auto;
      background: #fff;
      color: #111;
    }
    a{
      color: inherit;
      text-decoration: none;
    }
    header{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      margin-bottom:18px;
    }
    .topbar{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      margin: 10px 0 0;
    }
    .btn, button{
      display:inline-block;
      padding:10px 12px;
      border:1px solid #333;
      border-radius:10px;
      background:#fff;
      font:inherit;
      cursor:pointer;
      text-decoration:none;
      user-select:none;
    }
    .btn.secondary{
      border-color:#bbb;
    }
    .btn:disabled,
    button:disabled{
      opacity:.55;
      cursor:not-allowed;
    }
    .btn.navActive{
      background:#f5fff5;
      border-color:#cfe8cf;
      color:#111;
    }
    .liftBoxGreen{
      border: 1px solid #cfe8cf;
      background: #f5fff5;
      border-radius: 12px;
      padding: 10px 12px;
    }

    /* --- Sida: Personer (behåll funktionellt oförändrat, men utan krockar) --- */
    h1{ margin:0 0 6px; font-size: 28px; }
    .muted{ color:#555; margin:0; }

    nav{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      margin: 12px 0 18px;
    }
    .spacer{ flex:1 1 auto; }

    .btn.primary{
      background:#111;
      color:#fff;
      border-color:#111;
    }
    .btn.secondary{ background:#fafafa; }
    .btn.danger{ border-color:#ffb3b3; background:#fff2f2; }

    .pillRow{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      margin: 10px 0 18px;
    }
    .pill{
      display:inline-flex;
      gap:8px;
      align-items:center;
      padding:8px 10px;
      border:1px solid #ddd;
      border-radius:999px;
      background:#fafafa;
      font-size: .95rem;
    }
    .pill strong{ font-weight:900; }
    .pill.ok{ border-color:#cfe8cf; background:#f5fff5; }
    .pill.warn{ border-color:#ffe1a6; background:#fff9ee; }
    .pill.err{ border-color:#ffb3b3; background:#fff2f2; }

    .grid{
      display:grid;
      gap: 14px;
      grid-template-columns: 1fr;
    }
    @media (min-width: 980px){
      .grid{ grid-template-columns: 420px 1fr; }
    }

    .card{
      border:1px solid #e6e8eb;
      border-radius: 16px;
      padding: 14px;
      background:#fff;
      box-shadow: 0 1px 0 rgba(0,0,0,.03);
    }
    .card h2{ margin:0 0 6px; font-size: 18px; }
    .small{ margin:0 0 10px; color:#555; font-size: 13px; }

    label{ display:block; font-weight:800; margin: 10px 0 6px; }
    input, select, textarea{
      width:100%;
      box-sizing:border-box;
      padding: 10px;
      border-radius: 12px;
      border: 1px solid #bbb;
      font: inherit;
      background:#fff;
    }
    textarea{ min-height: 90px; resize: vertical; }

    .row2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    @media (max-width: 520px){
      .row2{ grid-template-columns: 1fr; }
    }

    .actions{
      display:flex;
      flex-wrap:wrap;
      gap: 10px;
      align-items:center;
      margin-top: 12px;
    }

    .list{
      margin: 10px 0 0;
      padding: 0;
      list-style:none;
      display:flex;
      flex-direction:column;
      gap:10px;
      max-height: 520px;
      overflow:auto;
      border-top: 1px solid #eee;
      padding-top: 10px;
    }
    .item{
      border:1px solid #eee;
      border-radius: 14px;
      padding: 10px;
      background:#fff;
      cursor:pointer;
    }
    .item:hover{ background:#fafafa; }
    .itemTitle{ font-weight:900; margin:0 0 2px; }
    .itemMeta{ margin:0; color:#555; font-size: 13px; }

    .infoBoxText{
      font-size: 13px;
      color:#333;
    }

    .error{ color:#b00020; font-weight:900; }
    .ok{ font-weight:900; }
    code{ background:#f4f4f4; padding:2px 6px; border-radius:6px; }
  </style>
</head>

<body>
  <header style="display:block;">
    <h1>Personer</h1>
    <p class="muted">Skapa och redigera personer i aktivt träd. Plats väljs från kartan.</p>

    <nav class="topbar" aria-label="Huvudmeny">
      <a class="btn secondary" href="../start.html">Start</a>
      <a class="btn secondary" href="./trees.html">Träd</a>
      <a class="btn navActive" href="./slaktkort.html" aria-current="page">Personer</a>
      <a class="btn secondary" href="./create-relation.html">Relationer</a>
      <a class="btn secondary" href="./map.html">Karta</a>
      <a class="btn secondary" href="./person-search.html">Sök historisk person</a>
      <span class="spacer"></span>
      <button class="btn secondary" id="logoutBtn" type="button">Logga ut</button>
    </nav>
  </header>

  <section class="pillRow" aria-label="Status">
    <span id="pillTree" class="pill warn">Aktivt träd: <strong>—</strong></span>
    <span id="pillPeople" class="pill">Personer: <strong>0</strong></span>
    <span id="pillDraft" class="pill">Utkast: <strong>—</strong></span>
  </section>

  <div class="grid">
    <section class="card" aria-label="Personlista">
      <h2>Personlista</h2>
      <p class="small">Klicka en person för att redigera. “Skapa ny” gör en ny person i aktivt träd.</p>

      <label for="search">Sök</label>
      <input id="search" placeholder="Skriv minst 3 bokstäver…" autocomplete="off" />

      <div class="actions">
        <button class="btn secondary" id="showAllBtn" type="button">Visa alla</button>
        <button class="btn secondary" id="clearSearchBtn" type="button">Rensa</button>
        <span class="small" id="matchInfo" aria-live="polite">—</span>
      </div>

      <div class="actions" style="margin-top:10px;">
        <button class="btn" id="newBtn" type="button">Skapa ny person</button>
        <button class="btn secondary" id="reloadBtn" type="button">Ladda om</button>
        <button class="btn secondary" id="findHistoricalBtn" type="button">Sök historisk person</button>
      </div>

      <ul id="list" class="list" aria-label="Personer"></ul>
    </section>

    <section class="card" aria-label="Skapa/redigera person">
      <h2 id="formTitle">Skapa person</h2>
      <p class="small" id="formSub">Fyll i uppgifter och spara.</p>

      <div id="topMsg" class="liftBoxGreen infoBoxText" hidden></div>

      <label for="fornamn">Förnamn</label>
      <input id="fornamn" autocomplete="given-name" />

      <label for="efternamn">Efternamn</label>
      <input id="efternamn" autocomplete="family-name" />

      <label for="kon">Kön</label>
      <select id="kon">
        <option value="">Välj…</option>
        <option value="man">man</option>
        <option value="kvinna">kvinna</option>
      </select>

      <label for="yrke">Yrke (valfritt)</label>
      <input id="yrke" />

      <div class="row2">
        <div>
          <label for="fodelsear">Födelseår (valfritt)</label>
          <input id="fodelsear" inputmode="numeric" placeholder="t.ex. 1988" />
        </div>
        <div>
          <label for="dodsar">Dödsår (valfritt)</label>
          <input id="dodsar" inputmode="numeric" placeholder="t.ex. 2020" />
        </div>
      </div>

      <div class="row2">
        <div>
          <label for="plats">Plats (text, valfritt)</label>
          <input id="plats" placeholder="t.ex. Falun" />
        </div>
        <div>
          <label for="coords">Koordinater (från kartan)</label>
          <input id="coords" placeholder="t.ex. 60.6070, 15.6355" />
        </div>
      </div>

      <div class="actions">
        <button class="btn primary" id="pickPlaceBtn" type="button">Välj plats</button>
        <button class="btn secondary" id="clearPlaceBtn" type="button">Rensa plats</button>
      </div>

      <label for="anteckning">Anteckning (valfritt)</label>
      <textarea id="anteckning"></textarea>

      <div class="actions">
        <button class="btn primary" id="saveBtn" type="button">Spara</button>
        <button class="btn danger" id="deleteBtn" type="button">Ta bort</button>
        <button class="btn secondary" id="resetBtn" type="button">Återställ</button>
      </div>

      <div class="liftBoxGreen infoBoxText" style="margin-top:10px;">
        <strong>Platsflöde</strong><br />
        När du klickar <code>Välj plats</code> sparas ett utkast automatiskt.<br />
        Kartan/Place-picker kan sedan skriva tillbaka koordinater via <code>slakttradet_place_pick_result</code>.
      </div>
    </section>
  </div>

  <script>
    "use strict";

    (function authGuard(){
      try{
        if(sessionStorage.getItem("demo_auth") !== "1"){
          window.location.href = "../index.html";
        }
      }catch{}
    })();

    const KEY_TREES  = "slakttradet_trees";
    const KEY_ACTIVE = "slakttradet_active_tree_id";

    const cardsKey = (treeId) => "slakttradet_slaktkort_" + String(treeId);
    const relKey   = (treeId) => "slakttradet_relationer_" + String(treeId);

    const draftKey = (treeId) => "slakttradet_person_draft_" + String(treeId);
    const editIdKey = (treeId) => "slakttradet_edit_person_id_" + String(treeId);

    const PLACE_CTX_KEY = "slakttradet_place_pick_ctx";
    const PLACE_RES_KEY = "slakttradet_place_pick_result";

    const logoutBtn = document.getElementById("logoutBtn");

    const pillTree = document.getElementById("pillTree");
    const pillPeople = document.getElementById("pillPeople");
    const pillDraft = document.getElementById("pillDraft");

    const listEl = document.getElementById("list");
    const searchEl = document.getElementById("search");
    const showAllBtn = document.getElementById("showAllBtn");
    const clearSearchBtn = document.getElementById("clearSearchBtn");
    const matchInfo = document.getElementById("matchInfo");

    const newBtn = document.getElementById("newBtn");
    const reloadBtn = document.getElementById("reloadBtn");
    const findHistoricalBtn = document.getElementById("findHistoricalBtn");

    const formTitle = document.getElementById("formTitle");
    const formSub = document.getElementById("formSub");
    const topMsg = document.getElementById("topMsg");

    const fornamnEl = document.getElementById("fornamn");
    const efternamnEl = document.getElementById("efternamn");
    const konEl = document.getElementById("kon");
    const yrkeEl = document.getElementById("yrke");
    const fodelsearEl = document.getElementById("fodelsear");
    const dodsarEl = document.getElementById("dodsar");
    const platsEl = document.getElementById("plats");
    const coordsEl = document.getElementById("coords");
    const anteckningEl = document.getElementById("anteckning");

    const pickPlaceBtn = document.getElementById("pickPlaceBtn");
    const clearPlaceBtn = document.getElementById("clearPlaceBtn");

    const saveBtn = document.getElementById("saveBtn");
    const deleteBtn = document.getElementById("deleteBtn");
    const resetBtn = document.getElementById("resetBtn");

    function safeParse(raw, fallback){
      try{ return JSON.parse(raw); }catch{ return fallback; }
    }
    function loadJson(key, fallback){
      const raw = localStorage.getItem(key);
      return raw ? safeParse(raw, fallback) : fallback;
    }
    function saveJson(key, value){
      localStorage.setItem(key, JSON.stringify(value));
    }

    function escapeHtml(s){
      return String(s || "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function activeTreeId(){
      return localStorage.getItem(KEY_ACTIVE) || "";
    }
    function getTrees(){
      const arr = loadJson(KEY_TREES, []);
      return Array.isArray(arr) ? arr : [];
    }
    function activeTreeLabel(){
      const id = activeTreeId();
      if(!id) return "—";
      const t = getTrees().find(x => String(x.id) === String(id));
      return t ? (t.name || t.id) : id;
    }

    function loadPeople(){
      const t = activeTreeId();
      if(!t) return [];
      const arr = loadJson(cardsKey(t), []);
      return Array.isArray(arr) ? arr : [];
    }
    function savePeople(people){
      const t = activeTreeId();
      if(!t) return;
      saveJson(cardsKey(t), people);
    }

    function personName(p){
      const n = `${p.fornamn || ""} ${p.efternamn || ""}`.trim();
      return n || "(namnlös)";
    }

    function parseYear(v){
      const s = String(v || "").trim();
      if(!s) return "";
      const n = Number(s);
      if(!Number.isFinite(n)) return "";
      const i = Math.trunc(n);
      if(i < 0 || i > 3000) return "";
      return String(i);
    }

    function inLatLonRange(lat, lon){
      return Number.isFinite(lat) && Number.isFinite(lon) && lat >= -90 && lat <= 90 && lon >= -180 && lon <= 180;
    }
    function normalizeCoordsString(v){
      const s = String(v || "").trim();
      if(!s) return "";
      const parts = s.split(",").map(x => x.trim()).filter(Boolean);
      if(parts.length !== 2) return "";
      const lat = Number(parts[0]);
      const lon = Number(parts[1]);
      if(!inLatLonRange(lat, lon)) return "";
      return lat.toFixed(4) + ", " + lon.toFixed(4);
    }

    function newId(){
      return "p_" + Date.now().toString(36) + "_" + Math.random().toString(36).slice(2,7);
    }

    function getEditId(){
      const t = activeTreeId();
      if(!t) return "";
      return localStorage.getItem(editIdKey(t)) || "";
    }
    function setEditId(id){
      const t = activeTreeId();
      if(!t) return;
      localStorage.setItem(editIdKey(t), String(id || ""));
    }

    function loadDraft(){
      const t = activeTreeId();
      if(!t) return null;
      const d = loadJson(draftKey(t), null);
      return d && typeof d === "object" ? d : null;
    }
    function saveDraft(d){
      const t = activeTreeId();
      if(!t) return;
      saveJson(draftKey(t), d || {});
      pillDraft.innerHTML = "Utkast: <strong>Ja</strong>";
      pillDraft.className = "pill ok";
    }
    function clearDraft(){
      const t = activeTreeId();
      if(!t) return;
      localStorage.removeItem(draftKey(t));
      pillDraft.innerHTML = "Utkast: <strong>Nej</strong>";
      pillDraft.className = "pill";
    }

    function makeDraftFromPerson(p){
      return {
        id: String(p.id || ""),
        fornamn: String(p.fornamn || ""),
        efternamn: String(p.efternamn || ""),
        kon: String(p.kon || ""),
        yrke: String(p.yrke || ""),
        fodelsear: String(p.fodelsear || ""),
        dodsar: String(p.dodsar || ""),
        plats: String(p.plats || ""),
        coords: (p.coords && typeof p.coords === "object" && p.coords) ? { lat: p.coords.lat, lon: p.coords.lon } : null,
        anteckning: String(p.anteckning || "")
      };
    }

    function readFormToDraft(){
      const existing = loadDraft() || {};
      const d = {
        id: String(existing.id || ""),
        fornamn: String(fornamnEl.value || "").trim(),
        efternamn: String(efternamnEl.value || "").trim(),
        kon: String(konEl.value || ""),
        yrke: String(yrkeEl.value || "").trim(),
        fodelsear: parseYear(fodelsearEl.value),
        dodsar: parseYear(dodsarEl.value),
        plats: String(platsEl.value || "").trim(),
        coords: null,
        anteckning: String(anteckningEl.value || "").trim()
      };

      const norm = normalizeCoordsString(coordsEl.value);
      if(norm){
        const parts = norm.split(",").map(x => x.trim());
        d.coords = { lat: Number(parts[0]), lon: Number(parts[1]) };
      }else{
        d.coords = null;
      }

      saveDraft(d);
      return d;
    }

    function applyDraftToForm(d){
      fornamnEl.value = d?.fornamn || "";
      efternamnEl.value = d?.efternamn || "";
      konEl.value = d?.kon || "";
      yrkeEl.value = d?.yrke || "";
      fodelsearEl.value = d?.fodelsear || "";
      dodsarEl.value = d?.dodsar || "";
      platsEl.value = d?.plats || "";

      if(d && d.coords && typeof d.coords === "object"){
        const lat = Number(d.coords.lat);
        const lon = Number(d.coords.lon);
        if(inLatLonRange(lat, lon)){
          coordsEl.value = lat.toFixed(4) + ", " + lon.toFixed(4);
        }else{
          coordsEl.value = "";
        }
      }else{
        coordsEl.value = "";
      }

      anteckningEl.value = d?.anteckning || "";
    }

    function setFormMode(mode, person){
      if(mode === "EDIT"){
        formTitle.textContent = "Redigera person";
        formSub.textContent = person ? ("Redigerar: " + personName(person)) : "Redigera person.";
        deleteBtn.disabled = false;
      }else{
        formTitle.textContent = "Skapa person";
        formSub.textContent = "Fyll i uppgifter och spara.";
        deleteBtn.disabled = true;
      }
    }

    let autosaveTimer = null;
    function scheduleAutosave(){
      if(autosaveTimer) clearTimeout(autosaveTimer);
      autosaveTimer = setTimeout(() => {
        try{ readFormToDraft(); }catch{}
      }, 180);
    }

    function consumePlaceResult(){
      const ctx = loadJson(PLACE_CTX_KEY, null);
      const res = loadJson(PLACE_RES_KEY, null);
      if(!ctx || !res) return false;

      const t = activeTreeId();
      if(!t || String(ctx.treeId || "") !== String(t)){
        localStorage.removeItem(PLACE_CTX_KEY);
        localStorage.removeItem(PLACE_RES_KEY);
        return false;
      }

      const lat = Number(res.lat);
      const lon = Number(res.lon);
      if(!inLatLonRange(lat, lon)){
        localStorage.removeItem(PLACE_CTX_KEY);
        localStorage.removeItem(PLACE_RES_KEY);
        return false;
      }

      const d = loadDraft() || {};
      const editId = String(ctx.editId || "");
      if(editId) d.id = editId;

      d.coords = { lat, lon };

      if(res.label && String(res.label).trim()){
        d.plats = String(res.label).trim();
      }else if(!d.plats){
        d.plats = "";
      }

      saveDraft(d);
      applyDraftToForm(d);

      localStorage.removeItem(PLACE_CTX_KEY);
      localStorage.removeItem(PLACE_RES_KEY);

      showTopMsg("ok", "✅ Plats införd från kartan. Glöm inte att spara personen.");
      return true;
    }

    function showTopMsg(kind, text){
      topMsg.hidden = false;
      topMsg.style.borderColor = (kind === "ok") ? "#cfe8cf" : (kind === "err" ? "#ffb3b3" : "#ffe1a6");
      topMsg.style.background  = (kind === "ok") ? "#f5fff5" : (kind === "err" ? "#fff2f2" : "#fff9ee");
      topMsg.innerHTML = escapeHtml(text);
    }
    function clearTopMsg(){
      topMsg.hidden = true;
      topMsg.innerHTML = "";
    }

    function renderList(){
      const people = loadPeople();
      const q = String(searchEl.value || "").trim().toLowerCase();

      let arr = people;
      if(q && q.length >= 3){
        arr = people.filter(p => {
          const n = personName(p).toLowerCase();
          const place = String(p.plats || "").toLowerCase();
          return n.includes(q) || place.includes(q);
        });
      }else if(q && q.length > 0 && q.length < 3){
        arr = [];
      }

      matchInfo.textContent =
        (q ? (q.length >= 3 ? (arr.length + " matchar") : "Skriv minst 3 bokstäver") : (people.length + " totalt"));

      listEl.innerHTML = "";

      if(arr.length === 0){
        const li = document.createElement("li");
        li.className = "item";
        li.style.cursor = "default";
        li.innerHTML =
          "<p class='itemTitle'>Inga träffar</p>" +
          "<p class='itemMeta'>" + (q && q.length < 3 ? "Skriv minst 3 bokstäver för förslag." : "Prova Visa alla eller skapa ny.") + "</p>";
        listEl.appendChild(li);
        return;
      }

      for(const p of arr){
        const li = document.createElement("li");
        li.className = "item";
        li.dataset.id = String(p.id);

        const coordsTxt = (p.coords && typeof p.coords === "object" && inLatLonRange(Number(p.coords.lat), Number(p.coords.lon)))
          ? (Number(p.coords.lat).toFixed(4) + ", " + Number(p.coords.lon).toFixed(4))
          : "";

        li.innerHTML =
          "<p class='itemTitle'>" + escapeHtml(personName(p)) + "</p>" +
          "<p class='itemMeta'>" +
            (p.plats ? ("Plats: " + escapeHtml(p.plats)) : "Plats: —") +
            (coordsTxt ? (" · Coords: " + escapeHtml(coordsTxt)) : "") +
          "</p>";

        li.addEventListener("click", () => {
          clearTopMsg();
          const id = String(p.id);
          setEditId(id);

          const d = makeDraftFromPerson(p);
          saveDraft(d);
          applyDraftToForm(d);
          setFormMode("EDIT", p);
        });

        listEl.appendChild(li);
      }
    }

    function refreshHeaderPills(){
      const t = activeTreeId();
      const trees = getTrees();
      const hasTrees = trees.length > 0;
      const hasActive = !!t;

      pillTree.className = "pill " + (hasActive ? "ok" : (hasTrees ? "warn" : "err"));
      pillTree.innerHTML = "Aktivt träd: <strong>" + escapeHtml(hasActive ? activeTreeLabel() : "—") + "</strong>";

      const people = hasActive ? loadPeople() : [];
      pillPeople.innerHTML = "Personer: <strong>" + people.length + "</strong>";

      const d = hasActive ? loadDraft() : null;
      if(d){
        pillDraft.innerHTML = "Utkast: <strong>Ja</strong>";
        pillDraft.className = "pill ok";
      }else{
        pillDraft.innerHTML = "Utkast: <strong>Nej</strong>";
        pillDraft.className = "pill";
      }
    }

    function initForm(){
      clearTopMsg();
      refreshHeaderPills();

      const t = activeTreeId();
      const hasActive = !!t;

      if(!hasActive){
        showTopMsg("warn", "⚠️ Inget aktivt träd. Gå till Träd och välj ett aktivt träd.");
        setFormMode("NEW", null);
        applyDraftToForm(null);
        return;
      }

      consumePlaceResult();

      const d = loadDraft();
      const editId = getEditId();

      if(d){
        applyDraftToForm(d);
        if(d.id){
          const p = loadPeople().find(x => String(x.id) === String(d.id));
          setFormMode("EDIT", p || d);
        }else if(editId){
          d.id = editId;
          saveDraft(d);
          const p = loadPeople().find(x => String(x.id) === String(editId));
          setFormMode("EDIT", p || d);
        }else{
          setFormMode("NEW", null);
        }
      }else{
        if(editId){
          const p = loadPeople().find(x => String(x.id) === String(editId));
          if(p){
            const nd = makeDraftFromPerson(p);
            saveDraft(nd);
            applyDraftToForm(nd);
            setFormMode("EDIT", p);
          }else{
            setEditId("");
            setFormMode("NEW", null);
            applyDraftToForm(null);
          }
        }else{
          setFormMode("NEW", null);
          applyDraftToForm(null);
        }
      }
    }

    function validateDraft(d){
      if(!d.fornamn || !d.efternamn){
        return "Förnamn och efternamn krävs.";
      }
      return "";
    }

    function saveCurrent(){
      const t = activeTreeId();
      if(!t){
        showTopMsg("warn", "⚠️ Välj aktivt träd först.");
        return;
      }

      const d = readFormToDraft();
      const err = validateDraft(d);
      if(err){
        showTopMsg("err", "⛔ " + err);
        return;
      }

      const people = loadPeople();
      const editingId = d.id || getEditId();

      if(editingId){
        const idx = people.findIndex(p => String(p.id) === String(editingId));
        const id = String(editingId);

        const updated = {
          id,
          fornamn: d.fornamn,
          efternamn: d.efternamn,
          kon: d.kon,
          yrke: d.yrke,
          fodelsear: d.fodelsear,
          dodsar: d.dodsar,
          plats: d.plats,
          coords: d.coords ? { lat: Number(d.coords.lat), lon: Number(d.coords.lon) } : null,
          anteckning: d.anteckning
        };

        if(idx >= 0) people[idx] = updated;
        else people.push(updated);

        savePeople(people);
        setEditId(id);
        saveDraft(makeDraftFromPerson(updated));
        showTopMsg("ok", "✅ Sparat.");
      }else{
        const id = newId();
        const created = {
          id,
          fornamn: d.fornamn,
          efternamn: d.efternamn,
          kon: d.kon,
          yrke: d.yrke,
          fodelsear: d.fodelsear,
          dodsar: d.dodsar,
          plats: d.plats,
          coords: d.coords ? { lat: Number(d.coords.lat), lon: Number(d.coords.lon) } : null,
          anteckning: d.anteckning
        };
        people.push(created);
        savePeople(people);
        setEditId(id);
        saveDraft(makeDraftFromPerson(created));
        setFormMode("EDIT", created);
        showTopMsg("ok", "✅ Sparat (ny person).");
      }

      refreshHeaderPills();
      renderList();
    }

    function deleteCurrent(){
      const t = activeTreeId();
      if(!t){
        showTopMsg("warn", "⚠️ Välj aktivt träd först.");
        return;
      }

      const editId = getEditId();
      const d = loadDraft();
      const id = String((d && d.id) || editId || "");

      if(!id){
        showTopMsg("warn", "⚠️ Ingen vald person att ta bort.");
        return;
      }

      const people = loadPeople();
      const next = people.filter(p => String(p.id) !== String(id));
      savePeople(next);

      setEditId("");
      clearDraft();
      applyDraftToForm(null);
      setFormMode("NEW", null);

      showTopMsg("ok", "✅ Personen togs bort.");
      refreshHeaderPills();
      renderList();
    }

    function resetToSaved(){
      const t = activeTreeId();
      if(!t) return;

      const editId = getEditId();
      if(!editId){
        clearDraft();
        applyDraftToForm(null);
        setFormMode("NEW", null);
        showTopMsg("ok", "✅ Återställde (tomt).");
        refreshHeaderPills();
        return;
      }

      const p = loadPeople().find(x => String(x.id) === String(editId));
      if(p){
        const d = makeDraftFromPerson(p);
        saveDraft(d);
        applyDraftToForm(d);
        setFormMode("EDIT", p);
        showTopMsg("ok", "✅ Återställde till sparad version.");
      }else{
        setEditId("");
        clearDraft();
        applyDraftToForm(null);
        setFormMode("NEW", null);
        showTopMsg("warn", "⚠️ Kunde inte hitta sparad person. Startar ny.");
      }

      refreshHeaderPills();
      renderList();
    }

    function startPlacePick(){
      const t = activeTreeId();
      if(!t){
        showTopMsg("warn", "⚠️ Välj aktivt träd först.");
        return;
      }

      const d = readFormToDraft();
      if(d.id) setEditId(d.id);

      const ctx = { treeId: String(t), editId: String(d.id || getEditId() || ""), ts: Date.now() };
      saveJson(PLACE_CTX_KEY, ctx);

      window.location.href = "./place-picker.html";
    }

    function clearPlace(){
      const d = loadDraft() || {};
      d.plats = "";
      d.coords = null;
      saveDraft(d);
      applyDraftToForm(d);
      showTopMsg("ok", "✅ Plats rensad (glöm inte att spara).");
    }

    // =====================================================
    // PATCH: AUTO-OPEN FROM HASH (#open=<personId>)
    // =====================================================
    function getOpenIdFromHash(){
      const h = String(window.location.hash || "");
      if(!h.startsWith("#open=")) return "";
      try{
        return decodeURIComponent(h.slice("#open=".length)).trim();
      }catch{
        return "";
      }
    }

    function clearHash(){
      try{
        history.replaceState(null, "", window.location.pathname + window.location.search);
      }catch{
        // fallback
        window.location.hash = "";
      }
    }

    function tryOpenFromHash(){
      const openId = getOpenIdFromHash();
      if(!openId) return false;

      const t = activeTreeId();
      if(!t){
        showTopMsg("warn", "⚠️ Kan inte öppna importerad person: inget aktivt träd valt.");
        clearHash();
        return true;
      }

      const people = loadPeople();
      const p = people.find(x => String(x.id) === String(openId));
      if(!p){
        showTopMsg("warn", "⚠️ Kunde inte hitta importerad person (id saknas i listan).");
        clearHash();
        return true;
      }

      setEditId(String(p.id));
      const d = makeDraftFromPerson(p);
      saveDraft(d);
      applyDraftToForm(d);
      setFormMode("EDIT", p);
      showTopMsg("ok", "✅ Import klar. Personen är öppnad för redigering.");
      clearHash();
      return true;
    }

    // EVENTS
    logoutBtn.addEventListener("click", () => {
      try{ sessionStorage.removeItem("demo_auth"); }catch{}
      window.location.href = "../index.html";
    });

    newBtn.addEventListener("click", () => {
      clearTopMsg();
      setEditId("");
      clearDraft();
      applyDraftToForm(null);
      setFormMode("NEW", null);
      refreshHeaderPills();
      try{ fornamnEl.focus(); }catch{}
    });

    reloadBtn.addEventListener("click", () => {
      initForm();
      renderList();
      // efter reload: om hash finns, försök igen
      tryOpenFromHash();
    });

    // FIX: knappen ska faktiskt gå till sidan
    findHistoricalBtn.addEventListener("click", () => {
      window.location.href = "./person-search.html";
    });

    saveBtn.addEventListener("click", saveCurrent);
    deleteBtn.addEventListener("click", deleteCurrent);
    resetBtn.addEventListener("click", resetToSaved);

    pickPlaceBtn.addEventListener("click", startPlacePick);
    clearPlaceBtn.addEventListener("click", clearPlace);

    [fornamnEl, efternamnEl, konEl, yrkeEl, fodelsearEl, dodsarEl, platsEl, coordsEl, anteckningEl]
      .forEach(el => el.addEventListener("input", scheduleAutosave));

    let searchTimer = null;
    searchEl.addEventListener("input", () => {
      if(searchTimer) clearTimeout(searchTimer);
      searchTimer = setTimeout(renderList, 120);
    });
    showAllBtn.addEventListener("click", () => {
      searchEl.value = "";
      renderList();
    });
    clearSearchBtn.addEventListener("click", () => {
      searchEl.value = "";
      renderList();
      try{ searchEl.focus(); }catch{}
    });

    // START
    initForm();
    renderList();
    // efter init: försök öppna om vi kom hit från import
    tryOpenFromHash();
  </script>
</body>
</html>
