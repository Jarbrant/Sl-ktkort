<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Personer ‚Äì Sl√§ktkort</title>
  <meta name="description" content="Skapa och redigera personer i aktivt tr√§d. Plats v√§ljs fr√•n kartan." />

  <style>
    :root { color-scheme: light; }
    body{
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      line-height: 1.5;
      margin: 0;
      padding: 24px;
      max-width: 1180px;
      margin-inline: auto;
      background: #fff;
      color: #111;
    }
    a{ color: inherit; text-decoration:none; }

    header{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      margin-bottom:18px;
    }
    h1{ margin:0 0 6px; font-size:1.6rem; }
    .muted{ color:#555; margin:0 0 12px; }

    .topbar{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      margin: 10px 0 0;
    }
    .btn, button{
      display:inline-block;
      padding:10px 12px;
      border:1px solid #333;
      border-radius:10px;
      background:#fff;
      font:inherit;
      cursor:pointer;
      text-decoration:none;
      user-select:none;
    }
    .btn.secondary{ border-color:#bbb; }
    .btn.danger{ border-color:#b00020; color:#b00020; }
    .btn:disabled{ opacity:.5; cursor:not-allowed; }

    .pillRow{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      margin: 10px 0 18px;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border:1px solid #ddd;
      border-radius:999px;
      background:#fafafa;
      font-size:.95rem;
    }
    .pill strong{ font-weight:900; }
    .pill.ok{ border-color:#cfe8cf; background:#f5fff5; }
    .pill.warn{ border-color:#ffe1a6; background:#fff9ee; }
    .pill.err{ border-color:#ffb3b3; background:#fff2f2; }

    .grid{
      display:grid;
      gap:14px;
      grid-template-columns: 1fr;
    }
    @media (min-width: 1080px){
      .grid{ grid-template-columns: 420px 1fr; }
    }

    .card{
      border:1px solid #ddd;
      border-radius:12px;
      padding:16px;
      background:#fff;
      position: relative;
    }
    .card h2{ margin:0 0 6px; font-size:1.15rem; }
    .small{ font-size:.95rem; color:#555; margin:0 0 10px; }

    label{ display:block; margin:10px 0 6px; font-weight:800; }
    input, select, textarea{
      width:100%;
      box-sizing:border-box;
      padding:10px;
      border-radius:10px;
      border:1px solid #bbb;
      font:inherit;
      background:#fff;
    }
    textarea{ min-height: 92px; resize: vertical; }

    .row2{
      display:grid;
      grid-template-columns: 1fr;
      gap:12px;
    }
    @media (min-width: 720px){
      .row2{ grid-template-columns: 1fr 1fr; }
    }

    .actions{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      margin-top: 12px;
    }

    .hintBox{
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid #ffe1a6;
      background: #fff9ee;
    }
    .okBox{
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid #cfe8cf;
      background: #f5fff5;
    }
    .errBox{
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid #ffb3b3;
      background: #fff2f2;
    }

    .list{
      margin: 10px 0 0;
      padding: 0;
      list-style:none;
      display:flex;
      flex-direction:column;
      gap:10px;
      max-height: 560px;
      overflow:auto;
      border-top: 1px solid #eee;
      padding-top: 10px;
    }
    .item{
      border:1px solid #eee;
      border-radius:12px;
      padding:10px;
      background:#fff;
      cursor:pointer;
    }
    .item:hover{ background:#fafafa; }
    .item.active{
      border-color:#7fcf9b;
      box-shadow: 0 0 0 4px rgba(183,228,199,.35);
    }
    .itemTitle{ font-weight:900; margin:0 0 2px; }
    .itemMeta{ margin:0; color:#555; font-size:.95rem; }
    .itemSub{ margin:4px 0 0; color:#333; font-size:.95rem; }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    code{ background:#f4f4f4; padding:2px 6px; border-radius:6px; }

    .sr-only{
      position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px;
      overflow: hidden; clip: rect(0,0,0,0); white-space: nowrap; border: 0;
    }
  </style>
</head>

<body>
<header>
  <div>
    <h1>Personer</h1>
    <p class="muted">Skapa och redigera personer i <strong>aktivt tr√§d</strong>. Plats v√§ljs fr√•n kartan.</p>

    <nav class="topbar" aria-label="Navigation">
      <a class="btn secondary" href="../start.html">Start</a>
      <a class="btn secondary" href="./trees.html">Tr√§d</a>
      <a class="btn" href="./slaktkort.html">Personer</a>
      <a class="btn secondary" href="./create-relation.html">Relationer</a>
      <a class="btn secondary" href="./map.html">Karta</a>
    </nav>
  </div>

  <div class="actions" style="justify-content:flex-end;">
    <button id="logoutBtn" class="btn secondary" type="button">Logga ut</button>
  </div>
</header>

<section class="pillRow" aria-label="Status">
  <span id="pillTree" class="pill warn">Aktivt tr√§d: <strong>‚Äî</strong></span>
  <span id="pillPeople" class="pill">Personer: <strong>0</strong></span>
  <span id="pillDraft" class="pill">Utkast: <strong>‚Äî</strong></span>
</section>

<div class="grid">
  <!-- V√ÑNSTER: LISTA -->
  <section class="card" aria-label="Personlista">
    <h2>Personlista</h2>
    <p class="small">Klicka en person f√∂r att redigera. ‚ÄúSkapa ny‚Äù g√∂r en ny person i aktivt tr√§d.</p>

    <label for="search">S√∂k</label>
    <input id="search" placeholder="S√∂k namn‚Ä¶" autocomplete="off" />

    <div class="actions">
      <button id="newBtn" class="btn" type="button">Skapa ny person</button>
      <button id="reloadBtn" class="btn secondary" type="button">Ladda om</button>
    </div>

    <div id="hint" class="hintBox" hidden></div>

    <ul id="list" class="list" aria-label="Personer"></ul>
  </section>

  <!-- H√ñGER: FORM -->
  <section class="card" aria-label="Personkort">
    <h2 id="panelTitle">Skapa person</h2>
    <p class="small" id="panelSub">Fyll i uppgifter och spara.</p>

    <div id="ok" class="okBox" hidden></div>
    <div id="err" class="errBox" hidden></div>

    <div class="row2">
      <div>
        <label for="fornamn">F√∂rnamn</label>
        <input id="fornamn" autocomplete="off" />
      </div>
      <div>
        <label for="efternamn">Efternamn</label>
        <input id="efternamn" autocomplete="off" />
      </div>
    </div>

    <div class="row2">
      <div>
        <label for="kon">K√∂n</label>
        <select id="kon">
          <option value="">V√§lj‚Ä¶</option>
          <option value="man">man</option>
          <option value="kvinna">kvinna</option>
        </select>
      </div>
      <div>
        <label for="yrke">Yrke (valfritt)</label>
        <input id="yrke" autocomplete="off" />
      </div>
    </div>

    <div class="row2">
      <div>
        <label for="fodelsear">F√∂delse√•r (valfritt)</label>
        <input id="fodelsear" inputmode="numeric" placeholder="t.ex. 1988" />
      </div>
      <div>
        <label for="dodsar">D√∂ds√•r (valfritt)</label>
        <input id="dodsar" inputmode="numeric" placeholder="t.ex. 2020" />
      </div>
    </div>

    <label for="platsText">Plats (text, valfritt)</label>
    <input id="platsText" placeholder="t.ex. Falun" autocomplete="off" />

    <label for="coords">Koordinater (fr√•n kartan)</label>
    <input id="coords" class="mono" readonly placeholder="V√§lj plats p√• kartan" />

    <div class="actions">
      <button id="pickBtn" class="btn secondary" type="button">V√§lj plats</button>
      <button id="clearPlaceBtn" class="btn secondary" type="button">Rensa plats</button>
    </div>

    <label for="anteckning">Anteckning (valfritt)</label>
    <textarea id="anteckning" placeholder="Skriv n√•got kort‚Ä¶"></textarea>

    <div class="actions">
      <button id="saveBtn" class="btn" type="button">Spara</button>
      <button id="deleteBtn" class="btn danger" type="button" disabled>Ta bort</button>
      <button id="resetBtn" class="btn secondary" type="button">√Öterst√§ll</button>
    </div>

    <div class="hintBox" style="margin-top:14px;">
      <strong>Platsfl√∂de</strong>
      <div class="small" style="margin-top:6px;">
        N√§r du klickar <code>V√§lj plats</code> sparas ett utkast automatiskt.<br/>
        Kartan kan sedan skriva tillbaka koordinater via <code>slakttradet_place_pick_result</code>.
      </div>
    </div>

    <p class="small" id="tech" style="margin-top:10px;">‚Äî</p>
  </section>
</div>

<script>
  "use strict";

  // =====================================================
  // DEMO AUTH GUARD (matchar dina andra sidor)
  // =====================================================
  (function authGuard(){
    try{
      if(sessionStorage.getItem("demo_auth") !== "1"){
        window.location.href = "../index.html";
      }
    }catch{}
  })();

  // =====================================================
  // STORAGE KEYS (L√ÖSTA)
  // =====================================================
  const KEY_TREES  = "slakttradet_trees";
  const KEY_ACTIVE = "slakttradet_active_tree_id";
  const cardsKey = (treeId) => "slakttradet_slaktkort_" + String(treeId);

  // Handshake med karta
  // map.html (eller annan sida) kan s√§tta:
  // slakttradet_place_pick_result = { treeId, personId, lat, lon, placeText?, ts }
  const KEY_PICK_RESULT  = "slakttradet_place_pick_result";
  // vi sparar ett utkast s√• inget f√∂rsvinner
  const draftKey = (treeId) => "slakttradet_person_draft_" + String(treeId);

  // =====================================================
  // DOM
  // =====================================================
  const logoutBtn = document.getElementById("logoutBtn");

  const pillTree = document.getElementById("pillTree");
  const pillPeople = document.getElementById("pillPeople");
  const pillDraft = document.getElementById("pillDraft");

  const hintEl = document.getElementById("hint");
  const okEl = document.getElementById("ok");
  const errEl = document.getElementById("err");

  const searchEl = document.getElementById("search");
  const newBtn = document.getElementById("newBtn");
  const reloadBtn = document.getElementById("reloadBtn");
  const listEl = document.getElementById("list");

  const panelTitle = document.getElementById("panelTitle");
  const panelSub = document.getElementById("panelSub");

  const fornamnEl = document.getElementById("fornamn");
  const efternamnEl = document.getElementById("efternamn");
  const konEl = document.getElementById("kon");
  const yrkeEl = document.getElementById("yrke");
  const fodelsearEl = document.getElementById("fodelsear");
  const dodsarEl = document.getElementById("dodsar");
  const platsTextEl = document.getElementById("platsText");
  const coordsEl = document.getElementById("coords");
  const anteckningEl = document.getElementById("anteckning");

  const pickBtn = document.getElementById("pickBtn");
  const clearPlaceBtn = document.getElementById("clearPlaceBtn");

  const saveBtn = document.getElementById("saveBtn");
  const deleteBtn = document.getElementById("deleteBtn");
  const resetBtn = document.getElementById("resetBtn");

  const techEl = document.getElementById("tech");

  // =====================================================
  // HELPERS
  // =====================================================
  function safeParse(raw, fallback){
    try{ return JSON.parse(raw); }catch{ return fallback; }
  }
  function loadJson(key, fallback){
    const raw = localStorage.getItem(key);
    return raw ? safeParse(raw, fallback) : fallback;
  }
  function saveJson(key, value){
    localStorage.setItem(key, JSON.stringify(value));
  }
  function escapeHtml(s){
    return String(s || "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }
  function nowId(){
    return "p_" + Date.now().toString(36) + "_" + Math.random().toString(36).slice(2,8);
  }

  function setBox(el, html){
    el.hidden = false;
    el.innerHTML = html;
  }
  function clearBoxes(){
    hintEl.hidden = true; hintEl.innerHTML = "";
    okEl.hidden = true; okEl.innerHTML = "";
    errEl.hidden = true; errEl.innerHTML = "";
  }

  function getTrees(){
    const arr = loadJson(KEY_TREES, []);
    return Array.isArray(arr) ? arr : [];
  }
  function activeTreeId(){
    return localStorage.getItem(KEY_ACTIVE) || "";
  }
  function activeTreeLabel(){
    const id = activeTreeId();
    if(!id) return "‚Äî";
    const t = getTrees().find(x => String(x.id) === String(id));
    return t ? (t.name || t.id) : id;
  }

  function loadPeople(){
    const t = activeTreeId();
    if(!t) return [];
    const arr = loadJson(cardsKey(t), []);
    return Array.isArray(arr) ? arr : [];
  }
  function savePeople(arr){
    const t = activeTreeId();
    if(!t) return;
    saveJson(cardsKey(t), Array.isArray(arr) ? arr : []);
  }

  function personName(p){
    const n = `${p.fornamn || ""} ${p.efternamn || ""}`.trim();
    return n || "(namnl√∂s)";
  }
  function yearsLine(p){
    const a = (p && p.fodelsear != null && String(p.fodelsear).trim() !== "") ? String(p.fodelsear).trim() : "";
    const b = (p && p.dodsar != null && String(p.dodsar).trim() !== "") ? String(p.dodsar).trim() : "";
    if(!a && !b) return "";
    if(a && b) return `${a}‚Äì${b}`;
    return a ? `${a}‚Äì` : `‚Äì${b}`;
  }

  function normalizeYear(v){
    const s = String(v || "").trim();
    if(!s) return "";
    const n = Number(s);
    if(!Number.isFinite(n)) return "";
    const i = Math.trunc(n);
    // enkel sanity, men inte f√∂r h√•rd
    if(i < 0 || i > 3000) return "";
    return String(i);
  }

  function normalizeCoords(lat, lon){
    const a = Number(lat), b = Number(lon);
    if(!Number.isFinite(a) || !Number.isFinite(b)) return null;
    if(a < -90 || a > 90 || b < -180 || b > 180) return null;
    return { lat: a, lon: b };
  }

  // =====================================================
  // STATE
  // =====================================================
  let people = [];
  let selectedId = ""; // "" = create mode
  let searchTimer = null;

  // =====================================================
  // DRAFT (s√• inget f√∂rsvinner vid karta)
  // =====================================================
  function getDraft(){
    const t = activeTreeId();
    if(!t) return null;
    return loadJson(draftKey(t), null);
  }
  function setDraft(obj){
    const t = activeTreeId();
    if(!t) return;
    saveJson(draftKey(t), obj);
  }
  function clearDraft(){
    const t = activeTreeId();
    if(!t) return;
    localStorage.removeItem(draftKey(t));
  }

  function formToDraft(){
    const t = activeTreeId();
    if(!t) return null;

    const d = {
      treeId: t,
      selectedId: selectedId || "",
      form: {
        id: selectedId || "",
        fornamn: String(fornamnEl.value || ""),
        efternamn: String(efternamnEl.value || ""),
        kon: String(konEl.value || ""),
        yrke: String(yrkeEl.value || ""),
        fodelsear: String(fodelsearEl.value || ""),
        dodsar: String(dodsarEl.value || ""),
        plats: String(platsTextEl.value || ""),
        coordsText: String(coordsEl.value || ""), // "lat, lon"
        anteckning: String(anteckningEl.value || "")
      },
      ts: Date.now()
    };
    return d;
  }

  function applyDraftToForm(d){
    if(!d || !d.form) return;

    // vi applicerar bara formf√§lt
    fornamnEl.value = d.form.fornamn || "";
    efternamnEl.value = d.form.efternamn || "";
    konEl.value = d.form.kon || "";
    yrkeEl.value = d.form.yrke || "";
    fodelsearEl.value = d.form.fodelsear || "";
    dodsarEl.value = d.form.dodsar || "";
    platsTextEl.value = d.form.plats || "";
    coordsEl.value = d.form.coordsText || "";
    anteckningEl.value = d.form.anteckning || "";
  }

  // =====================================================
  // UI
  // =====================================================
  function renderPills(){
    const trees = getTrees();
    const act = activeTreeId();
    const hasTrees = trees.length > 0;
    const hasActive = !!act && trees.some(t => String(t.id) === String(act));

    pillTree.className = "pill " + (hasActive ? "ok" : (hasTrees ? "warn" : "err"));
    pillTree.innerHTML = "Aktivt tr√§d: <strong>" + escapeHtml(hasActive ? activeTreeLabel() : "‚Äî") + "</strong>";

    pillPeople.innerHTML = "Personer: <strong>" + (hasActive ? people.length : 0) + "</strong>";

    const d = getDraft();
    pillDraft.innerHTML = "Utkast: <strong>" + (d && d.ts ? "Ja" : "Nej") + "</strong>";
  }

  function renderHint(){
    const trees = getTrees();
    const act = activeTreeId();
    const hasTrees = trees.length > 0;
    const hasActive = !!act && trees.some(t => String(t.id) === String(act));

    if(!hasTrees){
      setBox(hintEl, "<strong>üö© Inga tr√§d:</strong> G√• till <a href='./trees.html'><code>Tr√§d</code></a> och skapa ett tr√§d.");
      return false;
    }
    if(!hasActive){
      setBox(hintEl, "<strong>üö© Inget aktivt tr√§d:</strong> V√§lj aktivt tr√§d i <a href='./trees.html'><code>Tr√§d</code></a>.");
      return false;
    }
    return true;
  }

  function matchesSearch(p, q){
    if(!q) return true;
    const name = (personName(p) || "").toLowerCase();
    return name.includes(q);
  }

  function renderList(){
    listEl.innerHTML = "";

    const ok = renderHint();
    if(!ok){
      const li = document.createElement("li");
      li.className = "item";
      li.style.cursor = "default";
      li.innerHTML = "<p class='itemTitle'>‚Äî</p><p class='itemMeta'>V√§lj aktivt tr√§d f√∂rst.</p>";
      listEl.appendChild(li);
      return;
    }

    const q = String(searchEl.value || "").trim().toLowerCase();
    const filtered = people.filter(p => matchesSearch(p, q));

    if(filtered.length === 0){
      const li = document.createElement("li");
      li.className = "item";
      li.style.cursor = "default";
      li.innerHTML = "<p class='itemTitle'>Inga tr√§ffar</p><p class='itemMeta'>Prova att rensa s√∂k.</p>";
      listEl.appendChild(li);
      return;
    }

    for(const p of filtered){
      const li = document.createElement("li");
      const isSel = selectedId && String(p.id) === String(selectedId);
      li.className = "item" + (isSel ? " active" : "");
      li.dataset.id = String(p.id);

      const years = yearsLine(p);
      const coords = (p.coords && typeof p.coords === "object") ? p.coords : null;
      const coordsLine = coords && Number.isFinite(+coords.lat) && Number.isFinite(+coords.lon)
        ? ("üìç " + Number(coords.lat).toFixed(4) + ", " + Number(coords.lon).toFixed(4))
        : "";

      const placeLine = String(p.plats || "").trim();

      li.innerHTML =
        "<p class='itemTitle'>" + escapeHtml(personName(p)) + "</p>" +
        "<p class='itemMeta'>" + escapeHtml(years || "‚Äî") + "</p>" +
        "<p class='itemSub'>" + escapeHtml([placeLine, coordsLine].filter(Boolean).join(" ¬∑ ") || "‚Äî") + "</p>";

      li.addEventListener("click", () => {
        selectPerson(String(p.id));
      });

      listEl.appendChild(li);
    }
  }

  function setPanelMode(){
    if(selectedId){
      const p = people.find(x => String(x.id) === String(selectedId));
      panelTitle.textContent = "Redigera person";
      panelSub.textContent = "Uppdatera uppgifter och spara.";
      deleteBtn.disabled = false;

      if(p){
        // om det finns draft som matchar samma selectedId, anv√§nd det (s√• inget f√∂rsvinner)
        const d = getDraft();
        if(d && String(d.selectedId || "") === String(selectedId)){
          applyDraftToForm(d);
        }else{
          fillFormFromPerson(p);
        }
      }
    }else{
      panelTitle.textContent = "Skapa person";
      panelSub.textContent = "Fyll i uppgifter och spara.";
      deleteBtn.disabled = true;

      // om det finns draft f√∂r "ny" person, anv√§nd det
      const d = getDraft();
      if(d && !d.selectedId){
        applyDraftToForm(d);
      }else{
        clearForm();
      }
    }
    renderTech();
  }

  function clearForm(){
    fornamnEl.value = "";
    efternamnEl.value = "";
    konEl.value = "";
    yrkeEl.value = "";
    fodelsearEl.value = "";
    dodsarEl.value = "";
    platsTextEl.value = "";
    coordsEl.value = "";
    anteckningEl.value = "";
  }

  function fillFormFromPerson(p){
    fornamnEl.value = p.fornamn || "";
    efternamnEl.value = p.efternamn || "";
    konEl.value = p.kon || "";
    yrkeEl.value = p.yrke || "";
    fodelsearEl.value = (p.fodelsear != null ? String(p.fodelsear) : "");
    dodsarEl.value = (p.dodsar != null ? String(p.dodsar) : "");
    platsTextEl.value = p.plats || p.platsText || p.platsnamn || p.plats_legacy || p.plats_old || p.plats_v1 || p.plats_v2 || p.plats_v3 || p.plats_v4 || p.plats_v5 || p.plats_v6 || p.plats_v7 || p.plats_v8 || p.plats_v9 || p.plats_v10 || p.plats_v11 || p.plats_v12 || p.plats_v13 || p.plats_v14 || p.plats_v15 || p.plats_v16 || p.plats_v17 || p.plats_v18 || p.plats_v19 || p.plats_v20 || p.plats_v21 || p.plats_v22 || p.plats_v23 || p.plats_v24 || p.plats_v25 || p.plats_v26 || p.plats_v27 || p.plats_v28 || p.plats_v29 || p.plats_v30 || p.plats_v31 || p.plats_v32 || p.plats_v33 || p.plats_v34 || p.plats_v35 || p.plats_v36 || p.plats_v37 || p.plats_v38 || p.plats_v39 || p.plats_v40 || p.plats_v41 || p.plats_v42 || p.plats_v43 || p.plats_v44 || p.plats_v45 || p.plats_v46 || p.plats_v47 || p.plats_v48 || p.plats_v49 || p.plats_v50 || p.plats || "";
    anteckningEl.value = p.anteckning || "";

    const c = p.coords && typeof p.coords === "object" ? p.coords : null;
    if(c && Number.isFinite(+c.lat) && Number.isFinite(+c.lon)){
      coordsEl.value = Number(c.lat).toFixed(4) + ", " + Number(c.lon).toFixed(4);
    }else{
      coordsEl.value = "";
    }
  }

  function renderTech(){
    const t = activeTreeId();
    techEl.textContent =
      "Aktivt treeId: " + (t || "‚Äî") +
      " ¬∑ PeopleKey: " + (t ? cardsKey(t) : "‚Äî") +
      " ¬∑ Vald person: " + (selectedId || "‚Äî (ny)");
  }

  // =====================================================
  // CORE
  // =====================================================
  function selectPerson(id){
    clearBoxes();
    // innan vi byter person: spara draft f√∂r nuvarande form
    try{
      setDraft(formToDraft());
    }catch{}

    selectedId = String(id || "");
    setPanelMode();
    renderList();
    renderPills();
  }

  function setCreateMode(){
    clearBoxes();
    try{ setDraft(formToDraft()); }catch{}
    selectedId = "";
    setPanelMode();
    renderList();
    renderPills();
    try{ fornamnEl.focus(); }catch{}
  }

  function buildPersonFromForm(existingId){
    const fornamn = String(fornamnEl.value || "").trim();
    const efternamn = String(efternamnEl.value || "").trim();

    const kon = String(konEl.value || "").trim();
    const yrke = String(yrkeEl.value || "").trim();

    const fodelsear = normalizeYear(fodelsearEl.value);
    const dodsar = normalizeYear(dodsarEl.value);

    const plats = String(platsTextEl.value || "").trim();

    // coords text: "lat, lon"
    let coordsObj = null;
    const cText = String(coordsEl.value || "").trim();
    if(cText){
      const parts = cText.split(",").map(x => x.trim()).filter(Boolean);
      if(parts.length === 2){
        coordsObj = normalizeCoords(parts[0], parts[1]);
      }
    }

    const anteckning = String(anteckningEl.value || "").trim();

    const p = {
      id: existingId ? String(existingId) : nowId(),
      fornamn,
      efternamn,
      kon,
      yrke,
      fodelsear: fodelsear || "",
      dodsar: dodsar || "",
      plats,
      coords: coordsObj ? { lat: coordsObj.lat, lon: coordsObj.lon } : null,
      anteckning,
      updatedAt: Date.now()
    };

    // createdAt
    if(!existingId) p.createdAt = Date.now();

    return p;
  }

  function validatePerson(p){
    if(!p.fornamn && !p.efternamn){
      return "Skriv minst f√∂rnamn eller efternamn.";
    }
    if(p.kon && p.kon !== "man" && p.kon !== "kvinna"){
      return "K√∂n m√•ste vara man eller kvinna.";
    }
    // √•r √§r redan normaliserade
    // coords valideras i normalizeCoords
    return "";
  }

  function save(){
    clearBoxes();
    const okTree = renderHint();
    if(!okTree) return;

    const existing = selectedId ? people.find(x => String(x.id) === String(selectedId)) : null;
    const p = buildPersonFromForm(existing ? existing.id : "");

    const err = validatePerson(p);
    if(err){
      setBox(errEl, "<strong>Kan inte spara:</strong> " + escapeHtml(err));
      return;
    }

    // spara i array
    if(existing){
      const idx = people.findIndex(x => String(x.id) === String(existing.id));
      if(idx >= 0){
        // beh√•ll createdAt
        p.createdAt = existing.createdAt || p.createdAt || Date.now();
        people[idx] = p;
      }
    }else{
      people.unshift(p);
      selectedId = String(p.id);
    }

    savePeople(people);

    // n√§r vi sparat ‚Äúriktig‚Äù data: uppdatera draft s√• att den matchar sparad state
    try{
      setDraft(formToDraft());
    }catch{}

    setBox(okEl, "<strong>Sparat.</strong>");
    refresh();
  }

  function removePerson(){
    clearBoxes();
    if(!selectedId) return;

    const p = people.find(x => String(x.id) === String(selectedId));
    if(!p) return;

    const ok = confirm("Ta bort person?\n\n" + personName(p));
    if(!ok) return;

    people = people.filter(x => String(x.id) !== String(selectedId));
    savePeople(people);

    // rensa draft om det g√§llde samma person
    const d = getDraft();
    if(d && String(d.selectedId || "") === String(selectedId)){
      clearDraft();
    }

    selectedId = "";
    setBox(okEl, "<strong>Borttaget.</strong>");
    refresh();
  }

  function resetForm(){
    clearBoxes();
    const d = getDraft();

    if(selectedId){
      const p = people.find(x => String(x.id) === String(selectedId));
      if(!p){
        clearForm();
        return;
      }
      // om draft finns f√∂r denna person: √•terst√§ll till senast draft
      if(d && String(d.selectedId || "") === String(selectedId)){
        applyDraftToForm(d);
        setBox(okEl, "<strong>√Öterst√§llt fr√•n utkast.</strong>");
      }else{
        fillFormFromPerson(p);
        setBox(okEl, "<strong>√Öterst√§llt.</strong>");
      }
    }else{
      if(d && !d.selectedId){
        applyDraftToForm(d);
        setBox(okEl, "<strong>√Öterst√§llt fr√•n utkast.</strong>");
      }else{
        clearForm();
        setBox(okEl, "<strong>√Öterst√§llt.</strong>");
      }
    }
  }

  // =====================================================
  // PICK PLACE (NAVIGERA TILL KARTA MEN S√ÑKRA DATA)
  // =====================================================
  function saveDraftBeforeLeaving(){
    try{
      setDraft(formToDraft());
      renderPills();
    }catch{}
  }

  function goPickPlace(){
    clearBoxes();
    const okTree = renderHint();
    if(!okTree) return;

    // s√§kerst√§ll att vi har en person-id att koppla platsen till
    // om det √§r ny person utan id: skapa ett "pre-id" i draft s√• kartan kan skicka tillbaka
    if(!selectedId){
      const preId = nowId();
      selectedId = preId; // vi anv√§nder detta id n√§r vi senare sparar f√∂rsta g√•ngen
      // uppdatera UI-l√§ge s√• delete blir aktiv f√∂rst efter riktig save (men vi l√•ter det vara disabled)
      deleteBtn.disabled = true;
      setPanelMode();
    }

    saveDraftBeforeLeaving();

    // Skriv "context" s√• map.html kan veta vad som ska uppdateras (om du v√§ljer att l√§sa det d√§r)
    try{
      localStorage.setItem("slakttradet_place_pick_context", JSON.stringify({
        treeId: activeTreeId(),
        personId: selectedId,
        returnTo: "slaktkort",
        ts: Date.now()
      }));
    }catch{}

    // Navigera till karta
    // (map.html kan v√§lja att l√§sa context eller query params senare)
    window.location.href = "./map.html";
  }

  function clearPlace(){
    clearBoxes();
    platsTextEl.value = "";
    coordsEl.value = "";
    saveDraftBeforeLeaving();
    setBox(okEl, "<strong>Plats rensad i utkast.</strong> (Spara f√∂r att skriva till personen.)");
  }

  // =====================================================
  // APPLY PICK RESULT (n√§r vi kommer tillbaka fr√•n map)
  // =====================================================
  function tryApplyPickResult(){
    const raw = localStorage.getItem(KEY_PICK_RESULT);
    if(!raw) return false;

    const res = safeParse(raw, null);
    if(!res || !res.treeId || !res.personId) return false;

    // bara applicera om det g√§ller v√•rt aktiva tr√§d
    if(String(res.treeId) !== String(activeTreeId())) return false;

    // vi vill s√§tta coords i r√§tt person i formul√§ret:
    // om vi redan redigerar just den personen -> applicera direkt
    // annars: v√§lj personen (eller skapa draft-state) och applicera
    const targetId = String(res.personId);

    // coords
    const c = normalizeCoords(res.lat, res.lon);
    if(!c) return false;

    const coordsText = c.lat.toFixed(4) + ", " + c.lon.toFixed(4);

    // 1) Om vi √§r p√• samma person i form
    if(String(selectedId || "") === targetId){
      coordsEl.value = coordsText;
      if(res.placeText && String(res.placeText).trim()){
        platsTextEl.value = String(res.placeText).trim();
      }
      saveDraftBeforeLeaving();
      setBox(okEl, "<strong>Plats mottagen fr√•n kartan.</strong> (Tryck Spara f√∂r att skriva till personen.)");
      // konsumera
      localStorage.removeItem(KEY_PICK_RESULT);
      return true;
    }

    // 2) Om personen redan finns i listan
    const exists = people.some(p => String(p.id) === targetId);
    if(exists){
      selectedId = targetId;
      setPanelMode();
      coordsEl.value = coordsText;
      if(res.placeText && String(res.placeText).trim()){
        platsTextEl.value = String(res.placeText).trim();
      }
      saveDraftBeforeLeaving();
      setBox(okEl, "<strong>Plats mottagen fr√•n kartan.</strong> (Tryck Spara.)");
      localStorage.removeItem(KEY_PICK_RESULT);
      refresh();
      return true;
    }

    // 3) Om det var en ‚Äúny person‚Äù som bara fanns som draft
    // Vi byter till det id:t och l√§gger coords i draft/form, s√• inget tappas
    selectedId = targetId;
    setPanelMode();
    coordsEl.value = coordsText;
    if(res.placeText && String(res.placeText).trim()){
      platsTextEl.value = String(res.placeText).trim();
    }
    saveDraftBeforeLeaving();
    setBox(okEl, "<strong>Plats mottagen fr√•n kartan.</strong> (Fyll i namn och tryck Spara.)");
    localStorage.removeItem(KEY_PICK_RESULT);
    refresh();
    return true;
  }

  // =====================================================
  // REFRESH
  // =====================================================
  function refresh(){
    // uppdatera people
    people = loadPeople();

    // om selectedId inte l√§ngre finns i people och det inte √§r draft-preId -> g√• till create
    if(selectedId){
      const exists = people.some(p => String(p.id) === String(selectedId));
      if(!exists){
        // om det finns draft som matchar selectedId: l√•t det vara (ny person-l√§ge med preId)
        const d = getDraft();
        if(!(d && String(d.selectedId || "") === String(selectedId))){
          selectedId = "";
        }
      }
    }

    renderPills();
    renderList();
    setPanelMode();
    renderTech();

    // efter refresh: f√∂rs√∂k applicera pick-result om det finns
    try{ tryApplyPickResult(); }catch{}
  }

  // =====================================================
  // EVENTS
  // =====================================================
  newBtn.addEventListener("click", setCreateMode);

  reloadBtn.addEventListener("click", () => {
    clearBoxes();
    refresh();
    setBox(okEl, "<strong>Omladdat.</strong>");
  });

  saveBtn.addEventListener("click", save);
  deleteBtn.addEventListener("click", removePerson);
  resetBtn.addEventListener("click", resetForm);

  pickBtn.addEventListener("click", goPickPlace);
  clearPlaceBtn.addEventListener("click", clearPlace);

  logoutBtn.addEventListener("click", () => {
    try{ sessionStorage.removeItem("demo_auth"); }catch{}
    window.location.href = "../index.html";
  });

  // autospara draft n√§r man skriver (s√• inget tappas)
  const autosaveFields = [
    fornamnEl, efternamnEl, konEl, yrkeEl, fodelsearEl, dodsarEl, platsTextEl, anteckningEl
  ];
  for(const el of autosaveFields){
    el.addEventListener("input", () => {
      if(searchTimer) clearTimeout(searchTimer);
      searchTimer = setTimeout(() => {
        try{ setDraft(formToDraft()); renderPills(); }catch{}
      }, 120);
    });
  }

  // s√∂k
  searchEl.addEventListener("input", () => {
    if(searchTimer) clearTimeout(searchTimer);
    searchTimer = setTimeout(renderList, 120);
  });

  // s√§kerhets-autosave n√§r man l√§mnar sidan
  window.addEventListener("beforeunload", () => {
    try{ setDraft(formToDraft()); }catch{}
  });

  // =====================================================
  // START
  // =====================================================
  (function init(){
    clearBoxes();
    selectedId = ""; // start i skapa-l√§ge
    refresh();
  })();
</script>
</body>
</html>
