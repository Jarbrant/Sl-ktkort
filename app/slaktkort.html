<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Personer ‚Äì Sl√§ktkort</title>
  <meta name="description" content="Skapa/√§ndra sl√§ktkort (personer) per aktivt tr√§d i localStorage. Visar √§ven ber√§knade relationer (syskon/kusin/morbror osv) baserat p√• F√∂r√§lder‚ÜíBarn + Partner." />

  <style>
    :root { color-scheme: light; }
    body{
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      line-height: 1.5;
      margin: 0;
      padding: 24px;
      max-width: 980px;
      margin-inline: auto;
      background: #fff;
      color: #111;
    }
    a{ color: inherit; text-decoration:none; }
    header{ margin-bottom: 16px; }
    h1{ margin: 0 0 6px; font-size: 1.6rem; }
    .muted{ color:#555; margin: 0 0 12px; }

    .topbar{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      margin: 10px 0 16px;
    }
    .btn, button{
      display:inline-block;
      padding:10px 12px;
      border:1px solid #333;
      border-radius:10px;
      background:#fff;
      font:inherit;
      cursor:pointer;
      text-decoration:none;
    }
    .btn.secondary{ border-color:#bbb; }
    .btn.danger{ border-color:#b00020; color:#b00020; }
    .btn.disabled{ opacity:.45; cursor:not-allowed; pointer-events:none; }

    .card{
      border:1px solid #ddd;
      border-radius:12px;
      padding:16px;
      margin: 14px 0;
      background:#fff;
    }
    .card h2{ margin:0 0 6px; font-size:1.15rem; }
    .small{ font-size:.95rem; color:#555; margin:0 0 10px; }

    label{ display:block; margin:10px 0 6px; font-weight:800; }
    input, select, textarea{
      width:100%;
      box-sizing:border-box;
      padding:10px;
      border-radius:10px;
      border:1px solid #bbb;
      font:inherit;
      background:#fff;
    }
    textarea{ min-height: 90px; resize: vertical; }

    .row{ display:grid; gap:12px; grid-template-columns: 1fr; }
    @media (min-width: 720px){
      .row.two{ grid-template-columns: 1fr 1fr; }
      .row.three{ grid-template-columns: 1fr 1fr 1fr; }
    }

    .actions{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      margin-top: 12px;
    }

    .error{ color:#b00020; font-weight:900; }
    .ok{ font-weight:900; }

    .focusBox{
      border:1px solid #eee;
      border-radius:12px;
      padding:12px;
      background:#fafafa;
      margin-top: 10px;
    }
    .focusTitle{ font-weight:950; margin:0 0 4px; font-size:1.05rem; }
    .focusMeta{ margin:0; color:#444; }

    .list{
      margin: 10px 0 0;
      padding: 0;
      list-style:none;
      display:flex;
      flex-direction:column;
      gap:10px;
      max-height: 320px;
      overflow:auto;
      border-top: 1px solid #eee;
      padding-top: 10px;
    }
    .item{
      border:1px solid #eee;
      border-radius:12px;
      padding:10px;
      background:#fff;
      cursor:pointer;
    }
    .item:hover{ background:#fafafa; }
    .item.isActive{
      outline: 2px solid #111;
      outline-offset: 2px;
    }
    .itemTitle{ font-weight:950; margin:0 0 2px; }
    .itemMeta{ margin:0; color:#555; font-size:.95rem; }

    .relGrid{
      display:grid;
      gap:12px;
      grid-template-columns: 1fr;
      margin-top: 10px;
    }
    @media (min-width: 900px){
      .relGrid{ grid-template-columns: 1fr 1fr; }
    }
    .relBox{
      border:1px solid #eee;
      border-radius:12px;
      padding:12px;
      background:#fff;
    }
    .relBox h3{
      margin:0 0 8px;
      font-size: 1.05rem;
    }
    .relLine{
      display:flex;
      justify-content:space-between;
      gap:10px;
      padding:6px 0;
      border-top:1px solid #f1f1f1;
    }
    .relLine:first-of-type{ border-top:0; }
    .relLeft{ min-width: 0; }
    .relName{ font-weight:850; }
    .relSub{ color:#666; font-size:.92rem; }
    .relAction{ white-space:nowrap; }

    code{ background:#f4f4f4; padding:2px 6px; border-radius:6px; }
    pre{ white-space:pre-wrap; background:#f4f4f4; padding:12px; border-radius:12px; overflow:auto; }
  </style>
</head>

<body>
<header>
  <h1>üë§ Personer (Sl√§ktkort)</h1>
  <p class="muted">
    Du matar in grunddata + grundrelationer (F√∂r√§lder‚ÜíBarn + Partner). Resten (syskon/kusin/morbror osv) r√§knas fram h√§r.
  </p>

  <nav class="topbar" aria-label="Navigation">
    <a class="btn secondary" href="../start.html">Start</a>
    <a class="btn secondary" href="./trees.html">Tr√§d</a>
    <a class="btn" href="./slaktkort.html">Personer</a>
    <a class="btn secondary" href="./create-relation.html">Relationer</a>
    <a class="btn secondary" href="./map.html">Karta</a>
    <a class="btn secondary" href="./place-picker.html">Plats-picker</a>
    <button id="logoutBtn" class="btn secondary" type="button">Logga ut</button>
  </nav>
</header>

<!-- 1) Tr√§d -->
<section class="card">
  <h2>1) Tr√§d</h2>
  <p class="small">Personer och relationer sparas per tr√§d i <code>localStorage</code>.</p>

  <label for="treeSelect">Aktivt tr√§d</label>
  <select id="treeSelect" aria-label="V√§lj tr√§d"></select>

  <div class="actions">
    <button id="reloadTreesBtn" class="btn secondary" type="button">Ladda tr√§d</button>
    <a class="btn secondary" href="./trees.html">G√• till Tr√§d</a>
  </div>

  <p id="treeMsg" class="muted" aria-live="polite"></p>
</section>

<!-- 2) Skapa / √§ndra person -->
<section class="card">
  <h2 id="formTitle">2) Skapa person</h2>
  <p class="small" id="formHint">
    Tips: om du g√•r till Plats-picker och kommer tillbaka, sparas dina f√§lt som ‚Äúutkast‚Äù automatiskt.
  </p>

  <div class="row two">
    <div>
      <label for="fornamn">F√∂rnamn</label>
      <input id="fornamn" placeholder="t.ex. Anna" autocomplete="given-name" />
    </div>
    <div>
      <label for="efternamn">Efternamn</label>
      <input id="efternamn" placeholder="t.ex. Andersson" autocomplete="family-name" />
    </div>
  </div>

  <label for="kon">K√∂n</label>
  <select id="kon">
    <option>Ok√§nt</option>
    <option>Man</option>
    <option>Kvinna</option>
  </select>

  <div class="row two">
    <div>
      <label for="fodelsear">F√∂delse√•r (valfritt)</label>
      <input id="fodelsear" type="number" placeholder="t.ex. 1874" inputmode="numeric" />
    </div>
    <div>
      <label for="dodsar">D√∂ds√•r (valfritt)</label>
      <input id="dodsar" type="number" placeholder="t.ex. 1942" inputmode="numeric" />
    </div>
  </div>

  <label for="plats">Plats (valfritt)</label>
  <input id="plats" placeholder="t.ex. Uppsala" />

  <label for="coords">Koordinater (lat, lon) (valfritt)</label>
  <input id="coords" placeholder="t.ex. 59.3293, 18.0686" />

  <div class="actions">
    <a class="btn secondary" href="./place-picker.html">V√§lj koordinater i Plats-picker</a>
    <button type="button" id="clearCoordsBtn" class="btn secondary">Rensa koordinater</button>
    <button type="button" id="clearDraftBtn" class="btn secondary">Rensa utkast</button>
  </div>

  <label for="anteckning">Anteckning (valfritt)</label>
  <textarea id="anteckning" placeholder="fri text"></textarea>

  <div class="actions">
    <button id="saveBtn" type="button" class="btn">Spara</button>
    <button id="newBtn" type="button" class="btn secondary">Ny person</button>
    <button id="deleteBtn" type="button" class="btn danger">Ta bort person</button>
  </div>

  <p id="saveMsg" class="muted" aria-live="polite"></p>
</section>

<!-- 3) Ber√§knade relationer -->
<section class="card">
  <h2>3) Ber√§knade relationer f√∂r vald person</h2>
  <p class="small">
    Dessa bygger p√• dina sparade relationer i <code>create-relation.html</code>.
    Om n√•got saknas: l√§gg till F√∂r√§lder‚ÜíBarn eller Partner, s√• uppdateras listan.
  </p>

  <div class="actions">
    <a class="btn secondary" href="./create-relation.html">L√§gg till grundrelationer</a>
    <button id="refreshComputedBtn" type="button" class="btn secondary">Uppdatera ber√§kningar</button>
  </div>

  <div id="computedEmpty" class="muted" style="margin-top:10px;"></div>

  <div class="relGrid" id="relGrid" aria-label="Ber√§knade relationer"></div>
</section>

<!-- 4) Personlista -->
<section class="card">
  <h2>4) Personer i aktivt tr√§d</h2>
  <p class="small">Klicka en person f√∂r att √∂ppna/√§ndra den.</p>

  <div class="actions">
    <button id="refreshListBtn" type="button" class="btn secondary">Uppdatera lista</button>
    <a class="btn secondary" href="./create-relation.html">Forts√§tt ‚Üí Relationer</a>
    <a class="btn secondary" href="./map.html">Forts√§tt ‚Üí Karta</a>
  </div>

  <ul id="peopleList" class="list" aria-label="Personlista"></ul>

  <details style="margin-top:12px;">
    <summary class="small">Visa JSON (debug)</summary>
    <pre id="out">[]</pre>
  </details>
</section>

<script>
  // ============================
  // Estetisk auth-guard
  // ============================
  (function authGuard(){
    try{
      if(sessionStorage.getItem("demo_auth") !== "1"){
        window.location.href = "../index.html";
      }
    }catch{}
  })();

  // ============================
  // Keys (M√ÖSTE matcha √∂vriga sidor)
  // ============================
  const KEY_TREES = "slakttradet_trees";
  const KEY_ACTIVE = "slakttradet_active_tree_id";
  const KEY_LAST_LOC = "slakttradet_last_location";

  const cardsKey = (treeId) => "slakttradet_slaktkort_" + String(treeId);
  const relKey   = (treeId) => "slakttradet_relationer_" + String(treeId);

  // Utkast s√• du inte tappar f√§lt n√§r du g√•r till place-picker
  const draftKey = (treeId) => "slakttradet_slaktkort_draft_" + String(treeId);

  // ============================
  // DOM
  // ============================
  const logoutBtn = document.getElementById("logoutBtn");

  const treeSelect = document.getElementById("treeSelect");
  const reloadTreesBtn = document.getElementById("reloadTreesBtn");
  const treeMsg = document.getElementById("treeMsg");

  const formTitle = document.getElementById("formTitle");
  const formHint = document.getElementById("formHint");

  const fornamnEl = document.getElementById("fornamn");
  const efternamnEl = document.getElementById("efternamn");
  const konEl = document.getElementById("kon");
  const fodelsearEl = document.getElementById("fodelsear");
  const dodsarEl = document.getElementById("dodsar");
  const platsEl = document.getElementById("plats");
  const coordsEl = document.getElementById("coords");
  const anteckningEl = document.getElementById("anteckning");

  const clearCoordsBtn = document.getElementById("clearCoordsBtn");
  const clearDraftBtn = document.getElementById("clearDraftBtn");

  const saveBtn = document.getElementById("saveBtn");
  const newBtn = document.getElementById("newBtn");
  const deleteBtn = document.getElementById("deleteBtn");
  const saveMsg = document.getElementById("saveMsg");

  const refreshComputedBtn = document.getElementById("refreshComputedBtn");
  const computedEmpty = document.getElementById("computedEmpty");
  const relGrid = document.getElementById("relGrid");

  const refreshListBtn = document.getElementById("refreshListBtn");
  const peopleList = document.getElementById("peopleList");
  const out = document.getElementById("out");

  // ============================
  // State
  // ============================
  let editingPersonId = "";     // aktuell person vi visar/editerar
  let suppressDraftSave = false;

  // ============================
  // Helpers
  // ============================
  function safeParse(raw, fallback){ try{ return JSON.parse(raw); }catch{ return fallback; } }
  function loadJson(key, fallback){
    const raw = localStorage.getItem(key);
    return raw ? safeParse(raw, fallback) : fallback;
  }
  function saveJson(key, value){ localStorage.setItem(key, JSON.stringify(value)); }

  function escapeHtml(s){
    return String(s || "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }
  function setMsg(el, type, text){
    el.innerHTML = type === "error"
      ? "<span class='error'>" + escapeHtml(text) + "</span>"
      : type === "ok"
        ? "<span class='ok'>" + escapeHtml(text) + "</span>"
        : escapeHtml(text || "");
  }

  function getActiveTreeId(){ return localStorage.getItem(KEY_ACTIVE) || ""; }
  function setActiveTreeId(id){ localStorage.setItem(KEY_ACTIVE, String(id || "")); }

  function loadTrees(){
    const trees = loadJson(KEY_TREES, []);
    return Array.isArray(trees) ? trees : [];
  }

  function loadCards(treeId){
    const arr = loadJson(cardsKey(treeId), []);
    return Array.isArray(arr) ? arr : [];
  }
  function saveCards(treeId, cards){
    saveJson(cardsKey(treeId), cards);
  }

  function loadRels(treeId){
    const arr = loadJson(relKey(treeId), []);
    return Array.isArray(arr) ? arr : [];
  }

  function personName(p){
    const n = `${p.fornamn || ""} ${p.efternamn || ""}`.trim();
    return n || "(namnl√∂s)";
  }
  function yearsLine(p){
    const a = (p && p.fodelsear != null && String(p.fodelsear).trim() !== "") ? String(p.fodelsear).trim() : "";
    const b = (p && p.dodsar != null && String(p.dodsar).trim() !== "") ? String(p.dodsar).trim() : "";
    if(!a && !b) return "";
    if(a && b) return `${a}‚Äì${b}`;
    return a ? `${a}‚Äì` : `‚Äì${b}`;
  }
  function metaLine(p){
    const parts = [];
    const y = yearsLine(p);
    const place = String(p.plats || "").trim();
    if(y) parts.push(y);
    if(place) parts.push(place);
    return parts.length ? parts.join(" ¬∑ ") : "‚Äî";
  }

  function parseOptionalInt(el){
    const raw = String(el.value || "").trim();
    if(!raw) return null;
    const n = Number(raw);
    return Number.isFinite(n) ? n : null;
  }

  function parseCoords(text){
    const raw = String(text || "").trim();
    if(!raw) return null;

    const normalized = raw.replace(/\s+/g, " ");
    const partsComma = normalized.split(",").map(s => s.trim()).filter(Boolean);

    let a, b;
    if (partsComma.length === 2) { a = partsComma[0]; b = partsComma[1]; }
    else {
      const partsSpace = normalized.split(" ").filter(Boolean);
      if (partsSpace.length !== 2) return null;
      a = partsSpace[0]; b = partsSpace[1];
    }

    const lat = Number(a);
    const lon = Number(b);

    if (!Number.isFinite(lat) || !Number.isFinite(lon)) return null;
    if (lat < -90 || lat > 90) return null;
    if (lon < -180 || lon > 180) return null;

    return { lat, lon };
  }

  function makeCardId(){
    return "p" + Date.now().toString().slice(-10);
  }

  // ============================
  // Draft (s√• du inte tappar namn n√§r du g√•r till place-picker)
  // ============================
  function readDraft(){
    const t = getActiveTreeId();
    if(!t) return null;
    return loadJson(draftKey(t), null);
  }
  function writeDraft(){
    if(suppressDraftSave) return;
    const t = getActiveTreeId();
    if(!t) return;

    const payload = {
      editingPersonId: editingPersonId || "",
      fornamn: String(fornamnEl.value || ""),
      efternamn: String(efternamnEl.value || ""),
      kon: String(konEl.value || "Ok√§nt"),
      fodelsear: String(fodelsearEl.value || ""),
      dodsar: String(dodsarEl.value || ""),
      plats: String(platsEl.value || ""),
      coords: String(coordsEl.value || ""),
      anteckning: String(anteckningEl.value || "")
    };
    saveJson(draftKey(t), payload);
  }
  function clearDraft(){
    const t = getActiveTreeId();
    if(!t) return;
    localStorage.removeItem(draftKey(t));
  }
  function restoreDraftIfUseful(){
    const d = readDraft();
    if(!d) return;

    // Om formul√§ret redan har n√•got, l√§mna det
    const alreadyHasAny =
      String(fornamnEl.value || "").trim() ||
      String(efternamnEl.value || "").trim() ||
      String(platsEl.value || "").trim() ||
      String(coordsEl.value || "").trim() ||
      String(anteckningEl.value || "").trim();
    if(alreadyHasAny) return;

    suppressDraftSave = true;
    editingPersonId = String(d.editingPersonId || "");
    fornamnEl.value = d.fornamn || "";
    efternamnEl.value = d.efternamn || "";
    konEl.value = d.kon || "Ok√§nt";
    fodelsearEl.value = d.fodelsear || "";
    dodsarEl.value = d.dodsar || "";
    platsEl.value = d.plats || "";
    coordsEl.value = d.coords || "";
    anteckningEl.value = d.anteckning || "";
    suppressDraftSave = false;

    updateFormMode();
    setMsg(saveMsg, "", "Utkast √•terst√§llt (s√• du inte tappar text n√§r du byter sida).");
  }

  function attachDraftAutoSave(){
    const els = [fornamnEl, efternamnEl, konEl, fodelsearEl, dodsarEl, platsEl, coordsEl, anteckningEl];
    els.forEach(el => el.addEventListener("input", writeDraft));
    konEl.addEventListener("change", writeDraft);
  }

  // ============================
  // Trees UI
  // ============================
  function renderTreeSelect(){
    const trees = loadTrees();
    const activeId = getActiveTreeId();

    treeSelect.innerHTML = "";

    if(!trees.length){
      treeSelect.innerHTML = "<option value=''>Inga tr√§d √§nnu</option>";
      setMsg(treeMsg, "error", "Inga tr√§d sparade. G√• till Tr√§d och skapa ett tr√§d.");
      return;
    }

    treeSelect.innerHTML = "<option value=''>V√§lj‚Ä¶</option>";
    for(const t of trees){
      const opt = document.createElement("option");
      opt.value = String(t.id);
      opt.textContent = `${t.name}${String(t.id) === activeId ? " (aktivt)" : ""}`;
      treeSelect.appendChild(opt);
    }

    if(activeId){
      treeSelect.value = activeId;
    }else{
      treeSelect.value = String(trees[0].id);
      setActiveTreeId(treeSelect.value);
    }

    setMsg(treeMsg, "ok", "Tr√§d laddade.");
  }

  treeSelect.addEventListener("change", () => {
    if(treeSelect.value) setActiveTreeId(treeSelect.value);

    // byte tr√§d = nytt arbetsl√§ge
    editingPersonId = "";
    resetForm(false);
    restoreDraftIfUseful();
    renderPeopleList();
    renderComputedRelations();
  });

  reloadTreesBtn.addEventListener("click", () => {
    renderTreeSelect();
    restoreDraftIfUseful();
    renderPeopleList();
    renderComputedRelations();
  });

  // ============================
  // Prefill coords fr√•n place-picker
  // ============================
  function prefillCoordsFromPlacePicker(){
    const data = loadJson(KEY_LAST_LOC, null);
    if (!data || typeof data.lat !== "number" || typeof data.lon !== "number") return;
    if(String(coordsEl.value || "").trim()) return; // skriv inte √∂ver om du redan har
    coordsEl.value = `${data.lat}, ${data.lon}`;
    writeDraft();
  }

  clearCoordsBtn.addEventListener("click", () => {
    coordsEl.value = "";
    writeDraft();
    setMsg(saveMsg, "", "Koordinater rensade.");
  });

  clearDraftBtn.addEventListener("click", () => {
    clearDraft();
    setMsg(saveMsg, "ok", "Utkast rensat.");
  });

  // ============================
  // Form mode (create/edit)
  // ============================
  function updateFormMode(){
    if(editingPersonId){
      formTitle.textContent = "2) √Ñndra person";
      saveBtn.textContent = "Spara √§ndringar";
      deleteBtn.classList.remove("disabled");
      deleteBtn.disabled = false;
      formHint.textContent = "Du √§ndrar en befintlig person. Klicka ‚ÄúNy person‚Äù f√∂r att skapa ny.";
    }else{
      formTitle.textContent = "2) Skapa person";
      saveBtn.textContent = "Spara";
      deleteBtn.disabled = true;
      deleteBtn.classList.add("disabled");
      formHint.textContent = "Tips: om du g√•r till Plats-picker och kommer tillbaka, sparas dina f√§lt som ‚Äúutkast‚Äù automatiskt.";
    }
  }

  function resetForm(clearMsg=true){
    suppressDraftSave = true;
    fornamnEl.value = "";
    efternamnEl.value = "";
    konEl.value = "Ok√§nt";
    fodelsearEl.value = "";
    dodsarEl.value = "";
    platsEl.value = "";
    coordsEl.value = "";
    anteckningEl.value = "";
    suppressDraftSave = false;

    editingPersonId = "";
    updateFormMode();
    if(clearMsg) setMsg(saveMsg, "", "");
    writeDraft();
  }

  function fillFormFromPerson(p){
    suppressDraftSave = true;
    fornamnEl.value = p.fornamn || "";
    efternamnEl.value = p.efternamn || "";
    konEl.value = p.kon || "Ok√§nt";
    fodelsearEl.value = (p.fodelsear == null ? "" : String(p.fodelsear));
    dodsarEl.value = (p.dodsar == null ? "" : String(p.dodsar));
    platsEl.value = p.plats || "";
    if(p.coords && typeof p.coords === "object"){
      coordsEl.value = `${p.coords.lat}, ${p.coords.lon}`;
    }else{
      coordsEl.value = p.coords ? String(p.coords) : "";
    }
    anteckningEl.value = p.anteckning || "";
    suppressDraftSave = false;

    writeDraft();
  }

  newBtn.addEventListener("click", () => {
    resetForm();
    renderComputedRelations();
  });

  // ============================
  // Save / Delete
  // ============================
  function buildPayload(existingId){
    const treeId = getActiveTreeId();
    if(!treeId) return { error: "V√§lj ett tr√§d f√∂rst." };

    const coordsObj = parseCoords(coordsEl.value);

    const payload = {
      id: existingId || makeCardId(),
      fornamn: String(fornamnEl.value || "").trim(),
      efternamn: String(efternamnEl.value || "").trim(),
      kon: String(konEl.value || "Ok√§nt"),
      fodelsear: parseOptionalInt(fodelsearEl),
      dodsar: parseOptionalInt(dodsarEl),
      plats: String(platsEl.value || "").trim(),
      coords: coordsObj,
      anteckning: String(anteckningEl.value || "").trim(),
      updatedAt: new Date().toISOString()
    };

    if(!payload.fornamn && !payload.efternamn){
      return { error: "Fyll i minst f√∂rnamn eller efternamn." };
    }
    if(String(coordsEl.value || "").trim() && !coordsObj){
      return { error: "Koordinater m√•ste vara 'lat, lon' (ex: 59.3293, 18.0686)." };
    }
    return { payload };
  }

  function savePerson(){
    const treeId = getActiveTreeId();
    if(!treeId) return setMsg(saveMsg, "error", "V√§lj ett tr√§d f√∂rst.");

    const { payload, error } = buildPayload(editingPersonId || "");
    if(error) return setMsg(saveMsg, "error", error);

    const cards = loadCards(treeId);

    if(editingPersonId){
      const idx = cards.findIndex(p => String(p.id) === String(editingPersonId));
      if(idx === -1){
        cards.push({ ...payload, createdAt: new Date().toISOString() });
        saveCards(treeId, cards);
        setMsg(saveMsg, "ok", "Person hittades inte i listan ‚Äì skapade ny ist√§llet.");
      }else{
        const prev = cards[idx] || {};
        cards[idx] = { ...prev, ...payload, id: editingPersonId, createdAt: prev.createdAt || prev.updatedAt || new Date().toISOString() };
        saveCards(treeId, cards);
        setMsg(saveMsg, "ok", "√Ñndringar sparade.");
      }
    }else{
      cards.push({ ...payload, createdAt: new Date().toISOString() });
      saveCards(treeId, cards);
      setMsg(saveMsg, "ok", `Person sparad (id: ${payload.id}).`);
      editingPersonId = payload.id;
      updateFormMode();
    }

    writeDraft();
    renderPeopleList();
    renderComputedRelations();
    openAndHighlight(editingPersonId || payload.id);
  }

  function deletePerson(){
    const treeId = getActiveTreeId();
    if(!treeId) return setMsg(saveMsg, "error", "V√§lj ett tr√§d f√∂rst.");
    if(!editingPersonId) return setMsg(saveMsg, "error", "V√§lj en person f√∂rst.");

    const yes = confirm("Ta bort personen?\n\nObs: relationer kan fortfarande peka p√• samma id tills du tar bort dem i Relationer.");
    if(!yes) return;

    const cards = loadCards(treeId).filter(p => String(p.id) !== String(editingPersonId));
    saveCards(treeId, cards);

    editingPersonId = "";
    resetForm(false);
    clearDraft();
    setMsg(saveMsg, "ok", "Person borttagen.");

    renderPeopleList();
    renderComputedRelations();
  }

  saveBtn.addEventListener("click", savePerson);
  deleteBtn.addEventListener("click", deletePerson);

  // ============================
  // People list
  // ============================
  function renderPeopleList(){
    const treeId = getActiveTreeId();
    peopleList.innerHTML = "";

    if(!treeId){
      out.textContent = "[]";
      const li = document.createElement("li");
      li.className = "item";
      li.style.cursor = "default";
      li.innerHTML = "<p class='itemTitle'>Inget tr√§d valt</p><p class='itemMeta'>G√• till Tr√§d och v√§lj aktivt tr√§d.</p>";
      peopleList.appendChild(li);
      return;
    }

    const cards = loadCards(treeId);
    out.textContent = JSON.stringify({ slaktkort: cards, relationer: loadRels(treeId) }, null, 2);

    if(cards.length === 0){
      const li = document.createElement("li");
      li.className = "item";
      li.style.cursor = "default";
      li.innerHTML = "<p class='itemTitle'>Inga personer √§n</p><p class='itemMeta'>Skapa en person i formul√§ret.</p>";
      peopleList.appendChild(li);
      return;
    }

    for(const p of cards){
      const li = document.createElement("li");
      li.className = "item";
      li.dataset.id = String(p.id);

      const years = yearsLine(p);
      const place = String(p.plats || "").trim();
      const coordText = (p.coords && typeof p.coords === "object")
        ? `${p.coords.lat}, ${p.coords.lon}`
        : (p.coords ? String(p.coords) : "");

      li.innerHTML =
        "<p class='itemTitle'>" + escapeHtml(personName(p)) + "</p>" +
        "<p class='itemMeta'>" +
          (years ? escapeHtml(years) + " ¬∑ " : "") +
          (place ? escapeHtml(place) + " ¬∑ " : "") +
          (coordText ? ("üìç " + escapeHtml(coordText)) : "") +
        "</p>";

      li.addEventListener("click", () => {
        editingPersonId = String(p.id);
        fillFormFromPerson(p);
        updateFormMode();
        setMsg(saveMsg, "", "Person laddad. √Ñndra och klicka Spara √§ndringar.");
        highlightItem(editingPersonId);
        renderComputedRelations();
      });

      peopleList.appendChild(li);
    }

    highlightItem(editingPersonId);
  }

  function highlightItem(id){
    const all = peopleList.querySelectorAll(".item");
    all.forEach(x => x.classList.remove("isActive"));
    if(!id) return;

    const el = peopleList.querySelector(".item[data-id='" + CSS.escape(String(id)) + "']");
    if(el){
      el.classList.add("isActive");
      el.scrollIntoView({ block: "nearest" });
    }
  }

  function openAndHighlight(id){
    if(!id) return;
    const treeId = getActiveTreeId();
    if(!treeId) return;

    const cards = loadCards(treeId);
    const p = cards.find(x => String(x.id) === String(id));
    if(!p) return;

    editingPersonId = String(id);
    fillFormFromPerson(p);
    updateFormMode();
    highlightItem(id);
  }

  refreshListBtn.addEventListener("click", () => {
    renderPeopleList();
    renderComputedRelations();
  });

  // ============================
  // Ber√§knade relationer (syskon/kusin/morbror osv)
  // Bygger ENDAST p√•:
  // - FORALDER_BARN: franPersonId (f√∂r√§lder) -> tillPersonId (barn)
  // - PARTNER: personAId <-> personBId
  // ============================
  function buildIndexes(people, rels){
    const byId = new Map(people.map(p => [String(p.id), p]));

    const parentsOf = new Map();   // childId -> Set(parentId)
    const childrenOf = new Map();  // parentId -> Set(childId)
    const partnersOf = new Map();  // personId -> Set(partnerId)

    function addSet(map, key, value){
      const k = String(key);
      const v = String(value);
      if(!map.has(k)) map.set(k, new Set());
      map.get(k).add(v);
    }

    for(const r of rels){
      if(!r || !r.typ) continue;

      if(r.typ === "FORALDER_BARN"){
        const parentId = String(r.franPersonId || "");
        const childId = String(r.tillPersonId || "");
        if(!parentId || !childId) continue;
        addSet(parentsOf, childId, parentId);
        addSet(childrenOf, parentId, childId);
      }

      if(r.typ === "PARTNER"){
        const a = String(r.personAId || "");
        const b = String(r.personBId || "");
        if(!a || !b || a === b) continue;
        addSet(partnersOf, a, b);
        addSet(partnersOf, b, a);
      }
    }

    return { byId, parentsOf, childrenOf, partnersOf };
  }

  function uniqIds(arr){
    const s = new Set();
    for(const x of arr) if(x) s.add(String(x));
    return Array.from(s);
  }

  function personLinkButton(personId){
    const a = document.createElement("a");
    a.className = "btn secondary";
    a.style.padding = "8px 10px";
    a.href = "./slaktkort.html"; // vi √∂ppnar h√§r genom att bara klicka i listan (snabbt)
    a.textContent = "√ñppna";
    a.addEventListener("click", (e) => {
      e.preventDefault();
      const treeId = getActiveTreeId();
      if(!treeId) return;
      const cards = loadCards(treeId);
      const p = cards.find(x => String(x.id) === String(personId));
      if(!p) return;
      editingPersonId = String(personId);
      fillFormFromPerson(p);
      updateFormMode();
      highlightItem(editingPersonId);
      renderComputedRelations();
      window.scrollTo({ top: 0, behavior: "smooth" });
    });
    return a;
  }

  function renderRelBox(title, ids, idx){
    const box = document.createElement("div");
    box.className = "relBox";
    box.innerHTML = "<h3>" + escapeHtml(title) + "</h3>";

    const clean = uniqIds(ids).filter(id => idx.byId.has(String(id)) && String(id) !== String(editingPersonId));
    if(clean.length === 0){
      const p = document.createElement("p");
      p.className = "muted";
      p.style.margin = "0";
      p.textContent = "‚Äî";
      box.appendChild(p);
      return box;
    }

    // sortera alfabetiskt f√∂r lugn k√§nsla
    clean.sort((a,b) => {
      const pa = idx.byId.get(String(a));
      const pb = idx.byId.get(String(b));
      return personName(pa).localeCompare(personName(pb), "sv");
    });

    for(const id of clean){
      const p = idx.byId.get(String(id));
      const row = document.createElement("div");
      row.className = "relLine";

      const left = document.createElement("div");
      left.className = "relLeft";
      left.innerHTML =
        "<div class='relName'>" + escapeHtml(personName(p)) + "</div>" +
        "<div class='relSub'>" + escapeHtml(metaLine(p)) + "</div>";

      const right = document.createElement("div");
      right.className = "relAction";
      right.appendChild(personLinkButton(id));

      row.appendChild(left);
      row.appendChild(right);
      box.appendChild(row);
    }

    return box;
  }

  function computeRelationsFor(personId, idx){
    const me = String(personId);

    const parents = Array.from(idx.parentsOf.get(me) || []);
    const children = Array.from(idx.childrenOf.get(me) || []);
    const partners = Array.from(idx.partnersOf.get(me) || []);

    // Syskon: delar minst en f√∂r√§lder
    const siblingsSet = new Set();
    for(const p of parents){
      const kids = idx.childrenOf.get(String(p)) || new Set();
      for(const k of kids){
        if(String(k) !== me) siblingsSet.add(String(k));
      }
    }
    const siblings = Array.from(siblingsSet);

    // Mor-/far-f√∂r√§ldrar: f√∂r√§ldrar till mina f√∂r√§ldrar
    const grandparentsSet = new Set();
    for(const p of parents){
      const gps = idx.parentsOf.get(String(p)) || new Set();
      for(const gp of gps) grandparentsSet.add(String(gp));
    }
    const grandparents = Array.from(grandparentsSet);

    // Barnbarn: barn till mina barn
    const grandchildrenSet = new Set();
    for(const c of children){
      const gcs = idx.childrenOf.get(String(c)) || new Set();
      for(const gc of gcs) grandchildrenSet.add(String(gc));
    }
    const grandchildren = Array.from(grandchildrenSet);

    // Moster/morbror/faster/farbror: syskon till mina f√∂r√§ldrar
    const auntsUnclesSet = new Set();
    for(const p of parents){
      const pParents = Array.from(idx.parentsOf.get(String(p)) || []);
      for(const pp of pParents){
        const kids = idx.childrenOf.get(String(pp)) || new Set();
        for(const k of kids){
          if(String(k) !== String(p)) auntsUnclesSet.add(String(k));
        }
      }
    }
    const auntsUncles = Array.from(auntsUnclesSet);

    // Kusiner: barn till mina mostrar/morbr√∂der/fastrar/farbr√∂der
    const cousinsSet = new Set();
    for(const au of auntsUncles){
      const kids = idx.childrenOf.get(String(au)) || new Set();
      for(const k of kids) cousinsSet.add(String(k));
    }
    const cousins = Array.from(cousinsSet);

    // Syskons barn: (brorson/systerdotter etc) ‚Äì vi kallar dem "Syskonbarn"
    const niecesNephewsSet = new Set();
    for(const s of siblings){
      const kids = idx.childrenOf.get(String(s)) || new Set();
      for(const k of kids) niecesNephewsSet.add(String(k));
    }
    const niecesNephews = Array.from(niecesNephewsSet);

    // Sv√§rf√∂r√§ldrar (partners f√∂r√§ldrar)
    const inlawsParentsSet = new Set();
    for(const partner of partners){
      const ps = idx.parentsOf.get(String(partner)) || new Set();
      for(const p of ps) inlawsParentsSet.add(String(p));
    }
    const inlawsParents = Array.from(inlawsParentsSet);

    // Sv√§rsyskon (partners syskon)
    const inlawsSiblingsSet = new Set();
    for(const partner of partners){
      const partnerParents = Array.from(idx.parentsOf.get(String(partner)) || []);
      for(const pp of partnerParents){
        const kids = idx.childrenOf.get(String(pp)) || new Set();
        for(const k of kids){
          if(String(k) !== String(partner)) inlawsSiblingsSet.add(String(k));
        }
      }
    }
    const inlawsSiblings = Array.from(inlawsSiblingsSet);

    return {
      parents,
      partners,
      children,
      siblings,
      grandparents,
      grandchildren,
      auntsUncles,
      cousins,
      niecesNephews,
      inlawsParents,
      inlawsSiblings
    };
  }

  function renderComputedRelations(){
    relGrid.innerHTML = "";
    computedEmpty.textContent = "";

    const treeId = getActiveTreeId();
    if(!treeId){
      computedEmpty.textContent = "V√§lj ett tr√§d f√∂rst.";
      return;
    }

    if(!editingPersonId){
      computedEmpty.textContent = "V√§lj en person i listan (l√§ngst ner) f√∂r att se relationer.";
      return;
    }

    const people = loadCards(treeId);
    const rels = loadRels(treeId);
    const idx = buildIndexes(people, rels);

    if(!idx.byId.has(String(editingPersonId))){
      computedEmpty.textContent = "Personen finns inte i listan l√§ngre.";
      return;
    }

    // Om inga relationer alls finns
    if(rels.length === 0){
      computedEmpty.textContent = "Inga relationer sparade √§n. G√• till Relationer och l√§gg till F√∂r√§lder‚ÜíBarn eller Partner.";
      return;
    }

    const R = computeRelationsFor(editingPersonId, idx);

    // Rendera boxar i en bra ordning
    relGrid.appendChild(renderRelBox("F√∂r√§ldrar", R.parents, idx));
    relGrid.appendChild(renderRelBox("Partner", R.partners, idx));
    relGrid.appendChild(renderRelBox("Barn", R.children, idx));
    relGrid.appendChild(renderRelBox("Syskon", R.siblings, idx));

    relGrid.appendChild(renderRelBox("Mor-/far-f√∂r√§ldrar", R.grandparents, idx));
    relGrid.appendChild(renderRelBox("Barnbarn", R.grandchildren, idx));

    relGrid.appendChild(renderRelBox("Moster/Morbror/Faster/Farbror", R.auntsUncles, idx));
    relGrid.appendChild(renderRelBox("Kusiner", R.cousins, idx));

    relGrid.appendChild(renderRelBox("Syskonbarn (brorson/systerdotter)", R.niecesNephews, idx));
    relGrid.appendChild(renderRelBox("Sv√§rf√∂r√§ldrar (partners f√∂r√§ldrar)", R.inlawsParents, idx));
    relGrid.appendChild(renderRelBox("Sv√§rsyskon (partners syskon)", R.inlawsSiblings, idx));
  }

  refreshComputedBtn.addEventListener("click", renderComputedRelations);

  // ============================
  // Logout
  // ============================
  logoutBtn.addEventListener("click", () => {
    try{ sessionStorage.removeItem("demo_auth"); }catch{}
    window.location.href = "../index.html";
  });

  // ============================
  // Init
  // ============================
  (function init(){
    renderTreeSelect();
    prefillCoordsFromPlacePicker();
    attachDraftAutoSave();
    renderPeopleList();
    restoreDraftIfUseful();
    updateFormMode();
    renderComputedRelations();
  })();
</script>
</body>
</html>
