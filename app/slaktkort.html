<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Personer ‚Äì Sl√§ktkort</title>
  <meta name="description" content="Skapa och redigera personer (localStorage-first). V√§lj plats fr√•n karta och spara koordinater." />

  <style>
    :root { color-scheme: light; }
    body{
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      line-height: 1.5;
      margin: 0;
      padding: 24px;
      max-width: 1180px;
      margin-inline: auto;
      background: #fff;
      color: #111;
    }
    a{ color: inherit; text-decoration:none; }
    header{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      margin-bottom:18px;
    }
    h1{ margin:0 0 6px; font-size:1.6rem; }
    .muted{ color:#555; margin:0 0 12px; }

    .topbar{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      margin: 10px 0 0;
    }
    .btn, button{
      display:inline-block;
      padding:10px 12px;
      border:1px solid #333;
      border-radius:10px;
      background:#fff;
      font:inherit;
      cursor:pointer;
      text-decoration:none;
      user-select:none;
    }
    .btn.secondary{ border-color:#bbb; }
    .btn.danger{ border-color:#b00020; color:#b00020; }
    .btn:disabled{ opacity:.5; cursor:not-allowed; }

    .pillRow{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      margin: 10px 0 18px;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border:1px solid #ddd;
      border-radius:999px;
      background:#fafafa;
      font-size:.95rem;
    }
    .pill strong{ font-weight:900; }
    .pill.ok{ border-color:#cfe8cf; background:#f5fff5; }
    .pill.warn{ border-color:#ffe1a6; background:#fff9ee; }
    .pill.err{ border-color:#ffb3b3; background:#fff2f2; }

    .grid{
      display:grid;
      gap:14px;
      grid-template-columns: 1fr;
    }
    @media (min-width: 1080px){
      .grid{ grid-template-columns: 420px 1fr; }
    }

    .card{
      border:1px solid #ddd;
      border-radius:12px;
      padding:16px;
      background:#fff;
      position: relative;
    }
    .card h2{ margin:0 0 6px; font-size:1.15rem; }
    .small{ font-size:.95rem; color:#555; margin:0 0 10px; }

    .list{
      margin: 10px 0 0;
      padding: 0;
      list-style:none;
      display:flex;
      flex-direction:column;
      gap:10px;
      max-height: 520px;
      overflow:auto;
      border-top: 1px solid #eee;
      padding-top: 10px;
    }
    .item{
      border:1px solid #eee;
      border-radius:12px;
      padding:10px;
      background:#fff;
      cursor:pointer;
    }
    .item:hover{ background:#fafafa; }
    .item.active{
      border-color:#7fcf9b;
      box-shadow: 0 0 0 4px rgba(183,228,199,.35);
      background:#fff;
    }
    .itemTitle{ font-weight:900; margin:0 0 2px; }
    .itemMeta{ margin:0; color:#555; font-size:.95rem; }
    .itemSub{ margin:4px 0 0; color:#333; font-size:.95rem; }

    label{ display:block; margin:10px 0 6px; font-weight:800; }
    input, select, textarea{
      width:100%;
      box-sizing:border-box;
      padding:10px;
      border-radius:10px;
      border:1px solid #bbb;
      font:inherit;
      background:#fff;
    }
    textarea{ min-height: 110px; resize: vertical; }

    .row2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }
    @media (max-width: 640px){
      .row2{ grid-template-columns: 1fr; }
    }

    .actions{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      margin-top: 12px;
    }

    .hintBox{
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid #ffe1a6;
      background: #fff9ee;
    }
    .okBox{
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid #cfe8cf;
      background: #f5fff5;
    }
    code{ background:#f4f4f4; padding:2px 6px; border-radius:6px; }
  </style>
</head>

<body>
<header>
  <div>
    <h1>Personer</h1>
    <p class="muted">Skapa och redigera personer i aktivt tr√§d. V√§lj plats fr√•n kartan och spara koordinater.</p>

    <nav class="topbar" aria-label="Navigation">
      <a class="btn secondary" href="../start.html">Start</a>
      <a class="btn secondary" href="./trees.html">Tr√§d</a>
      <a class="btn" href="./slaktkort.html">Personer</a>
      <a class="btn secondary" href="./create-relation.html">Relationer</a>
      <a class="btn secondary" href="./map.html">Karta</a>
    </nav>
  </div>

  <div class="actions" style="justify-content:flex-end;">
    <button id="logoutBtn" class="btn secondary" type="button">Logga ut</button>
  </div>
</header>

<section class="pillRow" aria-label="Status">
  <span id="pillTree" class="pill warn">Aktivt tr√§d: <strong>‚Äî</strong></span>
  <span id="pillPeople" class="pill">Personer: <strong>0</strong></span>
  <span id="pillCoords" class="pill">Med koordinater: <strong>0</strong></span>
</section>

<div class="grid">
  <!-- V√ÑNSTER: LISTA -->
  <section class="card" aria-label="Lista">
    <h2>Personlista</h2>
    <p class="small">Klicka en person f√∂r att redigera. Eller skapa ny.</p>

    <div class="actions">
      <button id="newBtn" type="button" class="btn">Skapa ny person</button>
      <button id="reloadBtn" type="button" class="btn secondary">Ladda om</button>
    </div>

    <div id="leftHint" class="hintBox" hidden></div>

    <ul id="list" class="list" aria-label="Personer"></ul>
  </section>

  <!-- H√ñGER: FORM -->
  <section class="card" aria-label="Personkort">
    <h2 id="formTitle">Ny person</h2>
    <p class="small" id="formSub">Fyll i uppgifter och spara.</p>

    <div class="row2">
      <div>
        <label for="fornamn">F√∂rnamn</label>
        <input id="fornamn" autocomplete="off" />
      </div>
      <div>
        <label for="efternamn">Efternamn</label>
        <input id="efternamn" autocomplete="off" />
      </div>
    </div>

    <div class="row2">
      <div>
        <label for="kon">K√∂n</label>
        <select id="kon">
          <option value="">‚Äî</option>
          <option value="man">Man</option>
          <option value="kvinna">Kvinna</option>
        </select>
      </div>
      <div>
        <label for="yrke">Yrke (valfritt)</label>
        <input id="yrke" autocomplete="off" />
      </div>
    </div>

    <div class="row2">
      <div>
        <label for="fodelsear">F√∂delse√•r (valfritt)</label>
        <input id="fodelsear" inputmode="numeric" placeholder="t.ex. 1980" />
      </div>
      <div>
        <label for="dodsar">D√∂ds√•r (valfritt)</label>
        <input id="dodsar" inputmode="numeric" placeholder="t.ex. 2020" />
      </div>
    </div>

    <label for="plats">Plats (valfritt)</label>
    <input id="plats" placeholder="t.ex. Falun" autocomplete="off" />

    <div class="hintBox">
      <strong>Plats fr√•n kartan</strong>
      <div class="small" style="margin-top:6px;">
        Klicka <strong>V√§lj plats</strong>, s√§tt flaggan p√• kartan och spara d√§r. N√§r du kommer tillbaka fylls koordinaterna i automatiskt.
      </div>
      <div class="actions" style="margin-top:10px;">
        <button id="pickBtn" type="button" class="btn">V√§lj plats</button>
        <button id="clearCoordsBtn" type="button" class="btn secondary">Rensa koordinater</button>
      </div>
    </div>

    <label for="coords">Koordinater (lat, lon) (valfritt)</label>
    <input id="coords" placeholder="t.ex. 60.6070, 15.6355" autocomplete="off" />

    <label for="anteckning">Anteckning (valfritt)</label>
    <textarea id="anteckning" placeholder="..." ></textarea>

    <div class="actions">
      <button id="saveBtn" type="button" class="btn">Spara</button>
      <button id="deleteBtn" type="button" class="btn danger" disabled>Ta bort</button>
      <button id="resetBtn" type="button" class="btn secondary">√Öterst√§ll form</button>
    </div>

    <div id="statusBox" class="okBox" hidden></div>
    <p class="small" id="tech" style="margin-top:10px;">‚Äî</p>
  </section>
</div>

<script>
  "use strict";

  // =====================================================
  // DEMO AUTH GUARD (matchar din map.html)
  // =====================================================
  (function authGuard(){
    try{
      if(sessionStorage.getItem("demo_auth") !== "1"){
        window.location.href = "../index.html";
      }
    }catch{}
  })();

  // =====================================================
  // STORAGE KEYS (m√•ste matcha √∂vriga sidor)
  // =====================================================
  const KEY_TREES  = "slakttradet_trees";
  const KEY_ACTIVE = "slakttradet_active_tree_id";
  const cardsKey = (treeId) => "slakttradet_slaktkort_" + String(treeId);

  // Pick integration (matchar map.html)
  const PICK_RESULT_KEY = "slaktkort_map_pick_result";
  const PICK_AUTOSTART_KEY = "slaktkort_map_pick_autostart";

  // Draft: f√∂r att inte tappa uppgifter n√§r man g√•r till kartan
  const DRAFT_KEY = "slaktkort_person_draft_v1";

  // =====================================================
  // DOM
  // =====================================================
  const logoutBtn = document.getElementById("logoutBtn");

  const pillTree = document.getElementById("pillTree");
  const pillPeople = document.getElementById("pillPeople");
  const pillCoords = document.getElementById("pillCoords");

  const leftHint = document.getElementById("leftHint");
  const listEl = document.getElementById("list");
  const newBtn = document.getElementById("newBtn");
  const reloadBtn = document.getElementById("reloadBtn");

  const formTitle = document.getElementById("formTitle");
  const formSub = document.getElementById("formSub");

  const fornamnEl = document.getElementById("fornamn");
  const efternamnEl = document.getElementById("efternamn");
  const konEl = document.getElementById("kon");
  const yrkeEl = document.getElementById("yrke");
  const fodelsearEl = document.getElementById("fodelsear");
  const dodsarEl = document.getElementById("dodsar");
  const platsEl = document.getElementById("plats");
  const coordsEl = document.getElementById("coords");
  const anteckningEl = document.getElementById("anteckning");

  const pickBtn = document.getElementById("pickBtn");
  const clearCoordsBtn = document.getElementById("clearCoordsBtn");

  const saveBtn = document.getElementById("saveBtn");
  const deleteBtn = document.getElementById("deleteBtn");
  const resetBtn = document.getElementById("resetBtn");

  const statusBox = document.getElementById("statusBox");
  const techEl = document.getElementById("tech");

  // =====================================================
  // HELPERS
  // =====================================================
  function safeParse(raw, fallback){
    try{ return JSON.parse(raw); }catch{ return fallback; }
  }
  function loadJson(key, fallback){
    const raw = localStorage.getItem(key);
    return raw ? safeParse(raw, fallback) : fallback;
  }
  function saveJson(key, value){
    localStorage.setItem(key, JSON.stringify(value));
  }
  function escapeHtml(s){
    return String(s || "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }
  function uid(){
    return "p_" + Date.now().toString(36) + "_" + Math.random().toString(36).slice(2,8);
  }
  function activeTreeId(){
    return localStorage.getItem(KEY_ACTIVE) || "";
  }
  function getTrees(){
    const trees = loadJson(KEY_TREES, []);
    return Array.isArray(trees) ? trees : [];
  }
  function activeTreeLabel(){
    const id = activeTreeId();
    if(!id) return "‚Äî";
    const t = getTrees().find(x => String(x.id) === String(id));
    return t ? (t.name || t.id) : id;
  }
  function loadPeople(){
    const t = activeTreeId();
    if(!t) return [];
    const arr = loadJson(cardsKey(t), []);
    return Array.isArray(arr) ? arr : [];
  }
  function savePeople(arr){
    const t = activeTreeId();
    if(!t) return;
    saveJson(cardsKey(t), Array.isArray(arr) ? arr : []);
  }
  function personName(p){
    const n = `${p.fornamn || ""} ${p.efternamn || ""}`.trim();
    return n || "(namnl√∂s)";
  }
  function yearsLine(p){
    const a = (p && p.fodelsear != null && String(p.fodelsear).trim() !== "") ? String(p.fodelsear).trim() : "";
    const b = (p && p.dodsar != null && String(p.dodsar).trim() !== "") ? String(p.dodsar).trim() : "";
    if(!a && !b) return "";
    if(a && b) return `${a}‚Äì${b}`;
    return a ? `${a}‚Äì` : `‚Äì${b}`;
  }
  function parseCoordsText(txt){
    const s = String(txt || "").trim();
    if(!s) return null;
    const parts = s.split(",").map(x => x.trim()).filter(Boolean);
    if(parts.length !== 2) return null;
    const lat = Number(parts[0]);
    const lon = Number(parts[1]);
    if(!Number.isFinite(lat) || !Number.isFinite(lon)) return null;
    if(lat < -90 || lat > 90 || lon < -180 || lon > 180) return null;
    return { lat, lon };
  }
  function coordsToText(c){
    if(!c || !Number.isFinite(c.lat) || !Number.isFinite(c.lon)) return "";
    return `${c.lat.toFixed(4)}, ${c.lon.toFixed(4)}`;
  }
  function showStatus(html){
    statusBox.hidden = false;
    statusBox.innerHTML = html;
    setTimeout(() => { try{ statusBox.hidden = true; }catch{} }, 1800);
  }

  // =====================================================
  // STATE
  // =====================================================
  let people = [];
  let selectedId = ""; // "" = ny person

  // =====================================================
  // DRAFT (f√∂r att inte tappa formdata n√§r man g√•r till kartan)
  // =====================================================
  function makeDraft(){
    return {
      ts: Date.now(),
      selectedId: selectedId || "",
      form: {
        fornamn: fornamnEl.value || "",
        efternamn: efternamnEl.value || "",
        kon: konEl.value || "",
        yrke: yrkeEl.value || "",
        fodelsear: fodelsearEl.value || "",
        dodsar: dodsarEl.value || "",
        plats: platsEl.value || "",
        coordsText: coordsEl.value || "",
        anteckning: anteckningEl.value || ""
      }
    };
  }
  function saveDraft(){
    try{ localStorage.setItem(DRAFT_KEY, JSON.stringify(makeDraft())); }catch{}
  }
  function clearDraft(){
    try{ localStorage.removeItem(DRAFT_KEY); }catch{}
  }
  function loadDraft(){
    const d = loadJson(DRAFT_KEY, null);
    if(!d || !d.form) return null;
    return d;
  }
  function applyDraft(d){
    try{
      selectedId = String(d.selectedId || "");
      const f = d.form || {};
      fornamnEl.value = f.fornamn || "";
      efternamnEl.value = f.efternamn || "";
      konEl.value = f.kon || "";
      yrkeEl.value = f.yrke || "";
      fodelsearEl.value = f.fodelsear || "";
      dodsarEl.value = f.dodsar || "";
      platsEl.value = f.plats || "";
      coordsEl.value = f.coordsText || "";
      anteckningEl.value = f.anteckning || "";
    }catch{}
  }

  // autospara draft vid √§ndringar (s√• du aldrig tappar uppgifter)
  function hookAutoDraft(){
    const els = [
      fornamnEl, efternamnEl, konEl, yrkeEl, fodelsearEl, dodsarEl, platsEl, coordsEl, anteckningEl
    ];
    for(const el of els){
      el.addEventListener("input", saveDraft);
      el.addEventListener("change", saveDraft);
    }
  }

  // =====================================================
  // PICK RESULT (kommer fr√•n map.html)
  // =====================================================
  function consumePickResult(){
    const raw = localStorage.getItem(PICK_RESULT_KEY);
    if(!raw) return null;
    localStorage.removeItem(PICK_RESULT_KEY);
    const obj = safeParse(raw, null);
    if(!obj) return null;
    const lat = Number(obj.lat);
    const lon = Number(obj.lon);
    if(!Number.isFinite(lat) || !Number.isFinite(lon)) return null;
    return { lat, lon };
  }

  // =====================================================
  // UI RENDER
  // =====================================================
  function renderPills(){
    const trees = getTrees();
    const hasTrees = trees.length > 0;
    const t = activeTreeId();
    const hasActive = !!t;

    pillTree.className = "pill " + (hasActive ? "ok" : (hasTrees ? "warn" : "err"));
    pillTree.innerHTML = "Aktivt tr√§d: <strong>" + (hasActive ? escapeHtml(activeTreeLabel()) : "‚Äî") + "</strong>";

    pillPeople.innerHTML = "Personer: <strong>" + people.length + "</strong>";

    const nCoords = people.filter(p => {
      const c = p && p.coords && typeof p.coords === "object" ? p.coords : null;
      return c && Number.isFinite(Number(c.lat)) && Number.isFinite(Number(c.lon));
    }).length;
    pillCoords.innerHTML = "Med koordinater: <strong>" + nCoords + "</strong>";
  }

  function renderList(){
    listEl.innerHTML = "";

    const t = activeTreeId();
    if(!t){
      leftHint.hidden = false;
      leftHint.innerHTML = "<strong>üö© Inget aktivt tr√§d:</strong> G√• till <a href='./trees.html'><code>Tr√§d</code></a> och v√§lj aktivt tr√§d.";
      return;
    }

    leftHint.hidden = true;
    leftHint.innerHTML = "";

    if(people.length === 0){
      const li = document.createElement("li");
      li.className = "item";
      li.style.cursor = "default";
      li.innerHTML = "<p class='itemTitle'>Inga personer √§nnu</p><p class='itemMeta'>Klicka ‚ÄúSkapa ny person‚Äù.</p>";
      listEl.appendChild(li);
      return;
    }

    for(const p of people){
      const li = document.createElement("li");
      li.className = "item" + (String(p.id) === String(selectedId) ? " active" : "");
      li.dataset.id = String(p.id);

      const years = yearsLine(p);
      const hasC = p && p.coords && Number.isFinite(Number(p.coords.lat)) && Number.isFinite(Number(p.coords.lon));
      const coordsLine = hasC ? ("Koordinater: " + Number(p.coords.lat).toFixed(4) + ", " + Number(p.coords.lon).toFixed(4)) : "Koordinater: ‚Äî";
      const platsLine = String(p.plats || "").trim() ? ("Plats: " + escapeHtml(String(p.plats || "").trim())) : "Plats: ‚Äî";

      li.innerHTML =
        "<p class='itemTitle'>" + escapeHtml(personName(p)) + "</p>" +
        "<p class='itemMeta'>" + escapeHtml(years || "‚Äî") + "</p>" +
        "<p class='itemSub'>" + escapeHtml(platsLine) + "</p>" +
        "<p class='itemSub'>" + escapeHtml(coordsLine) + "</p>";

      li.addEventListener("click", () => {
        selectPerson(String(p.id));
      });

      listEl.appendChild(li);
    }
  }

  function setFormMode(){
    if(selectedId){
      formTitle.textContent = "Redigera person";
      formSub.textContent = "√Ñndra uppgifter och spara.";
      deleteBtn.disabled = false;
    }else{
      formTitle.textContent = "Ny person";
      formSub.textContent = "Fyll i uppgifter och spara.";
      deleteBtn.disabled = true;
    }
  }

  function clearForm(){
    selectedId = "";
    fornamnEl.value = "";
    efternamnEl.value = "";
    konEl.value = "";
    yrkeEl.value = "";
    fodelsearEl.value = "";
    dodsarEl.value = "";
    platsEl.value = "";
    coordsEl.value = "";
    anteckningEl.value = "";
    setFormMode();
    renderList();
    saveDraft();
    renderTech();
  }

  function selectPerson(id){
    const p = people.find(x => String(x.id) === String(id));
    if(!p) return;

    selectedId = String(p.id);

    fornamnEl.value = p.fornamn || "";
    efternamnEl.value = p.efternamn || "";
    konEl.value = p.kon || "";
    yrkeEl.value = p.yrke || "";
    fodelsearEl.value = (p.fodelsear ?? "") + "";
    dodsarEl.value = (p.dodsar ?? "") + "";
    platsEl.value = p.plats || "";
    coordsEl.value = p && p.coords ? coordsToText({ lat:Number(p.coords.lat), lon:Number(p.coords.lon) }) : "";
    anteckningEl.value = p.anteckning || "";

    setFormMode();
    renderList();
    saveDraft();
    renderTech();
  }

  function gatherForm(){
    const coordsParsed = parseCoordsText(coordsEl.value);
    return {
      fornamn: String(fornamnEl.value || "").trim(),
      efternamn: String(efternamnEl.value || "").trim(),
      kon: String(konEl.value || "").trim(),
      yrke: String(yrkeEl.value || "").trim(),
      fodelsear: String(fodelsearEl.value || "").trim(),
      dodsar: String(dodsarEl.value || "").trim(),
      plats: String(platsEl.value || "").trim(),
      coords: coordsParsed ? { lat: coordsParsed.lat, lon: coordsParsed.lon } : null,
      anteckning: String(anteckningEl.value || "").trim()
    };
  }

  function renderTech(){
    const t = activeTreeId();
    if(!t){
      techEl.textContent = "‚Äî";
      return;
    }
    const mode = selectedId ? ("Redigerar: " + selectedId) : "Skapar: ny person";
    techEl.textContent = mode + " ¬∑ Storage: " + cardsKey(t);
  }

  // =====================================================
  // CRUD
  // =====================================================
  function savePerson(){
    const t = activeTreeId();
    if(!t){
      showStatus("<strong>V√§lj aktivt tr√§d f√∂rst.</strong> G√• till Tr√§d.");
      return;
    }

    const f = gatherForm();
    if(!f.fornamn && !f.efternamn){
      showStatus("<strong>Fyll i minst f√∂rnamn eller efternamn.</strong>");
      return;
    }

    if(coordsEl.value.trim() && !f.coords){
      showStatus("<strong>Koordinater ser fel ut.</strong> Skriv som: 60.6070, 15.6355");
      return;
    }

    if(selectedId){
      // update
      const idx = people.findIndex(x => String(x.id) === String(selectedId));
      if(idx === -1){
        showStatus("<strong>Hittar inte personen.</strong> Ladda om.");
        return;
      }

      const prev = people[idx];
      const updated = {
        ...prev,
        fornamn: f.fornamn,
        efternamn: f.efternamn,
        kon: f.kon,
        yrke: f.yrke,
        fodelsear: f.fodelsear,
        dodsar: f.dodsar,
        plats: f.plats,
        coords: f.coords ? { lat: f.coords.lat, lon: f.coords.lon } : null,
        anteckning: f.anteckning,
        updatedAt: Date.now()
      };

      people[idx] = updated;
      savePeople(people);
      showStatus("<strong>Sparat.</strong>");
      clearDraft(); // klart
      // beh√•ll selection
      renderPills();
      renderList();
      renderTech();
      return;
    }

    // create
    const p = {
      id: uid(),
      fornamn: f.fornamn,
      efternamn: f.efternamn,
      kon: f.kon,
      yrke: f.yrke,
      fodelsear: f.fodelsear,
      dodsar: f.dodsar,
      plats: f.plats,
      coords: f.coords ? { lat: f.coords.lat, lon: f.coords.lon } : null,
      anteckning: f.anteckning,
      createdAt: Date.now(),
      updatedAt: Date.now()
    };

    people.unshift(p);
    savePeople(people);
    selectedId = String(p.id);
    setFormMode();
    showStatus("<strong>Skapad och sparad.</strong>");
    clearDraft(); // klart
    renderPills();
    renderList();
    renderTech();
  }

  function deletePerson(){
    if(!selectedId) return;
    const idx = people.findIndex(x => String(x.id) === String(selectedId));
    if(idx === -1) return;

    const name = personName(people[idx]);
    const ok = confirm("Ta bort " + name + "?");
    if(!ok) return;

    people.splice(idx, 1);
    savePeople(people);
    showStatus("<strong>Borttagen.</strong>");
    clearDraft();
    clearForm();
    renderPills();
  }

  // =====================================================
  // KARTA PICK FLOW
  // =====================================================
  function goPickOnMap(){
    // autospara draft s√• inget tappas
    saveDraft();

    // s√§tt autostart-flagga (kompatibel)
    try{ localStorage.setItem(PICK_AUTOSTART_KEY, "1"); }catch{}

    // √∂ppna map i pick-l√§ge
    window.location.href = "./map.html?pick=1";
  }

  function applyPickedCoordsIfAny(){
    const picked = consumePickResult();
    if(!picked) return false;

    coordsEl.value = coordsToText({ lat: picked.lat, lon: picked.lon });
    showStatus("<strong>Plats vald.</strong> Spara personen f√∂r att beh√•lla koordinaterna.");
    saveDraft();
    return true;
  }

  function clearCoords(){
    coordsEl.value = "";
    saveDraft();
    showStatus("<strong>Koordinater rensade.</strong>");
  }

  // =====================================================
  // EVENTS
  // =====================================================
  newBtn.addEventListener("click", () => {
    clearForm();
    showStatus("<strong>Ny person.</strong>");
  });

  reloadBtn.addEventListener("click", () => {
    init();
    showStatus("<strong>Omladdat.</strong>");
  });

  saveBtn.addEventListener("click", savePerson);
  deleteBtn.addEventListener("click", deletePerson);

  resetBtn.addEventListener("click", () => {
    // √•terst√§ll fr√•n vald person eller tom
    if(selectedId){
      selectPerson(selectedId);
      showStatus("<strong>√Öterst√§llt.</strong>");
    }else{
      clearForm();
      showStatus("<strong>√Öterst√§llt.</strong>");
    }
  });

  pickBtn.addEventListener("click", goPickOnMap);
  clearCoordsBtn.addEventListener("click", clearCoords);

  logoutBtn.addEventListener("click", () => {
    try{ sessionStorage.removeItem("demo_auth"); }catch{}
    window.location.href = "../index.html";
  });

  // =====================================================
  // INIT
  // =====================================================
  function init(){
    people = loadPeople();

    // status pills
    renderPills();

    // f√∂rst: om vi kommer tillbaka fr√•n kartan -> applicera coords
    // (innan vi eventuellt l√§ser draft)
    const hadPick = applyPickedCoordsIfAny();

    // sedan: om det finns draft -> √•terst√§ll form (s√• inget tappas)
    const draft = loadDraft();
    if(draft){
      applyDraft(draft);
      setFormMode();

      // om vi precis fick coords fr√•n kartan vill vi beh√•lla dem √§ven om draft hade annat
      if(hadPick){
        // coordsEl √§r redan uppdaterad; s√§kerst√§ll att draft ocks√• sparas
        saveDraft();
      }
    }else{
      setFormMode();
    }

    // om draft s√§ger att en person var vald, highlighta den
    // men om selectedId finns och personen finns -> ok, annars ny
    if(selectedId){
      const exists = people.some(p => String(p.id) === String(selectedId));
      if(!exists) selectedId = "";
    }

    // render
    renderList();
    setFormMode();
    renderTech();
  }

  hookAutoDraft();
  init();
</script>
</body>
</html>
