<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Personer – Släktkort</title>
  <meta name="description" content="Skapa och redigera personer i aktivt träd (localStorage-first) med platsval från karta." />
  <style>
    :root { color-scheme: light; }
    body{
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      line-height: 1.5;
      margin: 0;
      padding: 24px;
      max-width: 1100px;
      margin-inline: auto;
      background: #fff;
      color: #111;
    }
    a{ color: inherit; text-decoration:none; }
    header{ margin-bottom: 16px; }

    nav{
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      margin: 10px 0 18px;
    }
    nav a{
      padding: 8px 10px;
      border-radius: 12px;
      background: #f2f3f5;
      border: 1px solid #e6e8eb;
    }
    nav a[aria-current="page"]{
      background: #e9f7ef;
      border-color: #bfe7cf;
    }
    .spacer{ flex: 1 1 auto; }
    .btn{
      padding: 8px 10px;
      border-radius: 12px;
      background: #fff;
      border: 1px solid #e6e8eb;
      cursor: pointer;
      font: inherit;
    }
    .btn.primary{
      background:#111;
      color:#fff;
      border-color:#111;
    }
    .btn.secondary{
      background:#fafafa;
    }
    .btn:disabled{
      opacity:.55;
      cursor:not-allowed;
    }

    .grid{
      display:grid;
      gap: 14px;
      grid-template-columns: 1fr;
    }
    @media (min-width: 980px){
      .grid{ grid-template-columns: 420px 1fr; align-items:start; }
    }

    .card{
      border: 1px solid #e6e8eb;
      border-radius: 16px;
      padding: 14px 14px 12px;
      background: #fff;
      box-shadow: 0 1px 0 rgba(0,0,0,.03);
    }
    h1{ margin: 0 0 4px; font-size: 28px; }
    .kicker{
      margin: 0 0 6px;
      color: #4b5563;
      font-size: 13px;
    }
    h2{ margin:0 0 8px; font-size: 16px; }
    .muted{ color:#6b7280; font-size: 13px; margin:0; }

    label{ display:block; font-weight: 750; margin:10px 0 6px; }
    input, select, textarea{
      width:100%;
      box-sizing:border-box;
      padding:10px;
      border-radius:12px;
      border:1px solid #e6e8eb;
      font:inherit;
      background:#fff;
    }
    textarea{ min-height: 90px; resize: vertical; }

    .row2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    @media (max-width: 520px){
      .row2{ grid-template-columns: 1fr; }
    }

    .actions{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      margin-top: 12px;
    }

    .pillRow{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      margin: 10px 0 0;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border:1px solid #ddd;
      border-radius:999px;
      background:#fafafa;
      font-size:.95rem;
    }
    .pill strong{ font-weight:900; }
    .pill.ok{ border-color:#cfe8cf; background:#f5fff5; }
    .pill.warn{ border-color:#ffe1a6; background:#fff9ee; }
    .pill.err{ border-color:#ffb3b3; background:#fff2f2; }

    .list{
      margin: 10px 0 0;
      padding: 0;
      list-style:none;
      display:flex;
      flex-direction:column;
      gap:10px;
      max-height: 560px;
      overflow:auto;
    }
    .item{
      border:1px solid #e6e8eb;
      border-radius:14px;
      padding:10px;
      background:#fff;
    }
    .itemTop{
      display:flex;
      align-items:baseline;
      justify-content:space-between;
      gap:10px;
    }
    .itemTitle{ font-weight:900; margin:0; }
    .itemMeta{ margin:4px 0 0; color:#4b5563; font-size: 13px; }
    .itemBtns{ display:flex; gap:8px; flex-wrap:wrap; margin-top: 8px; }
    .smallBtn{
      padding: 7px 9px;
      border-radius: 12px;
      border: 1px solid #e6e8eb;
      background:#fafafa;
      cursor:pointer;
      font:inherit;
      font-size: 13px;
    }

    .hintBox{
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid #ffe1a6;
      background: #fff9ee;
      color:#111;
      font-size: 13px;
    }

    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
  </style>
</head>

<body>
  <header>
    <h1>Personer</h1>
    <p class="kicker">Lägg till personer i aktivt träd. Välj plats från kartan utan att förlora formuläret.</p>

    <nav aria-label="Huvudmeny">
      <a href="../start.html">Start</a>
      <a href="./trees.html">Träd</a>
      <a href="./slaktkort.html" aria-current="page">Personer</a>
      <a href="./create-relation.html">Relationer</a>
      <a href="./map.html">Karta</a>
      <span class="spacer"></span>
      <button class="btn" id="logoutBtn" type="button">Logga ut</button>
    </nav>

    <div class="pillRow" aria-label="Status">
      <span id="pillTree" class="pill warn">Aktivt träd: <strong>—</strong></span>
      <span id="pillCount" class="pill">Personer: <strong>0</strong></span>
      <span id="pillCoords" class="pill">Med koordinater: <strong>0</strong></span>
    </div>
  </header>

  <div class="grid">
    <!-- Vänster: formulär -->
    <section class="card" aria-label="Personformulär">
      <h2 id="formTitle">Skapa person</h2>
      <p class="muted" id="formSub">Fyll i uppgifter. Plats väljs via kartan.</p>

      <form id="personForm" autocomplete="off">
        <div class="row2">
          <div>
            <label for="fornamn">Förnamn</label>
            <input id="fornamn" name="fornamn" placeholder="t.ex. Stina" />
          </div>
          <div>
            <label for="efternamn">Efternamn</label>
            <input id="efternamn" name="efternamn" placeholder="t.ex. Nilsson" />
          </div>
        </div>

        <div class="row2">
          <div>
            <label for="kon">Kön</label>
            <select id="kon" name="kon">
              <option value="">—</option>
              <option value="man">Man</option>
              <option value="kvinna">Kvinna</option>
            </select>
          </div>
          <div>
            <label for="yrke">Yrke (valfritt)</label>
            <input id="yrke" name="yrke" placeholder="t.ex. bonde" />
          </div>
        </div>

        <div class="row2">
          <div>
            <label for="fodelsear">Födelseår (valfritt)</label>
            <input id="fodelsear" name="fodelsear" inputmode="numeric" placeholder="t.ex. 1988" />
          </div>
          <div>
            <label for="dodsar">Dödsår (valfritt)</label>
            <input id="dodsar" name="dodsar" inputmode="numeric" placeholder="t.ex. 2050" />
          </div>
        </div>

        <label for="plats">Plats (valfritt)</label>
        <input id="plats" name="plats" placeholder="t.ex. Falun" />

        <label>Koordinater</label>
        <input id="coords" name="coords" class="mono" placeholder="Välj från kartan" readonly />

        <div class="actions">
          <button id="pickOnMapBtn" class="btn secondary" type="button">Välj från kartan</button>
          <button id="clearCoordsBtn" class="btn secondary" type="button">Rensa koordinater</button>
        </div>

        <label for="notes">Anteckning (valfritt)</label>
        <textarea id="notes" name="notes" placeholder="Valfri anteckning…"></textarea>

        <div class="actions">
          <button id="savePersonBtn" class="btn primary" type="submit">Spara person</button>
          <button id="newPersonBtn" class="btn" type="button">Ny person</button>
        </div>

        <div id="msg" class="hintBox" hidden></div>
      </form>

      <div class="hintBox" id="mapHint">
        Tips: Klicka <strong>Välj från kartan</strong>, sätt en flagga, och gå tillbaka hit så fylls koordinaterna i automatiskt.
      </div>
    </section>

    <!-- Höger: lista -->
    <section class="card" aria-label="Personlista">
      <h2>Lista</h2>
      <p class="muted">Klicka Redigera för att ändra en person.</p>
      <ul id="peopleList" class="list" aria-label="Personer"></ul>
    </section>
  </div>

  <script>
    "use strict";

    // =====================================================
    // AUTH-GUARD (DEMO) – samma stil som map.html
    // =====================================================
    (function authGuard(){
      try{
        if(sessionStorage.getItem("demo_auth") !== "1"){
          window.location.href = "../index.html";
        }
      }catch{}
    })();

    // =====================================================
    // STORAGE KEYS (matchar map.html)
    // =====================================================
    const KEY_TREES  = "slakttradet_trees";
    const KEY_ACTIVE = "slakttradet_active_tree_id";
    const cardsKey = (treeId) => "slakttradet_slaktkort_" + String(treeId);

    // =====================================================
    // DRAFT + MAP PICK keys
    // =====================================================
    const DRAFT_KEY = "slaktkort_person_draft_v1";
    const PICK_RESULT_KEY = "slaktkort_map_pick_result";

    // =====================================================
    // DOM
    // =====================================================
    const pillTree = document.getElementById("pillTree");
    const pillCount = document.getElementById("pillCount");
    const pillCoords = document.getElementById("pillCoords");

    const peopleList = document.getElementById("peopleList");

    const form = document.getElementById("personForm");
    const formTitle = document.getElementById("formTitle");
    const formSub = document.getElementById("formSub");
    const msg = document.getElementById("msg");

    const fornamn = document.getElementById("fornamn");
    const efternamn = document.getElementById("efternamn");
    const kon = document.getElementById("kon");
    const yrke = document.getElementById("yrke");
    const fodelsear = document.getElementById("fodelsear");
    const dodsar = document.getElementById("dodsar");
    const plats = document.getElementById("plats");
    const coords = document.getElementById("coords");
    const notes = document.getElementById("notes");

    const pickOnMapBtn = document.getElementById("pickOnMapBtn");
    const clearCoordsBtn = document.getElementById("clearCoordsBtn");
    const newPersonBtn = document.getElementById("newPersonBtn");
    const logoutBtn = document.getElementById("logoutBtn");

    // =====================================================
    // Helpers
    // =====================================================
    function safeParseJSON(raw, fallback){
      try{ return JSON.parse(raw); }catch{ return fallback; }
    }
    function loadJson(key, fallback){
      const raw = localStorage.getItem(key);
      return raw ? safeParseJSON(raw, fallback) : fallback;
    }
    function saveJson(key, value){
      localStorage.setItem(key, JSON.stringify(value));
    }
    function escapeHtml(s){
      return String(s ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }
    function uuid(){
      try{
        if(crypto && typeof crypto.randomUUID === "function") return crypto.randomUUID();
      }catch{}
      return "p_" + Math.random().toString(16).slice(2) + "_" + Date.now().toString(16);
    }
    function activeTreeId(){
      return localStorage.getItem(KEY_ACTIVE) || "";
    }
    function getTrees(){
      const t = loadJson(KEY_TREES, []);
      return Array.isArray(t) ? t : [];
    }
    function activeTreeLabel(){
      const id = activeTreeId();
      if(!id) return "—";
      const t = getTrees().find(x => String(x.id) === String(id));
      return t ? (t.name || t.id) : id;
    }
    function personName(p){
      const n = `${p.fornamn || ""} ${p.efternamn || ""}`.trim();
      return n || "(namnlös)";
    }
    function yearsLine(p){
      const a = (p && p.fodelsear != null && String(p.fodelsear).trim() !== "") ? String(p.fodelsear).trim() : "";
      const b = (p && p.dodsar != null && String(p.dodsar).trim() !== "") ? String(p.dodsar).trim() : "";
      if(!a && !b) return "";
      if(a && b) return `${a}–${b}`;
      return a ? `${a}–` : `–${b}`;
    }
    function parseCoordsString(s){
      const t = String(s || "").trim();
      if(!t) return null;
      const parts = t.split(",").map(x => x.trim()).filter(Boolean);
      if(parts.length !== 2) return null;
      const lat = Number(parts[0]);
      const lon = Number(parts[1]);
      if(!Number.isFinite(lat) || !Number.isFinite(lon)) return null;
      if(lat < -90 || lat > 90 || lon < -180 || lon > 180) return null;
      return { lat, lon };
    }
    function formatCoords(c){
      if(!c) return "";
      return `${Number(c.lat).toFixed(4)}, ${Number(c.lon).toFixed(4)}`;
    }
    function showMsg(text){
      msg.hidden = false;
      msg.textContent = text;
    }
    function hideMsg(){
      msg.hidden = true;
      msg.textContent = "";
    }

    // =====================================================
    // People load/save per active tree
    // =====================================================
    function loadPeople(){
      const t = activeTreeId();
      if(!t) return [];
      const arr = loadJson(cardsKey(t), []);
      return Array.isArray(arr) ? arr : [];
    }
    function savePeople(arr){
      const t = activeTreeId();
      if(!t) return;
      saveJson(cardsKey(t), arr);
    }

    // =====================================================
    // Editor state
    // =====================================================
    let editingId = "";

    function clearForm(){
      editingId = "";
      formTitle.textContent = "Skapa person";
      formSub.textContent = "Fyll i uppgifter. Plats väljs via kartan.";
      fornamn.value = "";
      efternamn.value = "";
      kon.value = "";
      yrke.value = "";
      fodelsear.value = "";
      dodsar.value = "";
      plats.value = "";
      coords.value = "";
      notes.value = "";
      hideMsg();
      saveDraft(); // håll draft i sync även när man rensar
    }

    function fillForm(p){
      editingId = String(p.id || "");
      formTitle.textContent = "Redigera person";
      formSub.textContent = "Ändra uppgifter och spara.";
      fornamn.value = String(p.fornamn || "");
      efternamn.value = String(p.efternamn || "");
      kon.value = String(p.kon || "");
      yrke.value = String(p.yrke || "");
      fodelsear.value = (p.fodelsear == null ? "" : String(p.fodelsear));
      dodsar.value = (p.dodsar == null ? "" : String(p.dodsar));
      plats.value = String(p.plats || "");
      coords.value = p.coords && typeof p.coords === "object" ? formatCoords(p.coords) : "";
      notes.value = String(p.notes || "");
      hideMsg();
      saveDraft();
    }

    // =====================================================
    // Draft (sessionStorage) – behåll formulär mellan sidor
    // =====================================================
    function readForm(){
      return {
        editingId,
        fornamn: fornamn.value,
        efternamn: efternamn.value,
        kon: kon.value,
        yrke: yrke.value,
        fodelsear: fodelsear.value,
        dodsar: dodsar.value,
        plats: plats.value,
        coords: coords.value,
        notes: notes.value
      };
    }
    function writeForm(d){
      if(!d || typeof d !== "object") return;
      editingId = String(d.editingId || "");
      fornamn.value = String(d.fornamn || "");
      efternamn.value = String(d.efternamn || "");
      kon.value = String(d.kon || "");
      yrke.value = String(d.yrke || "");
      fodelsear.value = String(d.fodelsear || "");
      dodsar.value = String(d.dodsar || "");
      plats.value = String(d.plats || "");
      coords.value = String(d.coords || "");
      notes.value = String(d.notes || "");

      if(editingId){
        formTitle.textContent = "Redigera person";
        formSub.textContent = "Ändra uppgifter och spara.";
      }else{
        formTitle.textContent = "Skapa person";
        formSub.textContent = "Fyll i uppgifter. Plats väljs via kartan.";
      }
    }
    function saveDraft(){
      try{
        sessionStorage.setItem(DRAFT_KEY, JSON.stringify({ ts: Date.now(), data: readForm() }));
      }catch{}
    }
    function loadDraft(){
      try{
        const raw = sessionStorage.getItem(DRAFT_KEY);
        if(!raw) return null;
        const obj = JSON.parse(raw);
        if(!obj || typeof obj !== "object") return null;
        if(obj.ts && (Date.now() - obj.ts) > 2*60*60*1000){
          sessionStorage.removeItem(DRAFT_KEY);
          return null;
        }
        return obj.data || null;
      }catch{
        return null;
      }
    }
    function clearDraft(){
      try{ sessionStorage.removeItem(DRAFT_KEY); }catch{}
    }

    // autospara draft när man skriver
    let draftTimer = null;
    form.addEventListener("input", () => {
      if(draftTimer) clearTimeout(draftTimer);
      draftTimer = setTimeout(saveDraft, 120);
    });

    // =====================================================
    // Apply map pick result on load (coords)
    // =====================================================
    function applyPickResultIfAny(){
      try{
        const raw = sessionStorage.getItem(PICK_RESULT_KEY);
        if(!raw) return;
        const res = JSON.parse(raw);
        if(!res || typeof res !== "object") return;

        const lat = Number(res.lat);
        const lon = Number(res.lon);
        if(!Number.isFinite(lat) || !Number.isFinite(lon)) return;

        coords.value = `${lat.toFixed(4)}, ${lon.toFixed(4)}`;
        // valfritt: om plats är tom, skriv "Vald på karta"
        if(!String(plats.value || "").trim()){
          plats.value = "Vald på karta";
        }

        saveDraft();
        sessionStorage.removeItem(PICK_RESULT_KEY);
      }catch{}
    }

    // =====================================================
    // Render list
    // =====================================================
    function render(){
      const t = activeTreeId();
      const hasActive = !!t;
      const trees = getTrees();

      pillTree.className = "pill " + (hasActive ? "ok" : (trees.length ? "warn" : "err"));
      pillTree.innerHTML = "Aktivt träd: <strong>" + escapeHtml(hasActive ? activeTreeLabel() : "—") + "</strong>";

      const people = hasActive ? loadPeople() : [];
      pillCount.innerHTML = "Personer: <strong>" + people.length + "</strong>";

      const withCoords = people.filter(p => p && p.coords && Number.isFinite(+p.coords.lat) && Number.isFinite(+p.coords.lon)).length;
      pillCoords.innerHTML = "Med koordinater: <strong>" + withCoords + "</strong>";

      peopleList.innerHTML = "";

      if(!trees.length){
        const li = document.createElement("li");
        li.className = "item";
        li.innerHTML = "<p class='itemTitle'>Inga träd ännu</p><p class='itemMeta'>Gå till Träd och skapa ett träd först.</p>";
        peopleList.appendChild(li);
        return;
      }

      if(!hasActive){
        const li = document.createElement("li");
        li.className = "item";
        li.innerHTML = "<p class='itemTitle'>Inget aktivt träd valt</p><p class='itemMeta'>Gå till Träd och välj aktivt träd.</p>";
        peopleList.appendChild(li);
        return;
      }

      if(people.length === 0){
        const li = document.createElement("li");
        li.className = "item";
        li.innerHTML = "<p class='itemTitle'>Inga personer ännu</p><p class='itemMeta'>Skapa din första person i formuläret.</p>";
        peopleList.appendChild(li);
        return;
      }

      for(const p of people){
        const li = document.createElement("li");
        li.className = "item";

        const top = document.createElement("div");
        top.className = "itemTop";

        const title = document.createElement("p");
        title.className = "itemTitle";
        title.textContent = personName(p);

        const yrs = document.createElement("p");
        yrs.className = "itemMeta";
        yrs.textContent = yearsLine(p) || "—";

        top.appendChild(title);
        top.appendChild(yrs);

        const meta = document.createElement("p");
        meta.className = "itemMeta";
        const c = p.coords ? formatCoords(p.coords) : "";
        meta.textContent =
          (p.plats ? ("Plats: " + p.plats + " · ") : "") +
          (c ? ("Coords: " + c) : "Coords: —");

        const btns = document.createElement("div");
        btns.className = "itemBtns";

        const edit = document.createElement("button");
        edit.type = "button";
        edit.className = "smallBtn";
        edit.textContent = "Redigera";
        edit.addEventListener("click", () => fillForm(p));

        const del = document.createElement("button");
        del.type = "button";
        del.className = "smallBtn";
        del.textContent = "Ta bort";
        del.addEventListener("click", () => {
          const ok = confirm("Ta bort " + personName(p) + "?");
          if(!ok) return;
          const next = loadPeople().filter(x => String(x.id) !== String(p.id));
          savePeople(next);
          if(String(editingId) === String(p.id)){
            clearForm();
          }
          render();
        });

        btns.appendChild(edit);
        btns.appendChild(del);

        li.appendChild(top);
        li.appendChild(meta);
        li.appendChild(btns);

        peopleList.appendChild(li);
      }
    }

    // =====================================================
    // Events
    // =====================================================
    pickOnMapBtn.addEventListener("click", () => {
      // spara draft innan navigation så inget försvinner
      saveDraft();
      // gå till map
      window.location.href = "./map.html";
    });

    clearCoordsBtn.addEventListener("click", () => {
      coords.value = "";
      saveDraft();
    });

    newPersonBtn.addEventListener("click", () => {
      clearForm();
    });

    form.addEventListener("submit", (e) => {
      e.preventDefault();

      const t = activeTreeId();
      if(!t){
        showMsg("Välj ett aktivt träd först (gå till Träd).");
        return;
      }

      const fn = String(fornamn.value || "").trim();
      const en = String(efternamn.value || "").trim();
      if(!fn && !en){
        showMsg("Fyll i minst förnamn eller efternamn.");
        return;
      }

      const c = parseCoordsString(coords.value);

      const person = {
        id: editingId || uuid(),
        fornamn: fn,
        efternamn: en,
        kon: String(kon.value || ""),
        yrke: String(yrke.value || "").trim(),
        fodelsear: String(fodelsear.value || "").trim(),
        dodsar: String(dodsar.value || "").trim(),
        plats: String(plats.value || "").trim(),
        coords: c ? { lat: c.lat, lon: c.lon } : null,
        notes: String(notes.value || "").trim()
      };

      // normalisera tomma år
      if(person.fodelsear === "") person.fodelsear = "";
      if(person.dodsar === "") person.dodsar = "";

      const all = loadPeople();
      const idx = all.findIndex(x => String(x.id) === String(person.id));
      if(idx >= 0){
        all[idx] = person;
      }else{
        all.push(person);
      }
      savePeople(all);

      // rensa draft efter lyckad save så man inte “återställer gammalt”
      clearDraft();

      // håll kvar i edit-läge eller skapa ny?
      fillForm(person);
      showMsg("Sparad.");

      render();
    });

    logoutBtn.addEventListener("click", () => {
      try{ sessionStorage.removeItem("demo_auth"); }catch{}
      window.location.href = "../index.html";
    });

    // =====================================================
    // Boot
    // =====================================================
    // 1) Återställ draft först (så allt kommer tillbaka)
    const d = loadDraft();
    if(d) writeForm(d);

    // 2) Applicera ev. punkt från kartan (utan att tappa draft)
    applyPickResultIfAny();

    // 3) Om vi är i edit-läge enligt draft: sätt rubriker rätt
    if(editingId){
      formTitle.textContent = "Redigera person";
      formSub.textContent = "Ändra uppgifter och spara.";
    }

    render();
  </script>
</body>
</html>
